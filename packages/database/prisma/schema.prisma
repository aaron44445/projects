generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Salon {
  id                           String              @id @default(uuid())
  name                         String
  slug                         String              @unique
  email                        String
  phone                        String?
  address                      String?
  city                         String?
  state                        String?
  zip                          String?
  country                      String              @default("US")
  timezone                     String              @default("UTC")
  logoUrl                      String?             @map("logo_url")
  website                      String?
  description                  String?
  subscriptionPlan             String              @default("essentials") @map("subscription_plan")
  subscriptionTier             String              @default("free") @map("subscription_tier")
  featuresEnabled              String              @default("[]") @map("features_enabled")
  stripeAccountId              String?             @map("stripe_account_id")
  stripeCustomerId             String?             @map("stripe_customer_id")
  isActive                     Boolean             @default(true) @map("is_active")
  createdAt                    DateTime            @default(now()) @map("created_at")
  updatedAt                    DateTime            @updatedAt @map("updated_at")
  marketingAddonEnabled        Boolean             @default(false) @map("marketing_addon_enabled")
  marketingAddonSuspended      Boolean             @default(false) @map("marketing_addon_suspended")
  marketingAddonEnabledAt      DateTime?           @map("marketing_addon_enabled_at")
  stripeMarketingSubId         String?             @map("stripe_marketing_sub_id")
  sendgridApiKeyEncrypted      String?             @map("sendgrid_api_key_encrypted")
  sendgridFromEmail            String?             @map("sendgrid_from_email")
  sendgridValidated            Boolean             @default(false) @map("sendgrid_validated")
  sendgridLastValidatedAt      DateTime?           @map("sendgrid_last_validated_at")
  twilioAccountSidEncrypted    String?             @map("twilio_account_sid_encrypted")
  twilioAuthTokenEncrypted     String?             @map("twilio_auth_token_encrypted")
  twilioPhoneNumber            String?             @map("twilio_phone_number")
  twilioValidated              Boolean             @default(false) @map("twilio_validated")
  twilioLastValidatedAt        DateTime?           @map("twilio_last_validated_at")
  businessType                 String?             @map("business_type")
  onboardingComplete           Boolean             @default(false) @map("onboarding_complete")
  onboardingStep               Int                 @default(1) @map("onboarding_step")
  widgetAccentColor            String              @default("#B5A8D5") @map("widget_accent_color")
  widgetButtonStyle            String              @default("rounded") @map("widget_button_style")
  widgetFontFamily             String              @default("system") @map("widget_font_family")
  widgetPrimaryColor           String              @default("#7C9A82") @map("widget_primary_color")
  brand_background_color       String              @default("#FAF8F3")
  brand_primary_color          String              @default("#C7DCC8")
  business_hours               String              @default("[]")
  notification_settings        String              @default("{}")
  multiLocationEnabled         Boolean             @default(false) @map("multi_location_enabled")
  syncPricingFromFlagship      Boolean             @default(false) @map("sync_pricing_from_flagship")
  syncServicesFromFlagship     Boolean             @default(false) @map("sync_services_from_flagship")
  syncSettingsFromFlagship     Boolean             @default(false) @map("sync_settings_from_flagship")
  bookingEnabled               Boolean             @default(true) @map("booking_enabled")
  bookingMaxAdvanceDays        Int                 @default(30) @map("booking_max_advance_days")
  bookingMinNoticeHours        Int                 @default(2) @map("booking_min_notice_hours")
  bookingRequireEmail          Boolean             @default(true) @map("booking_require_email")
  bookingRequirePhone          Boolean             @default(false) @map("booking_require_phone")
  bookingSlotInterval          Int                 @default(30) @map("booking_slot_interval")
  staffCanCompleteAppointments Boolean             @default(true) @map("staff_can_complete_appointments")
  staffCanEditSchedule         Boolean             @default(true) @map("staff_can_edit_schedule")
  staffCanRequestTimeOff       Boolean             @default(true) @map("staff_can_request_time_off")
  staffCanViewClientContact    Boolean             @default(true) @map("staff_can_view_client_contact")
  staffScheduleNeedsApproval   Boolean             @default(false) @map("staff_schedule_needs_approval")
  requireTimeOffApproval       Boolean             @default(false) @map("require_time_off_approval")
  currency                     String              @default("USD")
  dateFormat                   String              @default("DMY") @map("date_format")
  locale                       String              @default("en")
  taxEnabled                   Boolean             @default(false) @map("tax_enabled")
  taxIncluded                  Boolean             @default(true) @map("tax_included")
  taxName                      String              @default("VAT") @map("tax_name")
  taxRate                      Float?              @map("tax_rate")
  depositPercentage            Int                 @default(20) @map("deposit_percentage")
  requireDeposit               Boolean             @default(false) @map("require_deposit")
  cancellationPolicy           String              @default("{}") @map("cancellation_policy")
  timeFormat                   String              @default("24h") @map("time_format")
  vatNumber                    String?             @map("vat_number")
  weekStartsOn                 Int                 @default(1) @map("week_starts_on")
  termsAcceptedAt              DateTime?           @map("terms_accepted_at")
  termsVersion                 String?             @map("terms_version")
  appointments                 Appointment[]
  clients                      Client[]
  commissionRecords            CommissionRecord[]
  consultationForms            ConsultationForm[]
  giftCards                    GiftCard[]
  locations                    Location[]
  marketingCampaigns           MarketingCampaign[]
  notificationLogs             NotificationLog[]
  packages                     Package[]
  payments                     Payment[]
  serviceCategories            ServiceCategory[]
  services                     Service[]
  subscription                 Subscription?
  teamInvites                  TeamInvite[]
  users                        User[]

  @@map("salons")
}

model User {
  id                           String                        @id @default(uuid())
  salonId                      String                        @map("salon_id")
  email                        String
  passwordHash                 String?                       @map("password_hash")
  firstName                    String                        @map("first_name")
  lastName                     String                        @map("last_name")
  phone                        String?
  role                         String                        @default("staff")
  avatarUrl                    String?                       @map("avatar_url")
  certifications               String?
  commissionRate               Float?                        @map("commission_rate")
  googleId                     String?                       @map("google_id")
  appleId                      String?                       @map("apple_id")
  magicLinkToken               String?                       @map("magic_link_token")
  magicLinkExpires             DateTime?                     @map("magic_link_expires")
  emailVerified                Boolean                       @default(false) @map("email_verified")
  isActive                     Boolean                       @default(true) @map("is_active")
  lastLogin                    DateTime?                     @map("last_login")
  createdAt                    DateTime                      @default(now()) @map("created_at")
  updatedAt                    DateTime                      @updatedAt @map("updated_at")
  onlineBookingEnabled         Boolean                       @default(true) @map("online_booking_enabled")
  locale                       String?
  appointments                 Appointment[]
  clientNotes                  ClientNote[]
  preferredByClients           Client[]                      @relation("PreferredStaff")
  commissionRecords            CommissionRecord[]
  emailVerificationTokens      EmailVerificationToken[]
  loginHistory                 LoginHistory[]
  ownerNotificationPreferences OwnerNotificationPreferences?
  passwordResetTokens          PasswordResetToken[]
  refreshTokens                RefreshToken[]
  scheduleChangesReviewed      ScheduleChangeRequest[]       @relation("ScheduleChangeReviewer")
  scheduleChangeRequests       ScheduleChangeRequest[]
  staffAvailability            StaffAvailability[]
  staffLocations               StaffLocation[]
  staffServices                StaffService[]
  teamInvitesSent              TeamInvite[]                  @relation("InvitedBy")
  timeOffReviewed              TimeOff[]                     @relation("TimeOffReviewer")
  timeOff                      TimeOff[]
  twoFactorAuth                TwoFactorAuth?
  userSessions                 UserSession[]
  salon                        Salon                         @relation(fields: [salonId], references: [id], onDelete: Cascade)

  @@unique([salonId, email])
  @@index([salonId])
  @@index([email])
  @@index([isActive])
  @@map("users")
}

model Client {
  id                      String                         @id @default(uuid())
  salonId                 String                         @map("salon_id")
  firstName               String                         @map("first_name")
  lastName                String                         @map("last_name")
  email                   String?
  phone                   String?
  address                 String?
  city                    String?
  state                   String?
  zip                     String?
  birthday                DateTime?
  notes                   String?
  preferredStaffId        String?                        @map("preferred_staff_id")
  communicationPreference String                         @default("email") @map("communication_preference")
  optedInReminders        Boolean                        @default(true) @map("opted_in_reminders")
  optedInMarketing        Boolean                        @default(false) @map("opted_in_marketing")
  isActive                Boolean                        @default(true) @map("is_active")
  passwordHash            String?                        @map("password_hash")
  emailVerified           Boolean                        @default(false) @map("email_verified")
  lastLogin               DateTime?                      @map("last_login")
  loyaltyPoints           Int                            @default(0) @map("loyalty_points")
  createdAt               DateTime                       @default(now()) @map("created_at")
  updatedAt               DateTime                       @updatedAt @map("updated_at")
  preferredLocationId     String?                        @map("preferred_location_id")
  country                 String?
  tags                    String[]                       @default([])
  dataConsentAt           DateTime?                      @map("data_consent_at")
  dataConsentGiven        Boolean                        @default(false) @map("data_consent_given")
  appointments            Appointment[]
  emailVerificationTokens ClientEmailVerificationToken[]
  clientNotes             ClientNote[]
  clientPackages          ClientPackage[]
  notificationLogs        NotificationLog[]
  passwordResetTokens     ClientPasswordResetToken[]
  refreshTokens           ClientRefreshToken[]
  preferredLocation       Location?                      @relation("PreferredLocation", fields: [preferredLocationId], references: [id])
  preferredStaff          User?                          @relation("PreferredStaff", fields: [preferredStaffId], references: [id])
  salon                   Salon                          @relation(fields: [salonId], references: [id], onDelete: Cascade)
  formResponses           FormResponse[]
  payments                Payment[]

  @@index([salonId])
  @@index([email])
  @@index([salonId, email])
  @@index([isActive])
  @@map("clients")
}

model ClientNote {
  id        String   @id @default(uuid())
  clientId  String   @map("client_id")
  staffId   String   @map("staff_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  staff     User     @relation(fields: [staffId], references: [id])

  @@index([clientId])
  @@map("client_notes")
}

model ServiceCategory {
  id           String    @id @default(uuid())
  salonId      String    @map("salon_id")
  name         String
  description  String?
  displayOrder Int       @default(0) @map("display_order")
  createdAt    DateTime  @default(now()) @map("created_at")
  salon        Salon     @relation(fields: [salonId], references: [id], onDelete: Cascade)
  services     Service[]

  @@index([salonId])
  @@map("service_categories")
}

model Service {
  id                   String            @id @default(uuid())
  salonId              String            @map("salon_id")
  categoryId           String?           @map("category_id")
  name                 String
  description          String?
  durationMinutes      Int               @default(30) @map("duration_minutes")
  bufferMinutes        Int               @default(0) @map("buffer_minutes")
  price                Float
  memberPrice          Float?            @map("member_price")
  color                String            @default("#C7DCC8")
  isActive             Boolean           @default(true) @map("is_active")
  displayOrder         Int               @default(0) @map("display_order")
  createdAt            DateTime          @default(now()) @map("created_at")
  updatedAt            DateTime          @updatedAt @map("updated_at")
  onlineBookingEnabled Boolean           @default(true) @map("online_booking_enabled")
  appointments         Appointment[]
  packageServices      PackageService[]
  serviceLocations     ServiceLocation[]
  category             ServiceCategory?  @relation(fields: [categoryId], references: [id])
  salon                Salon             @relation(fields: [salonId], references: [id], onDelete: Cascade)
  staffServices        StaffService[]

  @@index([salonId])
  @@index([isActive])
  @@index([salonId, isActive])
  @@map("services")
}

model StaffService {
  id          String  @id @default(uuid())
  staffId     String  @map("staff_id")
  serviceId   String  @map("service_id")
  isAvailable Boolean @default(true) @map("is_available")
  service     Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  staff       User    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([staffId, serviceId])
  @@map("staff_services")
}

model StaffAvailability {
  id          String    @id @default(uuid())
  staffId     String    @map("staff_id")
  dayOfWeek   Int       @map("day_of_week")
  startTime   String    @map("start_time")
  endTime     String    @map("end_time")
  isAvailable Boolean   @default(true) @map("is_available")
  locationId  String?   @map("location_id")
  location    Location? @relation(fields: [locationId], references: [id], onDelete: Cascade)
  staff       User      @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([staffId, locationId, dayOfWeek])
  @@index([staffId])
  @@index([locationId])
  @@map("staff_availability")
}

model TimeOff {
  id          String    @id @default(uuid())
  staffId     String    @map("staff_id")
  startDate   DateTime  @map("start_date")
  endDate     DateTime  @map("end_date")
  reason      String?
  notes       String?
  createdAt   DateTime  @default(now()) @map("created_at")
  reviewNotes String?   @map("review_notes")
  reviewedAt  DateTime? @map("reviewed_at")
  reviewedBy  String?   @map("reviewed_by")
  status      String    @default("pending")
  type        String    @default("vacation")
  reviewer    User?     @relation("TimeOffReviewer", fields: [reviewedBy], references: [id])
  staff       User      @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([startDate])
  @@index([status])
  @@map("time_off")
}

model ScheduleChangeRequest {
  id           String    @id @default(uuid())
  staffId      String    @map("staff_id")
  locationId   String?   @map("location_id")
  dayOfWeek    Int       @map("day_of_week")
  newStartTime String?   @map("new_start_time")
  newEndTime   String?   @map("new_end_time")
  newIsWorking Boolean   @map("new_is_working")
  status       String    @default("pending")
  requestedAt  DateTime  @default(now()) @map("requested_at")
  reviewedAt   DateTime? @map("reviewed_at")
  reviewedBy   String?   @map("reviewed_by")
  reviewNotes  String?   @map("review_notes")
  location     Location? @relation(fields: [locationId], references: [id], onDelete: Cascade)
  reviewer     User?     @relation("ScheduleChangeReviewer", fields: [reviewedBy], references: [id])
  staff        User      @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([status])
  @@map("schedule_change_requests")
}

model Location {
  id                     String                  @id @default(uuid())
  salonId                String                  @map("salon_id")
  name                   String
  address                String?
  city                   String?
  state                  String?
  zip                    String?
  phone                  String?
  timezone               String?
  hours                  String?
  isPrimary              Boolean                 @default(false) @map("is_primary")
  isActive               Boolean                 @default(true) @map("is_active")
  createdAt              DateTime                @default(now()) @map("created_at")
  updatedAt              DateTime                @updatedAt @map("updated_at")
  country                String?
  appointments           Appointment[]
  preferredByClients     Client[]                @relation("PreferredLocation")
  locationHours          LocationHours[]
  salon                  Salon                   @relation(fields: [salonId], references: [id], onDelete: Cascade)
  payments               Payment[]
  scheduleChangeRequests ScheduleChangeRequest[]
  serviceLocations       ServiceLocation[]
  staffAvailability      StaffAvailability[]
  staffLocations         StaffLocation[]

  @@index([salonId])
  @@index([isActive])
  @@map("locations")
}

model LocationHours {
  id         String   @id @default(uuid())
  locationId String   @map("location_id")
  dayOfWeek  Int      @map("day_of_week")
  openTime   String?  @map("open_time")
  closeTime  String?  @map("close_time")
  isClosed   Boolean  @default(false) @map("is_closed")
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, dayOfWeek])
  @@index([locationId])
  @@map("location_hours")
}

model StaffLocation {
  id         String   @id @default(uuid())
  staffId    String   @map("staff_id")
  locationId String   @map("location_id")
  isPrimary  Boolean  @default(false) @map("is_primary")
  createdAt  DateTime @default(now()) @map("created_at")
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  staff      User     @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([staffId, locationId])
  @@map("staff_locations")
}

model ServiceLocation {
  id               String   @id @default(uuid())
  serviceId        String   @map("service_id")
  locationId       String   @map("location_id")
  isEnabled        Boolean  @default(true) @map("is_enabled")
  priceOverride    Decimal? @map("price_override") @db.Decimal(10, 2)
  durationOverride Int?     @map("duration_override")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  location         Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  service          Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([serviceId, locationId])
  @@map("service_locations")
}

model Appointment {
  id                 String             @id @default(uuid())
  salonId            String             @map("salon_id")
  locationId         String?            @map("location_id")
  clientId           String             @map("client_id")
  staffId            String             @map("staff_id")
  serviceId          String             @map("service_id")
  startTime          DateTime           @map("start_time")
  endTime            DateTime           @map("end_time")
  durationMinutes    Int                @map("duration_minutes")
  price              Float
  priceOverride      Float?             @map("price_override")
  depositAmount      Float?             @map("deposit_amount")
  depositStatus      String?            @map("deposit_status")
  stripePaymentIntentId String?         @map("stripe_payment_intent_id")
  status             String             @default("confirmed")
  cancellationReason String?            @map("cancellation_reason")
  notes              String?
  source             String             @default("manual")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  cancelledAt        DateTime?          @map("cancelled_at")
  client             Client             @relation(fields: [clientId], references: [id])
  location           Location?          @relation(fields: [locationId], references: [id])
  salon              Salon              @relation(fields: [salonId], references: [id], onDelete: Cascade)
  service            Service            @relation(fields: [serviceId], references: [id])
  staff              User               @relation(fields: [staffId], references: [id])
  commissionRecords  CommissionRecord[]
  formResponses      FormResponse[]
  notificationLogs   NotificationLog[]
  payments           Payment[]
  reminderLogs       ReminderLog[]

  @@index([salonId])
  @@index([staffId])
  @@index([clientId])
  @@index([startTime])
  @@index([status])
  @@index([salonId, startTime])
  @@index([staffId, startTime])
  @@index([salonId, status])
  @@map("appointments")
}

model Payment {
  id                String             @id @default(uuid())
  salonId           String             @map("salon_id")
  appointmentId     String?            @map("appointment_id")
  clientId          String             @map("client_id")
  amount            Float
  tipAmount         Float              @default(0) @map("tip_amount")
  totalAmount       Float              @map("total_amount")
  method            String?
  status            String             @default("pending")
  stripePaymentId   String?            @unique @map("stripe_payment_id")
  stripeRefundId    String?            @map("stripe_refund_id")
  refundAmount      Float?             @map("refund_amount")
  refundReason      String?            @map("refund_reason")
  createdAt         DateTime           @default(now()) @map("created_at")
  refundedAt        DateTime?          @map("refunded_at")
  locationId        String?            @map("location_id")
  commissionRecords CommissionRecord[]
  appointment       Appointment?       @relation(fields: [appointmentId], references: [id])
  client            Client             @relation(fields: [clientId], references: [id])
  location          Location?          @relation(fields: [locationId], references: [id])
  salon             Salon              @relation(fields: [salonId], references: [id], onDelete: Cascade)

  @@index([salonId])
  @@index([locationId])
  @@index([clientId])
  @@index([status])
  @@index([createdAt])
  @@index([salonId, status])
  @@map("payments")
}

model Package {
  id              String           @id @default(uuid())
  salonId         String           @map("salon_id")
  name            String
  description     String?
  price           Float
  type            String           @default("one_time")
  durationDays    Int?             @map("duration_days")
  renewalPrice    Float?           @map("renewal_price")
  isActive        Boolean          @default(true) @map("is_active")
  createdAt       DateTime         @default(now()) @map("created_at")
  clientPackages  ClientPackage[]
  packageServices PackageService[]
  salon           Salon            @relation(fields: [salonId], references: [id], onDelete: Cascade)

  @@map("packages")
}

model PackageService {
  id        String  @id @default(uuid())
  packageId String  @map("package_id")
  serviceId String  @map("service_id")
  quantity  Int     @default(1)
  package   Package @relation(fields: [packageId], references: [id], onDelete: Cascade)
  service   Service @relation(fields: [serviceId], references: [id])

  @@map("package_services")
}

model ClientPackage {
  id                   String    @id @default(uuid())
  clientId             String    @map("client_id")
  packageId            String    @map("package_id")
  purchaseDate         DateTime  @map("purchase_date")
  expirationDate       DateTime? @map("expiration_date")
  servicesRemaining    Int       @map("services_remaining")
  totalServices        Int       @map("total_services")
  autoRenew            Boolean   @default(false) @map("auto_renew")
  stripeSubscriptionId String?   @map("stripe_subscription_id")
  isActive             Boolean   @default(true) @map("is_active")
  createdAt            DateTime  @default(now()) @map("created_at")
  client               Client    @relation(fields: [clientId], references: [id])
  package              Package   @relation(fields: [packageId], references: [id])

  @@map("client_packages")
}

model GiftCard {
  id             String    @id @default(uuid())
  salonId        String    @map("salon_id")
  code           String    @unique
  initialAmount  Float     @map("initial_amount")
  balance        Float
  status         String    @default("active")
  expiresAt      DateTime? @map("expires_at")
  purchasedAt    DateTime  @default(now()) @map("purchased_at")
  redeemedAt     DateTime? @map("redeemed_at")
  purchaserEmail String?   @map("purchaser_email")
  recipientEmail String?   @map("recipient_email")
  recipientName  String?   @map("recipient_name")
  message        String?
  salon          Salon     @relation(fields: [salonId], references: [id], onDelete: Cascade)

  @@index([salonId])
  @@index([status])
  @@map("gift_cards")
}

model MarketingCampaign {
  id              String    @id @default(uuid())
  salonId         String    @map("salon_id")
  name            String
  type            String
  subjectLine     String?   @map("subject_line")
  message         String
  audienceFilter  String?   @map("audience_filter")
  status          String    @default("draft")
  scheduledFor    DateTime? @map("scheduled_for")
  sentAt          DateTime? @map("sent_at")
  recipientsCount Int?      @map("recipients_count")
  openedCount     Int       @default(0) @map("opened_count")
  clickedCount    Int       @default(0) @map("clicked_count")
  createdAt       DateTime  @default(now()) @map("created_at")
  salon           Salon     @relation(fields: [salonId], references: [id], onDelete: Cascade)

  @@index([salonId])
  @@index([status])
  @@map("marketing_campaigns")
}

model ConsultationForm {
  id          String         @id @default(uuid())
  salonId     String         @map("salon_id")
  name        String
  description String?
  fields      String
  isActive    Boolean        @default(true) @map("is_active")
  createdAt   DateTime       @default(now()) @map("created_at")
  salon       Salon          @relation(fields: [salonId], references: [id], onDelete: Cascade)
  responses   FormResponse[]

  @@map("consultation_forms")
}

model FormResponse {
  id            String           @id @default(uuid())
  formId        String           @map("form_id")
  clientId      String           @map("client_id")
  appointmentId String?          @map("appointment_id")
  responseData  String           @map("response_data")
  signatureUrl  String?          @map("signature_url")
  submittedAt   DateTime         @default(now()) @map("submitted_at")
  appointment   Appointment?     @relation(fields: [appointmentId], references: [id])
  client        Client           @relation(fields: [clientId], references: [id])
  form          ConsultationForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@map("form_responses")
}

model CommissionRecord {
  id               String      @id @default(uuid())
  salonId          String      @map("salon_id")
  staffId          String      @map("staff_id")
  appointmentId    String      @map("appointment_id")
  paymentId        String      @map("payment_id")
  serviceAmount    Float       @map("service_amount")
  tipAmount        Float       @default(0) @map("tip_amount")
  commissionRate   Float       @map("commission_rate")
  commissionAmount Float       @map("commission_amount")
  periodStart      DateTime?   @map("period_start")
  periodEnd        DateTime?   @map("period_end")
  isPaid           Boolean     @default(false) @map("is_paid")
  paidAt           DateTime?   @map("paid_at")
  createdAt        DateTime    @default(now()) @map("created_at")
  appointment      Appointment @relation(fields: [appointmentId], references: [id])
  payment          Payment     @relation(fields: [paymentId], references: [id])
  salon            Salon       @relation(fields: [salonId], references: [id], onDelete: Cascade)
  staff            User        @relation(fields: [staffId], references: [id])

  @@index([salonId])
  @@index([staffId])
  @@index([isPaid])
  @@index([createdAt])
  @@map("commission_records")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tokenHash String   @map("token_hash")
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([userId])
  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("email_verification_tokens")
}

model ReminderLog {
  id            String      @id @default(uuid())
  appointmentId String      @map("appointment_id")
  reminderType  String      @map("reminder_type")
  channel       String
  success       Boolean     @default(true)
  error         String?
  sentAt        DateTime    @default(now()) @map("sent_at")
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@unique([appointmentId, reminderType])
  @@index([appointmentId])
  @@index([sentAt])
  @@map("reminder_logs")
}

model NotificationLog {
  id                  String      @id @default(uuid())
  salonId             String      @map("salon_id")
  appointmentId       String?     @map("appointment_id")
  clientId            String      @map("client_id")
  type                String
  channels            String      @default("[]")
  status              String      @default("pending")
  emailStatus         String?     @map("email_status")
  emailSentAt         DateTime?   @map("email_sent_at")
  emailDeliveredAt    DateTime?   @map("email_delivered_at")
  emailError          String?     @map("email_error")
  sendgridMessageId   String?     @unique @map("sendgrid_message_id")
  smsStatus           String?     @map("sms_status")
  smsSentAt           DateTime?   @map("sms_sent_at")
  smsDeliveredAt      DateTime?   @map("sms_delivered_at")
  smsError            String?     @map("sms_error")
  smsErrorCode        String?     @map("sms_error_code")
  twilioMessageSid    String?     @unique @map("twilio_message_sid")
  retryCount          Int         @default(0) @map("retry_count")
  retryAt             DateTime?   @map("retry_at")
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")
  salon               Salon       @relation(fields: [salonId], references: [id], onDelete: Cascade)
  appointment         Appointment? @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  client              Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([salonId])
  @@index([clientId])
  @@index([appointmentId])
  @@index([status])
  @@index([retryAt])
  @@index([createdAt])
  @@map("notification_logs")
}

model Subscription {
  id                   String              @id @default(uuid())
  salonId              String              @unique @map("salon_id")
  stripeSubscriptionId String?             @unique @map("stripe_subscription_id")
  stripeCustomerId     String?             @map("stripe_customer_id")
  plan                 String              @default("free")
  status               String              @default("active")
  currentPeriodStart   DateTime?           @map("current_period_start")
  currentPeriodEnd     DateTime?           @map("current_period_end")
  cancelAtPeriodEnd    Boolean             @default(false) @map("cancel_at_period_end")
  canceledAt           DateTime?           @map("canceled_at")
  trialEndsAt          DateTime?           @map("trial_ends_at")
  graceEndsAt          DateTime?           @map("grace_ends_at")
  createdAt            DateTime            @default(now()) @map("created_at")
  updatedAt            DateTime            @updatedAt @map("updated_at")
  additionalLocations  Int                 @default(0) @map("additional_locations")
  salon                Salon               @relation(fields: [salonId], references: [id], onDelete: Cascade)
  addons               SubscriptionAddon[]

  @@index([stripeSubscriptionId])
  @@index([status])
  @@map("subscriptions")
}

model SubscriptionAddon {
  id                       String       @id @default(uuid())
  subscriptionId           String       @map("subscription_id")
  addonId                  String       @map("addon_id")
  stripeSubscriptionItemId String?      @map("stripe_subscription_item_id")
  status                   String       @default("active")
  enabledAt                DateTime     @default(now()) @map("enabled_at")
  canceledAt               DateTime?    @map("canceled_at")
  subscription             Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@unique([subscriptionId, addonId])
  @@index([subscriptionId])
  @@index([addonId])
  @@map("subscription_addons")
}

model BillingHistory {
  id               String    @id @default(uuid())
  salonId          String    @map("salon_id")
  stripeInvoiceId  String?   @unique @map("stripe_invoice_id")
  amount           Float
  currency         String    @default("usd")
  status           String
  description      String?
  invoicePdfUrl    String?   @map("invoice_pdf_url")
  hostedInvoiceUrl String?   @map("hosted_invoice_url")
  periodStart      DateTime  @map("period_start")
  periodEnd        DateTime  @map("period_end")
  paidAt           DateTime? @map("paid_at")
  createdAt        DateTime  @default(now()) @map("created_at")

  @@index([salonId])
  @@index([createdAt])
  @@map("billing_history")
}

model DemoRequest {
  id            String   @id @default(uuid())
  firstName     String   @map("first_name")
  lastName      String   @map("last_name")
  email         String
  phone         String
  businessName  String   @map("business_name")
  businessSize  String   @map("business_size")
  preferredDate String   @map("preferred_date")
  preferredTime String   @map("preferred_time")
  message       String?
  status        String   @default("pending")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@map("demo_requests")
}

model ClientRefreshToken {
  id        String   @id @default(uuid())
  clientId  String   @map("client_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([expiresAt])
  @@map("client_refresh_tokens")
}

model ClientPasswordResetToken {
  id        String   @id @default(uuid())
  clientId  String   @map("client_id")
  tokenHash String   @map("token_hash")
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([tokenHash])
  @@map("client_password_reset_tokens")
}

model ClientEmailVerificationToken {
  id        String   @id @default(uuid())
  clientId  String   @map("client_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@map("client_email_verification_tokens")
}

model GdprDeletionRequest {
  id                String    @id @default(uuid())
  clientId          String    @map("client_id")
  salonId           String    @map("salon_id")
  status            String    @default("pending")
  reason            String?
  requestedAt       DateTime  @default(now()) @map("requested_at")
  scheduledDeletion DateTime  @map("scheduled_deletion")
  cancelledAt       DateTime? @map("cancelled_at")
  completedAt       DateTime? @map("completed_at")
  deletionLog       String?   @map("deletion_log")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@unique([clientId, status])
  @@index([clientId])
  @@index([salonId])
  @@index([status])
  @@index([scheduledDeletion])
  @@map("gdpr_deletion_requests")
}

model GdprDeletionLog {
  id           String   @id @default(uuid())
  salonId      String   @map("salon_id")
  clientEmail  String   @map("client_email")
  requestId    String   @map("request_id")
  deletionType String   @map("deletion_type")
  itemsDeleted String   @map("items_deleted")
  performedAt  DateTime @default(now()) @map("performed_at")
  performedBy  String?  @map("performed_by")

  @@index([salonId])
  @@index([performedAt])
  @@map("gdpr_deletion_logs")
}

model LoginHistory {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  location   String?
  success    Boolean  @default(true)
  failReason String?  @map("fail_reason")
  createdAt  DateTime @default(now()) @map("created_at")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("login_history")
}

model UserSession {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  tokenHash  String   @map("token_hash")
  deviceInfo String?  @map("device_info")
  ipAddress  String?  @map("ip_address")
  location   String?
  lastActive DateTime @default(now()) @map("last_active")
  expiresAt  DateTime @map("expires_at")
  isRevoked  Boolean  @default(false) @map("is_revoked")
  createdAt  DateTime @default(now()) @map("created_at")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("user_sessions")
}

model OwnerNotificationPreferences {
  id                   String   @id @default(uuid())
  userId               String   @unique @map("user_id")
  newBookingEmail      Boolean  @default(true) @map("new_booking_email")
  cancellationEmail    Boolean  @default(true) @map("cancellation_email")
  dailySummaryEmail    Boolean  @default(false) @map("daily_summary_email")
  weeklySummaryEmail   Boolean  @default(true) @map("weekly_summary_email")
  newReviewEmail       Boolean  @default(true) @map("new_review_email")
  paymentReceivedEmail Boolean  @default(true) @map("payment_received_email")
  notificationEmail    String?  @map("notification_email")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("owner_notification_preferences")
}

model TeamInvite {
  id         String    @id @default(uuid())
  salonId    String    @map("salon_id")
  email      String
  role       String    @default("staff")
  invitedBy  String    @map("invited_by")
  token      String    @unique
  expiresAt  DateTime  @map("expires_at")
  acceptedAt DateTime? @map("accepted_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  inviter    User      @relation("InvitedBy", fields: [invitedBy], references: [id])
  salon      Salon     @relation(fields: [salonId], references: [id], onDelete: Cascade)

  @@index([salonId])
  @@index([token])
  @@map("team_invites")
}

model TwoFactorAuth {
  id          String    @id @default(uuid())
  userId      String    @unique @map("user_id")
  secret      String
  isEnabled   Boolean   @default(false) @map("is_enabled")
  backupCodes String?   @map("backup_codes")
  enabledAt   DateTime? @map("enabled_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("two_factor_auth")
}

model AccountDeletionRequest {
  id                String    @id @default(uuid())
  userId            String    @map("user_id")
  salonId           String    @map("salon_id")
  status            String    @default("pending")
  reason            String?
  requestedAt       DateTime  @default(now()) @map("requested_at")
  scheduledDeletion DateTime  @map("scheduled_deletion")
  cancelledAt       DateTime? @map("cancelled_at")
  completedAt       DateTime? @map("completed_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@index([userId])
  @@index([salonId])
  @@index([status])
  @@map("account_deletion_requests")
}

model WebhookEvent {
  id            String   @id @default(uuid())
  stripeEventId String   @unique @map("stripe_event_id")
  eventType     String   @map("event_type")
  processedAt   DateTime @default(now()) @map("processed_at")

  @@index([stripeEventId])
  @@map("webhook_events")
}

model FileUpload {
  id         String   @id @default(uuid())
  publicId   String   @unique @map("public_id")
  url        String
  salonId    String   @map("salon_id")
  userId     String   @map("user_id")
  fileType   String   @map("file_type")
  bytes      Int?
  width      Int?
  height     Int?
  format     String?
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  @@index([salonId])
  @@index([publicId])
  @@map("file_uploads")
}

model NotificationJob {
  id            String    @id @default(uuid())
  salonId       String    @map("salon_id")
  clientId      String?   @map("client_id")  // Optional for staff notifications (time_off_approved, time_off_rejected)
  staffId       String?   @map("staff_id")   // For staff-targeted notifications
  appointmentId String?   @map("appointment_id")
  type          String    // 'booking_confirmation', 'reminder_24h', 'reminder_2h', 'cancellation', 'time_off_approved', 'time_off_rejected'
  payload       String    // JSON stringified notification data
  status        String    @default("pending") // 'pending', 'processing', 'completed', 'failed'
  attempts      Int       @default(0)
  maxAttempts   Int       @default(3) @map("max_attempts")
  error         String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  processedAt   DateTime? @map("processed_at")

  @@index([status, createdAt])
  @@index([status, attempts])
  @@map("notification_jobs")
}
