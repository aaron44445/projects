---
phase: 20-staff-portal-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routes/staffPortal.ts
  - apps/web/src/app/staff/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard API returns staffCanViewClientContact boolean"
    - "Dashboard appointments filter to staff's assigned locations"
    - "Client phone only displays when staffCanViewClientContact is true"
  artifacts:
    - path: "apps/api/src/routes/staffPortal.ts"
      provides: "Location-filtered dashboard with visibility setting"
      contains: "staffCanViewClientContact"
  key_links:
    - from: "apps/api/src/routes/staffPortal.ts"
      to: "prisma.staffLocation.findMany"
      via: "location filtering"
      pattern: "locationId.*in.*staffLocationIds"
---

<objective>
Add location-aware filtering and client visibility controls to dashboard API

Purpose: Staff should only see appointments at their assigned locations, and client contact info should respect salon's staffCanViewClientContact setting (SCHED-03 requirement).

Output: Enhanced dashboard API that filters by staff locations and includes visibility flag, plus frontend that conditionally shows client phone.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-staff-portal-core/20-CONTEXT.md
@.planning/phases/20-staff-portal-core/20-RESEARCH.md
@apps/api/src/routes/staffPortal.ts
@apps/web/src/app/staff/dashboard/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add location filtering and visibility setting to dashboard API</name>
  <files>apps/api/src/routes/staffPortal.ts</files>
  <action>
    Modify the GET /staff-portal/dashboard route (around line 680):

    1. After getting staffId and salonId, fetch staff's assigned locations:
    ```typescript
    // Get staff's assigned locations
    const staffLocations = await prisma.staffLocation.findMany({
      where: { staffId },
      select: { locationId: true }
    });
    const staffLocationIds = staffLocations.map(sl => sl.locationId);
    ```

    2. Fetch salon's staffCanViewClientContact setting:
    ```typescript
    const salon = await prisma.salon.findUnique({
      where: { id: salonId },
      select: { staffCanViewClientContact: true }
    });
    ```

    3. Modify the todayAppointments query to filter by locationId (only if staff has location assignments):
    ```typescript
    const todayAppointments = await prisma.appointment.findMany({
      where: {
        staffId,
        salonId,
        startTime: { gte: today, lt: tomorrow },
        status: { notIn: ['cancelled'] },
        // Only filter by location if staff has assignments
        ...(staffLocationIds.length > 0 && { locationId: { in: staffLocationIds } }),
      },
      include: {
        client: { select: { id: true, firstName: true, lastName: true, phone: true } },
        service: { select: { id: true, name: true, durationMinutes: true, color: true, price: true } },
        location: { select: { id: true, name: true } },  // Add location for multi-location badge
      },
      orderBy: { startTime: 'asc' },
    });
    ```

    4. Apply the same location filter to upcomingAppointments query.

    5. Add staffCanViewClientContact and hasMultipleLocations to the response:
    ```typescript
    res.json({
      success: true,
      data: {
        todayAppointments,
        upcomingAppointments,
        earnings,
        timeOffRequests,
        availability,
        stats: { ... },
        staffCanViewClientContact: salon?.staffCanViewClientContact ?? true,
        hasMultipleLocations: staffLocationIds.length > 1,
      },
    });
    ```
  </action>
  <verify>
    Run: `cd C:\projects\spa-final && npm run build -w apps/api`
    Should complete without TypeScript errors.
  </verify>
  <done>Dashboard API returns staffCanViewClientContact and hasMultipleLocations flags, appointments filtered by staff's assigned locations</done>
</task>

<task type="auto">
  <name>Task 2: Update frontend to respect client visibility and show location badges</name>
  <files>apps/web/src/app/staff/dashboard/page.tsx</files>
  <action>
    Update the dashboard page component:

    1. Update the DashboardData interface to include new fields:
    ```typescript
    interface DashboardData {
      todayAppointments: {
        id: string;
        clientName: string;
        serviceName: string;
        startTime: string;
        endTime: string;
        status: string;
        price: number;
        location?: { id: string; name: string };
        client?: { phone?: string };
      }[];
      // ... existing fields ...
      staffCanViewClientContact: boolean;
      hasMultipleLocations: boolean;
    }
    ```

    2. In the appointment card rendering (around line 267-298), add conditional phone display and location badge:
    ```tsx
    <div
      key={appointment.id}
      className="p-4 hover:bg-charcoal/5 transition-colors"
    >
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <div className="w-12 h-12 rounded-xl bg-sage/10 flex items-center justify-center">
            <Clock className="w-5 h-5 text-sage" />
          </div>
          <div>
            <p className="font-medium text-charcoal">
              {appointment.clientName}
            </p>
            {/* Show phone if allowed */}
            {dashboardData.staffCanViewClientContact && appointment.client?.phone && (
              <p className="text-xs text-charcoal/50">{appointment.client.phone}</p>
            )}
            <p className="text-sm text-charcoal/60">
              {appointment.serviceName}
            </p>
            {/* Location badge for multi-location staff */}
            {dashboardData.hasMultipleLocations && appointment.location && (
              <span className="inline-flex items-center gap-1 mt-1 px-2 py-0.5 bg-lavender/20 text-lavender-dark rounded-full text-xs">
                <MapPin className="w-3 h-3" />
                {appointment.location.name}
              </span>
            )}
          </div>
        </div>
        {/* ... time and status ... */}
      </div>
    </div>
    ```

    3. Import MapPin from lucide-react at the top of the file.
  </action>
  <verify>
    Run: `cd C:\projects\spa-final && npm run build -w apps/web`
    Should complete without TypeScript errors.
  </verify>
  <done>Dashboard conditionally shows client phone based on staffCanViewClientContact, displays location badges for multi-location staff</done>
</task>

</tasks>

<verification>
1. API build passes: `npm run build -w apps/api`
2. Web build passes: `npm run build -w apps/web`
3. Manual test: Dashboard API response includes staffCanViewClientContact and hasMultipleLocations
4. Manual test: When staffCanViewClientContact is false, phone numbers are hidden
</verification>

<success_criteria>
- Dashboard API includes staffCanViewClientContact boolean in response
- Appointments are filtered to staff's assigned locations
- Client phone only displays when visibility setting allows
- Multi-location staff see location badges on appointment cards
</success_criteria>

<output>
After completion, create `.planning/phases/20-staff-portal-core/20-01-SUMMARY.md`
</output>
