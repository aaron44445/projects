---
phase: 20-staff-portal-core
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routes/staffPortal.ts
  - apps/web/src/app/staff/profile/page.tsx
autonomous: true

must_haves:
  truths:
    - "Profile API returns assigned locations array"
    - "Profile page displays assigned locations with badges"
    - "Primary location is visually distinguished"
    - "Avatar upload functionality works (existing implementation verified)"
    - "Phone edit functionality works (existing implementation verified)"
  artifacts:
    - path: "apps/web/src/app/staff/profile/page.tsx"
      provides: "Location display in profile"
      contains: "assignedLocations"
  key_links:
    - from: "apps/api/src/routes/staffPortal.ts"
      to: "prisma.staffLocation"
      via: "profile endpoint"
      pattern: "assignedLocations"
---

<objective>
Add assigned locations display to staff profile page

Purpose: Staff can view their assigned locations alongside assigned services (PROF-01 requirement), and verify existing avatar upload and phone edit functionality (PROF-02 requirement).

Output: Profile API returns assigned locations, profile page displays them with primary location indicated, existing profile editing verified working.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-staff-portal-core/20-CONTEXT.md
@.planning/phases/20-staff-portal-core/20-RESEARCH.md
@apps/api/src/routes/staffPortal.ts
@apps/web/src/app/staff/profile/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add assigned locations to profile API response</name>
  <files>apps/api/src/routes/staffPortal.ts</files>
  <action>
    Find the GET /staff-portal/profile endpoint and add assigned locations to the response.

    1. First locate the profile GET endpoint (search for "GET /api/v1/staff-portal/profile" or router.get('/profile')).

    2. After fetching the user data, also fetch their assigned locations:
    ```typescript
    // Get staff's assigned locations
    const staffLocations = await prisma.staffLocation.findMany({
      where: { staffId: req.user.userId },
      include: {
        location: {
          select: { id: true, name: true, address: true }
        }
      },
      orderBy: { isPrimary: 'desc' }  // Primary location first
    });

    const assignedLocations = staffLocations.map(sl => ({
      id: sl.location.id,
      name: sl.location.name,
      address: sl.location.address,
      isPrimary: sl.isPrimary
    }));
    ```

    3. Include assignedLocations in the response data object alongside existing fields like assignedServices.
  </action>
  <verify>
    Run: `cd C:\projects\spa-final && npm run build -w apps/api`
    Should complete without TypeScript errors.
  </verify>
  <done>Profile API returns assignedLocations array with id, name, address, and isPrimary flag</done>
</task>

<task type="auto">
  <name>Task 2: Display assigned locations in profile page</name>
  <files>apps/web/src/app/staff/profile/page.tsx</files>
  <action>
    Update the profile page to display assigned locations:

    1. Add assignedLocations to the StaffProfile interface:
    ```typescript
    interface StaffProfile {
      // ... existing fields ...
      assignedLocations: {
        id: string;
        name: string;
        address?: string;
        isPrimary: boolean;
      }[];
    }
    ```

    2. Import MapPin icon from lucide-react (add to existing imports).

    3. After the "Assigned Services" section (around line 450), add an "Assigned Locations" section:
    ```tsx
    {/* Assigned Locations (Read-only) */}
    <div className="bg-white rounded-2xl shadow-soft border border-charcoal/5 overflow-hidden">
      <div className="p-5 border-b border-charcoal/10">
        <h3 className="text-lg font-semibold text-charcoal">
          <MapPin className="w-5 h-5 inline mr-2" />
          Assigned Locations
        </h3>
        <p className="text-sm text-charcoal/60">
          Locations where you are scheduled to work
        </p>
      </div>

      <div className="p-6">
        {profile.assignedLocations.length === 0 ? (
          <p className="text-charcoal/60 text-center py-4">
            No locations assigned yet. Contact your manager.
          </p>
        ) : (
          <div className="flex flex-wrap gap-2">
            {profile.assignedLocations.map((location) => (
              <div
                key={location.id}
                className={`px-4 py-2 rounded-xl ${
                  location.isPrimary
                    ? 'bg-sage/20 border border-sage/30'
                    : 'bg-charcoal/5'
                }`}
              >
                <div className="flex items-center gap-2">
                  <p className="font-medium text-charcoal">{location.name}</p>
                  {location.isPrimary && (
                    <span className="px-2 py-0.5 bg-sage/30 text-sage-dark rounded text-xs font-medium">
                      Primary
                    </span>
                  )}
                </div>
                {location.address && (
                  <p className="text-xs text-charcoal/60">{location.address}</p>
                )}
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
    ```

    4. Ensure the section is placed after the Assigned Services section for consistent layout.
  </action>
  <verify>
    Run: `cd C:\projects\spa-final && npm run build -w apps/web`
    Should complete without TypeScript errors.
  </verify>
  <done>Profile page displays assigned locations with primary location highlighted</done>
</task>

<task type="auto">
  <name>Task 3: Verify existing avatar upload and phone edit functionality (PROF-02)</name>
  <files>apps/web/src/app/staff/profile/page.tsx</files>
  <action>
    Verify the existing profile editing functionality satisfies PROF-02 requirements.

    Research confirmed these features already exist (profile page lines 125-176 for avatar, phone field throughout):

    1. **Avatar Upload** - Verify these elements exist in the profile page:
       - File input for avatar selection with accept="image/*"
       - Client-side validation: file.type.startsWith('image/') check
       - Client-side validation: file.size check (5MB limit)
       - POST request to /staff-portal/profile/avatar endpoint
       - Avatar preview updates after successful upload
       - Success toast/message on completion

    2. **Phone Edit** - Verify these elements exist:
       - Phone input field in the profile form
       - Phone validation (format check)
       - Phone field included in PATCH /staff-portal/profile request
       - Save button triggers profile update

    3. If any of these are missing, add them. If all exist, document in SUMMARY that PROF-02 is satisfied by existing implementation.

    **Expected code patterns to verify exist:**
    ```typescript
    // Avatar upload handler (should exist around line 125-176)
    const handleAvatarChange = async (e: React.ChangeEvent<HTMLInputElement>) => { ... }

    // Phone field in form (should exist in profile form)
    <input type="tel" value={profile.phone} onChange={...} />
    ```
  </action>
  <verify>
    Run: `cd C:\projects\spa-final && grep -n "handleAvatarChange\|profile/avatar\|type.*tel" apps/web/src/app/staff/profile/page.tsx`
    Should show matches for avatar upload handler and phone input field.
  </verify>
  <done>PROF-02 (avatar and phone editing) verified - existing implementation confirmed working, or gaps filled if any found</done>
</task>

</tasks>

<verification>
1. API build passes: `npm run build -w apps/api`
2. Web build passes: `npm run build -w apps/web`
3. Profile page shows both assigned services AND assigned locations sections
4. Primary location has visual distinction (sage background + "Primary" badge)
5. Avatar upload functionality exists and handles file validation
6. Phone edit functionality exists with proper form handling
</verification>

<success_criteria>
- Profile API includes assignedLocations array in response
- Each location shows name and address
- Primary location is visually distinguished with badge
- Empty state shown when no locations assigned
- Avatar upload functionality verified working (PROF-02)
- Phone edit functionality verified working (PROF-02)
</success_criteria>

<output>
After completion, create `.planning/phases/20-staff-portal-core/20-02-SUMMARY.md`
</output>
