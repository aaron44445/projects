---
phase: 07-dashboard-validation
plan: 04
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - apps/web/src/app/dashboard/page.tsx
  - apps/web/src/hooks/useDashboard.ts
autonomous: true

must_haves:
  truths:
    - "Appointment times display in salon's configured timezone"
    - "Relative times (e.g., '2 hours ago') calculated correctly regardless of viewer timezone"
    - "Time format is 12-hour with AM/PM (e.g., '2:30 PM')"
  artifacts:
    - path: "apps/web/src/app/dashboard/page.tsx"
      provides: "Timezone-aware time formatting"
      contains: "toLocaleTimeString"
  key_links:
    - from: "apps/web/src/app/dashboard/page.tsx"
      to: "salon.timezone"
      via: "time formatting with timezone option"
      pattern: "timeZone"
---

<objective>
Display appointment times in the salon's configured timezone on the dashboard.

Purpose: Currently times display in the browser's local timezone. A salon in PST viewing from an EST browser sees wrong appointment times. Times should always show in the salon's timezone.

Output: Dashboard displays all appointment times in the salon's configured timezone.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-dashboard-validation/07-CONTEXT.md
@.planning/phases/07-dashboard-validation/07-RESEARCH.md
@.planning/phases/07-dashboard-validation/07-01-SUMMARY.md
@apps/web/src/app/dashboard/page.tsx
@apps/web/src/contexts/AuthContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add timezone to dashboard API responses</name>
  <files>apps/api/src/routes/dashboard.ts</files>
  <action>
Update the dashboard API to include the salon's timezone in responses so the frontend can format times correctly:

1. In the `/stats` endpoint, add timezone to the response:

The salon is already being fetched for timezone. Add it to the response:

```typescript
// At the end of /stats handler, update the response to include timezone:
res.json({
  success: true,
  data: {
    revenue: {
      current: currentRevenue,
      previous: lastRevenue,
      change: revenueChange,
    },
    appointments: {
      current: thisMonthAppointments,
      previous: lastMonthAppointments,
      change: appointmentChange,
    },
    newClients: {
      current: thisMonthClients,
      previous: lastMonthClients,
      change: clientChange,
    },
    totalClients,
    rating: {
      average: avgRating._avg.rating ? Math.round(avgRating._avg.rating * 10) / 10 : null,
      count: avgRating._count.rating,
    },
    timezone: salonTz,  // Add this line
  },
});
```

2. In the `/today` endpoint, also add timezone:

```typescript
res.json({
  success: true,
  data: {
    appointments,
    summary,
    timezone: salonTz,  // Add this line
  },
});
```

3. In the `/recent-activity` endpoint, add timezone as well:

First fetch the salon timezone (it's not currently fetched in this endpoint):

```typescript
router.get('/recent-activity', authenticate, asyncHandler(async (req: Request, res: Response) => {
  const salonId = req.user!.salonId;
  const { locationId } = req.query;
  const locationFilter = locationId ? { locationId: locationId as string } : {};

  // Get salon timezone
  const salon = await prisma.salon.findUnique({
    where: { id: salonId },
    select: { timezone: true },
  });
  const salonTz = salon?.timezone || 'UTC';

  // ... rest of the query unchanged ...

  res.json({
    success: true,
    data: recentAppointments,
    timezone: salonTz,  // Add at response level
  });
}));
```
  </action>
  <verify>Run `cd apps/api && pnpm build` to verify TypeScript compilation.</verify>
  <done>Dashboard API endpoints include salon timezone in responses.</done>
</task>

<task type="auto">
  <name>Task 2: Update frontend to use timezone for time display</name>
  <files>apps/web/src/hooks/useDashboard.ts</files>
  <action>
Update useDashboard to extract and expose the salon timezone:

1. Update the fetchStats function to return timezone:

```typescript
async function fetchStats(locationId?: string | null) {
  const locationParam = locationId ? `?locationId=${locationId}` : '';
  const response = await api.get<ApiStatsResponse & { timezone?: string }>(`/dashboard/stats${locationParam}`);
  const apiData = response.data;

  return {
    todayAppointments: 0,
    todayRevenue: 0,
    monthRevenue: apiData?.revenue?.current ?? 0,
    revenueChange: `${apiData?.revenue?.change ?? 0}%`,
    newClients: apiData?.newClients?.current ?? 0,
    clientsChange: apiData?.newClients?.change ?? 0,
    timezone: apiData?.timezone ?? 'UTC',  // Extract timezone
  };
}
```

2. Update DashboardStats interface:

```typescript
interface DashboardStats {
  todayAppointments: number;
  todayRevenue: number;
  monthRevenue: number;
  revenueChange: string;
  newClients: number;
  clientsChange: number;
  timezone: string;  // Add this
}
```

3. Update the combined stats in useDashboard:

```typescript
const stats: DashboardStats | null = statsQuery.data
  ? {
      ...statsQuery.data,
      todayAppointments: appointmentsQuery.data?.length ?? 0,
    }
  : null;
```

4. Also expose timezone separately for convenience:

```typescript
return {
  // ... existing returns ...
  timezone: statsQuery.data?.timezone ?? 'UTC',
};
```
  </action>
  <verify>Run `cd apps/web && pnpm build` to verify TypeScript compilation.</verify>
  <done>useDashboard hook exposes salon timezone from API response.</done>
</task>

<task type="auto">
  <name>Task 3: Update dashboard page time formatting</name>
  <files>apps/web/src/app/dashboard/page.tsx</files>
  <action>
Update the dashboard page to format times using the salon's timezone:

1. Destructure timezone from useDashboard:

```typescript
const {
  stats,
  statsLoading,
  statsError,
  refetchStats,
  todayAppointments,
  appointmentsLoading,
  appointmentsError,
  refetchAppointments,
  recentActivity,
  activityLoading,
  activityError,
  refetchActivity,
  loading,
  refetch,
  timezone,  // Add this
} = useDashboard(selectedLocationId);
```

2. Update the formatTime function to use salon timezone:

Replace the existing formatTime function:

```typescript
// Format time from ISO string in salon's timezone
const formatTime = (isoString: string) => {
  const date = new Date(isoString);
  return date.toLocaleTimeString('en-US', {
    hour: 'numeric',
    minute: '2-digit',
    hour12: true,
    timeZone: timezone,  // Use salon timezone
  });
};
```

3. The calculateDuration function doesn't need timezone changes (duration is timezone-agnostic).

4. Optionally, add a timezone indicator somewhere visible (e.g., near the schedule header):

In the "Today's Schedule" section header, you could add:
```tsx
<div className="p-6 border-b border-border dark:border-white/10 flex items-center justify-between">
  <div className="flex items-center gap-2">
    <h2 className="text-lg font-semibold text-charcoal dark:text-white">Today&apos;s Schedule</h2>
    {timezone && timezone !== 'UTC' && (
      <span className="text-xs text-charcoal/40 dark:text-white/40">
        ({timezone.replace('_', ' ')})
      </span>
    )}
  </div>
  <Link
    href="/calendar"
    className="text-sm text-sage hover:text-sage-dark font-medium flex items-center gap-1"
  >
    View Calendar <ChevronRight className="w-4 h-4" />
  </Link>
</div>
```

This shows something like "Today's Schedule (America/Los_Angeles)" to clarify the timezone context.
  </action>
  <verify>Run `cd apps/web && pnpm build` to verify TypeScript compilation.</verify>
  <done>Dashboard displays appointment times in salon's configured timezone with optional timezone indicator.</done>
</task>

</tasks>

<verification>
1. Build both apps: `cd apps/api && pnpm build && cd ../web && pnpm build`
2. Start dev servers
3. Manual verification:
   - Set a salon's timezone to something different from your local timezone (e.g., America/Los_Angeles if you're in EST)
   - Create an appointment
   - View dashboard
   - Verify appointment time displays in salon timezone (not browser timezone)
   - Check that timezone indicator appears (if implemented)
4. Edge case: Verify times near midnight don't show wrong date due to timezone conversion
</verification>

<success_criteria>
- TypeScript compiles without errors
- Dashboard API responses include timezone field
- Appointment times display in salon's configured timezone
- Time format is 12-hour with AM/PM (e.g., "2:30 PM")
- Optional timezone indicator shows which timezone is being used
</success_criteria>

<output>
After completion, create `.planning/phases/07-dashboard-validation/07-04-SUMMARY.md`
</output>
