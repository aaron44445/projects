---
phase: 06-settings-persistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/app/settings/page.tsx
  - apps/web/src/hooks/useLocationHours.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Owner can change business hours and see them persist after page refresh"
    - "Business hours save button shows loading state during save"
    - "Hours changes save to database via API"
  artifacts:
    - path: "apps/web/src/hooks/useLocationHours.ts"
      provides: "Location hours fetch and update hook"
      exports: ["useLocationHours"]
    - path: "apps/web/src/app/settings/page.tsx"
      provides: "Business hours section wired to API"
      contains: "useLocationHours"
  key_links:
    - from: "apps/web/src/app/settings/page.tsx"
      to: "/api/v1/locations/:id/hours"
      via: "useLocationHours hook"
      pattern: "useLocationHours"
---

<objective>
Wire business hours settings UI to the existing locations hours API

Purpose: Fix SET-01 (settings changes apply immediately) for business hours. Currently the business hours section uses local state with hardcoded defaults and never persists to the database.

Output: Business hours settings that persist across page refreshes, using the existing GET/PUT /locations/:id/hours API endpoints.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-settings-persistence/06-CONTEXT.md
@.planning/phases/06-settings-persistence/06-RESEARCH.md

Key context:
- API endpoints exist: GET/PUT /locations/:id/hours (apps/api/src/routes/locations.ts lines 540-640)
- LocationHours table stores hours per location per dayOfWeek
- useNotificationSettings hook demonstrates the pattern (apps/web/src/hooks/useNotificationSettings.ts)
- Settings page has hours section at case 'hours' (around line 1290)
- Current hours state is local only: `const [hours, setHours] = useState<BusinessHour[]>(defaultHours)`
- LocationContext provides locations and selectedLocationId
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useLocationHours hook</name>
  <files>apps/web/src/hooks/useLocationHours.ts</files>
  <action>
Create a new hook following the useNotificationSettings pattern:

```typescript
'use client';

import { useState, useEffect, useCallback } from 'react';
import { api, ApiError } from '@/lib/api';

interface LocationHour {
  dayOfWeek: number;
  openTime: string | null;
  closeTime: string | null;
  isClosed: boolean;
}

const DAY_NAMES = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

export function useLocationHours(locationId: string | null) {
  const [hours, setHours] = useState<LocationHour[]>([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const fetchHours = useCallback(async () => {
    if (!locationId) {
      setHours([]);
      setLoading(false);
      return;
    }

    setLoading(true);
    setError(null);
    try {
      const response = await api.get<LocationHour[]>(`/locations/${locationId}/hours`);
      if (response.success && response.data) {
        setHours(response.data);
      }
    } catch (err) {
      const message = err instanceof ApiError ? err.message : 'Failed to fetch hours';
      setError(message);
      console.error('[LocationHours] Fetch error:', err);
    } finally {
      setLoading(false);
    }
  }, [locationId]);

  useEffect(() => {
    fetchHours();
  }, [fetchHours]);

  const updateHours = useCallback(async (newHours: LocationHour[]): Promise<boolean> => {
    if (!locationId) return false;

    setSaving(true);
    setError(null);

    // Optimistic update
    const previousHours = hours;
    setHours(newHours);

    try {
      const response = await api.put<LocationHour[]>(`/locations/${locationId}/hours`, { hours: newHours });
      if (response.success && response.data) {
        setHours(response.data);
        console.log('[LocationHours] Saved successfully');
        return true;
      } else {
        setHours(previousHours);
        return false;
      }
    } catch (err) {
      const message = err instanceof ApiError ? err.message : 'Failed to save hours';
      setError(message);
      setHours(previousHours);
      console.error('[LocationHours] Save error:', err);
      return false;
    } finally {
      setSaving(false);
    }
  }, [locationId, hours]);

  // Helper to convert API format to UI format
  const getDisplayHours = useCallback(() => {
    return DAY_NAMES.map((day, index) => {
      const hourData = hours.find(h => h.dayOfWeek === index);
      return {
        day,
        dayOfWeek: index,
        open: hourData?.openTime || '09:00',
        close: hourData?.closeTime || '17:00',
        isOpen: hourData ? !hourData.isClosed : index !== 0, // Sunday closed by default
      };
    });
  }, [hours]);

  // Helper to convert UI format back to API format
  const setDisplayHours = useCallback(async (displayHours: Array<{ dayOfWeek: number; open: string; close: string; isOpen: boolean }>) => {
    const apiHours = displayHours.map(h => ({
      dayOfWeek: h.dayOfWeek,
      openTime: h.isOpen ? h.open : null,
      closeTime: h.isOpen ? h.close : null,
      isClosed: !h.isOpen,
    }));
    return updateHours(apiHours);
  }, [updateHours]);

  return {
    hours,
    loading,
    saving,
    error,
    fetchHours,
    updateHours,
    getDisplayHours,
    setDisplayHours,
  };
}
```

Export from hooks/index.ts if it exists, otherwise just use direct import.

AVOID:
- Do not add toast library (use console.log like useNotificationSettings)
- Do not implement auto-save on change (business hours uses Save button pattern)
  </action>
  <verify>
    - File exists: `ls apps/web/src/hooks/useLocationHours.ts`
    - TypeScript compiles: `cd apps/web && npx tsc --noEmit 2>&1 | head -20`
  </verify>
  <done>useLocationHours hook created with fetch, save, and display format conversion helpers</done>
</task>

<task type="auto">
  <name>Task 2: Wire business hours UI to useLocationHours hook</name>
  <files>apps/web/src/app/settings/page.tsx</files>
  <action>
Modify the settings page to use the new hook:

1. Add import at top of file:
   ```typescript
   import { useLocationHours } from '@/hooks/useLocationHours';
   ```

2. In SettingsContent component, add hook call after other hooks:
   ```typescript
   const { selectedLocationId } = useLocationContext();
   const {
     loading: hoursLoading,
     saving: hoursSaving,
     error: hoursError,
     getDisplayHours,
     setDisplayHours
   } = useLocationHours(selectedLocationId);
   ```

3. Replace the local `hours` state with computed value from hook:
   - Remove: `const [hours, setHours] = useState<BusinessHour[]>(defaultHours);`
   - Keep the BusinessHour interface for UI typing
   - Use `getDisplayHours()` to get hours for display

4. In the 'hours' case section (around line 1290):

   a. Add loading state at top:
   ```typescript
   if (hoursLoading) {
     return (
       <div className="flex items-center justify-center py-12">
         <Loader2 className="w-6 h-6 animate-spin text-sage" />
         <span className="ml-2 text-charcoal/60 dark:text-white/60">Loading hours...</span>
       </div>
     );
   }
   ```

   b. Change hours mapping to use computed value:
   ```typescript
   const displayHours = getDisplayHours();
   ```
   Then map over `displayHours` instead of `hours`

   c. Update onChange handlers to update local state first, then save on button click:
   - Create local state for editing: `const [editingHours, setEditingHours] = useState<typeof displayHours | null>(null);`
   - Initialize from displayHours when they load
   - Update local state on change
   - Save on button click

   d. Add a Save button at the bottom of the hours section:
   ```typescript
   <div className="flex items-center justify-end gap-4 pt-4 border-t border-charcoal/10 dark:border-white/10">
     {hoursError && (
       <p className="text-red-500 text-sm flex items-center gap-2">
         <AlertCircle className="w-4 h-4" />
         {hoursError}
       </p>
     )}
     {hoursSaved && (
       <p className="text-sage text-sm flex items-center gap-2">
         <Check className="w-4 h-4" />
         Hours saved
       </p>
     )}
     <button
       onClick={handleSaveHours}
       disabled={hoursSaving}
       className="inline-flex items-center gap-2 px-4 py-2 bg-sage text-white rounded-lg font-medium hover:bg-sage-dark transition-colors disabled:opacity-50"
     >
       {hoursSaving ? (
         <>
           <Loader2 className="w-4 h-4 animate-spin" />
           Saving...
         </>
       ) : (
         'Save Hours'
       )}
     </button>
   </div>
   ```

5. Add handleSaveHours function:
   ```typescript
   const [hoursSaved, setHoursSaved] = useState(false);
   const [editingHours, setEditingHours] = useState<Array<{ day: string; dayOfWeek: number; open: string; close: string; isOpen: boolean }> | null>(null);

   // Initialize editing state when display hours load
   useEffect(() => {
     if (!hoursLoading && !editingHours) {
       setEditingHours(getDisplayHours());
     }
   }, [hoursLoading, getDisplayHours, editingHours]);

   const handleSaveHours = async () => {
     if (!editingHours) return;
     const success = await setDisplayHours(editingHours);
     if (success) {
       setHoursSaved(true);
       setTimeout(() => setHoursSaved(false), 2000);
     }
   };
   ```

6. Update the hours.map to use editingHours:
   ```typescript
   {(editingHours || getDisplayHours()).map((day, index) => (
   ```

   And update onChange handlers to modify editingHours:
   ```typescript
   onChange={(e) => {
     if (!editingHours) return;
     const updated = [...editingHours];
     updated[index].isOpen = e.target.checked;
     setEditingHours(updated);
   }}
   ```

7. Show location selector hint if no location selected:
   ```typescript
   if (!selectedLocationId) {
     return (
       <div className="text-center py-12">
         <Clock className="w-12 h-12 mx-auto text-charcoal/20 dark:text-white/20 mb-4" />
         <p className="text-charcoal/60 dark:text-white/60">
           Select a location from the header to manage its business hours.
         </p>
       </div>
     );
   }
   ```

AVOID:
- Do not change existing styles
- Do not add new dependencies
- Do not change the hours display format (keep day name, open/close time inputs)
  </action>
  <verify>
    - TypeScript compiles: `cd apps/web && npx tsc --noEmit 2>&1 | head -20`
    - Hook is imported: `grep -n "useLocationHours" apps/web/src/app/settings/page.tsx | head -5`
    - Save button exists: `grep -n "Save Hours" apps/web/src/app/settings/page.tsx`
  </verify>
  <done>Business hours section loads from API, edits local state, saves via API on button click, shows loading/saving states</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. TypeScript compiles without errors:
   ```bash
   cd apps/web && npx tsc --noEmit
   ```

2. Hook file exists and exports correctly:
   ```bash
   grep "export function useLocationHours" apps/web/src/hooks/useLocationHours.ts
   ```

3. Settings page imports and uses hook:
   ```bash
   grep -n "useLocationHours" apps/web/src/app/settings/page.tsx
   ```
</verification>

<success_criteria>
- [ ] useLocationHours hook created with fetch, save, loading, and error states
- [ ] Business hours section shows loading state while fetching
- [ ] Business hours section shows "Select a location" message if no location selected
- [ ] Hours changes update local editing state (not auto-save)
- [ ] Save button triggers API call with loading state
- [ ] Success/error feedback shown after save
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-settings-persistence/06-01-SUMMARY.md`
</output>
