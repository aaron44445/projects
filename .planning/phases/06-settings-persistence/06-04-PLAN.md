---
phase: 06-settings-persistence
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/app/embed/[slug]/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Booking widget passes locationId to availability API"
    - "Business hours changes in settings affect booking widget time slots"
    - "Closed days show no available slots in booking widget"
  artifacts:
    - path: "apps/web/src/app/embed/[slug]/page.tsx"
      provides: "Booking widget with locationId in availability calls"
      contains: "locationId"
  key_links:
    - from: "apps/web/src/app/embed/[slug]/page.tsx"
      to: "/api/v1/public/:slug/availability"
      via: "fetchAvailability with locationId"
      pattern: "locationId.*availability|availability.*locationId"
---

<objective>
Fix booking widget to pass locationId to availability API

Purpose: Close Gap 2 from 06-02 verification. The booking widget does not pass `locationId` to the availability API, causing the API to fall back to hardcoded default hours instead of using the location-specific hours saved via Settings. Users experience this as "business hours don't affect availability."

Output: Booking widget that passes the selected location's ID to the availability API, so location-specific business hours are respected.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-settings-persistence/06-02-SUMMARY.md

Key context from gap analysis:

**Root Cause (from 06-02-SUMMARY.md):**
```typescript
// In apps/web/src/app/embed/[slug]/page.tsx
async function fetchAvailability(
  slug: string,
  date: string,
  serviceId: string,
  staffId?: string  // locationId NOT accepted!
): Promise<TimeSlot[]> {
  let url = `${API_BASE}/api/v1/public/${slug}/availability?date=${date}&serviceId=${serviceId}`;
  if (staffId) url += `&staffId=${staffId}`;  // locationId NOT passed!
  // ...
}

// Call site (line 1138):
fetchAvailability(slug, booking.date, booking.serviceId, booking.staffId || undefined)
// booking.locationId exists but is NOT passed!
```

**API behavior without locationId:**
The availability API accepts `locationId` as optional. Without it, `getBusinessHours` in availability.ts falls back to hardcoded defaults (9-5 weekdays, Sunday closed).

**API behavior with locationId:**
When `locationId` is provided, `getBusinessHours` queries `prisma.locationHours.findUnique` to get the actual configured hours.

**Impact:** Business hours settings have no effect on booking widget availability
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add locationId parameter to fetchAvailability function</name>
  <files>apps/web/src/app/embed/[slug]/page.tsx</files>
  <action>
Update the fetchAvailability function and its call site to pass locationId.

**Step 1: Update function signature (around line 264)**

Change:
```typescript
async function fetchAvailability(
  slug: string,
  date: string,
  serviceId: string,
  staffId?: string
): Promise<TimeSlot[]> {
```

To:
```typescript
async function fetchAvailability(
  slug: string,
  date: string,
  serviceId: string,
  staffId?: string,
  locationId?: string
): Promise<TimeSlot[]> {
```

**Step 2: Add locationId to URL building (around line 271-272)**

Change:
```typescript
let url = `${API_BASE}/api/v1/public/${slug}/availability?date=${date}&serviceId=${serviceId}`;
if (staffId) url += `&staffId=${staffId}`;
```

To:
```typescript
let url = `${API_BASE}/api/v1/public/${slug}/availability?date=${date}&serviceId=${serviceId}`;
if (staffId) url += `&staffId=${staffId}`;
if (locationId) url += `&locationId=${locationId}`;
```

**Step 3: Update call site to pass booking.locationId (around line 1138)**

Change:
```typescript
fetchAvailability(slug, booking.date, booking.serviceId, booking.staffId || undefined)
```

To:
```typescript
fetchAvailability(slug, booking.date, booking.serviceId, booking.staffId || undefined, booking.locationId || undefined)
```

The `booking` object already has a `locationId` field (see BookingData interface around line 98-99), so we just need to pass it through.

AVOID:
- Do not change the BookingData interface
- Do not modify how locationId is selected in the booking flow
- Do not change how the API processes the request
  </action>
  <verify>
    - TypeScript compiles: `cd apps/web && npx tsc --noEmit 2>&1 | head -20`
    - Function has locationId param: `grep -A 5 "async function fetchAvailability" apps/web/src/app/embed/[slug]/page.tsx`
    - URL includes locationId: `grep "locationId" apps/web/src/app/embed/[slug]/page.tsx | grep -v "interface\|BookingData" | head -5`
  </verify>
  <done>fetchAvailability accepts and passes locationId to availability API</done>
</task>

</tasks>

<verification>
After task completion:

1. TypeScript compiles:
   ```bash
   cd apps/web && npx tsc --noEmit
   ```

2. Verify function signature includes locationId:
   ```bash
   grep -A 6 "async function fetchAvailability" apps/web/src/app/embed/[slug]/page.tsx
   ```
   Should show `locationId?: string` in parameters

3. Verify URL includes locationId:
   ```bash
   grep "locationId" apps/web/src/app/embed/[slug]/page.tsx | head -10
   ```
   Should show `if (locationId) url += \`&locationId=\${locationId}\``

4. Verify call site passes locationId:
   ```bash
   grep -B 2 -A 2 "fetchAvailability(slug" apps/web/src/app/embed/[slug]/page.tsx
   ```
   Should show `booking.locationId` being passed

**Manual verification (requires running app):**
1. Go to Settings > Business Hours for a location
2. Set Tuesday to CLOSED, save
3. Open booking widget for that salon
4. Select a service at that location
5. Navigate to a Tuesday date
6. Verify NO time slots are available
7. Go back to Settings and re-enable Tuesday
8. Refresh widget - slots should now appear
</verification>

<success_criteria>
- [ ] fetchAvailability function accepts locationId parameter
- [ ] fetchAvailability appends locationId to URL when provided
- [ ] Call site passes booking.locationId to fetchAvailability
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-settings-persistence/06-04-SUMMARY.md`
</output>
