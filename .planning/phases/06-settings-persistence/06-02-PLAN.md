---
phase: 06-settings-persistence
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Business hours changes in settings page affect booking widget availability"
    - "Service pricing changes reflect in booking widget"
    - "Settings persist across page refresh"
  artifacts: []
  key_links:
    - from: "apps/api/src/services/availability.ts"
      to: "prisma.locationHours"
      via: "getBusinessHours function"
      pattern: "prisma\\.locationHours\\.findUnique"
    - from: "apps/api/src/routes/public.ts"
      to: "prisma.service"
      via: "fresh database query"
      pattern: "prisma\\.service\\.findMany"
---

<objective>
Verify settings persistence end-to-end with manual testing

Purpose: Confirm SET-01 (settings apply immediately), SET-02 (business hours affect availability), and SET-03 (service pricing reflects in bookings) are working correctly.

Output: Verified settings persistence with human confirmation that changes flow through to the booking widget.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-settings-persistence/06-CONTEXT.md
@.planning/phases/06-settings-persistence/06-01-SUMMARY.md

Key context:
- Availability service fetches LocationHours from database (apps/api/src/services/availability.ts lines 107-145)
- Public services endpoint fetches fresh from database with location overrides (apps/api/src/routes/public.ts lines 159-217)
- No application-level caching - database is source of truth
- Phase 5 already verified notification settings persistence works
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify availability service uses LocationHours</name>
  <files></files>
  <action>
Verify the availability calculation fetches business hours from the database (not hardcoded):

1. Confirm getBusinessHours function queries LocationHours table:
   ```bash
   grep -A 20 "async function getBusinessHours" apps/api/src/services/availability.ts
   ```
   Should show `prisma.locationHours.findUnique` query

2. Confirm calculateAvailableSlots calls getBusinessHours:
   ```bash
   grep "getBusinessHours" apps/api/src/services/availability.ts
   ```
   Should show call within calculateAvailableSlots

3. Verify no caching layer intercepts the query:
   ```bash
   grep -r "cache\|Cache\|memoize\|Redis" apps/api/src/services/availability.ts
   ```
   Should return no matches (stateless architecture)

Document findings for the checkpoint task.
  </action>
  <verify>
    - getBusinessHours queries database: `grep "prisma.locationHours" apps/api/src/services/availability.ts`
    - No caching in availability service: `grep -c "cache" apps/api/src/services/availability.ts` returns 0
  </verify>
  <done>Confirmed availability service fetches LocationHours from database without caching</done>
</task>

<task type="auto">
  <name>Task 2: Verify public services endpoint serves fresh data</name>
  <files></files>
  <action>
Verify the public services endpoint queries fresh data from database:

1. Confirm services are fetched from database:
   ```bash
   grep -A 30 "GET /api/v1/public/:slug/services" apps/api/src/routes/public.ts
   ```
   Should show `prisma.service.findMany` query

2. Confirm location-specific pricing is applied:
   ```bash
   grep "priceOverride\|locationSettings" apps/api/src/routes/public.ts
   ```
   Should show `locationSettings?.priceOverride` being used

3. Verify no caching headers or application cache:
   ```bash
   grep -r "cache-control\|Cache-Control\|maxAge\|stale" apps/api/src/routes/public.ts
   ```
   Should return no matches

Document findings for the checkpoint task.
  </action>
  <verify>
    - Services fetched from database: `grep "prisma.service.findMany" apps/api/src/routes/public.ts`
    - Price overrides applied: `grep "priceOverride" apps/api/src/routes/public.ts`
  </verify>
  <done>Confirmed public services endpoint serves fresh data from database with location-specific pricing</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Settings persistence for Phase 6:
1. Business hours now save to database via useLocationHours hook (06-01)
2. Availability service fetches LocationHours from database (verified in Task 1)
3. Public services endpoint serves fresh pricing data (verified in Task 2)

The architecture is correct - no application-level caching, database is source of truth.
  </what-built>
  <how-to-verify>
**Test SET-01: Settings changes persist**

1. Go to Settings > Business Hours
2. Change Monday hours from 9:00-17:00 to 10:00-18:00
3. Click "Save Hours"
4. Refresh the page
5. Verify Monday shows 10:00-18:00 (not reset to default)

**Test SET-02: Business hours affect availability**

1. In Settings > Business Hours, set Tuesday to CLOSED
2. Save changes
3. Open the booking widget (public/:slug or embed)
4. Select a service
5. Navigate to next Tuesday
6. Verify NO time slots are available for Tuesday
7. Go back to Settings and re-enable Tuesday
8. Check booking widget again - slots should now appear

**Test SET-03: Service pricing updates reflect in bookings**

1. Go to Settings > Locations > [Your Location] > Services
2. Note the current price for a service (e.g., "Haircut" at $50)
3. Set a price override (e.g., $65)
4. Save the override
5. Open the booking widget
6. Select the same service at the same location
7. Verify the price shown is $65 (the override), not $50

Note: If you don't have location-specific service settings UI, use the API directly:
```bash
curl -X PUT "$API_URL/locations/YOUR_LOCATION_ID/services/YOUR_SERVICE_ID" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"priceOverride": 65}'
```
  </how-to-verify>
  <resume-signal>
Report results for each test:
- SET-01 (settings persist): PASS/FAIL + details
- SET-02 (hours affect availability): PASS/FAIL + details
- SET-03 (pricing in bookings): PASS/FAIL + details

Type "all tests pass" if everything works, or describe any failures.
  </resume-signal>
</task>

</tasks>

<verification>
This plan is primarily verification - success depends on the checkpoint task passing.

Automated verification confirms:
1. Availability service queries LocationHours table (no hardcoded hours)
2. Public services endpoint applies price overrides from database
3. No application-level caching that would prevent fresh data
</verification>

<success_criteria>
- [ ] Availability service confirmed to query LocationHours from database
- [ ] Public services endpoint confirmed to apply location price overrides
- [ ] Human verification: SET-01 (settings persist) - PASS
- [ ] Human verification: SET-02 (hours affect availability) - PASS
- [ ] Human verification: SET-03 (pricing in bookings) - PASS
</success_criteria>

<output>
After completion, create `.planning/phases/06-settings-persistence/06-02-SUMMARY.md`
</output>
