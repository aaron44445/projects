---
phase: 24-technical-debt
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - apps/web/src/app/embed/[slug]/page.tsx
  - apps/web/src/hooks/usePayment.ts
  - apps/web/src/app/forgot-password/page.tsx
  - apps/web/src/app/reset-password/page.tsx
  - apps/web/src/contexts/ClientAuthContext.tsx
  - apps/web/src/app/demo/page.tsx
autonomous: true

must_haves:
  truths:
    - "All internal API calls use centralized api client"
    - "No direct fetch() calls to /api/v1/* endpoints remain"
    - "External API calls (Stripe, SendGrid) remain unchanged"
    - "Public endpoints work without auth tokens"
  artifacts:
    - path: "apps/web/src/app/embed/[slug]/page.tsx"
      provides: "Booking widget using api client"
      contains: "import.*api.*from.*@/lib/api"
    - path: "apps/web/src/hooks/usePayment.ts"
      provides: "Payment hook using api client"
      contains: "import.*api.*from.*@/lib/api"
  key_links:
    - from: "apps/web/src/app/embed/[slug]/page.tsx"
      to: "apps/web/src/lib/api.ts"
      via: "api.get/post imports"
      pattern: "api\\.(get|post)"
---

<objective>
Consolidate all direct fetch() calls to internal APIs into the centralized api client.

Purpose: Resolve DEBT-04 where ~17 files use direct fetch() calls to /api/v1/* endpoints, bypassing the centralized ApiClient that provides token refresh, retry logic, timeout handling, and error normalization. The booking widget (embed page) is the primary target with 7 fetch calls; remaining files have 1-2 calls each.

Output: All internal API calls go through api.get/post/put/patch/delete with consistent error handling and timeout protection.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-technical-debt/24-RESEARCH.md
@apps/web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Booking Widget Fetch Calls</name>
  <files>apps/web/src/app/embed/[slug]/page.tsx</files>
  <action>
    Migrate the 7 fetch() calls in the booking widget to use the centralized api client:

    1. Add import at top of file:
       ```typescript
       import { api } from '@/lib/api';
       ```

    2. Remove API_BASE constant usage (api client handles base URL):
       - Keep: const API_BASE = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001/api/v1';
       - Note: Still needed for backwards compatibility, but new calls won't use it

    3. Migrate each fetch function (lines ~204-306):

       a) fetchSalon (line ~206):
          BEFORE: const res = await fetch(`${API_BASE}/api/v1/public/${slug}/salon`);
          AFTER:  const response = await api.get<SalonData>(`/public/${slug}/salon`);
          Note: api client adds /api/v1 prefix automatically

       b) fetchLocations (line ~226):
          BEFORE: const res = await fetch(`${API_BASE}/api/v1/public/${slug}/locations`);
          AFTER:  const response = await api.get<Location[]>(`/public/${slug}/locations`);

       c) fetchServices (line ~238):
          BEFORE: const res = await fetch(url);
          AFTER:  const response = await api.get<Service[]>(`/public/${slug}/services${locationId ? `?locationId=${locationId}` : ''}`);

       d) fetchStaff (line ~253):
          BEFORE: const res = await fetch(url);
          AFTER:  const response = await api.get<Staff[]>(`/public/${slug}/staff?serviceId=${serviceId}${locationId ? `&locationId=${locationId}` : ''}`);

       e) fetchAvailability (line ~272):
          BEFORE: const res = await fetch(url);
          AFTER:  const response = await api.get<AvailabilitySlot[]>(`/public/${slug}/availability?...`);

       f) createBooking (line ~297):
          BEFORE: const res = await fetch(`${API_BASE}/api/v1/public/${slug}/book`, { method: 'POST', ... });
          AFTER:  const response = await api.post<BookingResult>(`/public/${slug}/book`, bookingData);

    4. Update response handling pattern:
       BEFORE:
       ```typescript
       const res = await fetch(url);
       const data = await res.json();
       if (data.success && data.data) { ... }
       ```

       AFTER:
       ```typescript
       const response = await api.get<T>(endpoint);
       if (response.success && response.data) { ... }
       ```

    Note: Public endpoints don't require auth tokens. The api client handles this gracefully - it only adds Authorization header if a token exists. The booking widget runs in an iframe without parent window auth context.
  </action>
  <verify>
    Check no direct fetch to internal API remains:
    Run: grep -E "fetch\(\`\\\${API_BASE}" apps/web/src/app/embed/[slug]/page.tsx
    Expected: No matches

    Check api client is imported:
    Run: grep "import.*api.*from.*@/lib/api" apps/web/src/app/embed/[slug]/page.tsx
    Expected: 1 match

    TypeScript check:
    Run: npx tsc --noEmit apps/web/src/app/embed/[slug]/page.tsx
    Expected: No errors
  </verify>
  <done>
    Booking widget uses api client for all internal API calls with consistent error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate Remaining Direct Fetch Calls</name>
  <files>
    apps/web/src/hooks/usePayment.ts
    apps/web/src/app/forgot-password/page.tsx
    apps/web/src/app/reset-password/page.tsx
    apps/web/src/contexts/ClientAuthContext.tsx
    apps/web/src/app/demo/page.tsx
  </files>
  <action>
    Migrate remaining direct fetch() calls to api client:

    1. usePayment.ts (line ~46):
       - Check if this is calling an internal or external API
       - If internal (/api/v1/*): migrate to api.post()
       - If external (Stripe): leave as-is

    2. forgot-password/page.tsx:
       - Migrate password reset request to api.post()
       - This is likely calling /api/v1/auth/forgot-password

    3. reset-password/page.tsx:
       - Migrate password reset confirmation to api.post()
       - This is likely calling /api/v1/auth/reset-password

    4. ClientAuthContext.tsx:
       - Check for any direct fetch calls to auth endpoints
       - If auth endpoints, consider whether api client is appropriate
       - Note: Auth context may need direct fetch for token operations

    5. demo/page.tsx:
       - Migrate any demo data fetches to api client

    For each file:
    a) Add import: import { api } from '@/lib/api';
    b) Replace fetch() with api.get/post/put/patch/delete
    c) Update response handling to use ApiResponse<T> shape
    d) Remove manual JSON parsing (api client handles it)

    DO NOT migrate:
    - External API calls (Stripe, SendGrid, etc.)
    - Token refresh calls in api.ts itself
    - Server-side API routes (they ARE the API)
  </action>
  <verify>
    Check remaining direct fetch calls to internal API:
    Run: grep -rE "fetch\(.*api/v1" apps/web/src --include="*.tsx" --include="*.ts" | grep -v "lib/api.ts" | grep -v node_modules
    Expected: No matches (or only external API calls)

    TypeScript check:
    Run: npx tsc --noEmit
    Expected: No errors in migrated files
  </verify>
  <done>
    All non-embed files use api client for internal API calls.
  </done>
</task>

<task type="auto">
  <name>Task 3: Final Verification and Build</name>
  <files>apps/web/src (verification only)</files>
  <action>
    Comprehensive verification of API client consolidation:

    1. Scan for remaining direct fetch to internal APIs:
       Run: grep -rE "fetch\(\`.*api/v1" apps/web/src --include="*.tsx" --include="*.ts"
       Expected: Only in apps/web/src/lib/api.ts (the client itself)

    2. Verify api client imports in migrated files:
       Run: grep -l "import.*api.*from.*@/lib/api" apps/web/src --include="*.tsx" --include="*.ts" -r
       Expected: All files that make API calls should import the client

    3. Run full web build:
       Run: npm run build (in apps/web)
       Expected: Build succeeds

    4. Identify any intentionally excluded files:
       - apps/web/src/lib/api.ts - the client itself, uses fetch internally
       - Any files calling external APIs (Stripe, etc.) - these are OK

    5. Document any edge cases or exceptions found.
  </action>
  <verify>
    Build verification:
    Run: cd apps/web && npm run build
    Expected: Build succeeds with no errors

    Pattern verification:
    Run: grep -rE "fetch\(" apps/web/src --include="*.tsx" --include="*.ts" | grep -v "lib/api.ts" | grep -v "refetch" | wc -l
    Expected: Minimal count (only external API calls or React Query refetch)
  </verify>
  <done>
    All internal API calls consolidated to api client. Build passes. DEBT-04 resolved.
  </done>
</task>

</tasks>

<verification>
1. Internal API consolidation: `grep -rE "fetch\(\`.*api/v1" apps/web/src` returns only lib/api.ts
2. API client usage: Migrated files import from '@/lib/api'
3. Build passes: `npm run build` in apps/web succeeds
4. Booking widget functional: Can complete a booking flow (manual test in staging)
5. Auth flows work: Forgot password and reset password still function
</verification>

<success_criteria>
- Zero direct fetch() calls to /api/v1/* endpoints outside of lib/api.ts
- All migrated code uses api.get/post/put/patch/delete
- External API calls (Stripe, etc.) unchanged
- Build passes without errors
- No runtime regressions in booking widget or auth flows
</success_criteria>

<output>
After completion, create `.planning/phases/24-technical-debt/24-04-SUMMARY.md`
</output>
