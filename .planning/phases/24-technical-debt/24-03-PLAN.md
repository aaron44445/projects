---
phase: 24-technical-debt
plan: 03
type: execute
wave: 2
depends_on: []
files_modified:
  - apps/api/src/cron/appointmentReminders.ts
autonomous: true

must_haves:
  truths:
    - "Cron reminder notifications create NotificationLog entries"
    - "Email and SMS delivery status tracked per-channel in NotificationLog"
    - "ReminderLog deduplication still works (no double-sends)"
    - "Reminder templates unchanged (same content as before)"
  artifacts:
    - path: "apps/api/src/cron/appointmentReminders.ts"
      provides: "Cron reminders with NotificationLog integration"
      contains: "sendNotification"
  key_links:
    - from: "apps/api/src/cron/appointmentReminders.ts"
      to: "apps/api/src/services/notifications.ts"
      via: "sendNotification() import"
      pattern: "import.*sendNotification.*from.*notifications"
---

<objective>
Route cron appointment reminders through NotificationLog for delivery tracking.

Purpose: Resolve DEBT-03 where cron-triggered reminders (24h and 2h before appointments) bypass NotificationLog, making delivery status invisible in admin views and preventing delivery analytics. The sendNotification() facade already exists and is used by webhook-triggered notifications; this plan integrates cron reminders with the same logging infrastructure.

Output: All appointment reminders (cron and webhook-triggered) tracked in NotificationLog with per-channel delivery status.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-technical-debt/24-RESEARCH.md
@apps/api/src/services/notifications.ts
@apps/api/src/cron/appointmentReminders.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Import sendNotification and Update Dependencies</name>
  <files>apps/api/src/cron/appointmentReminders.ts</files>
  <action>
    Update imports in appointmentReminders.ts to use sendNotification facade:

    1. Add import for sendNotification:
       ```typescript
       import { sendNotification } from '../services/notifications.js';
       ```

    2. Keep existing imports for email/SMS templates (still needed for backward compatibility check):
       - Keep: appointmentReminderEmail, appointmentReminder2hEmail from './email.js'
       - Keep: appointmentReminderSms, appointmentReminder2hSms from './sms.js'

    3. Remove direct sendEmail/sendSms imports (will be called via sendNotification):
       - Remove: sendEmail from '../services/email.js'
       - Remove: sendSms from '../services/sms.js'

    Note: The sendNotification service internally uses the same email/SMS templates, so no template changes needed.
  </action>
  <verify>
    Check imports compile:
    Run: npx tsc --noEmit apps/api/src/cron/appointmentReminders.ts
    Expected: No TypeScript errors
  </verify>
  <done>
    sendNotification imported, direct sendEmail/sendSms imports removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor sendAppointmentReminder to Use sendNotification</name>
  <files>apps/api/src/cron/appointmentReminders.ts</files>
  <action>
    Refactor the sendAppointmentReminder function (lines ~156-258) to use sendNotification:

    BEFORE (current implementation):
    ```typescript
    // Direct email send
    if (client.email && channelConfig.email && (preference === 'email' || preference === 'both')) {
      result.emailSent = await sendEmail({
        to: client.email,
        subject: emailSubject,
        html: emailHtml,
      });
    }

    // Direct SMS send
    if (client.phone && channelConfig.sms && (preference === 'sms' || preference === 'both')) {
      const smsResult = await sendSms({
        to: client.phone,
        message: smsMessage,
      });
      result.smsSent = smsResult.success;
    }
    ```

    AFTER (using sendNotification):
    ```typescript
    // Determine channels based on config and client preference
    const channels: ('email' | 'sms')[] = [];
    if (client.email && channelConfig.email && (preference === 'email' || preference === 'both')) {
      channels.push('email');
    }
    if (client.phone && channelConfig.sms && (preference === 'sms' || preference === 'both')) {
      channels.push('sms');
    }

    // Skip if no channels available
    if (channels.length === 0) {
      result.error = 'No valid communication channels';
      return result;
    }

    // Send through unified notification service (creates NotificationLog entry)
    const notificationResult = await sendNotification({
      salonId: salon.id,
      clientId: client.id,
      appointmentId: appointment.id,
      type: reminderType === 'REMINDER_24H' ? 'reminder_24h' : 'reminder_2h',
      channels,
      data: {
        clientName: client.firstName,
        clientEmail: client.email || undefined,
        clientPhone: client.phone || undefined,
        serviceName: service.name,
        staffName,
        dateTime,
        salonName: salon.name,
        salonAddress: address,
      },
    });

    result.emailSent = notificationResult.emailSent;
    result.smsSent = notificationResult.smsSent;
    ```

    PRESERVE:
    - ReminderLog logging (await logReminder()) - this is for deduplication, keep it
    - Error handling structure
    - Return type (ReminderResult)
    - channelUsed determination for ReminderLog (email/sms/both)

    DELETE:
    - Direct sendEmail() calls
    - Direct sendSms() calls
    - Email subject/template construction (sendNotification handles this)
    - SMS message construction (sendNotification handles this)
  </action>
  <verify>
    TypeScript check:
    Run: npx tsc --noEmit apps/api/src/cron/appointmentReminders.ts
    Expected: No errors

    Check sendNotification is called:
    Run: grep "sendNotification" apps/api/src/cron/appointmentReminders.ts
    Expected: At least one match (the actual call)
  </verify>
  <done>
    sendAppointmentReminder uses sendNotification for all email/SMS delivery with automatic NotificationLog tracking.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify Integration and Build</name>
  <files>apps/api/src/cron/appointmentReminders.ts</files>
  <action>
    Comprehensive verification of the refactored reminder system:

    1. Verify no direct sendEmail/sendSms calls remain:
       Run: grep -E "await sendEmail|await sendSms" apps/api/src/cron/appointmentReminders.ts
       Expected: No matches

    2. Verify sendNotification is properly called:
       Run: grep "await sendNotification" apps/api/src/cron/appointmentReminders.ts
       Expected: Exactly 1 match (in sendAppointmentReminder function)

    3. Verify ReminderLog logging preserved:
       Run: grep "logReminder" apps/api/src/cron/appointmentReminders.ts
       Expected: 2 matches (success and error cases)

    4. Run full API build:
       Run: npm run build (in apps/api)
       Expected: Build succeeds

    5. Run API tests (if any exist for reminders):
       Run: npm test (in apps/api)
       Expected: All tests pass

    Note: Integration testing would require:
    - A scheduled appointment
    - Cron trigger
    - Verify NotificationLog entry created
    This is beyond unit testing scope but can be verified in staging.
  </action>
  <verify>
    Build verification:
    Run: cd apps/api && npm run build
    Expected: Build succeeds with no errors

    Pattern verification:
    Run: grep -c "sendNotification" apps/api/src/cron/appointmentReminders.ts
    Expected: At least 2 (import + call)
  </verify>
  <done>
    Cron reminders route through NotificationLog. Build passes. DEBT-03 resolved.
  </done>
</task>

</tasks>

<verification>
1. No direct sends: `grep -E "await sendEmail|await sendSms" apps/api/src/cron/appointmentReminders.ts` returns empty
2. NotificationLog integration: `grep "sendNotification" apps/api/src/cron/appointmentReminders.ts` returns import + call
3. ReminderLog preserved: `grep "logReminder" apps/api/src/cron/appointmentReminders.ts` returns 2 calls
4. Build passes: `npm run build` in apps/api succeeds
5. Tests pass: `npm test` in apps/api succeeds (if reminder tests exist)
</verification>

<success_criteria>
- All cron reminder sends go through sendNotification()
- NotificationLog entries created for every reminder attempt
- Per-channel status (emailSent, smsSent) tracked
- ReminderLog deduplication still works
- API build passes
- No change to reminder timing or template content
</success_criteria>

<output>
After completion, create `.planning/phases/24-technical-debt/24-03-SUMMARY.md`
</output>
