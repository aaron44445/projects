---
phase: 23-earnings-permissions
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routes/staffPortal.ts
  - apps/web/src/app/staff/schedule/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Schedule page respects staffCanViewClientContact setting"
    - "Client names are masked to 'FirstName L.' format when visibility disabled"
  artifacts:
    - path: "apps/api/src/routes/staffPortal.ts"
      provides: "staffCanViewClientContact in /schedule response"
      contains: "staffCanViewClientContact"
    - path: "apps/web/src/app/staff/schedule/page.tsx"
      provides: "Client name masking in appointment display"
      contains: "formatClientName"
  key_links:
    - from: "apps/web/src/app/staff/schedule/page.tsx"
      to: "staffCanViewClientContact"
      via: "API response field"
      pattern: "staffCanViewClientContact"
---

<objective>
Fix schedule page client visibility gap identified in verification.

Purpose: Close the gap where schedule page displays client firstName without respecting the staffCanViewClientContact salon setting, ensuring consistent privacy controls across all staff portal pages.

Output: Schedule page masks client names to "FirstName L." format when owner has disabled staff client visibility.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-earnings-permissions/23-03-SUMMARY.md

# Key patterns from 23-03:
# - formatClientName helper: shows "FirstName L." when staffCanViewClientContact is false
# - API includes staffCanViewClientContact boolean in response
# - Frontend conditionally masks client names based on setting
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add staffCanViewClientContact to schedule API response</name>
  <files>apps/api/src/routes/staffPortal.ts</files>
  <action>
Update GET /schedule endpoint (line 839) to include staffCanViewClientContact:

1. After line 844 (staffId/salonId extraction), add salon settings lookup:
```typescript
// Fetch salon's staffCanViewClientContact setting
const salon = await prisma.salon.findUnique({
  where: { id: salonId },
  select: { staffCanViewClientContact: true },
});
```

2. Update the response object (line 882-890) to include the setting:
```typescript
res.json({
  success: true,
  data: {
    appointments,
    timeOff,
    availability,
    dateRange: { start: startDate.toISOString(), end: endDate.toISOString() },
    staffCanViewClientContact: salon?.staffCanViewClientContact ?? true,
  },
});
```

Follow the exact pattern used in GET /dashboard (lines 718-722, 829) and GET /earnings (lines 952-956, 1017).
  </action>
  <verify>
Run `npm run build` in apps/api to verify TypeScript compilation passes.
  </verify>
  <done>
GET /schedule response includes staffCanViewClientContact boolean field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add client name masking to schedule page</name>
  <files>apps/web/src/app/staff/schedule/page.tsx</files>
  <action>
Update AppointmentsCalendar component (starting line 598) to mask client names:

1. Add formatClientName helper function near the top of the file (after imports, before getTimeOffStatusClasses):
```typescript
// Helper function for client name formatting based on visibility settings
function formatClientName(
  firstName: string,
  lastName: string,
  canViewContact: boolean
): string {
  if (canViewContact) {
    return `${firstName} ${lastName}`;
  }
  // Show first name + last initial only (e.g., "Sarah M.")
  return `${firstName} ${lastName.charAt(0)}.`;
}
```

2. Update useStaffAppointments hook usage to also track staffCanViewClientContact. Add state:
```typescript
const [staffCanViewClientContact, setStaffCanViewClientContact] = useState(true);
```

3. The hook currently calls /staff-portal/appointments which doesn't exist. Update fetchAppointments call to use /staff-portal/schedule instead:
- Change endpoint in hook OR call /schedule directly in the component
- Parse staffCanViewClientContact from response

4. Update line 703 to use formatClientName:
```typescript
<p className="font-medium truncate text-charcoal">
  {apt.client ? formatClientName(
    apt.client.firstName,
    apt.client.lastName || '',
    staffCanViewClientContact
  ) : 'Client'}
</p>
```

Note: The useStaffAppointments hook calls /staff-portal/appointments which doesn't exist. You may need to:
- Either update the hook to call /schedule endpoint
- Or fetch directly in the component using api.get('/staff-portal/schedule')

Follow the same pattern established in earnings/page.tsx (lines 70-80, 363-367).
  </action>
  <verify>
Run `npm run build` in apps/web to verify TypeScript compilation passes.
Run `npm run lint` to verify no linting errors.
  </verify>
  <done>
Schedule page masks client names to "FirstName L." format when staffCanViewClientContact is false.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. API verification:
   - GET /staff-portal/schedule returns staffCanViewClientContact in response

2. UI verification:
   - Schedule page shows full client names when staffCanViewClientContact is true (default)
   - Schedule page shows "FirstName L." format when staffCanViewClientContact is false

3. Build verification:
   - `npm run build` passes in both apps/api and apps/web
   - No TypeScript errors
</verification>

<success_criteria>
- GET /schedule endpoint includes staffCanViewClientContact boolean
- Schedule page conditionally masks client names based on visibility setting
- Consistent with dashboard and earnings pages client visibility behavior
- TypeScript compilation passes for both API and web
</success_criteria>

<output>
After completion, create `.planning/phases/23-earnings-permissions/23-05-SUMMARY.md`
</output>
