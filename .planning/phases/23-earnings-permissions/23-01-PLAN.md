---
phase: 23-earnings-permissions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routes/staffPortal.ts
  - apps/web/src/app/staff/earnings/page.tsx
autonomous: true

must_haves:
  truths:
    - "Staff can view earnings for current weekly pay period (Sunday-Saturday)"
    - "Staff can select from last 12 weekly pay periods via dropdown"
    - "Earnings summary shows total, tips, and commissions for selected period"
    - "Service-level breakdown table shows all commission records in period"
  artifacts:
    - path: "apps/api/src/routes/staffPortal.ts"
      provides: "Weekly pay period calculation in /earnings endpoint"
      contains: "startOfWeek"
    - path: "apps/web/src/app/staff/earnings/page.tsx"
      provides: "Weekly pay period selector UI"
      contains: "payPeriods"
  key_links:
    - from: "apps/web/src/app/staff/earnings/page.tsx"
      to: "/staff-portal/earnings"
      via: "API call with start/end date params"
      pattern: "api\\.get.*earnings\\?start"
---

<objective>
Implement weekly pay period support for staff earnings view.

Purpose: Replace month-based earnings display with weekly Sunday-Saturday pay periods, aligning with typical spa payroll cycles. Staff can select from last 12 weeks.

Output: Updated earnings API endpoint and frontend with weekly period selector dropdown.
</objective>

<execution_context>
@C:\Users\aaron\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\aaron\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-earnings-permissions/23-CONTEXT.md
@.planning/phases/23-earnings-permissions/23-RESEARCH.md

# Key existing code:
@apps/api/src/routes/staffPortal.ts (lines 920-966 - existing /earnings endpoint)
@apps/web/src/app/staff/earnings/page.tsx (current month-based implementation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update earnings API with weekly period calculation</name>
  <files>apps/api/src/routes/staffPortal.ts</files>
  <action>
Update the existing `/earnings` endpoint to support weekly pay periods:

1. Add imports at top of file:
   ```typescript
   import { startOfWeek, endOfWeek, format } from 'date-fns';
   ```
   (Note: date-fns is already imported for differenceInMinutes, subDays, startOfDay, endOfDay)

2. Modify the /earnings endpoint to:
   - Calculate current week boundaries using `startOfWeek(now, { weekStartsOn: 0 })` for Sunday start
   - If no `start`/`end` query params provided, default to current weekly period instead of current month
   - Return period metadata in response: `{ start, end, label, isCurrent }`

3. Add a new endpoint `GET /earnings/periods` that returns the last 12 weekly pay periods:
   ```typescript
   router.get('/earnings/periods', authenticate, staffOnly, asyncHandler(async (req, res) => {
     const now = new Date();
     const periods = Array.from({ length: 12 }, (_, i) => {
       const weekDate = subWeeks(now, i);
       const start = startOfWeek(weekDate, { weekStartsOn: 0 });
       const end = endOfWeek(weekDate, { weekStartsOn: 0 });
       return {
         index: i,
         start: start.toISOString(),
         end: end.toISOString(),
         label: `${format(start, 'MMM d')} - ${format(end, 'MMM d, yyyy')}`,
         isCurrent: i === 0
       };
     });
     res.json({ success: true, data: periods });
   }));
   ```

Import `subWeeks` from date-fns if not already imported.

The existing /earnings endpoint shape remains compatible - just change the default date range from month to week.
  </action>
  <verify>
Run TypeScript check: `npx tsc --noEmit -p apps/api`
No errors related to date-fns imports or endpoint structure.
  </verify>
  <done>
API returns weekly pay periods by default, and /earnings/periods endpoint returns last 12 weeks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update earnings page UI with period selector</name>
  <files>apps/web/src/app/staff/earnings/page.tsx</files>
  <action>
Refactor the earnings page to use weekly pay periods with a dropdown selector:

1. Remove the existing date filter dropdown (showDateFilter, setQuickDateRange, custom date inputs)

2. Add state for pay periods and selected period:
   ```typescript
   const [payPeriods, setPayPeriods] = useState<Array<{
     index: number;
     start: string;
     end: string;
     label: string;
     isCurrent: boolean;
   }>>([]);
   const [selectedPeriodIndex, setSelectedPeriodIndex] = useState(0);
   ```

3. Fetch pay periods on mount:
   ```typescript
   useEffect(() => {
     const fetchPeriods = async () => {
       const response = await api.get<typeof payPeriods>('/staff-portal/earnings/periods');
       if (response.success && response.data) {
         setPayPeriods(response.data);
       }
     };
     fetchPeriods();
   }, []);
   ```

4. Update fetchEarnings to use selected period's start/end dates instead of dateRange state

5. Replace the Date Range button in header with a native `<select>` dropdown:
   ```tsx
   <select
     value={selectedPeriodIndex}
     onChange={(e) => setSelectedPeriodIndex(Number(e.target.value))}
     className="px-4 py-2 border border-charcoal/20 rounded-xl text-charcoal bg-white focus:border-sage focus:ring-2 focus:ring-sage/20 outline-none"
   >
     {payPeriods.map((period) => (
       <option key={period.index} value={period.index}>
         {period.label} {period.isCurrent ? '(Current)' : ''}
       </option>
     ))}
   </select>
   ```

6. Update the subheader to show the selected period's label instead of getDateRangeLabel()

7. Remove unused imports: Filter, ChevronDown

Keep all existing summary cards and table UI - just change the date selection mechanism.
  </action>
  <verify>
Run frontend build: `npm run build --workspace apps/web`
Visit /staff/earnings page and verify:
- Dropdown shows weekly periods
- Selecting different periods loads that period's earnings
- Summary cards and table display correctly
  </verify>
  <done>
Earnings page shows weekly pay period dropdown with last 12 weeks, defaults to current week, and loads earnings for selected period.
  </done>
</task>

</tasks>

<verification>
1. API endpoint returns weekly periods: `curl http://localhost:3002/api/v1/staff-portal/earnings/periods` (requires auth)
2. Default earnings query returns current week: `curl http://localhost:3002/api/v1/staff-portal/earnings` (requires auth)
3. Frontend builds without errors
4. Period selector dropdown is functional and updates earnings data
</verification>

<success_criteria>
- Staff can view earnings summary for current pay period (Sunday-Saturday)
- Staff can select from last 12 weekly pay periods via dropdown
- Selecting a period loads earnings data for that date range
- EmptyState shown for periods with no earnings
</success_criteria>

<output>
After completion, create `.planning/phases/23-earnings-permissions/23-01-SUMMARY.md`
</output>
