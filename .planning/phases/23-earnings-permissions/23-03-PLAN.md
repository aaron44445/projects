---
phase: 23-earnings-permissions
plan: 03
type: execute
wave: 2
depends_on: ["23-01", "23-02"]
files_modified:
  - apps/web/src/app/staff/earnings/page.tsx
autonomous: true

must_haves:
  truths:
    - "Staff can click Export button to download CSV for selected period"
    - "Export button triggers file download with correct filename"
    - "Client names in table respect visibility settings (masked when setting is false)"
  artifacts:
    - path: "apps/web/src/app/staff/earnings/page.tsx"
      provides: "Export button and client name masking in UI"
      contains: "Download"
  key_links:
    - from: "Export button onClick"
      to: "/staff-portal/earnings/export"
      via: "window.location or fetch with blob download"
      pattern: "earnings/export"
---

<objective>
Add CSV export button to earnings page and implement client name masking in the UI.

Purpose: Complete the earnings transparency feature by enabling staff to download records and ensuring client privacy is respected in the table display.

Output: Updated earnings page with Export button and conditional client name display.
</objective>

<execution_context>
@C:\Users\aaron\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\aaron\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-earnings-permissions/23-CONTEXT.md
@.planning/phases/23-earnings-permissions/23-RESEARCH.md

# Dependencies from prior plans:
@.planning/phases/23-earnings-permissions/23-01-SUMMARY.md (if exists, for API changes)
@.planning/phases/23-earnings-permissions/23-02-SUMMARY.md (if exists, for export endpoint)

# Current implementation:
@apps/web/src/app/staff/earnings/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add staffCanViewClientContact to earnings API response</name>
  <files>apps/api/src/routes/staffPortal.ts</files>
  <action>
Update the GET /earnings endpoint to include the staffCanViewClientContact setting in its response:

1. After fetching commission records, also fetch the salon setting:
   ```typescript
   const salon = await prisma.salon.findUnique({
     where: { id: salonId },
     select: { staffCanViewClientContact: true }
   });
   ```

2. Include in response alongside existing data:
   ```typescript
   res.json({
     success: true,
     data: {
       records,
       summary,
       dateRange: { start: startDate.toISOString(), end: endDate.toISOString() },
       staffCanViewClientContact: salon?.staffCanViewClientContact ?? true,
     },
   });
   ```

This allows the frontend to know whether to mask client names in the table.
  </action>
  <verify>
Run TypeScript check: `npx tsc --noEmit -p apps/api`
Verify response includes staffCanViewClientContact field.
  </verify>
  <done>
Earnings API response includes staffCanViewClientContact boolean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Export button and client name masking to earnings page</name>
  <files>apps/web/src/app/staff/earnings/page.tsx</files>
  <action>
Update the earnings page with export functionality and client name masking:

1. Add Download icon to imports:
   ```typescript
   import { Download } from 'lucide-react';
   ```

2. Add helper function for client name formatting:
   ```typescript
   function formatClientName(
     firstName: string,
     lastName: string,
     canViewContact: boolean
   ): string {
     if (canViewContact) {
       return `${firstName} ${lastName}`;
     }
     return `${firstName} ${lastName.charAt(0)}.`;
   }
   ```

3. Update EarningsData interface to include staffCanViewClientContact:
   ```typescript
   interface EarningsData {
     records: EarningsRecord[];
     summary: EarningsSummary;
     staffCanViewClientContact: boolean;
   }
   ```

4. Add export handler function:
   ```typescript
   const handleExport = useCallback(() => {
     if (payPeriods.length === 0) return;
     const period = payPeriods[selectedPeriodIndex];
     if (!period) return;

     // Get auth token for the request
     const token = localStorage.getItem('staffAccessToken');
     if (!token) return;

     // Open download URL with auth
     const exportUrl = `${process.env.NEXT_PUBLIC_API_URL}/staff-portal/earnings/export?start=${period.start}&end=${period.end}`;

     // Use fetch to handle auth properly, then trigger download
     fetch(exportUrl, {
       headers: { 'Authorization': `Bearer ${token}` }
     })
       .then(response => response.blob())
       .then(blob => {
         const url = window.URL.createObjectURL(blob);
         const a = document.createElement('a');
         a.href = url;
         a.download = `earnings_${period.start.split('T')[0]}_to_${period.end.split('T')[0]}.csv`;
         document.body.appendChild(a);
         a.click();
         window.URL.revokeObjectURL(url);
         a.remove();
       });
   }, [payPeriods, selectedPeriodIndex]);
   ```

5. Add Export button next to the period selector in the header:
   ```tsx
   <div className="flex items-center gap-3">
     <select
       value={selectedPeriodIndex}
       onChange={(e) => setSelectedPeriodIndex(Number(e.target.value))}
       className="px-4 py-2 border border-charcoal/20 rounded-xl text-charcoal bg-white focus:border-sage focus:ring-2 focus:ring-sage/20 outline-none"
     >
       {payPeriods.map((period) => (
         <option key={period.index} value={period.index}>
           {period.label} {period.isCurrent ? '(Current)' : ''}
         </option>
       ))}
     </select>
     <button
       onClick={handleExport}
       disabled={!earningsData || earningsData.records.length === 0}
       className="flex items-center gap-2 px-4 py-2 bg-sage text-white rounded-xl font-medium hover:bg-sage-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
     >
       <Download className="w-4 h-4" />
       <span className="hidden sm:inline">Export</span>
     </button>
   </div>
   ```

6. Update the table to use formatted client names:
   In the records.map() section, replace:
   ```tsx
   <td className="px-5 py-4 text-sm text-charcoal font-medium">
     {record.clientName}
   </td>
   ```
   with:
   ```tsx
   <td className="px-5 py-4 text-sm text-charcoal font-medium">
     {earningsData.staffCanViewClientContact
       ? record.clientName
       : formatClientName(
           record.clientName.split(' ')[0],
           record.clientName.split(' ').slice(1).join(' ') || '',
           false
         )}
   </td>
   ```

   Note: The API already returns clientName as "FirstName LastName", so we parse it. Alternatively, update the EarningsRecord interface and API to return firstName/lastName separately.

Better approach - update the API response to include first/last separately:
- Update EarningsRecord interface to have `clientFirstName` and `clientLastName` instead of `clientName`
- Then use: `formatClientName(record.clientFirstName, record.clientLastName, earningsData.staffCanViewClientContact)`

This is cleaner and matches how the export endpoint handles it.
  </action>
  <verify>
Run frontend build: `npm run build --workspace apps/web`
Test on /staff/earnings page:
- Export button appears and triggers download
- When staffCanViewClientContact is false, client names show as "FirstName L."
  </verify>
  <done>
Export button downloads CSV for selected period. Client names in table respect visibility settings.
  </done>
</task>

</tasks>

<verification>
1. `npm run build --workspace apps/web` completes without errors
2. Export button visible next to period selector
3. Clicking Export downloads CSV file
4. Export disabled when no records exist
5. Client names masked appropriately in table based on salon setting
</verification>

<success_criteria>
- Staff can export earnings to CSV for selected period
- Export button disabled when no records
- Client names in table respect staffCanViewClientContact setting
- CSV filename includes date range
</success_criteria>

<output>
After completion, create `.planning/phases/23-earnings-permissions/23-03-SUMMARY.md`
</output>
