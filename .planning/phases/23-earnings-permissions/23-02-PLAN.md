---
phase: 23-earnings-permissions
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routes/staffPortal.ts
  - apps/api/package.json
autonomous: true

must_haves:
  truths:
    - "Staff can export earnings to CSV file for selected period"
    - "CSV contains Date, Service, Client Name, Service Price, Tip, Commission, Total columns"
    - "CSV filename includes staff name and date range"
    - "CSV respects client visibility settings (masked names when staffCanViewClientContact is false)"
  artifacts:
    - path: "apps/api/src/routes/staffPortal.ts"
      provides: "CSV export endpoint at GET /earnings/export"
      contains: "text/csv"
    - path: "apps/api/package.json"
      provides: "fast-csv dependency"
      contains: "fast-csv"
  key_links:
    - from: "GET /staff-portal/earnings/export"
      to: "CommissionRecord query"
      via: "Prisma findMany with date filters"
      pattern: "commissionRecord\\.findMany"
---

<objective>
Add CSV export functionality for staff earnings.

Purpose: Enable staff to download earnings records for personal records or tax purposes. Export respects client visibility settings.

Output: New API endpoint that streams CSV data with proper headers and masking.
</objective>

<execution_context>
@C:\Users\aaron\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\aaron\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-earnings-permissions/23-CONTEXT.md
@.planning/phases/23-earnings-permissions/23-RESEARCH.md

# Key patterns:
@apps/api/src/routes/staffPortal.ts (existing /earnings endpoint for reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install fast-csv dependency</name>
  <files>apps/api/package.json</files>
  <action>
Install fast-csv for CSV generation with streaming support:

```bash
npm install fast-csv --workspace @peacase/api
```

This adds the fast-csv package which handles CSV edge cases like quoted fields, special characters, and RFC 4180 compliance.
  </action>
  <verify>
Check package.json includes fast-csv: `grep "fast-csv" apps/api/package.json`
Import works: add `import { format as csvFormat } from '@fast-csv/format';` to staffPortal.ts and verify no TypeScript errors
  </verify>
  <done>
fast-csv is installed and importable in the API package.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CSV export endpoint with client name masking</name>
  <files>apps/api/src/routes/staffPortal.ts</files>
  <action>
Add a new endpoint for CSV export that reuses the earnings query logic:

1. Add import at top of file:
   ```typescript
   import { format as csvFormat } from '@fast-csv/format';
   ```

2. Add helper function for client name formatting:
   ```typescript
   function formatClientName(
     client: { firstName: string; lastName: string },
     canViewContact: boolean
   ): string {
     if (canViewContact) {
       return `${client.firstName} ${client.lastName}`;
     }
     // Show first name + last initial only (e.g., "Sarah M.")
     return `${client.firstName} ${client.lastName.charAt(0)}.`;
   }
   ```

3. Add the export endpoint after the existing /earnings endpoint:
   ```typescript
   // GET /api/v1/staff-portal/earnings/export
   // Export earnings to CSV
   router.get('/earnings/export', authenticate, staffOnly, asyncHandler(async (req: Request, res: Response) => {
     if (!req.user) {
       return res.status(401).json({ success: false, error: { code: 'UNAUTHORIZED', message: 'Not authenticated' } });
     }

     const staffId = req.user.userId;
     const salonId = req.user.salonId;

     // Parse date range (required for export)
     const startDate = req.query.start ? new Date(req.query.start as string) : null;
     const endDate = req.query.end ? new Date(req.query.end as string) : null;

     if (!startDate || !endDate) {
       return res.status(400).json({
         success: false,
         error: { code: 'VALIDATION_ERROR', message: 'start and end date parameters are required' }
       });
     }

     // Get salon settings for client visibility
     const salon = await prisma.salon.findUnique({
       where: { id: salonId },
       select: { staffCanViewClientContact: true }
     });
     const canViewClientContact = salon?.staffCanViewClientContact ?? true;

     // Get staff info for filename
     const staff = await prisma.user.findUnique({
       where: { id: staffId },
       select: { firstName: true, lastName: true }
     });

     // Fetch records
     const records = await prisma.commissionRecord.findMany({
       where: {
         staffId,
         salonId,
         createdAt: { gte: startDate, lte: endDate },
       },
       include: {
         appointment: {
           include: {
             service: { select: { name: true } },
             client: { select: { firstName: true, lastName: true } },
           },
         },
       },
       orderBy: { createdAt: 'asc' },
     });

     // Generate filename
     const staffName = staff ? `${staff.firstName}_${staff.lastName}`.replace(/\s+/g, '_') : 'staff';
     const startStr = format(startDate, 'yyyy-MM-dd');
     const endStr = format(endDate, 'yyyy-MM-dd');
     const filename = `earnings_${staffName}_${startStr}_to_${endStr}.csv`;

     // Set CSV headers
     res.setHeader('Content-Type', 'text/csv; charset=utf-8');
     res.setHeader('Content-Disposition', `attachment; filename="${filename}"`);

     // Stream CSV
     const csvStream = csvFormat({ headers: true });
     csvStream.pipe(res);

     for (const record of records) {
       const clientName = formatClientName(
         record.appointment.client,
         canViewClientContact
       );

       csvStream.write({
         Date: format(record.createdAt, 'MMM d, yyyy'),
         Service: record.appointment.service.name,
         'Client Name': clientName,
         'Service Price': record.serviceAmount.toFixed(2),
         Tip: record.tipAmount.toFixed(2),
         Commission: record.commissionAmount.toFixed(2),
         Total: (record.commissionAmount + record.tipAmount).toFixed(2)
       });
     }

     csvStream.end();
   }));
   ```

Note: The `format` function from date-fns is already used elsewhere in the file (if not, import it).
  </action>
  <verify>
Run TypeScript check: `npx tsc --noEmit -p apps/api`
Test endpoint manually with auth token:
`curl -H "Authorization: Bearer <token>" "http://localhost:3002/api/v1/staff-portal/earnings/export?start=2026-01-01&end=2026-01-31" --output test.csv`
Verify CSV has correct headers and data format.
  </verify>
  <done>
CSV export endpoint streams earnings data with proper headers, respects client visibility settings, and uses staff name + dates in filename.
  </done>
</task>

</tasks>

<verification>
1. `npm run build --workspace @peacase/api` completes without errors
2. Export endpoint returns CSV with correct Content-Type header
3. CSV contains Date, Service, Client Name, Service Price, Tip, Commission, Total columns
4. Client names are masked when staffCanViewClientContact is false
5. Filename follows pattern: `earnings_FirstName_LastName_YYYY-MM-DD_to_YYYY-MM-DD.csv`
</verification>

<success_criteria>
- GET /staff-portal/earnings/export returns downloadable CSV
- CSV includes all required columns
- Client names are masked based on salon settings
- Proper filename with staff name and date range
</success_criteria>

<output>
After completion, create `.planning/phases/23-earnings-permissions/23-02-SUMMARY.md`
</output>
