---
phase: 16-accessibility-compliance
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/ui/src/components/Modal.tsx
  - apps/web/src/components/BookingModal.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Modal traps Tab focus within it while open"
    - "Pressing Escape closes modal"
    - "Focus returns to trigger element when modal closes"
  artifacts:
    - path: "packages/ui/src/components/Modal.tsx"
      provides: "Focus trap that persists for focus restoration"
      contains: "visibility: hidden"
    - path: "apps/web/src/components/BookingModal.tsx"
      provides: "Escape key handler"
      contains: "handleEscape"
  key_links:
    - from: "Modal.tsx"
      to: "FocusTrap"
      via: "returnFocusOnDeactivate"
      pattern: "returnFocusOnDeactivate.*true"
---

<objective>
Fix Modal Focus Trap - Keep modal in DOM for focus restoration

Purpose: UAT Gap 1 revealed that `if (!isOpen) return null` destroys FocusTrap before focus can return to trigger. Focus trap library needs the DOM to persist briefly for `returnFocusOnDeactivate` to work.

Output: Modals that properly return focus when closed
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/ui/src/components/Modal.tsx
@apps/web/src/components/BookingModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Modal.tsx focus restoration</name>
  <files>packages/ui/src/components/Modal.tsx</files>
  <action>
Replace the early return pattern with visibility-based hiding to allow FocusTrap's returnFocusOnDeactivate to work:

1. Remove `if (!isOpen) return null;` at line 55
2. Instead, always render the modal but use CSS to hide it when closed:
   - Add `hidden` class or `style={{ display: isOpen ? 'flex' : 'none' }}` to the outer div
   - Set FocusTrap `active={isOpen}` (already done)
3. This keeps the DOM intact long enough for focus-trap-react to return focus

Also add an escape key handler inside the FocusTrap since escapeDeactivates is false:
- The existing useEffect already handles escape (lines 39-53), but verify it fires when FocusTrap is active

Pattern to follow:
```tsx
// Instead of: if (!isOpen) return null;
// Use conditional display:
<div
  className={cn("fixed inset-0 z-50 flex items-center justify-center", !isOpen && "hidden")}
  aria-hidden={!isOpen}
>
```

The `hidden` class will hide the modal visually while keeping DOM intact for focus restoration.
  </action>
  <verify>
1. Build succeeds: `cd apps/web && npm run build`
2. Modal component still exports correctly
  </verify>
  <done>Modal.tsx uses visibility hiding instead of conditional rendering, allowing FocusTrap to return focus properly</done>
</task>

<task type="auto">
  <name>Task 2: Fix BookingModal.tsx focus restoration</name>
  <files>apps/web/src/components/BookingModal.tsx</files>
  <action>
Apply the same pattern to BookingModal:

1. Remove `if (!isOpen) return null;` at line 122
2. Wrap the entire return in a div with conditional visibility:
   ```tsx
   return (
     <div className={!isOpen ? "hidden" : ""} aria-hidden={!isOpen}>
       <div className="fixed inset-0 bg-charcoal/50 ...">
         <FocusTrap ...>
   ```

3. Add an explicit escape key handler useEffect (similar to Modal.tsx):
   ```tsx
   useEffect(() => {
     const handleEscape = (e: KeyboardEvent) => {
       if (e.key === 'Escape' && isOpen) {
         onClose();
       }
     };

     if (isOpen) {
       document.addEventListener('keydown', handleEscape);
     }

     return () => {
       document.removeEventListener('keydown', handleEscape);
     };
   }, [isOpen, onClose]);
   ```

Note: BookingModal has escapeDeactivates: false (line 131) so we need manual escape handling.
  </action>
  <verify>
1. Build succeeds: `cd apps/web && npm run build`
2. No TypeScript errors
  </verify>
  <done>BookingModal.tsx uses visibility hiding and has explicit escape key handler</done>
</task>

</tasks>

<verification>
1. `cd apps/web && npm run build` passes
2. Modal components export correctly and type-check
</verification>

<success_criteria>
- Modal.tsx renders but hides when closed (no early return null)
- BookingModal.tsx renders but hides when closed (no early return null)
- BookingModal has escape key handler
- Both modals will return focus to trigger when closed (testable in UAT)
</success_criteria>

<output>
After completion, create `.planning/phases/16-accessibility-compliance/16-07-SUMMARY.md`
</output>
