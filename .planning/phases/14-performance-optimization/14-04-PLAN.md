---
phase: 14-performance-optimization
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/prisma/schema.prisma
  - apps/api/src/routes/dashboard.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "VIP client count comes from database COUNT query, not hardcoded value"
    - "Client model has tags field for storing VIP and other client tags"
    - "Dashboard /stats endpoint includes vipClients in Promise.all parallel queries"
  artifacts:
    - path: "packages/database/prisma/schema.prisma"
      provides: "Client.tags field for VIP tagging"
      contains: "tags"
    - path: "apps/api/src/routes/dashboard.ts"
      provides: "Database COUNT query for VIP clients"
      contains: "client.count"
  key_links:
    - from: "apps/api/src/routes/dashboard.ts"
      to: "prisma.client.count"
      via: "VIP client database query"
      pattern: "tags.*has.*VIP"
---

<objective>
Close gap: VIP client count returns hardcoded 0 instead of database COUNT query.

Purpose: PERF-03 requires VIP client count to use database COUNT, not client-side filtering. Currently returns hardcoded 0 because Client model lacks tags field.

Output: Client model with tags field, dashboard endpoint with real VIP COUNT query.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-performance-optimization/14-VERIFICATION.md

# Current implementation files
@packages/database/prisma/schema.prisma
@apps/api/src/routes/dashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tags field to Client model in Prisma schema</name>
  <files>packages/database/prisma/schema.prisma</files>
  <action>
Add a `tags` field to the Client model to store client tags including VIP status.

In packages/database/prisma/schema.prisma, find the Client model (around line 160) and add the following field after the `country` field (line 185):

```prisma
  tags                    String[]                       @default([])
```

This uses a PostgreSQL array type which supports the `has` filter in Prisma.

After adding the field, run migration:
```bash
cd packages/database && npx prisma db push
```

Note: Using `db push` for development. For production, use `prisma migrate dev --name add-client-tags`.
  </action>
  <verify>
Run `npx prisma db push` from packages/database directory - should succeed.
Run `npx prisma generate` to update the client types.
Check that TypeScript recognizes `tags` field on Client type.
  </verify>
  <done>Client model has tags field (String[] with default empty array) and database schema is updated.</done>
</task>

<task type="auto">
  <name>Task 2: Replace hardcoded vipClients with database COUNT query</name>
  <files>apps/api/src/routes/dashboard.ts</files>
  <action>
Update the /stats endpoint to query VIP clients from the database instead of returning hardcoded 0.

1. In apps/api/src/routes/dashboard.ts, add VIP client count query to the Promise.all block (lines 73-159).

Add a new query at the end of the Promise.all array (before the closing bracket on line 159):

```typescript
    // VIP clients count (clients with 'VIP' tag)
    prisma.client.count({
      where: {
        salonId,
        isActive: true,
        tags: { has: 'VIP' },
      },
    }),
```

2. Update the destructuring at line 73 to include the new query result:

Change:
```typescript
  const [
    currentMonthPayments,
    lastMonthPayments,
    thisMonthAppointments,
    lastMonthAppointments,
    thisMonthClients,
    lastMonthClients,
    totalClients,
    avgRating,
    salon,
  ] = await Promise.all([
```

To:
```typescript
  const [
    currentMonthPayments,
    lastMonthPayments,
    thisMonthAppointments,
    lastMonthAppointments,
    thisMonthClients,
    lastMonthClients,
    totalClients,
    avgRating,
    salon,
    vipClients,
  ] = await Promise.all([
```

3. Remove the hardcoded vipClients assignment (lines 185-187):

Delete these lines:
```typescript
  // VIP clients count: Requires 'tags' field on Client model (not yet in schema)
  // Returns 0 for now - see PERF-03 for VIP tagging feature
  const vipClients = 0;
```

The vipClients variable is now populated by the database query in Promise.all.

4. Update the comment on line 208 (vipClients in response):

Change:
```typescript
      vipClients, // PERF-03: Placeholder until Client.tags field added
```

To:
```typescript
      vipClients, // PERF-03: Database COUNT of clients with 'VIP' tag
```
  </action>
  <verify>
1. TypeScript compiles without errors: `cd apps/api && npx tsc --noEmit`
2. Start the API server and hit /api/v1/dashboard/stats endpoint
3. Response should include vipClients field (may be 0 if no VIP clients exist, but it's from database, not hardcoded)
4. Add a VIP tag to a client manually (or via API), verify count changes
  </verify>
  <done>
Dashboard /stats endpoint queries VIP clients from database using COUNT.
vipClients field in response reflects actual count of clients with 'VIP' tag.
Query is part of parallel Promise.all (no additional round trip).
  </done>
</task>

</tasks>

<verification>
1. Schema: `npx prisma db push` succeeds, Client model has tags field
2. Types: `npx prisma generate` succeeds, Client type includes tags: string[]
3. Build: `cd apps/api && npx tsc --noEmit` passes without errors
4. API: GET /api/v1/dashboard/stats returns vipClients field with number value
5. Database: If test client is tagged with 'VIP', vipClients count increases
6. Performance: Response time remains <200ms (query is parallel in Promise.all)
</verification>

<success_criteria>
- Client model has tags field (String[] with @default([]))
- Dashboard /stats endpoint includes vipClients COUNT query in Promise.all
- vipClients field returns actual database COUNT, not hardcoded 0
- PERF-03 requirement satisfied: VIP client count uses database COUNT, not client-side filtering
</success_criteria>

<output>
After completion, create `.planning/phases/14-performance-optimization/14-04-SUMMARY.md`
</output>
