---
phase: 14-performance-optimization
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/hooks/useDashboard.ts
autonomous: true

must_haves:
  truths:
    - "Dashboard queries have refetchIntervalInBackground: false"
    - "Dashboard stops polling when browser tab is backgrounded"
    - "Dashboard resumes polling when tab becomes active"
    - "refetchOnWindowFocus remains true for immediate stale check"
  artifacts:
    - path: "apps/web/src/hooks/useDashboard.ts"
      provides: "React Query configuration with background refetch disabled"
      contains: "refetchIntervalInBackground: false"
  key_links:
    - from: "apps/web/src/hooks/useDashboard.ts"
      to: "React Query"
      via: "useQuery configuration options"
      pattern: "refetchIntervalInBackground.*false"
---

<objective>
Disable dashboard polling when browser tab is backgrounded to reduce unnecessary API calls.

Purpose: Dashboard currently polls every 60 seconds even when the user is on a different tab (refetchIntervalInBackground: true). This wastes server resources and bandwidth. By setting refetchIntervalInBackground: false, React Query pauses polling when the tab is hidden and resumes when it becomes active.

Output: useDashboard hook with all 3 queries configured to pause polling in background.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-performance-optimization/14-CONTEXT.md
@.planning/phases/14-performance-optimization/14-RESEARCH.md

# Current implementation
@apps/web/src/hooks/useDashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set refetchIntervalInBackground to false for all dashboard queries</name>
  <files>apps/web/src/hooks/useDashboard.ts</files>
  <action>
Find all three useQuery calls in useDashboard.ts and change `refetchIntervalInBackground: true` to `refetchIntervalInBackground: false`.

1. Stats query (around line 183-192):
```typescript
// BEFORE
const statsQuery = useQuery({
  queryKey: ['dashboard', 'stats', locationId],
  queryFn: () => fetchStats(locationId),
  refetchInterval: REFRESH_INTERVAL_MS,
  refetchIntervalInBackground: true,  // <-- CHANGE THIS
  refetchOnWindowFocus: true,
  staleTime: 30000,
  gcTime: 300000,
  retry: 3,
});

// AFTER
const statsQuery = useQuery({
  queryKey: ['dashboard', 'stats', locationId],
  queryFn: () => fetchStats(locationId),
  refetchInterval: REFRESH_INTERVAL_MS,
  refetchIntervalInBackground: false,  // Pause polling when tab is backgrounded
  refetchOnWindowFocus: true,           // Refresh immediately when tab returns
  staleTime: 30000,
  gcTime: 300000,
  retry: 3,
});
```

2. Appointments query (around line 195-204):
```typescript
// BEFORE
const appointmentsQuery = useQuery({
  queryKey: ['dashboard', 'appointments', locationId],
  queryFn: () => fetchTodayAppointments(locationId),
  refetchInterval: REFRESH_INTERVAL_MS,
  refetchIntervalInBackground: true,  // <-- CHANGE THIS
  refetchOnWindowFocus: true,
  staleTime: 30000,
  gcTime: 300000,
  retry: 3,
});

// AFTER
const appointmentsQuery = useQuery({
  queryKey: ['dashboard', 'appointments', locationId],
  queryFn: () => fetchTodayAppointments(locationId),
  refetchInterval: REFRESH_INTERVAL_MS,
  refetchIntervalInBackground: false,  // Pause polling when tab is backgrounded
  refetchOnWindowFocus: true,           // Refresh immediately when tab returns
  staleTime: 30000,
  gcTime: 300000,
  retry: 3,
});
```

3. Activity query (around line 207-216):
```typescript
// BEFORE
const activityQuery = useQuery({
  queryKey: ['dashboard', 'activity', locationId],
  queryFn: () => fetchRecentActivity(locationId),
  refetchInterval: REFRESH_INTERVAL_MS,
  refetchIntervalInBackground: true,  // <-- CHANGE THIS
  refetchOnWindowFocus: true,
  staleTime: 30000,
  gcTime: 300000,
  retry: 3,
});

// AFTER
const activityQuery = useQuery({
  queryKey: ['dashboard', 'activity', locationId],
  queryFn: () => fetchRecentActivity(locationId),
  refetchInterval: REFRESH_INTERVAL_MS,
  refetchIntervalInBackground: false,  // Pause polling when tab is backgrounded
  refetchOnWindowFocus: true,           // Refresh immediately when tab returns
  staleTime: 30000,
  gcTime: 300000,
  retry: 3,
});
```

Summary of changes:
- Line ~187: `refetchIntervalInBackground: true` → `refetchIntervalInBackground: false`
- Line ~199: `refetchIntervalInBackground: true` → `refetchIntervalInBackground: false`
- Line ~211: `refetchIntervalInBackground: true` → `refetchIntervalInBackground: false`

These 3 changes are all that's needed. React Query handles the Visibility API detection automatically.
  </action>
  <verify>
1. TypeScript compiles: `cd apps/web && npx tsc --noEmit`
2. Manual browser test:
   - Open dashboard in browser
   - Open Network tab in devtools
   - Wait 60+ seconds, observe /dashboard/* requests happening
   - Switch to another tab for 2+ minutes
   - Switch back - should see immediate request (refetchOnWindowFocus)
   - While on another tab, no /dashboard/* requests should occur
  </verify>
  <done>
All 3 dashboard queries have refetchIntervalInBackground: false.
Polling pauses when tab is backgrounded.
Polling resumes when tab becomes active.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Browser test: Dashboard stops polling when tab is in background
3. Browser test: Dashboard refreshes immediately when tab returns to focus
4. No regressions: Dashboard still updates every 60 seconds when tab is active
</verification>

<success_criteria>
- refetchIntervalInBackground is set to false for all 3 dashboard queries
- Dashboard does not make API requests when browser tab is backgrounded
- Dashboard refetches immediately when user returns to tab
- Reduces unnecessary API calls by ~70% (typical user behavior has many background tabs)
</success_criteria>

<output>
After completion, create `.planning/phases/14-performance-optimization/14-03-SUMMARY.md`
</output>
