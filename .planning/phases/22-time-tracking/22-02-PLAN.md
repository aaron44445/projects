---
phase: 22-time-tracking
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - apps/web/src/app/portal/data/page.tsx
  - apps/web/src/hooks/useTimeClock.ts
autonomous: true

must_haves:
  truths:
    - "Staff can see prominent clock button on dashboard showing current status"
    - "Staff can tap to clock in and see immediate status update"
    - "Staff can tap to clock out and see confirmation"
    - "Staff can view complete clock history grouped by day"
    - "Times display in location timezone, not UTC"
    - "Duration shows for completed entries"
    - "Active (uncompleted) entries are visually distinct"
  artifacts:
    - path: "apps/web/src/hooks/useTimeClock.ts"
      provides: "Time clock state management hook"
      exports: ["useTimeClock"]
      min_lines: 50
    - path: "apps/web/src/app/portal/data/page.tsx"
      provides: "Time clock UI in staff dashboard"
      contains: "ClockButton"
  key_links:
    - from: "apps/web/src/hooks/useTimeClock.ts"
      to: "/api/v1/staff-portal/time-clock"
      via: "api client fetch"
      pattern: "api\\.(get|post).*time-clock"
    - from: "apps/web/src/app/portal/data/page.tsx"
      to: "useTimeClock"
      via: "hook import and call"
      pattern: "useTimeClock\\(\\)"
---

<objective>
Create time clock UI with clock button, status display, and history view for staff portal.

Purpose: Enables staff to clock in/out with a simple tap interface and view their complete time history with timezone-aware display.

Output:
- useTimeClock hook for state management
- Clock button component showing current status
- History list grouped by day with duration display
- Integration into staff portal dashboard page
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-time-tracking/22-RESEARCH.md
@.planning/phases/22-time-tracking/22-01-SUMMARY.md

# Existing patterns
@apps/web/src/app/portal/data/page.tsx
@apps/web/src/hooks/useStaffSchedule.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useTimeClock hook for state management</name>
  <files>apps/web/src/hooks/useTimeClock.ts</files>
  <action>
Create new hook at apps/web/src/hooks/useTimeClock.ts:

```typescript
'use client';

import { useState, useCallback, useEffect } from 'react';
import { api } from '@/lib/api';

interface TimeEntry {
  id: string;
  clockIn: string;
  clockOut: string | null;
  locationId: string;
  locationName: string;
  timezone: string;
  durationMinutes: number | null;
  isActive: boolean;
}

interface ClockStatus {
  isClockedIn: boolean;
  activeEntry: TimeEntry | null;
  canClockIn: boolean;
}

interface UseTimeClockReturn {
  status: ClockStatus | null;
  history: TimeEntry[];
  loading: boolean;
  historyLoading: boolean;
  error: string | null;
  clockIn: (locationId: string) => Promise<TimeEntry>;
  clockOut: () => Promise<TimeEntry>;
  refetchStatus: () => Promise<void>;
  fetchHistory: (startDate?: string, endDate?: string) => Promise<void>;
}

export function useTimeClock(): UseTimeClockReturn {
  const [status, setStatus] = useState<ClockStatus | null>(null);
  const [history, setHistory] = useState<TimeEntry[]>([]);
  const [loading, setLoading] = useState(true);
  const [historyLoading, setHistoryLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const fetchStatus = useCallback(async () => {
    try {
      setLoading(true);
      const response = await api.get<ClockStatus>('/staff-portal/time-clock/status');
      if (response.success && response.data) {
        setStatus(response.data);
        setError(null);
      }
    } catch (err) {
      setError('Failed to fetch clock status');
      console.error('Clock status error:', err);
    } finally {
      setLoading(false);
    }
  }, []);

  const fetchHistory = useCallback(async (startDate?: string, endDate?: string) => {
    try {
      setHistoryLoading(true);
      const params = new URLSearchParams();
      if (startDate) params.set('startDate', startDate);
      if (endDate) params.set('endDate', endDate);

      const url = `/staff-portal/time-clock/history${params.toString() ? '?' + params : ''}`;
      const response = await api.get<TimeEntry[]>(url);
      if (response.success && response.data) {
        setHistory(response.data);
      }
    } catch (err) {
      console.error('Clock history error:', err);
    } finally {
      setHistoryLoading(false);
    }
  }, []);

  const clockIn = useCallback(async (locationId: string): Promise<TimeEntry> => {
    const response = await api.post<TimeEntry>('/staff-portal/time-clock/clock-in', { locationId });
    if (response.success && response.data) {
      await fetchStatus();
      await fetchHistory();
      return response.data;
    }
    throw new Error(response.error?.message || 'Clock in failed');
  }, [fetchStatus, fetchHistory]);

  const clockOut = useCallback(async (): Promise<TimeEntry> => {
    if (!status?.activeEntry) {
      throw new Error('No active clock entry');
    }

    const response = await api.post<TimeEntry>(
      `/staff-portal/time-clock/clock-out/${status.activeEntry.id}`
    );
    if (response.success && response.data) {
      await fetchStatus();
      await fetchHistory();
      return response.data;
    }
    throw new Error(response.error?.message || 'Clock out failed');
  }, [status, fetchStatus, fetchHistory]);

  useEffect(() => {
    fetchStatus();
    fetchHistory();
  }, [fetchStatus, fetchHistory]);

  return {
    status,
    history,
    loading,
    historyLoading,
    error,
    clockIn,
    clockOut,
    refetchStatus: fetchStatus,
    fetchHistory,
  };
}
```

Follow existing hook patterns in the codebase (useStaffSchedule, useTimeOff, etc.).
Use the centralized api client from @/lib/api.
  </action>
  <verify>
File exists at apps/web/src/hooks/useTimeClock.ts.
TypeScript compiles without errors: `cd C:/projects/spa-final/apps/web && pnpm tsc --noEmit`
  </verify>
  <done>useTimeClock hook exists with status, history, clockIn, clockOut, and refetch functions.</done>
</task>

<task type="auto">
  <name>Task 2: Add Time Clock section to staff portal dashboard</name>
  <files>apps/web/src/app/portal/data/page.tsx</files>
  <action>
Add Time Clock section to the staff portal dashboard page.

Import at top:
```typescript
import { useTimeClock } from '@/hooks/useTimeClock';
import { formatInTimeZone } from 'date-fns-tz';
import { parseISO, format, differenceInMinutes } from 'date-fns';
import { Clock, AlertCircle } from 'lucide-react';
```

Add to component:

1. **Call useTimeClock hook:**
```typescript
const {
  status,
  history,
  loading: clockLoading,
  historyLoading,
  clockIn,
  clockOut
} = useTimeClock();
```

2. **Add state for clock actions:**
```typescript
const [clockSubmitting, setClockSubmitting] = useState(false);
const [clockError, setClockError] = useState<string | null>(null);
```

3. **Get primary location from staff profile data** (should already exist in page):
```typescript
const primaryLocation = staffProfile?.staffLocations?.find(sl => sl.isPrimary)?.location
  || staffProfile?.staffLocations?.[0]?.location;
```

4. **Add clock action handler:**
```typescript
const handleClockAction = async () => {
  if (!primaryLocation) {
    setClockError('No assigned location');
    return;
  }

  setClockSubmitting(true);
  setClockError(null);
  try {
    if (status?.isClockedIn) {
      await clockOut();
    } else {
      await clockIn(primaryLocation.id);
    }
  } catch (err) {
    setClockError(err instanceof Error ? err.message : 'Failed to clock in/out');
  } finally {
    setClockSubmitting(false);
  }
};
```

5. **Add Time Clock UI section** (place prominently near top of dashboard):

```tsx
{/* Time Clock Section */}
<div className="bg-white rounded-2xl shadow-soft border border-charcoal/5 p-6">
  <h2 className="text-lg font-semibold text-charcoal mb-4 flex items-center gap-2">
    <Clock className="w-5 h-5 text-sage" />
    Time Clock
  </h2>

  {clockLoading ? (
    <div className="h-24 bg-cream/50 animate-pulse rounded-xl" />
  ) : (
    <div className="text-center space-y-4">
      {status?.isClockedIn && status.activeEntry ? (
        <>
          <div className="w-16 h-16 mx-auto rounded-full bg-sage/10 flex items-center justify-center">
            <Clock className="w-8 h-8 text-sage animate-pulse" />
          </div>
          <div>
            <p className="text-sm text-charcoal/60">Clocked in since</p>
            <p className="text-2xl font-bold text-sage">
              {formatInTimeZone(
                parseISO(status.activeEntry.clockIn),
                status.activeEntry.timezone || 'UTC',
                'h:mm a'
              )}
            </p>
            {status.activeEntry.locationName && (
              <p className="text-sm text-charcoal/60">{status.activeEntry.locationName}</p>
            )}
          </div>
          <button
            onClick={handleClockAction}
            disabled={clockSubmitting}
            className="w-full px-6 py-3 bg-rose text-cream rounded-xl font-medium hover:bg-rose/90 transition-colors disabled:opacity-50"
          >
            {clockSubmitting ? 'Clocking out...' : 'Clock Out'}
          </button>
        </>
      ) : (
        <>
          <div className="w-16 h-16 mx-auto rounded-full bg-sage/10 flex items-center justify-center">
            <Clock className="w-8 h-8 text-sage" />
          </div>
          <div>
            <p className="text-lg font-medium text-charcoal">Not clocked in</p>
            <p className="text-sm text-charcoal/60">Tap below to start your shift</p>
          </div>
          <button
            onClick={handleClockAction}
            disabled={clockSubmitting || !primaryLocation}
            className="w-full px-6 py-3 bg-sage text-cream rounded-xl font-medium hover:bg-sage/90 transition-colors disabled:opacity-50"
          >
            {clockSubmitting ? 'Clocking in...' : 'Clock In'}
          </button>
        </>
      )}

      {clockError && (
        <div className="flex items-center gap-2 text-rose text-sm">
          <AlertCircle className="w-4 h-4" />
          {clockError}
        </div>
      )}
    </div>
  )}
</div>
```

6. **Add Time History Section** (below clock button):

```tsx
{/* Time History Section */}
<div className="bg-white rounded-2xl shadow-soft border border-charcoal/5 p-6">
  <h2 className="text-lg font-semibold text-charcoal mb-4">Recent Time Entries</h2>

  {historyLoading ? (
    <div className="space-y-3">
      {[1, 2, 3].map(i => (
        <div key={i} className="h-16 bg-cream/50 animate-pulse rounded-xl" />
      ))}
    </div>
  ) : history.length === 0 ? (
    <EmptyState
      icon={Clock}
      title="No time entries yet"
      description="Your clock in/out history will appear here"
    />
  ) : (
    <div className="space-y-3">
      {history.slice(0, 10).map((entry) => (
        <div
          key={entry.id}
          className={`p-4 rounded-xl border ${
            entry.isActive
              ? 'bg-sage/5 border-sage/20'
              : 'bg-cream/30 border-charcoal/5'
          }`}
        >
          <div className="flex items-center justify-between">
            <div>
              <p className="font-medium text-charcoal">
                {formatInTimeZone(
                  parseISO(entry.clockIn),
                  entry.timezone || 'UTC',
                  'MMM d, yyyy'
                )}
              </p>
              <p className="text-sm text-charcoal/60">
                {formatInTimeZone(
                  parseISO(entry.clockIn),
                  entry.timezone || 'UTC',
                  'h:mm a'
                )}
                {entry.clockOut ? (
                  <> - {formatInTimeZone(
                    parseISO(entry.clockOut),
                    entry.timezone || 'UTC',
                    'h:mm a'
                  )}</>
                ) : (
                  <span className="text-lavender ml-2">(active)</span>
                )}
              </p>
            </div>
            <div className="text-right">
              {entry.durationMinutes ? (
                <p className="font-medium text-charcoal">
                  {Math.floor(entry.durationMinutes / 60)}h {entry.durationMinutes % 60}m
                </p>
              ) : (
                <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-lavender/10 text-lavender">
                  In progress
                </span>
              )}
              {entry.locationName && (
                <p className="text-xs text-charcoal/50">{entry.locationName}</p>
              )}
            </div>
          </div>
        </div>
      ))}
    </div>
  )}
</div>
```

Ensure EmptyState is imported from @peacase/ui or exists locally.
Follow existing card/section patterns in the page.
  </action>
  <verify>
Run `cd C:/projects/spa-final/apps/web && pnpm dev`
Navigate to staff portal dashboard.
Clock button should be visible.
Test clock in/out functionality.
History should display below.
  </verify>
  <done>
Time Clock section displays on staff dashboard with:
- Current status (clocked in since X:XX or not clocked in)
- Clock in/out button that works
- Recent time entries list with dates, times, and durations
- Times displayed in location timezone
- Active entries visually distinguished
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Hook verification:**
   - useTimeClock.ts exists and exports hook
   - Hook manages status, history, loading states
   - clockIn/clockOut functions work

2. **UI verification:**
   - Time Clock section visible on staff dashboard
   - Shows "Not clocked in" when not clocked in
   - Shows "Clocked in since X:XX" when clocked in
   - Clock in button creates entry
   - Clock out button updates entry
   - History list shows recent entries
   - Times display in correct timezone
   - Duration calculated correctly

3. **Edge case verification:**
   - Can't double clock-in (button disabled or error shown)
   - Empty history shows EmptyState
   - Loading states display correctly
</verification>

<success_criteria>
- [ ] useTimeClock hook created with all functions
- [ ] Time Clock section visible on staff dashboard
- [ ] Clock in button works and shows status change
- [ ] Clock out button works and shows confirmation
- [ ] History displays with dates, times, durations
- [ ] Times shown in location timezone (not UTC)
- [ ] Active entries visually distinct from completed
- [ ] EmptyState shown when no history
- [ ] Error handling for failed clock operations
</success_criteria>

<output>
After completion, create `.planning/phases/22-time-tracking/22-02-SUMMARY.md`
</output>
