---
phase: 13-security-hardening
plan: 03
type: execute
wave: 2
depends_on:
  - 13-01
files_modified:
  - packages/database/prisma/schema.prisma
  - apps/api/src/middleware/validateFileOwnership.ts
  - apps/api/src/routes/uploads.ts
  - apps/api/src/services/upload.ts
autonomous: true

must_haves:
  truths:
    - "File DELETE requests verify ownership via database lookup before deletion"
    - "Unauthorized file access returns 404 (not 403) to prevent enumeration"
    - "Suspicious file access attempts are logged with userId and attempted fileId"
    - "File uploads are tracked in database with salonId for ownership verification"
  artifacts:
    - path: "packages/database/prisma/schema.prisma"
      provides: "FileUpload model for tracking uploads"
      contains: "model FileUpload"
    - path: "apps/api/src/middleware/validateFileOwnership.ts"
      provides: "Reusable ownership verification middleware"
      exports: ["validateFileOwnership"]
  key_links:
    - from: "apps/api/src/routes/uploads.ts"
      to: "apps/api/src/middleware/validateFileOwnership.ts"
      via: "middleware import"
      pattern: "validateFileOwnership"
    - from: "apps/api/src/middleware/validateFileOwnership.ts"
      to: "prisma.fileUpload"
      via: "database query"
      pattern: "prisma\\.fileUpload\\.findFirst"
---

<objective>
Implement database-backed file ownership verification for DELETE operations.

Purpose: Replace vulnerable path-based ownership checks with authoritative database lookups, preventing IDOR attacks and path traversal vulnerabilities.

Output: FileUpload database model, ownership verification middleware, and updated upload routes that track and verify file ownership.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-security-hardening/13-CONTEXT.md
@.planning/phases/13-security-hardening/13-RESEARCH.md
@packages/database/prisma/schema.prisma
@apps/api/src/routes/uploads.ts
@apps/api/src/services/upload.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FileUpload model to Prisma schema</name>
  <files>packages/database/prisma/schema.prisma</files>
  <action>
Add a new FileUpload model to track uploaded files with ownership information:

```prisma
model FileUpload {
  id         String   @id @default(uuid())
  publicId   String   @unique @map("public_id")
  url        String
  salonId    String   @map("salon_id")
  userId     String   @map("user_id")
  fileType   String   @map("file_type")
  bytes      Int?
  width      Int?
  height     Int?
  format     String?
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  @@index([salonId])
  @@index([publicId])
  @@map("file_uploads")
}
```

Place this model after the existing models (e.g., after WebhookEvent model at the end of the file).

Note: This model does NOT have relations to Salon or User to keep it lightweight and avoid
cascading issues - ownership is verified by salonId match, not foreign key.

After adding the model, run the migration:
```bash
cd packages/database && npx prisma db push
```

If using migrations instead of db push:
```bash
cd packages/database && npx prisma migrate dev --name add_file_upload_model
```

Then regenerate the Prisma client:
```bash
npx prisma generate
```
  </action>
  <verify>
1. `cd packages/database && npx prisma validate` - Schema is valid
2. `cd packages/database && npx prisma generate` - Client regenerates
3. `cd packages/database && npx prisma db push` - Migration applies (or use migrate dev)
  </verify>
  <done>
- FileUpload model added to schema.prisma
- Model tracks publicId, url, salonId, userId, fileType, and metadata
- Database migration applied
- Prisma client regenerated
  </done>
</task>

<task type="auto">
  <name>Task 2: Create file ownership verification middleware</name>
  <files>apps/api/src/middleware/validateFileOwnership.ts</files>
  <action>
Create new middleware file `apps/api/src/middleware/validateFileOwnership.ts`:

```typescript
import { Request, Response, NextFunction } from 'express';
import { prisma } from '@peacase/database';

// Extend Request type to include file metadata
interface FileOwnershipRequest extends Request {
  fileMetadata?: {
    id: string;
    publicId: string;
    salonId: string;
    userId: string;
  };
}

/**
 * Middleware to verify file ownership before allowing DELETE operations.
 *
 * Security features:
 * - Database lookup is authoritative source of ownership
 * - Returns 404 for both "not found" and "unauthorized" (prevents enumeration)
 * - Logs suspicious access attempts for security monitoring
 */
export async function validateFileOwnership(
  req: FileOwnershipRequest,
  res: Response,
  next: NextFunction
) {
  const { publicId } = req.params;
  const userId = req.user?.userId;
  const salonId = req.user?.salonId;

  // If no auth context, return 404 (don't reveal that auth is the issue)
  if (!userId || !salonId) {
    return res.status(404).json({
      success: false,
      error: {
        code: 'NOT_FOUND',
        message: 'File not found',
      },
    });
  }

  try {
    // Database lookup to verify ownership
    const file = await prisma.fileUpload.findFirst({
      where: { publicId },
      select: { id: true, publicId: true, salonId: true, userId: true },
    });

    // File doesn't exist in our tracking
    if (!file) {
      return res.status(404).json({
        success: false,
        error: {
          code: 'NOT_FOUND',
          message: 'File not found',
        },
      });
    }

    // Verify salon ownership (defense in depth)
    if (file.salonId !== salonId) {
      // Log suspicious attempt - this could indicate an attack
      console.warn('File ownership violation attempt', {
        timestamp: new Date().toISOString(),
        userId,
        userSalonId: salonId,
        requestedFileId: publicId,
        actualFileSalonId: file.salonId,
        ipAddress: req.ip || req.headers['x-forwarded-for'],
        userAgent: req.get('user-agent'),
      });

      // Return 404 to prevent enumeration (don't reveal file exists)
      return res.status(404).json({
        success: false,
        error: {
          code: 'NOT_FOUND',
          message: 'File not found',
        },
      });
    }

    // Ownership verified - attach metadata to request for handler use
    req.fileMetadata = file;
    next();
  } catch (error) {
    console.error('File ownership validation error:', error);
    return res.status(500).json({
      success: false,
      error: {
        code: 'SERVER_ERROR',
        message: 'Unable to verify file access',
      },
    });
  }
}
```

Note: The middleware returns 404 for all unauthorized access attempts to prevent
attackers from enumerating which files exist. This is a security best practice
(OWASP IDOR prevention).
  </action>
  <verify>
`cd apps/api && npx tsc --noEmit` - TypeScript compiles
  </verify>
  <done>
- validateFileOwnership.ts middleware created
- Returns 404 for unauthorized access (prevents enumeration)
- Logs suspicious attempts with userId, publicId, salonId, IP, and user-agent
- Attaches file metadata to request for handler use
  </done>
</task>

<task type="auto">
  <name>Task 3: Update uploads routes and service to track files</name>
  <files>apps/api/src/routes/uploads.ts, apps/api/src/services/upload.ts</files>
  <action>
Update uploads.ts:

1. Import the new middleware:
```typescript
import { validateFileOwnership } from '../middleware/validateFileOwnership.js';
```

2. Update the DELETE route to use the middleware:
```typescript
router.delete(
  '/:publicId(*)',
  authenticate,
  validateFileOwnership,  // Add this middleware
  asyncHandler(async (req: Request, res: Response) => {
    // ... existing handler code
  })
);
```

3. Remove the old path-based ownership check from the DELETE handler:
   - Remove the entire block that checks `publicId.includes(\`peacase/salons/\${salonId}\`)`
   - The middleware now handles ownership verification

4. After successful Cloudinary deletion, also delete from our database:
```typescript
// Delete from database tracking
await prisma.fileUpload.delete({
  where: { publicId: req.params.publicId },
});
```

5. Update each POST upload route (/image, /avatar) to track uploads in database:
   After the Cloudinary upload succeeds, add:
```typescript
// Track upload in database for ownership verification
await prisma.fileUpload.create({
  data: {
    publicId: result.publicId,
    url: result.secureUrl,
    salonId: req.user?.salonId || '',
    userId: req.user?.userId || '',
    fileType: type, // 'image', 'avatar', 'logo', 'service', 'gallery'
    bytes: result.bytes,
    width: result.width,
    height: result.height,
    format: result.format,
  },
});
```

Import prisma at the top:
```typescript
import { prisma } from '@peacase/database';
```

Note: For the /avatar route, fileType should be 'avatar'.
For the /image route, fileType is the `type` variable from the request body.
  </action>
  <verify>
1. `cd apps/api && npm run build` - TypeScript compiles
2. `cd apps/api && npm test` - Tests pass
3. Manual test:
   - Upload an image via API
   - Verify FileUpload record created in database
   - Delete the image via API
   - Verify FileUpload record removed from database
  </verify>
  <done>
- DELETE route uses validateFileOwnership middleware
- Old path-based ownership check removed
- File uploads create FileUpload database records
- File deletions remove FileUpload database records
- Ownership verified via database lookup before deletion
  </done>
</task>

</tasks>

<verification>
## Overall Verification

1. Schema valid: `cd packages/database && npx prisma validate`
2. API builds: `cd apps/api && npm run build`
3. Database migration applied: FileUpload table exists
4. Integration test flow:
   - Login as user A
   - Upload an image
   - Verify FileUpload record in database with correct salonId
   - Delete the image
   - Verify FileUpload record removed
   - Attempt to delete another salon's file (should get 404)
</verification>

<success_criteria>
- [ ] FileUpload model added to schema.prisma
- [ ] Database migration applied successfully
- [ ] validateFileOwnership.ts middleware created
- [ ] Middleware returns 404 for unauthorized access
- [ ] Middleware logs suspicious access attempts
- [ ] uploads.ts DELETE route uses middleware
- [ ] uploads.ts POST routes create FileUpload records
- [ ] uploads.ts DELETE route removes FileUpload records
- [ ] Old path-based ownership check removed
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-security-hardening/13-03-SUMMARY.md`
</output>
