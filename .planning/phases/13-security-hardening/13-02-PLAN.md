---
phase: 13-security-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/lib/passwordValidation.ts
  - apps/api/src/routes/auth.ts
  - apps/api/src/routes/account.ts
  - apps/web/src/components/PasswordChecklist.tsx
  - apps/web/src/app/staff/setup/page.tsx
  - apps/web/src/app/reset-password/page.tsx
autonomous: true

must_haves:
  truths:
    - "New user passwords require uppercase, lowercase, number, and special character"
    - "Password change requires uppercase, lowercase, number, and special character"
    - "Password reset requires uppercase, lowercase, number, and special character"
    - "UI shows real-time checklist as user types password"
    - "All unmet requirements shown in API error response"
  artifacts:
    - path: "apps/api/src/lib/passwordValidation.ts"
      provides: "Shared password validation schema"
      exports: ["passwordSchema", "PASSWORD_REQUIREMENTS"]
    - path: "apps/web/src/components/PasswordChecklist.tsx"
      provides: "Real-time password requirements UI"
      exports: ["PasswordChecklist"]
  key_links:
    - from: "apps/api/src/routes/auth.ts"
      to: "apps/api/src/lib/passwordValidation.ts"
      via: "import"
      pattern: "import.*passwordSchema.*from.*passwordValidation"
    - from: "apps/web/src/components/PasswordChecklist.tsx"
      to: "PASSWORD_REQUIREMENTS"
      via: "matching validation logic"
      pattern: "[A-Z].*[a-z].*[0-9].*[^A-Za-z0-9]"
---

<objective>
Implement password complexity requirements across backend and frontend.

Purpose: Enforce secure passwords (uppercase, lowercase, number, special character) at registration, password change, and password reset, with real-time UI feedback.

Output: Shared password validation module, updated auth/account routes, and PasswordChecklist React component integrated into relevant pages.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-security-hardening/13-CONTEXT.md
@.planning/phases/13-security-hardening/13-RESEARCH.md
@apps/api/src/routes/auth.ts
@apps/api/src/routes/account.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared password validation module</name>
  <files>apps/api/src/lib/passwordValidation.ts</files>
  <action>
Create a new file `apps/api/src/lib/passwordValidation.ts` with:

1. Define password requirement test functions (for use in frontend):
```typescript
export const PASSWORD_REQUIREMENTS = {
  minLength: (p: string) => p.length >= 8,
  hasUppercase: (p: string) => /[A-Z]/.test(p),
  hasLowercase: (p: string) => /[a-z]/.test(p),
  hasNumber: (p: string) => /[0-9]/.test(p),
  hasSpecialChar: (p: string) => /[^A-Za-z0-9]/.test(p),
} as const;
```

2. Create Zod password schema with chained refinements:
```typescript
export const passwordSchema = z.string()
  .min(1, 'Password is required')
  .refine(PASSWORD_REQUIREMENTS.minLength, {
    message: 'Password must be at least 8 characters',
  })
  .refine(PASSWORD_REQUIREMENTS.hasUppercase, {
    message: 'Password must contain at least one uppercase letter (A-Z)',
  })
  .refine(PASSWORD_REQUIREMENTS.hasLowercase, {
    message: 'Password must contain at least one lowercase letter (a-z)',
  })
  .refine(PASSWORD_REQUIREMENTS.hasNumber, {
    message: 'Password must contain at least one number (0-9)',
  })
  .refine(PASSWORD_REQUIREMENTS.hasSpecialChar, {
    message: 'Password must contain at least one special character (!@#$%^&*)',
  });
```

3. Export both PASSWORD_REQUIREMENTS and passwordSchema for use in routes.

Note: Import z from 'zod' at the top of the file.
  </action>
  <verify>
`cd apps/api && npx tsc --noEmit` - TypeScript compiles without errors
  </verify>
  <done>
- passwordValidation.ts exists with exported passwordSchema and PASSWORD_REQUIREMENTS
- Schema enforces min 8 chars, uppercase, lowercase, number, special character
- Each requirement has a clear error message
  </done>
</task>

<task type="auto">
  <name>Task 2: Update backend auth and account routes</name>
  <files>apps/api/src/routes/auth.ts, apps/api/src/routes/account.ts</files>
  <action>
Update auth.ts:
1. Import passwordSchema from '../lib/passwordValidation.js'
2. Replace the password field in registerSchema:
   - FROM: `password: z.string().min(1, 'Password is required').min(8, 'Password must be at least 8 characters')`
   - TO: `password: passwordSchema`
3. Replace the password field in resetPasswordSchema:
   - FROM: `password: z.string().min(8)`
   - TO: `password: passwordSchema`

Update account.ts:
1. Import passwordSchema from '../lib/passwordValidation.js'
2. Replace the newPassword field in changePasswordSchema:
   - FROM: `newPassword: z.string().min(8, 'New password must be at least 8 characters')`
   - TO: `newPassword: passwordSchema`

Error handling is already in place - Zod errors return fieldErrors with all unmet requirements.
The existing error handling in both files already extracts and returns detailed field errors.
  </action>
  <verify>
1. `cd apps/api && npx tsc --noEmit` - TypeScript compiles
2. `cd apps/api && npm test` - Existing tests pass (if any)
  </verify>
  <done>
- auth.ts uses passwordSchema for register and reset-password
- account.ts uses passwordSchema for change-password
- All routes return detailed validation errors listing unmet requirements
  </done>
</task>

<task type="auto">
  <name>Task 3: Create PasswordChecklist component and integrate</name>
  <files>apps/web/src/components/PasswordChecklist.tsx, apps/web/src/app/staff/setup/page.tsx, apps/web/src/app/reset-password/page.tsx</files>
  <action>
Create `apps/web/src/components/PasswordChecklist.tsx`:

```typescript
'use client';

import { CheckCircle, Circle } from 'lucide-react';

interface PasswordChecklistProps {
  password: string;
  className?: string;
}

const requirements = [
  {
    test: (p: string) => p.length >= 8,
    label: 'At least 8 characters',
    id: 'length',
  },
  {
    test: (p: string) => /[A-Z]/.test(p),
    label: 'One uppercase letter (A-Z)',
    id: 'uppercase',
  },
  {
    test: (p: string) => /[a-z]/.test(p),
    label: 'One lowercase letter (a-z)',
    id: 'lowercase',
  },
  {
    test: (p: string) => /[0-9]/.test(p),
    label: 'One number (0-9)',
    id: 'number',
  },
  {
    test: (p: string) => /[^A-Za-z0-9]/.test(p),
    label: 'One special character (!@#$%^&*)',
    id: 'special',
  },
];

export function PasswordChecklist({ password, className = '' }: PasswordChecklistProps) {
  const allMet = password.length > 0 && requirements.every(req => req.test(password));

  return (
    <div className={`space-y-2 ${className}`}>
      <p className="text-sm text-charcoal/60 font-medium">
        Password requirements:
      </p>
      <div className="space-y-1">
        {requirements.map((req) => {
          const met = password.length > 0 && req.test(password);
          const pending = password.length === 0;

          return (
            <div
              key={req.id}
              className="flex items-center gap-2 text-sm"
              role="listitem"
              aria-label={`${req.label}: ${met ? 'requirement met' : 'requirement not met'}`}
            >
              {met ? (
                <CheckCircle className="w-4 h-4 text-emerald-500 flex-shrink-0" aria-hidden="true" />
              ) : (
                <Circle className="w-4 h-4 text-charcoal/30 flex-shrink-0" aria-hidden="true" />
              )}
              <span className={
                met
                  ? 'text-emerald-700 font-medium'
                  : pending
                    ? 'text-charcoal/50'
                    : 'text-charcoal/70'
              }>
                {req.label}
              </span>
            </div>
          );
        })}
      </div>
      {allMet && (
        <p className="text-sm text-emerald-600 font-medium flex items-center gap-2 mt-3">
          <CheckCircle className="w-4 h-4" aria-hidden="true" />
          Password meets all requirements
        </p>
      )}
    </div>
  );
}
```

Integrate into staff/setup/page.tsx:
1. Find the password input field
2. Import PasswordChecklist component
3. Add `<PasswordChecklist password={password} className="mt-2" />` below the password input
4. The password state variable should already exist - connect to it

Integrate into reset-password/page.tsx:
1. Find the password input field (new password)
2. Import PasswordChecklist component
3. Add `<PasswordChecklist password={password} className="mt-2" />` below the password input
4. Connect to the appropriate state variable for the password field

Note: Both pages likely have form state - find the password value and pass it to the checklist.
Use existing UI patterns from the pages for consistent styling.
  </action>
  <verify>
1. `cd apps/web && npx tsc --noEmit` - TypeScript compiles
2. `cd apps/web && npm run build` - Build succeeds
3. Manual: Start dev server, navigate to /staff/setup and /reset-password, verify checklist appears
  </verify>
  <done>
- PasswordChecklist.tsx component created with real-time validation feedback
- Component shows checkmarks for met requirements, empty circles for unmet
- Integrated into staff/setup/page.tsx below password input
- Integrated into reset-password/page.tsx below password input
- "All requirements met" message shown when password is valid
  </done>
</task>

</tasks>

<verification>
## Overall Verification

1. Backend compiles: `cd apps/api && npm run build`
2. Frontend compiles: `cd apps/web && npm run build`
3. Test password validation:
   - Register with weak password (e.g., "password") should fail with detailed errors
   - Register with strong password (e.g., "SecurePass1!") should succeed
4. Test UI checklist:
   - Type in password field, see checkmarks appear in real-time
   - All green when password meets all requirements
</verification>

<success_criteria>
- [ ] passwordValidation.ts created with passwordSchema and PASSWORD_REQUIREMENTS exports
- [ ] auth.ts registerSchema uses passwordSchema
- [ ] auth.ts resetPasswordSchema uses passwordSchema
- [ ] account.ts changePasswordSchema uses passwordSchema
- [ ] PasswordChecklist.tsx component created
- [ ] Component shows real-time feedback as user types
- [ ] Integrated into staff/setup/page.tsx
- [ ] Integrated into reset-password/page.tsx
- [ ] TypeScript compiles for both API and web apps
</success_criteria>

<output>
After completion, create `.planning/phases/13-security-hardening/13-02-SUMMARY.md`
</output>
