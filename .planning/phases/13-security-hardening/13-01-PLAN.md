---
phase: 13-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/lib/env.ts
autonomous: true

must_haves:
  truths:
    - "Application fails to start in production if ENCRYPTION_KEY is missing or empty"
    - "Application fails to start in production if JWT_SECRET is missing or empty"
    - "Application starts normally in development with missing env vars (uses defaults)"
    - "Error message clearly identifies which variable is missing"
  artifacts:
    - path: "apps/api/src/lib/env.ts"
      provides: "Production-strict environment validation"
      contains: "process.exit"
  key_links:
    - from: "apps/api/src/lib/env.ts"
      to: "process.env.NODE_ENV"
      via: "conditional validation"
      pattern: "NODE_ENV.*production"
---

<objective>
Implement production-only strict environment validation for critical security variables.

Purpose: Prevent application from starting in production with missing JWT_SECRET or ENCRYPTION_KEY, avoiding cryptographic failures and session persistence issues.

Output: Modified env.ts that fails fast in production with clear error messages while maintaining development flexibility.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-security-hardening/13-CONTEXT.md
@.planning/phases/13-security-hardening/13-RESEARCH.md
@apps/api/src/lib/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement production-only environment validation</name>
  <files>apps/api/src/lib/env.ts</files>
  <action>
Modify the existing env.ts to enforce strict validation in production mode:

1. Update the Zod schema to use `superRefine()` for conditional validation:
   - In production: JWT_SECRET required (min 32 chars), ENCRYPTION_KEY required (exactly 64 hex chars)
   - In development/test: Allow defaults (current behavior preserved)

2. Modify `validateEnv()` function:
   - Keep the existing safeParse approach
   - On validation failure in production:
     - Write clear error to stderr identifying missing/invalid variables
     - Set `process.exitCode = 1`
     - Use `process.stderr.write('', () => process.exit(1))` to ensure stderr flushes
   - On validation failure in development:
     - Log warning (current behavior)
     - Continue with defaults

3. Keep the `getEncryptionKey()` helper but update warning message to indicate this only happens in development.

4. Maintain backward compatibility:
   - All existing exports must remain
   - Development mode behavior unchanged
   - Only production mode gains strict validation

Key patterns from research:
```typescript
.superRefine((data, ctx) => {
  if (data.NODE_ENV === 'production') {
    if (!data.JWT_SECRET || data.JWT_SECRET.length < 32) {
      ctx.addIssue({
        code: z.ZodIssueCode.custom,
        message: 'JWT_SECRET is required in production (minimum 32 characters)',
        path: ['JWT_SECRET'],
      });
    }
    if (!data.ENCRYPTION_KEY || data.ENCRYPTION_KEY.length !== 64) {
      ctx.addIssue({
        code: z.ZodIssueCode.custom,
        message: 'ENCRYPTION_KEY is required in production (must be 64 hex characters)',
        path: ['ENCRYPTION_KEY'],
      });
    }
  }
})
```

Do NOT use emojis in error messages for production (stderr should be clean for log parsing).
  </action>
  <verify>
Manual verification steps:
1. `cd apps/api && npm run build` - TypeScript compiles without errors
2. `NODE_ENV=development npm run dev` - App starts with warning about missing env vars
3. Check that removing JWT_SECRET in dev still allows startup with warning
  </verify>
  <done>
- env.ts validates JWT_SECRET and ENCRYPTION_KEY strictly in production mode
- Application exits with code 1 and clear error message if validation fails in production
- Development mode continues to work with defaults and warnings
- No breaking changes to existing exports or development workflow
  </done>
</task>

</tasks>

<verification>
## Overall Verification

1. TypeScript compilation passes: `cd apps/api && npm run build`
2. Development mode works: API starts with `NODE_ENV=development` even with missing vars
3. Code review: Confirm `superRefine` checks NODE_ENV before enforcing requirements
4. Code review: Confirm `process.exit(1)` only called when `NODE_ENV === 'production'`

Note: Full production verification requires deployment or setting NODE_ENV=production locally,
which would prevent the app from starting without real secrets. The implementation should be
verified through code review and TypeScript compilation.
</verification>

<success_criteria>
- [ ] env.ts contains production-only validation logic using superRefine
- [ ] JWT_SECRET validation: required in production, min 32 characters
- [ ] ENCRYPTION_KEY validation: required in production, exactly 64 hex characters
- [ ] process.exit(1) called only when NODE_ENV === 'production' and validation fails
- [ ] Clear error messages written to stderr before exit
- [ ] Development mode unchanged (warnings, defaults, no exit)
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-security-hardening/13-01-SUMMARY.md`
</output>
