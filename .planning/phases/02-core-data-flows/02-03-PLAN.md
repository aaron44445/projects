---
phase: 02-core-data-flows
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - apps/api/src/routes/staff.ts
  - apps/api/src/routes/locations.ts
  - apps/web/src/app/staff/page.tsx
  - apps/web/src/hooks/useStaff.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Staff can be assigned to specific locations"
    - "Staff with no location assignments appear at all locations"
    - "Staff list filters correctly when location is selected"
    - "Staff-location assignments persist after page refresh"
    - "Removing staff from location works correctly"
  artifacts:
    - path: "apps/api/src/routes/locations.ts"
      provides: "Staff-location assignment endpoints"
      exports: ["locationsRouter"]
    - path: "apps/api/src/routes/staff.ts"
      provides: "Staff listing with location filter"
      exports: ["staffRouter"]
  key_links:
    - from: "apps/web/src/app/staff/page.tsx"
      to: "/api/v1/staff?locationId=X"
      via: "useStaff.fetchStaff with locationId"
      pattern: "fetchStaff\\(.*locationId"
    - from: "apps/api/src/routes/staff.ts"
      to: "StaffLocation join table"
      via: "Prisma query"
      pattern: "staffLocation\\.findMany"
---

<objective>
Verify and fix staff-location assignment and filtering

Purpose: Multi-location salons need staff assigned to specific branches. This plan ensures staff can be assigned to locations and the filtering works correctly when viewing staff by location.

Output: Working staff-location assignments with correct filtering
</objective>

<execution_context>
@C:\Users\aaron\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\aaron\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-data-flows/02-RESEARCH.md
@apps/api/src/routes/staff.ts
@apps/api/src/routes/locations.ts
@apps/web/src/app/staff/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test and fix staff-location assignment</name>
  <files>apps/api/src/routes/locations.ts, apps/web/src/app/staff/page.tsx</files>
  <action>
Test assigning staff to locations:
1. Ensure salon has 2+ locations
2. Navigate to Staff page
3. Open a staff member's details
4. Find location assignment UI (may be a button or section)
5. Assign staff to Location A only

Verify:
- POST /api/v1/locations/:id/staff with staffId succeeds
- StaffLocation record created in database
- Staff member shows location assignment in their profile

Test removing staff from location:
1. Find the UI to remove location assignment
2. Remove staff from Location A

Verify:
- DELETE /api/v1/locations/:id/staff/:staffId succeeds
- StaffLocation record deleted
- Staff member no longer shows that location

Fix any issues found:
- If assignment UI is missing, check staff page for location modal/buttons
- If API fails, check for proper salonId validation
- If duplicate assignment fails silently, add unique constraint handling

Test primary location:
1. Assign staff to multiple locations
2. Set one as primary
3. Verify isPrimary flag persists
  </action>
  <verify>
Assign staff to a location via API:
- curl -X POST /api/v1/locations/:locId/staff -d '{"staffId":"X"}' succeeds
- curl -X GET /api/v1/locations/:locId/staff includes the staff member
Remove assignment:
- curl -X DELETE /api/v1/locations/:locId/staff/:staffId succeeds
- Staff no longer in GET response
  </verify>
  <done>Staff can be assigned to and removed from locations</done>
</task>

<task type="auto">
  <name>Task 2: Test and fix staff filtering by location</name>
  <files>apps/api/src/routes/staff.ts, apps/web/src/hooks/useStaff.ts, apps/web/src/app/staff/page.tsx</files>
  <action>
Test staff filtering when location selected:
1. Set up test data:
   - Staff A assigned to Location 1 only
   - Staff B assigned to Location 2 only
   - Staff C assigned to both Location 1 and 2
   - Staff D has NO location assignments
2. Switch to Location 1 using LocationSwitcher
3. View Staff page

Verify:
- Staff A appears (assigned to Location 1)
- Staff B does NOT appear (only assigned to Location 2)
- Staff C appears (assigned to Location 1)
- Staff D appears (no assignments = all locations)

Test with no location filter:
1. Clear location selection (if possible) or verify "All Locations" view
2. All staff should appear

Fix any issues found:
- If unassigned staff don't appear, check the "staff with no assignments" query in staff.ts
- If filtering doesn't work, verify locationId is passed to API
- If wrong staff appear, check the join logic on StaffLocation

Verify the API directly:
- GET /api/v1/staff (no filter) returns all active staff
- GET /api/v1/staff?locationId=X returns only assigned staff + unassigned staff
  </action>
  <verify>
With test data set up:
- curl -X GET /api/v1/staff?locationId=LOC1 returns Staff A, C, D (not B)
- curl -X GET /api/v1/staff returns all staff
UI matches API responses when switching locations
  </verify>
  <done>Staff list filters correctly by selected location</done>
</task>

<task type="auto">
  <name>Task 3: Test and fix staff scheduling at locations</name>
  <files>apps/api/src/routes/appointments.ts, apps/web/src/app/calendar/page.tsx</files>
  <action>
Test staff availability at specific locations:
1. Open staff availability for a staff member
2. Check if availability can be location-specific (StaffAvailability may have locationId)
3. If location-specific availability exists, test setting different hours per location

Verify calendar integration:
1. Switch to Location 1
2. View calendar/scheduling
3. Only staff assigned to Location 1 should appear as assignable

Test appointment creation with location:
1. Create an appointment at Location 1
2. Staff selector should only show staff at Location 1

Fix any issues found:
- If calendar shows all staff regardless of location, add locationId filter to staff fetch
- If appointments don't have locationId, verify appointment creation includes it
- If location-specific availability isn't implemented, document as future enhancement (don't build now)

Note: This task verifies the integration of staff-location with scheduling. If staff availability is not location-specific by design, document this behavior.
  </action>
  <verify>
When viewing calendar with Location 1 selected:
- Staff dropdown/list only shows staff assigned to Location 1 (plus unassigned)
- Creating appointment includes locationId in the record
- GET /api/v1/appointments?locationId=X returns only appointments at that location
  </verify>
  <done>Staff scheduling respects location assignments</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Create test scenario with multiple staff and locations
2. Assign staff to different location combinations
3. Switch between locations and verify correct staff appear
4. Create an appointment at specific location
5. Verify appointment-staff-location relationships are correct

All filtering should be consistent between API and UI.
</verification>

<success_criteria>
- Staff can be assigned to one or more locations
- Staff with no assignments appear at all locations (business rule)
- Staff list filters correctly when location is selected
- Staff removal from location works
- Calendar/scheduling shows only relevant staff per location
- Appointments are correctly associated with locations
- Data is consistent between API responses and UI display
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-data-flows/02-03-SUMMARY.md`
</output>
