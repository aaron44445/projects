---
phase: 02-core-data-flows
plan: 04
type: execute
wave: 2
depends_on: ["02-02"]
files_modified:
  - apps/api/src/routes/locations.ts
  - apps/api/src/routes/services.ts
  - apps/web/src/app/locations/page.tsx
  - apps/web/src/hooks/useServices.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Services can have location-specific pricing overrides"
    - "Services can be enabled/disabled per location"
    - "Location service settings persist and display correctly"
    - "Resetting a service override removes location-specific settings"
    - "Service list shows effective price at selected location"
    - "Booking widget shows only enabled services for selected location"
  artifacts:
    - path: "apps/api/src/routes/locations.ts"
      provides: "Location-service override endpoints"
      exports: ["locationsRouter"]
    - path: "apps/api/src/routes/services.ts"
      provides: "Service CRUD operations"
      exports: ["servicesRouter"]
  key_links:
    - from: "apps/web/src/app/locations/page.tsx"
      to: "/api/v1/locations/:id/services"
      via: "getServicesAtLocation"
      pattern: "locations.*services"
    - from: "apps/api/src/routes/locations.ts"
      to: "ServiceLocation join table"
      via: "Prisma upsert"
      pattern: "serviceLocation\\.(upsert|findMany)"
    - from: "apps/web/src/app/embed/[slug]/page.tsx"
      to: "/api/v1/booking/:slug/services"
      via: "booking widget service fetch"
      pattern: "booking.*services.*locationId"
---

<objective>
Verify and fix location-specific service settings

Purpose: Different locations may have different pricing or offer different services. This plan ensures service overrides work correctly per location.

Output: Working location-specific service pricing and availability
</objective>

<execution_context>
@C:\Users\aaron\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\aaron\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-data-flows/02-RESEARCH.md
@apps/api/src/routes/locations.ts
@apps/api/src/routes/services.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test and fix service listing per location</name>
  <files>apps/api/src/routes/locations.ts, apps/web/src/app/locations/page.tsx</files>
  <action>
Test service listing for a location:
1. Ensure salon has multiple services defined
2. Navigate to location details
3. Find the services section

Verify:
- GET /api/v1/locations/:id/services returns services with effective pricing
- Services show both base price and effective price
- hasOverride flag indicates if location has custom settings

Test the response format:
- Each service should include: id, name, basePrice, baseDuration, effectivePrice, effectiveDuration, isEnabled, hasOverride

Fix any issues found:
- If services don't load, check the API query joins ServiceLocation
- If effectivePrice is wrong, verify the null-coalescing logic
- If hasOverride is always false, check the detection logic
  </action>
  <verify>
Create service overrides via API, then verify:
- curl -X GET /api/v1/locations/:id/services returns services
- Services with overrides show hasOverride: true
- effectivePrice matches override when set
  </verify>
  <done>Services list correctly at location with effective pricing</done>
</task>

<task type="auto">
  <name>Task 2: Test and fix service price/duration overrides</name>
  <files>apps/api/src/routes/locations.ts, apps/web/src/app/locations/page.tsx</files>
  <action>
Test setting a price override:
1. Select a service at a location
2. Set priceOverride to a different value (e.g., base is $50, set override to $60)
3. Save the override

Verify:
- PUT /api/v1/locations/:id/services/:serviceId creates/updates ServiceLocation record
- effectivePrice now shows $60
- Base price still shows $50 (not modified)

Test setting a duration override:
1. Set durationOverride to different value (e.g., base is 60 min, set to 45 min)
2. Save

Verify:
- effectiveDuration shows 45 minutes
- Both overrides can coexist

Test clearing overrides:
1. Set priceOverride back to null
2. Verify effectivePrice returns to base price

Fix any issues found:
- If PUT fails, check the upsert logic and composite key
- If clearing doesn't work, verify null handling in update
- Ensure salonId validation prevents cross-tenant access
  </action>
  <verify>
Set price override to $75 for a service:
- curl -X PUT /api/v1/locations/:locId/services/:svcId -d '{"priceOverride":75}'
- GET /api/v1/locations/:locId/services shows effectivePrice: 75 for that service
Reset override:
- curl -X PUT ... -d '{"priceOverride":null}'
- effectivePrice returns to base price
  </verify>
  <done>Service price and duration overrides work correctly</done>
</task>

<task type="auto">
  <name>Task 3: Test and fix service enable/disable per location</name>
  <files>apps/api/src/routes/locations.ts, apps/web/src/app/services/page.tsx, apps/web/src/app/embed/[slug]/page.tsx</files>
  <action>
Test disabling a service at a location:
1. Find a service enabled at the location
2. Set isEnabled: false for that location

Verify:
- PUT /api/v1/locations/:id/services/:serviceId with isEnabled: false succeeds
- Service shows as disabled at that location
- Booking widget should NOT show this service for this location

Test re-enabling:
1. Set isEnabled: true
2. Verify service is available again

Test the full reset:
1. Use DELETE /api/v1/locations/:id/services/:serviceId
2. Verify all overrides are removed
3. Service reverts to salon-level defaults

Fix any issues found:
- If enable/disable doesn't persist, check the isEnabled field in upsert
- If reset doesn't work, verify DELETE removes the ServiceLocation record
- Ensure disabled services are filtered in booking widget queries

Verify booking widget integration:
1. Disable "Service X" at Location A
2. Open booking widget for Location A
3. Verify "Service X" does NOT appear in service list
4. Enable "Service X" at Location A
5. Verify "Service X" now appears in booking widget
  </action>
  <verify>
Disable a service at location:
- curl -X PUT /api/v1/locations/:locId/services/:svcId -d '{"isEnabled":false}'
- GET shows isEnabled: false for that service
Reset all overrides:
- curl -X DELETE /api/v1/locations/:locId/services/:svcId succeeds
- Service no longer has location-specific settings

Booking widget verification:
- With service disabled at Location A, open booking widget
- Verify disabled service is NOT in the service selection list
- curl -X GET /api/v1/booking/:slug/services?locationId=X confirms disabled service excluded
  </verify>
  <done>Services can be enabled/disabled per location, reset to defaults, and booking widget respects these settings</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Create a service with base price $100 and 60 minutes
2. At Location A: Set price override to $120
3. At Location B: Disable the service
4. Verify Location A shows service at $120
5. Verify Location B shows service as disabled
6. Open booking widget for Location A - verify service shows at $120
7. Open booking widget for Location B - verify service does NOT appear
8. Reset Location A overrides
9. Verify Location A shows service at $100 (base price)

All location-service interactions should work consistently.
</verification>

<success_criteria>
- Services list at location shows effective prices
- Price overrides save and apply correctly
- Duration overrides save and apply correctly
- Services can be disabled at specific locations
- Resetting removes all location-specific settings
- Base service data is never modified by location overrides
- Booking widget respects location-specific service availability (disabled services hidden)
- Booking widget shows services with location-specific pricing
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-data-flows/02-04-SUMMARY.md`
</output>
