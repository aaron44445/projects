---
phase: 02-core-data-flows
plan: 05
type: execute
wave: 3
depends_on: ["02-01", "02-03"]
files_modified:
  - apps/api/src/routes/staff.ts
  - apps/api/src/middleware/auth.ts
  - apps/web/src/hooks/usePermissions.ts
  - apps/web/src/components/RequirePermission.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Staff role cannot create or delete other staff members"
    - "Manager role cannot change user roles"
    - "Owner role has full access to all operations"
    - "Admin role can manage staff but not billing"
    - "Role-based UI elements hide based on permissions"
  artifacts:
    - path: "apps/api/src/middleware/auth.ts"
      provides: "Role-based authorization middleware"
      exports: ["authenticate", "authorize"]
    - path: "apps/web/src/hooks/usePermissions.ts"
      provides: "Frontend permission checking"
      exports: ["usePermissions", "PERMISSIONS"]
  key_links:
    - from: "apps/api/src/routes/staff.ts"
      to: "authorize middleware"
      via: "Route protection"
      pattern: "authorize\\('admin', 'owner'\\)"
    - from: "apps/web/src/app/staff/page.tsx"
      to: "RequirePermission component"
      via: "UI gating"
      pattern: "RequirePermission|can\\("
---

<objective>
Verify and fix role-based access control (RBAC)

Purpose: Different user roles should have different permissions. This plan audits the permission system and ensures staff, managers, admins, and owners have correct access levels.

Output: Working role-based permissions across API and UI
</objective>

<execution_context>
@C:\Users\aaron\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\aaron\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-data-flows/02-RESEARCH.md
@apps/api/src/middleware/auth.ts
@apps/api/src/routes/staff.ts
@apps/web/src/hooks/usePermissions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and fix API route permissions</name>
  <files>apps/api/src/routes/staff.ts, apps/api/src/routes/locations.ts, apps/api/src/routes/services.ts</files>
  <action>
Audit all sensitive routes for proper authorization:

Staff routes (staff.ts):
- POST /staff (create) - MUST require admin/owner
- PATCH /staff/:id (edit) - Allow self-edit, admin/owner for others
- DELETE /staff/:id (delete) - MUST require admin/owner
- PUT /staff/:id/availability - Allow self-edit, admin/owner for others
- PUT /staff/:id/services - MUST require admin/owner

Location routes (locations.ts):
- POST /locations - MUST require admin/owner
- PATCH /locations/:id - MUST require admin/owner
- DELETE /locations/:id - MUST require admin/owner
- POST /locations/:id/staff - MUST require admin/owner
- DELETE /locations/:id/staff/:staffId - MUST require admin/owner
- PUT /locations/:id/services/:serviceId - MUST require admin/owner

Service routes (services.ts):
- POST /services - MUST require admin/owner
- PATCH /services/:id - MUST require admin/owner
- DELETE /services/:id - MUST require admin/owner

For each route, verify:
1. authenticate middleware is present
2. authorize middleware with correct roles is present
3. Check actual enforcement with test requests

Fix any missing authorizations by adding authorize('admin', 'owner') where needed.

Test with different roles:
- Create test users with roles: staff, manager, admin, owner
- Attempt operations with each role
- Verify correct 403 responses for unauthorized access
  </action>
  <verify>
Test API authorization:
- Login as staff user
- curl -X POST /api/v1/staff should return 403 FORBIDDEN
- curl -X DELETE /api/v1/staff/:id should return 403 FORBIDDEN
- Login as owner
- Same requests should succeed (201 and 200)
  </verify>
  <done>API routes have correct role-based authorization</done>
</task>

<task type="auto">
  <name>Task 2: Audit and fix frontend permission gating</name>
  <files>apps/web/src/hooks/usePermissions.ts, apps/web/src/components/RequirePermission.tsx, apps/web/src/app/staff/page.tsx</files>
  <action>
Review and fix frontend permission system:

Check usePermissions hook:
1. Verify role hierarchy is correct (staff < manager < admin < owner)
2. Verify permission checks work correctly
3. Test isAtLeast function with different roles

Check RequirePermission component:
1. Verify it correctly hides/shows content based on permissions
2. Verify fallback behavior (what shows when no permission)

Check Staff page permission usage:
1. "Add Staff" button should only show for admin/owner
2. "Delete Staff" option should only show for admin/owner
3. "Edit Role" option should only show for admin/owner
4. Staff can edit their OWN profile (but not role)

Fix any issues found:
- If buttons show for unauthorized users, add RequirePermission wrapper
- If role checks are incorrect, fix the hierarchy
- Ensure UI matches API permissions (no clickable buttons that will fail)

Test end-to-end:
1. Login as staff user
2. Verify "Add Staff" button is hidden
3. Verify cannot see "Delete" option
4. Login as owner
5. Verify all options are visible
  </action>
  <verify>
As staff user:
- Add Staff button not visible
- Delete options not visible
- Can view staff list
As owner:
- All management options visible
- All operations work
  </verify>
  <done>Frontend correctly hides unauthorized actions</done>
</task>

<task type="auto">
  <name>Task 3: Test and fix manager role specific permissions</name>
  <files>apps/api/src/routes/staff.ts, apps/web/src/hooks/usePermissions.ts</files>
  <action>
Define and verify manager-specific permissions:

Manager should be able to:
- View all staff in their location(s)
- View staff availability and services
- Assign staff to appointments
- View reports for their location(s)

Manager should NOT be able to:
- Create or delete staff members
- Change user roles
- Access billing/subscription settings
- Manage locations
- Delete appointments for other staff (only their own)

Verify API enforcement:
1. Login as manager
2. Attempt to create staff - should get 403
3. Attempt to delete staff - should get 403
4. Attempt to edit staff role - should get 403
5. View staff list - should work
6. View own schedule - should work

Fix role-specific logic:
- In PATCH /staff/:id, verify only admin/owner can change roles
- Add specific checks for manager operations if needed

Update frontend:
- Manager should see limited UI (no create/delete buttons)
- Manager can see scheduling/assignment features
- Manager cannot access Billing page
  </action>
  <verify>
As manager:
- Can view staff list and details
- Cannot create staff (API returns 403)
- Cannot change anyone's role (API returns 403)
- Can view calendar and make appointments
As admin:
- Can create staff
- Can change roles
- Cannot access billing (only owner)
  </verify>
  <done>Manager role has correct limited permissions</done>
</task>

</tasks>

<verification>
Complete permission matrix test:

| Action | Staff | Manager | Admin | Owner |
|--------|-------|---------|-------|-------|
| View staff list | Y | Y | Y | Y |
| Create staff | N | N | Y | Y |
| Edit own profile | Y | Y | Y | Y |
| Edit other profiles | N | N | Y | Y |
| Delete staff | N | N | Y | Y |
| Change roles | N | N | Y | Y |
| Manage locations | N | N | Y | Y |
| Access billing | N | N | N | Y |

Test each cell in the matrix to verify correct behavior.
</verification>

<success_criteria>
- API routes enforce correct role requirements
- Frontend hides unauthorized actions
- Staff cannot perform admin operations
- Managers have limited management capabilities
- Admins can manage staff but not billing
- Owners have full access
- Error messages are clear when access denied
- No way to bypass permissions from UI
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-data-flows/02-05-SUMMARY.md`
</output>
