---
phase: 02-core-data-flows
plan: 05
type: execute
wave: 3
depends_on: ["02-01", "02-03"]
files_modified:
  - apps/api/src/routes/staff.ts
  - apps/api/src/routes/locations.ts
  - apps/api/src/routes/services.ts
  - apps/api/src/middleware/auth.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Staff role cannot create or delete other staff members via API"
    - "Manager role cannot change user roles via API"
    - "Owner role has full access to all API operations"
    - "Admin role can manage staff but not billing via API"
    - "Unauthorized API requests return 403 FORBIDDEN"
  artifacts:
    - path: "apps/api/src/middleware/auth.ts"
      provides: "Role-based authorization middleware"
      exports: ["authenticate", "authorize"]
    - path: "apps/api/src/routes/staff.ts"
      provides: "Staff CRUD operations with role protection"
      exports: ["staffRouter"]
  key_links:
    - from: "apps/api/src/routes/staff.ts"
      to: "authorize middleware"
      via: "Route protection"
      pattern: "authorize\\('admin', 'owner'\\)"
    - from: "apps/api/src/routes/locations.ts"
      to: "authorize middleware"
      via: "Route protection"
      pattern: "authorize\\("
---

<objective>
Audit and fix API route permissions (RBAC Part 1)

Purpose: Different user roles should have different permissions. This plan audits the API permission system and ensures staff, managers, admins, and owners have correct access levels at the API layer.

Output: Working role-based API authorization
</objective>

<execution_context>
@C:\Users\aaron\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\aaron\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-data-flows/02-RESEARCH.md
@apps/api/src/middleware/auth.ts
@apps/api/src/routes/staff.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and fix staff route permissions</name>
  <files>apps/api/src/routes/staff.ts, apps/api/src/middleware/auth.ts</files>
  <action>
Audit staff routes for proper authorization:

Staff routes (staff.ts):
- POST /staff (create) - MUST require admin/owner
- PATCH /staff/:id (edit) - Allow self-edit, admin/owner for others
- DELETE /staff/:id (delete) - MUST require admin/owner
- PUT /staff/:id/availability - Allow self-edit, admin/owner for others
- PUT /staff/:id/services - MUST require admin/owner

For each route, verify:
1. authenticate middleware is present
2. authorize middleware with correct roles is present
3. Check actual enforcement with test requests

Fix any missing authorizations by adding authorize('admin', 'owner') where needed.

Test with different roles:
- Create test tokens for roles: staff, manager, admin, owner
- Attempt POST /staff with staff token - should get 403
- Attempt DELETE /staff/:id with staff token - should get 403
- Attempt POST /staff with owner token - should succeed
  </action>
  <verify>
Test API authorization:
- Login as staff user
- curl -X POST /api/v1/staff should return 403 FORBIDDEN
- curl -X DELETE /api/v1/staff/:id should return 403 FORBIDDEN
- Login as owner
- Same requests should succeed (201 and 200)
  </verify>
  <done>Staff API routes have correct role-based authorization</done>
</task>

<task type="auto">
  <name>Task 2: Audit and fix location and service route permissions</name>
  <files>apps/api/src/routes/locations.ts, apps/api/src/routes/services.ts</files>
  <action>
Audit location and service routes for proper authorization:

Location routes (locations.ts):
- POST /locations - MUST require admin/owner
- PATCH /locations/:id - MUST require admin/owner
- DELETE /locations/:id - MUST require admin/owner
- POST /locations/:id/staff - MUST require admin/owner
- DELETE /locations/:id/staff/:staffId - MUST require admin/owner
- PUT /locations/:id/services/:serviceId - MUST require admin/owner

Service routes (services.ts):
- POST /services - MUST require admin/owner
- PATCH /services/:id - MUST require admin/owner
- DELETE /services/:id - MUST require admin/owner

For each route, verify:
1. authenticate middleware is present
2. authorize middleware with correct roles is present
3. Check actual enforcement with test requests

Fix any missing authorizations by adding authorize('admin', 'owner') where needed.

Test with different roles:
- Attempt location creation with staff token - should get 403
- Attempt service creation with manager token - should get 403
- Attempt same operations with admin token - should succeed
  </action>
  <verify>
Test API authorization:
- Login as manager user
- curl -X POST /api/v1/locations should return 403 FORBIDDEN
- curl -X POST /api/v1/services should return 403 FORBIDDEN
- Login as admin
- Same requests should succeed (201)
  </verify>
  <done>Location and service API routes have correct role-based authorization</done>
</task>

</tasks>

<verification>
After all tasks complete:
Run permission matrix test for API layer:

| Action | Staff | Manager | Admin | Owner |
|--------|-------|---------|-------|-------|
| Create staff | 403 | 403 | 201 | 201 |
| Delete staff | 403 | 403 | 200 | 200 |
| Create location | 403 | 403 | 201 | 201 |
| Delete location | 403 | 403 | 200 | 200 |
| Create service | 403 | 403 | 201 | 201 |

Test each cell with actual API requests.
</verification>

<success_criteria>
- All staff routes enforce correct role requirements
- All location routes enforce correct role requirements
- All service routes enforce correct role requirements
- Staff role gets 403 on admin operations
- Manager role gets 403 on admin operations
- Admin role succeeds on management operations
- Owner role succeeds on all operations
- Error responses include clear FORBIDDEN message
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-data-flows/02-05-SUMMARY.md`
</output>
