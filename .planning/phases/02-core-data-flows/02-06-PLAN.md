---
phase: 02-core-data-flows
plan: 06
type: execute
wave: 3
depends_on: ["02-05"]
files_modified:
  - apps/web/src/hooks/usePermissions.ts
  - apps/web/src/components/RequirePermission.tsx
  - apps/web/src/app/staff/page.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Role-based UI elements hide based on permissions"
    - "Staff user cannot see Add Staff or Delete Staff buttons"
    - "Manager can view staff but cannot see role change options"
    - "Admin can see all management UI except billing"
    - "Owner can see all UI elements"
  artifacts:
    - path: "apps/web/src/hooks/usePermissions.ts"
      provides: "Frontend permission checking"
      exports: ["usePermissions", "PERMISSIONS"]
    - path: "apps/web/src/components/RequirePermission.tsx"
      provides: "Permission-gated UI wrapper"
      exports: ["RequirePermission"]
  key_links:
    - from: "apps/web/src/app/staff/page.tsx"
      to: "RequirePermission component"
      via: "UI gating"
      pattern: "RequirePermission|can\\("
    - from: "apps/web/src/hooks/usePermissions.ts"
      to: "user role"
      via: "useAuth context"
      pattern: "user\\.role"
---

<objective>
Audit and fix frontend permission gating (RBAC Part 2)

Purpose: Frontend should hide unauthorized actions to prevent confusion. This plan audits the UI permission system and ensures role-appropriate elements are shown/hidden.

Output: Working role-based UI gating
</objective>

<execution_context>
@C:\Users\aaron\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\aaron\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-data-flows/02-RESEARCH.md
@.planning/phases/02-core-data-flows/02-05-SUMMARY.md
@apps/web/src/hooks/usePermissions.ts
@apps/web/src/components/RequirePermission.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and fix frontend permission system</name>
  <files>apps/web/src/hooks/usePermissions.ts, apps/web/src/components/RequirePermission.tsx</files>
  <action>
Review and fix frontend permission system:

Check usePermissions hook:
1. Verify role hierarchy is correct (staff < manager < admin < owner)
2. Verify permission checks work correctly
3. Test isAtLeast function with different roles:
   - isAtLeast('staff') returns true for all roles
   - isAtLeast('manager') returns true for manager, admin, owner
   - isAtLeast('admin') returns true for admin, owner
   - isAtLeast('owner') returns true only for owner

Check RequirePermission component:
1. Verify it correctly hides/shows content based on permissions
2. Verify fallback behavior (what shows when no permission)
3. Test with children that should be conditionally rendered

Fix any issues found:
- If role hierarchy is wrong, fix the comparison logic
- If RequirePermission doesn't work, check prop handling
- Ensure hook reads user role from auth context correctly
  </action>
  <verify>
Test permission hook:
- Call usePermissions() with staff role, verify isAtLeast('admin') returns false
- Call usePermissions() with owner role, verify isAtLeast('admin') returns true
- Render RequirePermission with minRole="admin" as staff, verify children hidden
  </verify>
  <done>Frontend permission system works correctly</done>
</task>

<task type="auto">
  <name>Task 2: Audit and fix staff page permission gating</name>
  <files>apps/web/src/app/staff/page.tsx, apps/web/src/components/RequirePermission.tsx</files>
  <action>
Check Staff page permission usage:
1. "Add Staff" button should only show for admin/owner
2. "Delete Staff" option should only show for admin/owner
3. "Edit Role" option should only show for admin/owner
4. Staff can edit their OWN profile (but not role)

Fix any issues found:
- If buttons show for unauthorized users, add RequirePermission wrapper
- If role checks are incorrect, fix the hierarchy
- Ensure UI matches API permissions (no clickable buttons that will fail)

Test end-to-end:
1. Login as staff user
2. Verify "Add Staff" button is hidden
3. Verify cannot see "Delete" option
4. Login as owner
5. Verify all options are visible
  </action>
  <verify>
As staff user:
- Add Staff button not visible on page
- Delete options not visible for any staff member
- Can view staff list
As owner:
- All management options visible
- All operations work when clicked
  </verify>
  <done>Staff page correctly hides unauthorized actions</done>
</task>

<task type="auto">
  <name>Task 3: Test manager role specific UI permissions</name>
  <files>apps/web/src/app/staff/page.tsx, apps/web/src/hooks/usePermissions.ts</files>
  <action>
Define and verify manager-specific UI permissions:

Manager should SEE:
- All staff in their location(s)
- Staff availability and services
- Appointment assignment features
- Reports for their location(s)

Manager should NOT SEE:
- "Create Staff" button
- "Delete Staff" options
- "Change Role" dropdown
- Billing/subscription settings
- Location management options

Test as manager:
1. Login as manager
2. Navigate to Staff page
3. Verify "Add Staff" button is NOT visible
4. Verify "Delete" options are NOT visible
5. Verify role change UI is NOT visible
6. Verify can view staff list and details
7. Navigate to Calendar
8. Verify can see scheduling/assignment features

Fix any missing gating:
- Add RequirePermission where manager shouldn't see content
- Ensure manager can still access read-only views
  </action>
  <verify>
As manager:
- Can view staff list and details
- Add Staff button not visible
- Delete options not visible
- Role change UI not visible
- Can view calendar and appointments
As admin:
- Can see Add Staff button
- Can see Delete options
- Can see Role change UI
- Cannot see Billing page (only owner)
  </verify>
  <done>Manager role has correct limited UI visibility</done>
</task>

</tasks>

<verification>
Complete permission matrix test for UI:

| UI Element | Staff | Manager | Admin | Owner |
|------------|-------|---------|-------|-------|
| View staff list | Y | Y | Y | Y |
| Add Staff button | N | N | Y | Y |
| Edit own profile | Y | Y | Y | Y |
| Edit other profiles | N | N | Y | Y |
| Delete staff option | N | N | Y | Y |
| Change roles option | N | N | Y | Y |
| Manage locations | N | N | Y | Y |
| Billing page access | N | N | N | Y |

Test each cell by logging in as that role and checking visibility.
</verification>

<success_criteria>
- usePermissions hook correctly implements role hierarchy
- RequirePermission component correctly hides/shows content
- Staff page hides management actions for staff/manager roles
- Manager can view but not modify staff
- Admin can manage staff but not see billing
- Owner sees all UI elements
- No clickable buttons that lead to 403 errors
- UI is consistent with API permissions from 02-05
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-data-flows/02-06-SUMMARY.md`
</output>
