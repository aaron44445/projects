---
phase: 02-core-data-flows
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routes/staff.ts
  - apps/api/src/routes/locations.ts
  - apps/web/src/app/staff/page.tsx
  - apps/web/src/hooks/useStaff.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Owner can add a new staff member and they appear in the staff list"
    - "Owner can edit staff member details (name, phone, role) and changes persist"
    - "Owner can deactivate a staff member and they disappear from active lists"
    - "Staff members can be assigned to specific services"
    - "Staff availability schedules save and display correctly"
  artifacts:
    - path: "apps/api/src/routes/staff.ts"
      provides: "Staff CRUD operations"
      exports: ["staffRouter"]
    - path: "apps/web/src/hooks/useStaff.ts"
      provides: "Staff data fetching and mutations"
      exports: ["useStaff"]
  key_links:
    - from: "apps/web/src/app/staff/page.tsx"
      to: "/api/v1/staff"
      via: "useStaff hook"
      pattern: "api\\.(get|post|patch|delete).*staff"
---

<objective>
Verify and fix staff CRUD operations end-to-end

Purpose: Staff management is the foundation for scheduling and permissions. This plan tests the complete add/edit/delete workflow from the owner's perspective, fixing any bugs discovered.

Output: Working staff CRUD with verified data persistence
</objective>

<execution_context>
@C:\Users\aaron\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\aaron\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-data-flows/02-RESEARCH.md
@apps/api/src/routes/staff.ts
@apps/web/src/hooks/useStaff.ts
@apps/web/src/app/staff/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test and fix staff creation flow</name>
  <files>apps/api/src/routes/staff.ts, apps/web/src/app/staff/page.tsx</files>
  <action>
Test the staff creation flow end-to-end:
1. Start the dev server (pnpm dev in apps/api and apps/web)
2. Log in as an owner
3. Navigate to Staff page
4. Click "Add Staff" button
5. Fill in required fields (email, firstName, lastName)
6. Submit the form

Verify:
- API returns 201 with created staff data
- New staff appears in the list without page refresh
- Email invitation is attempted (check logs, don't fail if email service not configured)

Fix any issues found:
- If form validation is missing, add client-side validation
- If API returns error, investigate and fix (check for tenant isolation, duplicate email handling)
- If UI doesn't update after creation, ensure optimistic update or refetch is triggered

DO NOT refactor unrelated code. Focus only on the staff creation workflow.
  </action>
  <verify>
Create a test staff member via UI and verify:
- curl -X GET /api/v1/staff returns the new member in the list
- Staff member shows correct name, email, role in UI
  </verify>
  <done>Owner can create a staff member and it appears in the list immediately</done>
</task>

<task type="auto">
  <name>Task 2: Test and fix staff edit and delete flows</name>
  <files>apps/api/src/routes/staff.ts, apps/web/src/app/staff/page.tsx</files>
  <action>
Test the staff edit flow:
1. Click on an existing staff member to open details
2. Click edit button
3. Modify firstName, phone, and role
4. Save changes

Verify:
- PATCH /api/v1/staff/:id returns 200 with updated data
- Changes appear immediately in UI
- Changes persist after page refresh

Test the staff delete (deactivate) flow:
1. Click delete on a staff member
2. Confirm deletion

Verify:
- DELETE /api/v1/staff/:id returns 200
- Staff member disappears from active list
- Staff member marked isActive: false in database (soft delete)

Fix any issues found:
- If edit doesn't persist, check if PATCH endpoint updates correctly
- If delete confirmation is missing, add it
- If deleted staff still appears, check filtering logic

Role permission check:
- Verify that role changes require admin/owner permission
- Test with a manager user to confirm they cannot change roles
  </action>
  <verify>
Edit a staff member's name and role, then verify:
- curl -X GET /api/v1/staff/:id shows updated values
- Delete the staff member, then verify:
- Staff no longer appears in GET /api/v1/staff response
  </verify>
  <done>Owner can edit staff details and deactivate staff members reliably</done>
</task>

<task type="auto">
  <name>Task 3: Test and fix staff services and availability</name>
  <files>apps/api/src/routes/staff.ts, apps/web/src/hooks/useStaff.ts</files>
  <action>
Test staff services assignment:
1. Open staff member details
2. Assign services they can perform
3. Save service assignments

Verify:
- PUT /api/v1/staff/:id/services saves correctly
- Services display correctly when viewing staff member
- Only services from same salon are available

Test staff availability:
1. Open staff availability editor
2. Set availability for Monday-Friday 9am-5pm
3. Set Sunday as unavailable
4. Save availability

Verify:
- PUT /api/v1/staff/:id/availability saves correctly
- Availability displays correctly
- Changes persist after page refresh

Fix any issues found:
- If services don't save, check the serviceIds validation
- If availability doesn't persist, verify the upsert logic
- Ensure salonId filtering on services query

Test edge cases:
- Assign 0 services (should clear all assignments)
- Set all days unavailable (should be allowed)
- Duplicate service assignment attempts (should be idempotent)
  </action>
  <verify>
Assign services to staff member, then verify:
- GET /api/v1/staff/:id includes staffServices array with correct services
Set availability schedule, then verify:
- GET /api/v1/staff/:id includes staffAvailability array with correct days/times
  </verify>
  <done>Staff services and availability save and display correctly</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Create a new staff member with all fields populated
2. Edit the staff member's details
3. Assign services and availability
4. Verify all changes persist after page refresh
5. Deactivate the staff member
6. Confirm they no longer appear in active staff list

All operations should complete without errors.
</verification>

<success_criteria>
- Staff creation succeeds and new member appears immediately
- Staff editing saves changes that persist across refresh
- Staff deletion (deactivation) removes from active list
- Service assignments save and display correctly
- Availability schedules save and display correctly
- All operations complete within expected timeframes
- Error messages are user-friendly when operations fail
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-data-flows/02-01-SUMMARY.md`
</output>
