---
phase: 02-core-data-flows
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routes/locations.ts
  - apps/web/src/app/locations/page.tsx
  - apps/web/src/hooks/useLocations.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Owner can switch between locations using the location selector"
    - "Location selection persists across page navigation and refresh"
    - "Owner can create a new location with address and hours"
    - "Owner can edit location details and changes apply immediately"
    - "Location hours save correctly with open/close times per day"
  artifacts:
    - path: "apps/api/src/routes/locations.ts"
      provides: "Location CRUD and settings operations"
      exports: ["locationsRouter"]
    - path: "apps/web/src/hooks/useLocations.tsx"
      provides: "Location data fetching, context, and mutations"
      exports: ["useLocations", "useLocationContext", "LocationProvider"]
  key_links:
    - from: "apps/web/src/components/LocationSwitcher.tsx"
      to: "useLocationContext"
      via: "React context"
      pattern: "useLocationContext"
    - from: "apps/web/src/app/locations/page.tsx"
      to: "/api/v1/locations"
      via: "useLocationContext hook"
      pattern: "api\\.(get|post|patch|delete).*locations"
---

<objective>
Verify and fix location switching and management

Purpose: Multi-location support is critical for salons with multiple branches. This plan ensures owners can switch locations and manage location settings reliably.

Output: Working location switching and CRUD operations
</objective>

<execution_context>
@C:\Users\aaron\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\aaron\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-data-flows/02-RESEARCH.md
@apps/api/src/routes/locations.ts
@apps/web/src/hooks/useLocations.tsx
@apps/web/src/app/locations/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test and fix location switching</name>
  <files>apps/web/src/components/LocationSwitcher.tsx, apps/web/src/hooks/useLocations.tsx</files>
  <action>
Test location switching functionality:
1. Ensure test salon has at least 2 locations (create via API if needed)
2. Log in as owner
3. Find and use the LocationSwitcher component in the UI
4. Switch between locations

Verify:
- LocationSwitcher shows all salon locations
- Selected location is visually indicated
- Selection persists in localStorage after switching
- After page refresh, previously selected location is still selected

Test context propagation:
1. Switch to Location A
2. Navigate to different pages (Dashboard, Staff, Calendar)
3. Verify selectedLocationId is consistent across pages

Fix any issues found:
- If LocationSwitcher doesn't appear, check if LocationProvider wraps the app
- If selection doesn't persist, verify localStorage read/write in useLocations
- If context doesn't propagate, ensure components use useLocationContext

Edge cases:
- Test with single-location salon (switcher should be hidden or show only one option)
- Test after deleting selected location (should fall back to primary or first location)
  </action>
  <verify>
Switch locations and verify:
- localStorage.getItem('selectedLocationId') returns the selected location ID
- After refresh, same location is still selected
- Navigating to different pages maintains selection
  </verify>
  <done>Location switching works and persists correctly</done>
</task>

<task type="auto">
  <name>Task 2: Test and fix location CRUD operations</name>
  <files>apps/api/src/routes/locations.ts, apps/web/src/app/locations/page.tsx</files>
  <action>
Test location creation:
1. Navigate to Locations page
2. Click "Add Location"
3. Fill in name, address, city, state, zip, phone, timezone
4. Submit the form

Verify:
- API returns 201 with created location
- New location appears in list immediately
- Multi-location check: If salon doesn't have multiLocationEnabled, second location should fail with MULTI_LOCATION_REQUIRED error

Test location editing:
1. Click edit on existing location
2. Modify address and phone
3. Save changes

Verify:
- PATCH /api/v1/locations/:id returns updated location
- Changes display immediately
- Changes persist after refresh

Test location deletion:
1. Attempt to delete non-primary location
2. Confirm deletion

Verify:
- DELETE /api/v1/locations/:id succeeds
- Location removed from list
- Future appointments check prevents deletion if appointments exist

Fix any issues found:
- If create fails, check validation and error messages
- If edit doesn't save, verify PATCH handler
- If delete of primary fails incorrectly, check the business logic

Test primary location handling:
- Set a location as primary
- Verify old primary loses its flag
- Cannot delete primary while other locations exist
  </action>
  <verify>
Create a location, edit it, then verify:
- curl -X GET /api/v1/locations returns updated list
- New location has all fields correct
Delete a non-primary location and verify:
- Location no longer in GET /api/v1/locations response
  </verify>
  <done>Location CRUD operations work reliably</done>
</task>

<task type="auto">
  <name>Task 3: Test and fix location hours management</name>
  <files>apps/api/src/routes/locations.ts, apps/web/src/app/locations/page.tsx</files>
  <action>
Test location hours:
1. Navigate to location details/settings
2. Find hours editor
3. Set custom hours:
   - Monday-Friday: 9:00 AM - 6:00 PM
   - Saturday: 10:00 AM - 4:00 PM
   - Sunday: Closed
4. Save hours

Verify:
- PUT /api/v1/locations/:id/hours saves all 7 days
- Hours display correctly when viewing location
- Closed days show as closed

Test hours retrieval:
1. Reload page
2. Verify hours still display correctly
3. GET /api/v1/locations/:id/hours returns saved hours

Fix any issues found:
- If hours don't save, check the upsert logic for LocationHours
- If times display incorrectly, verify time format consistency (HH:mm)
- If closed status doesn't save, check isClosed field handling

Edge cases:
- Save with all days closed (should be allowed)
- Save with invalid times (close before open) - should validate
- Location with no hours set (should return defaults)
  </action>
  <verify>
Save custom hours for a location, then verify:
- curl -X GET /api/v1/locations/:id/hours returns correct hours for all 7 days
- Sunday shows isClosed: true
- Weekday times match what was set
  </verify>
  <done>Location hours save and display correctly</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Create a new location with all details
2. Set custom business hours for the location
3. Switch to the new location using LocationSwitcher
4. Navigate to Dashboard and verify selection persisted
5. Edit the location details
6. Delete a non-primary location (or the one created)

All operations should complete without errors.
</verification>

<success_criteria>
- Location switching works across all pages
- Location selection persists in localStorage and survives refresh
- Location creation succeeds with proper validation
- Location editing saves changes immediately
- Location deletion works with proper constraints (no future appointments, not primary with others)
- Business hours save correctly with open/close times and closed days
- Multi-location feature gate works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-data-flows/02-02-SUMMARY.md`
</output>
