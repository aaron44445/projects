---
phase: 03-online-booking-widget
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/api/src/__tests__/booking-concurrency.test.ts
  - apps/api/scripts/load-test-booking.js
autonomous: false

must_haves:
  truths:
    - "100 concurrent booking attempts for same slot result in exactly 1 success"
    - "99 concurrent booking attempts receive TIME_CONFLICT error"
    - "0% double-bookings occur under load"
    - "Load test is repeatable and automated"
  artifacts:
    - path: "apps/api/src/__tests__/booking-concurrency.test.ts"
      provides: "Integration test for concurrent booking prevention"
      contains: "concurrent"
    - path: "apps/api/scripts/load-test-booking.js"
      provides: "k6 load test script for double-booking verification"
      contains: "k6"
  key_links:
    - from: "apps/api/scripts/load-test-booking.js"
      to: "POST /api/v1/public/:slug/book"
      via: "HTTP requests"
      pattern: "http.post"
---

<objective>
Create load tests to verify double-booking prevention works under concurrent load.

Purpose: Unit tests cannot catch race conditions that only appear under concurrent load. This plan creates automated tests that simulate 100 users booking the exact same time slot simultaneously, verifying that database-level locking prevents any double-bookings.

Output: Integration tests and k6 load test scripts that verify 0% double-bookings.
</objective>

<execution_context>
@C:\Users\aaron\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\aaron\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-online-booking-widget/03-RESEARCH.md
@.planning/phases/03-online-booking-widget/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create concurrent booking integration test</name>
  <files>apps/api/src/__tests__/booking-concurrency.test.ts</files>
  <action>
Create an integration test that simulates concurrent booking attempts:

1. Use vitest with the existing test setup from `apps/api/src/__tests__/setup.ts`

2. **Setup fixture:**
   - Create a test salon with booking enabled
   - Create a test service (30 min duration)
   - Create a test staff member (onlineBookingEnabled: true)
   - Pick a specific future time slot

3. **Test: "prevents double booking under concurrent load"**
```typescript
it('prevents double booking under concurrent load', async () => {
  const concurrentRequests = 20; // Lower than 100 for test speed, still catches race conditions
  const targetTime = new Date();
  targetTime.setDate(targetTime.getDate() + 1);
  targetTime.setHours(10, 0, 0, 0);

  // Create N booking requests simultaneously
  const promises = Array(concurrentRequests).fill(null).map((_, i) =>
    request(app)
      .post(`/api/v1/public/${testSalon.slug}/book`)
      .send({
        serviceId: testService.id,
        staffId: testStaff.id,
        startTime: targetTime.toISOString(),
        firstName: 'Test',
        lastName: `User${i}`,
        email: `test${i}@example.com`,
      })
  );

  const results = await Promise.all(promises);

  // Count successes and conflicts
  const successes = results.filter(r => r.status === 201);
  const conflicts = results.filter(r => r.status === 400 && r.body?.error?.code === 'TIME_CONFLICT');
  const errors = results.filter(r => r.status !== 201 && r.status !== 400);

  // Exactly one success
  expect(successes.length).toBe(1);

  // Rest are conflicts
  expect(conflicts.length).toBe(concurrentRequests - 1);

  // No unexpected errors
  expect(errors.length).toBe(0);

  // Verify only one appointment exists in database
  const appointments = await prisma.appointment.findMany({
    where: {
      salonId: testSalon.id,
      staffId: testStaff.id,
      startTime: targetTime,
      status: { notIn: ['cancelled'] },
    },
  });
  expect(appointments.length).toBe(1);
});
```

4. **Test: "alternatives returned on conflict"**
```typescript
it('returns alternative slots when time is taken', async () => {
  // First booking succeeds
  const firstBooking = await request(app)
    .post(`/api/v1/public/${testSalon.slug}/book`)
    .send({ /* ... */ });
  expect(firstBooking.status).toBe(201);

  // Second booking conflicts but gets alternatives
  const secondBooking = await request(app)
    .post(`/api/v1/public/${testSalon.slug}/book`)
    .send({ /* same time */ });

  expect(secondBooking.status).toBe(400);
  expect(secondBooking.body.error.code).toBe('TIME_CONFLICT');
  expect(secondBooking.body.alternatives).toBeDefined();
  expect(Array.isArray(secondBooking.body.alternatives)).toBe(true);
});
```
  </action>
  <verify>
```bash
pnpm --filter @peacase/api test booking-concurrency
```
All tests pass.
  </verify>
  <done>
Integration tests exist that verify concurrent booking prevention and alternative slot responses.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create k6 load test script</name>
  <files>apps/api/scripts/load-test-booking.js</files>
  <action>
Create a k6 load test script for verifying double-booking prevention at scale:

```javascript
// apps/api/scripts/load-test-booking.js
// Run with: k6 run apps/api/scripts/load-test-booking.js
//
// Requires: TEST_SALON_SLUG, TEST_SERVICE_ID, TEST_STAFF_ID env vars
// Or uses defaults for demo salon

import http from 'k6/http';
import { check, sleep } from 'k6';
import { Counter } from 'k6/metrics';

const successes = new Counter('booking_successes');
const conflicts = new Counter('booking_conflicts');
const errors = new Counter('booking_errors');

export const options = {
  scenarios: {
    double_booking_test: {
      executor: 'shared-iterations',
      vus: 100,           // 100 virtual users
      iterations: 100,    // 100 total requests (1 per VU)
      maxDuration: '60s',
    },
  },
  thresholds: {
    'booking_successes': ['count==1'],     // Exactly 1 success
    'booking_conflicts': ['count==99'],    // 99 conflicts
    'booking_errors': ['count==0'],        // No unexpected errors
  },
};

const BASE_URL = __ENV.BASE_URL || 'http://localhost:3001';
const SALON_SLUG = __ENV.TEST_SALON_SLUG || 'demo';
const SERVICE_ID = __ENV.TEST_SERVICE_ID || '';  // Must be set for real test
const STAFF_ID = __ENV.TEST_STAFF_ID || '';       // Must be set for real test

// Calculate target time: tomorrow at 10:00 AM
const tomorrow = new Date();
tomorrow.setDate(tomorrow.getDate() + 1);
tomorrow.setHours(10, 0, 0, 0);
const TARGET_TIME = tomorrow.toISOString();

export default function () {
  const payload = JSON.stringify({
    serviceId: SERVICE_ID,
    staffId: STAFF_ID,
    startTime: TARGET_TIME,
    firstName: 'Load',
    lastName: `Test${__VU}`,
    email: `loadtest-${__VU}-${Date.now()}@example.com`,
  });

  const params = {
    headers: {
      'Content-Type': 'application/json',
    },
  };

  const res = http.post(
    `${BASE_URL}/api/v1/public/${SALON_SLUG}/book`,
    payload,
    params
  );

  const result = check(res, {
    'booking succeeded': (r) => r.status === 201,
    'booking conflicted': (r) => r.status === 400,
  });

  if (res.status === 201) {
    successes.add(1);
  } else if (res.status === 400) {
    const body = JSON.parse(res.body);
    if (body.error && body.error.code === 'TIME_CONFLICT') {
      conflicts.add(1);
    } else {
      errors.add(1);
      console.log(`Unexpected 400: ${res.body}`);
    }
  } else {
    errors.add(1);
    console.log(`Unexpected status ${res.status}: ${res.body}`);
  }
}

export function teardown(data) {
  console.log('\n=== Double-Booking Prevention Test Results ===');
  console.log('Expected: 1 success, 99 conflicts, 0 errors');
  console.log('If successes > 1, double-booking occurred!');
}
```

Add a README section in the file explaining:
- How to set up test data (create salon, service, staff)
- How to run the test
- How to interpret results
  </action>
  <verify>
Script file exists and has valid JavaScript syntax:
```bash
node --check apps/api/scripts/load-test-booking.js
```
  </verify>
  <done>
k6 load test script exists with 100 concurrent request scenario and threshold verification.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Double-booking prevention system with:
1. Transactional booking with pessimistic locking (Plan 01)
2. Availability service with alternative slot suggestions (Plan 02)
3. Concurrent booking integration tests
4. k6 load test script
  </what-built>
  <how-to-verify>
**1. Run integration tests:**
```bash
pnpm --filter @peacase/api test booking-concurrency
```
Verify all tests pass.

**2. Manual booking test:**
- Start API: `pnpm --filter @peacase/api dev`
- Open two browser tabs to the booking widget
- Select the same service, staff, and time slot in both
- Click "Book" in both tabs as simultaneously as possible
- Verify: One succeeds, one shows conflict with alternative slots

**3. (Optional) Run k6 load test:**
If k6 is installed: Set up test data and run:
```bash
k6 run apps/api/scripts/load-test-booking.js
```
Verify: 1 success, 99 conflicts, 0 errors

**4. Check owner calendar:**
After a booking succeeds, verify it appears immediately in the owner's calendar view.
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Integration tests pass:** `pnpm --filter @peacase/api test booking-concurrency` all green
2. **Load test script valid:** JavaScript syntax check passes
3. **Manual verification confirms:**
   - Concurrent bookings result in exactly 1 success
   - Conflict response includes alternative slots
   - Successful booking appears in owner calendar immediately

</verification>

<success_criteria>
- Integration test verifies concurrent booking prevention (20+ simultaneous requests, 1 success)
- Integration test verifies alternative slots returned on conflict
- k6 load test script ready for 100-request scenario
- Manual verification confirms end-to-end booking flow works
- 0% double-bookings observed in any testing scenario
</success_criteria>

<output>
After completion, create `.planning/phases/03-online-booking-widget/03-03-SUMMARY.md`
</output>
