---
phase: 03-online-booking-widget
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/api/src/routes/public.ts
  - apps/api/src/services/availability.ts
autonomous: true

must_haves:
  truths:
    - "Availability calculation always includes buffer time in slot duration"
    - "Available slots respect business hours, staff availability, and time off"
    - "When booking conflict occurs, response includes alternative time slots"
    - "Alternative slots are for the same service and same staff (if specific staff was selected)"
  artifacts:
    - path: "apps/api/src/services/availability.ts"
      provides: "Availability calculation service with alternative slot suggestions"
      exports: ["calculateAvailableSlots", "findAlternativeSlots"]
    - path: "apps/api/src/routes/public.ts"
      provides: "Booking endpoint returns alternatives on conflict"
      contains: "alternatives"
  key_links:
    - from: "apps/api/src/routes/public.ts"
      to: "apps/api/src/services/availability.ts"
      via: "import and function call"
      pattern: "findAlternativeSlots"
---

<objective>
Audit and enhance availability calculation, and add alternative slot suggestions when booking conflicts occur.

Purpose: When a client attempts to book a slot that's no longer available (race condition or stale data), they should see helpful alternatives rather than just an error. This improves UX and conversion rate for online bookings.

Output: An availability service module with consistent slot calculation logic, and the booking endpoint enhanced to return alternatives on conflict.
</objective>

<execution_context>
@C:\Users\aaron\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\aaron\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-online-booking-widget/03-CONTEXT.md
@.planning/phases/03-online-booking-widget/03-RESEARCH.md

# Key source files
@apps/api/src/routes/public.ts (lines 340-646 - current availability endpoint)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create availability service module</name>
  <files>apps/api/src/services/availability.ts</files>
  <action>
Extract and consolidate availability logic into a reusable service module:

1. **Types:**
```typescript
interface AvailableSlot {
  time: string;        // "HH:mm" format
  staffId: string;
  staffName: string;
  startTime: Date;     // Full datetime for booking
  endTime: Date;       // Full datetime for booking
}

interface AvailabilityParams {
  salonId: string;
  locationId?: string;
  serviceId: string;
  staffId?: string;
  date: Date;
}
```

2. **Export `calculateAvailableSlots(params: AvailabilityParams)`:**
   - Refactor the existing logic from GET /:slug/availability endpoint
   - CRITICAL: Always use `totalDuration = service.durationMinutes + (service.bufferMinutes || 0)` for slot generation
   - Return array of AvailableSlot objects with full datetime info (not just time string)
   - Include staff filtering logic (assigned + unassigned to location pattern from 02-03)

3. **Export `findAlternativeSlots(params: AvailabilityParams & { excludeTime: Date, limit?: number })`:**
   - Find available slots within the same day first
   - If not enough, expand to next 7 days
   - Exclude the conflicted time slot
   - Return up to `limit` slots (default 3)
   - If staffId specified, alternatives must be for same staff
   - If staffId not specified, alternatives can be any available staff

4. **Helper function `hasConflict(staffId, slotStart, slotEnd, appointments)`:**
   - Extract from existing code
   - Used by both availability and alternative calculation
  </action>
  <verify>
```bash
pnpm --filter @peacase/api exec tsc --noEmit
```
  </verify>
  <done>
Availability service exists with calculateAvailableSlots and findAlternativeSlots functions, consistently using buffer time in calculations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor availability endpoint to use service</name>
  <files>apps/api/src/routes/public.ts</files>
  <action>
Refactor GET /:slug/availability endpoint to use the new availability service:

1. Import at top:
```typescript
import { calculateAvailableSlots, AvailableSlot } from '../services/availability';
```

2. Replace the inline slot generation logic (lines 547-640) with:
```typescript
const slots = await calculateAvailableSlots({
  salonId: salon.id,
  locationId: locationId as string | undefined,
  serviceId: serviceId as string,
  staffId: staffId as string | undefined,
  date: requestedDate,
});
```

3. Keep all the validation logic (salon lookup, service lookup, booking enabled check, date range checks) - just replace the slot calculation part.

4. Transform response to match current format:
```typescript
res.json({
  success: true,
  data: slots.map(s => ({
    time: s.time,
    staffId: s.staffId,
    staffName: s.staffName,
  })),
});
```
  </action>
  <verify>
1. TypeScript compiles: `pnpm --filter @peacase/api exec tsc --noEmit`
2. Manual test: Start API, call availability endpoint with valid params, verify slots returned
  </verify>
  <done>
Availability endpoint uses service module, maintaining backward-compatible response format.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add alternative slots to booking conflict response</name>
  <files>apps/api/src/routes/public.ts</files>
  <action>
Enhance the booking endpoint to return alternative slots when a conflict occurs:

1. Import the findAlternativeSlots function:
```typescript
import { calculateAvailableSlots, findAlternativeSlots } from '../services/availability';
```

2. In the BookingConflictError catch block, before returning the error response:
```typescript
if (error instanceof BookingConflictError) {
  // Find alternative slots
  const alternatives = await findAlternativeSlots({
    salonId: salon.id,
    locationId: locationId || undefined,
    serviceId: serviceId,
    staffId: staffId || undefined, // Only same staff if client selected specific staff
    date: new Date(startTime),
    excludeTime: new Date(startTime),
    limit: 3,
  });

  return res.status(400).json({
    success: false,
    error: {
      code: 'TIME_CONFLICT',
      message: 'This time slot is no longer available',
    },
    alternatives: alternatives.map(slot => ({
      time: slot.time,
      date: slot.startTime.toISOString().split('T')[0],
      staffId: slot.staffId,
      staffName: slot.staffName,
    })),
  });
}
```

3. The alternatives array will be empty if no alternatives found (acceptable - frontend can handle this).
  </action>
  <verify>
1. TypeScript compiles: `pnpm --filter @peacase/api exec tsc --noEmit`
2. Existing tests pass: `pnpm --filter @peacase/api test`
  </verify>
  <done>
Booking endpoint returns alternatives array in conflict response, containing up to 3 alternative time slots.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **TypeScript clean:** `pnpm --filter @peacase/api exec tsc --noEmit` exits 0
2. **Tests pass:** `pnpm --filter @peacase/api test` all green
3. **Manual verification:**
   - Call GET /public/:slug/availability - returns slots with buffer time correctly included
   - Attempt booking a conflicted slot - response includes `alternatives` array
4. **Code review:**
   - All slot calculations use `durationMinutes + (bufferMinutes || 0)`
   - findAlternativeSlots respects staffId constraint when provided
   - Alternative slots search same day first, then next 7 days

</verification>

<success_criteria>
- Availability service module exists with calculateAvailableSlots and findAlternativeSlots
- Buffer time consistently included in slot duration (service.durationMinutes + service.bufferMinutes)
- Availability endpoint refactored to use service (backward compatible response)
- Booking conflict response includes alternatives array with up to 3 alternative slots
- Alternatives respect staff selection (if client chose specific staff, alternatives are for same staff)
</success_criteria>

<output>
After completion, create `.planning/phases/03-online-booking-widget/03-02-SUMMARY.md`
</output>
