---
phase: 21-availability-time-off
plan: 03
type: execute
wave: 2
depends_on: ["21-01", "21-02"]
files_modified:
  - apps/api/src/routes/salon.ts
  - apps/web/src/app/staff/time-off/page.tsx
  - apps/web/src/app/staff/schedule/page.tsx
autonomous: true

must_haves:
  truths:
    - "Staff receives notification when time-off request is approved/rejected"
    - "Time-off page shows type dropdown (Vacation, Sick, Personal, Other)"
    - "Staff can see reviewer notes on approved/rejected requests"
  artifacts:
    - path: "apps/api/src/routes/salon.ts"
      provides: "NotificationJob creation on time-off status change"
      contains: "notificationJob.create"
    - path: "apps/web/src/app/staff/time-off/page.tsx"
      provides: "Type dropdown in request form"
      contains: "type"
  key_links:
    - from: "apps/api/src/routes/salon.ts"
      to: "prisma.notificationJob"
      via: "Create notification after approving/rejecting time-off"
      pattern: "notificationJob\\.create"
---

<objective>
Add staff notifications for time-off status changes and polish the time-off request UI.

Purpose: Staff need to know when their requests are reviewed. The UI should match CONTEXT.md specs for type dropdown.

Output: Notifications created on approve/reject, type dropdown in form, reviewer notes displayed.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-availability-time-off/21-CONTEXT.md
@.planning/phases/21-availability-time-off/21-RESEARCH.md
@.planning/phases/21-availability-time-off/21-01-SUMMARY.md
@.planning/phases/21-availability-time-off/21-02-SUMMARY.md

Key existing patterns:
- NotificationJob model exists for async notification queue
- Time-off page already has form but uses simple reason textarea
- Database TimeOff model has type field (vacation, sick, personal, other)
- STATUS_COLORS used for status badges
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add notification creation on time-off approval/rejection</name>
  <files>apps/api/src/routes/salon.ts</files>
  <action>
Modify the PATCH /salon/time-off-requests/:id endpoint (created in Plan 02) to create a notification after updating the time-off status:

After the `prisma.timeOff.update` call, add notification creation:

```typescript
// Create notification for staff
await prisma.notificationJob.create({
  data: {
    salonId,
    type: `time_off_${data.status}`,
    payload: JSON.stringify({
      staffId: updated.staffId,
      staffEmail: updated.staff.email,
      staffName: `${updated.staff.firstName} ${updated.staff.lastName}`,
      startDate: updated.startDate.toISOString(),
      endDate: updated.endDate.toISOString(),
      status: data.status,
      reviewNotes: data.reviewNotes || null,
    }),
    status: 'pending',
  },
});
```

Update the include clause to also select staff email:
```typescript
include: {
  staff: {
    select: { id: true, firstName: true, lastName: true, email: true },
  },
},
```

Note: The actual notification delivery is handled by the existing notification worker. We just need to create the job record.
  </action>
  <verify>
```bash
cd apps/api && npx tsc --noEmit 2>&1 | head -20
```
TypeScript compiles without errors.
  </verify>
  <done>NotificationJob created when time-off request is approved or rejected</done>
</task>

<task type="auto">
  <name>Task 2: Add type dropdown to time-off request form</name>
  <files>apps/web/src/app/staff/time-off/page.tsx</files>
  <action>
Update the time-off request modal form to include a type dropdown:

1. Add type to form state (around line 44):
```typescript
const [formData, setFormData] = useState({
  startDate: '',
  endDate: '',
  type: 'vacation' as 'vacation' | 'sick' | 'personal' | 'other',
  reason: '',
});
```

2. Add type dropdown to the form (after the date inputs grid, around line 366):
```typescript
<div>
  <label className="block text-sm font-medium text-charcoal mb-2">
    Type
  </label>
  <select
    value={formData.type}
    onChange={(e) =>
      setFormData((prev) => ({ ...prev, type: e.target.value as typeof formData.type }))
    }
    className="w-full px-4 py-3 rounded-xl border border-charcoal/20 focus:border-sage focus:ring-2 focus:ring-sage/20 outline-none transition-all"
  >
    <option value="vacation">Vacation / PTO</option>
    <option value="sick">Sick Leave</option>
    <option value="personal">Personal Day</option>
    <option value="other">Other</option>
  </select>
</div>
```

3. Update handleSubmit to include type in the API call (around line 92):
```typescript
const response = await api.post<TimeOffRequest>('/staff-portal/time-off', {
  ...formData,
  type: formData.type,
});
```

4. Reset type in form reset (in onClose handler, around line 96 and 323):
```typescript
setFormData({ startDate: '', endDate: '', type: 'vacation', reason: '' });
```

5. Update TimeOffRequest interface to include type (around line 22):
```typescript
interface TimeOffRequest {
  id: string;
  startDate: string;
  endDate: string;
  type: 'vacation' | 'sick' | 'personal' | 'other';
  reason: string;
  status: 'pending' | 'approved' | 'denied';
  createdAt: string;
  reviewedBy?: string;
  reviewedAt?: string;
  reviewNotes?: string;
}
```

6. Display type in the request list (in the request card, around line 283):
Add after the status badge:
```typescript
<span className="text-sm text-charcoal/60 capitalize">
  {request.type === 'vacation' ? 'PTO' : request.type}
</span>
```
  </action>
  <verify>
```bash
cd apps/web && npx tsc --noEmit 2>&1 | head -20
```
TypeScript compiles without errors.
  </verify>
  <done>Time-off form has type dropdown with Vacation/Sick/Personal/Other options</done>
</task>

<task type="auto">
  <name>Task 3: Display reviewer notes on approved/rejected requests</name>
  <files>apps/web/src/app/staff/time-off/page.tsx</files>
  <action>
Ensure reviewer notes are displayed prominently on reviewed requests.

The current implementation already shows reviewNotes (around line 285-291), but enhance it:

1. Update the reviewer notes display to be more visible:
```typescript
{request.reviewNotes && (
  <div className="mt-3 ml-8 p-3 bg-charcoal/5 rounded-lg">
    <p className="text-sm text-charcoal/60">
      <span className="font-medium">
        {request.status === 'approved' ? 'Approved' : request.status === 'denied' ? 'Denied' : 'Manager'} note:
      </span>{' '}
      {request.reviewNotes}
    </p>
    {request.reviewedAt && (
      <p className="text-xs text-charcoal/40 mt-1">
        {new Date(request.reviewedAt).toLocaleDateString('en-US', {
          month: 'short', day: 'numeric', year: 'numeric'
        })}
      </p>
    )}
  </div>
)}
```

2. If an approved request was auto-approved (reviewNotes === 'Auto-approved'), show differently:
```typescript
{request.status === 'approved' && request.reviewNotes === 'Auto-approved' && (
  <div className="mt-3 ml-8 flex items-center gap-2 text-xs text-sage">
    <CheckCircle2 className="w-4 h-4" />
    <span>Automatically approved</span>
  </div>
)}
{request.reviewNotes && request.reviewNotes !== 'Auto-approved' && (
  <div className="mt-3 ml-8 p-3 bg-charcoal/5 rounded-lg">
    <p className="text-sm text-charcoal/60">
      <span className="font-medium">Manager note:</span> {request.reviewNotes}
    </p>
  </div>
)}
```

This distinguishes auto-approved requests from manually approved ones with notes.
  </action>
  <verify>
```bash
cd apps/web && npx tsc --noEmit 2>&1 | head -20
```
TypeScript compiles without errors.
  </verify>
  <done>Reviewer notes displayed on approved/rejected requests, auto-approved requests marked distinctly</done>
</task>

</tasks>

<verification>
1. Notification check: `grep -n "notificationJob.create" apps/api/src/routes/salon.ts` shows notification creation
2. Type dropdown check: `grep -n "vacation.*sick.*personal" apps/web/src/app/staff/time-off/page.tsx` shows options
3. Review notes check: `grep -n "Auto-approved\|reviewNotes" apps/web/src/app/staff/time-off/page.tsx` shows display logic
4. TypeScript: Both apps compile without errors
</verification>

<success_criteria>
- When owner approves/rejects time-off, NotificationJob record is created
- Time-off request form has type dropdown with 4 options
- Submitted requests include type in the API call
- Request list shows type for each request
- Approved/rejected requests show reviewer's note if provided
- Auto-approved requests show "Automatically approved" indicator
</success_criteria>

<output>
After completion, create `.planning/phases/21-availability-time-off/21-03-SUMMARY.md`
</output>
