---
phase: 21-availability-time-off
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routes/salon.ts
  - apps/web/src/hooks/useSalon.ts
  - apps/web/src/app/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "Owner can see pending time-off requests in settings"
    - "Owner can approve time-off request with optional note"
    - "Owner can reject time-off request with optional note"
    - "Owner can toggle requireTimeOffApproval setting"
  artifacts:
    - path: "apps/api/src/routes/salon.ts"
      provides: "GET /time-off-requests and PATCH /time-off-requests/:id endpoints"
      contains: "time-off-requests"
    - path: "apps/web/src/app/settings/page.tsx"
      provides: "Staff Policies section with approval toggle and pending requests"
      contains: "requireTimeOffApproval"
  key_links:
    - from: "apps/web/src/app/settings/page.tsx"
      to: "/api/v1/salon/time-off-requests"
      via: "fetch for pending requests and approve/reject actions"
      pattern: "time-off-requests"
---

<objective>
Create owner approval UI for time-off requests in the settings page.

Purpose: When salon has requireTimeOffApproval=true, owners need a place to review and approve/reject staff time-off requests.

Output: New settings section for staff policies with approval toggle and pending requests list.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-availability-time-off/21-CONTEXT.md
@.planning/phases/21-availability-time-off/21-RESEARCH.md

Key existing patterns:
- Settings page uses section-based layout with icons
- TimeOff model has reviewedBy, reviewedAt, reviewNotes fields ready for approval
- STATUS_COLORS for status badges (pending=lavender, approved=sage, rejected=rose)
- Modal component from @peacase/ui for approval/reject dialogs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add owner time-off API endpoints</name>
  <files>apps/api/src/routes/salon.ts</files>
  <action>
Add endpoints for owner to manage staff time-off requests:

1. **GET /api/v1/salon/time-off-requests** - List pending time-off requests for all staff
```typescript
router.get('/time-off-requests', asyncHandler(async (req: Request, res: Response) => {
  const salonId = req.user!.salonId;
  const { status } = req.query; // Optional filter: 'pending', 'approved', 'rejected'

  const requests = await prisma.timeOff.findMany({
    where: {
      staff: { salonId },
      ...(status ? { status: status as string } : {}),
    },
    include: {
      staff: {
        select: { id: true, firstName: true, lastName: true, email: true },
      },
    },
    orderBy: [{ status: 'asc' }, { startDate: 'asc' }], // pending first, then by date
  });

  res.json({ success: true, data: requests });
}));
```

2. **PATCH /api/v1/salon/time-off-requests/:id** - Approve or reject request
```typescript
const timeOffReviewSchema = z.object({
  status: z.enum(['approved', 'rejected']),
  reviewNotes: z.string().optional(),
});

router.patch('/time-off-requests/:id', asyncHandler(async (req: Request, res: Response) => {
  const { id } = req.params;
  const salonId = req.user!.salonId;
  const reviewerId = req.user!.userId;
  const data = timeOffReviewSchema.parse(req.body);

  // Verify request belongs to this salon's staff
  const existing = await prisma.timeOff.findFirst({
    where: { id, staff: { salonId } },
  });

  if (!existing) {
    return res.status(404).json({
      success: false,
      error: { code: 'NOT_FOUND', message: 'Time off request not found' },
    });
  }

  const updated = await prisma.timeOff.update({
    where: { id },
    data: {
      status: data.status,
      reviewedAt: new Date(),
      reviewedBy: reviewerId,
      reviewNotes: data.reviewNotes,
    },
    include: {
      staff: {
        select: { id: true, firstName: true, lastName: true },
      },
    },
  });

  res.json({ success: true, data: updated });
}));
```

Place these endpoints after existing salon routes. Import `z` from 'zod' if not already imported.
  </action>
  <verify>
```bash
cd apps/api && npx tsc --noEmit 2>&1 | head -20
```
TypeScript compiles without errors.
  </verify>
  <done>GET /salon/time-off-requests lists pending requests, PATCH approves/rejects</done>
</task>

<task type="auto">
  <name>Task 2: Add time-off requests hook to useSalon</name>
  <files>apps/web/src/hooks/useSalon.ts</files>
  <action>
Add functions to useSalon hook for managing time-off requests:

1. Add types for time-off request with staff info:
```typescript
interface TimeOffRequestWithStaff {
  id: string;
  staffId: string;
  startDate: string;
  endDate: string;
  type: string;
  reason: string | null;
  status: 'pending' | 'approved' | 'rejected';
  reviewedAt: string | null;
  reviewNotes: string | null;
  createdAt: string;
  staff: {
    id: string;
    firstName: string;
    lastName: string;
    email: string;
  };
}
```

2. Add state and functions to the hook:
```typescript
const [timeOffRequests, setTimeOffRequests] = useState<TimeOffRequestWithStaff[]>([]);
const [timeOffLoading, setTimeOffLoading] = useState(false);

const fetchTimeOffRequests = useCallback(async (status?: string) => {
  setTimeOffLoading(true);
  try {
    const url = status ? `/salon/time-off-requests?status=${status}` : '/salon/time-off-requests';
    const response = await api.get<TimeOffRequestWithStaff[]>(url);
    if (response.success && response.data) {
      setTimeOffRequests(response.data);
    }
  } finally {
    setTimeOffLoading(false);
  }
}, []);

const reviewTimeOff = useCallback(async (id: string, status: 'approved' | 'rejected', reviewNotes?: string) => {
  const response = await api.patch<TimeOffRequestWithStaff>(`/salon/time-off-requests/${id}`, {
    status,
    reviewNotes,
  });
  if (response.success) {
    setTimeOffRequests(prev => prev.map(r => r.id === id ? response.data! : r));
  }
  return response;
}, []);
```

3. Export these new values from the hook return object.

Follow existing patterns in the file for error handling and loading states.
  </action>
  <verify>
```bash
cd apps/web && npx tsc --noEmit 2>&1 | head -20
```
TypeScript compiles without errors.
  </verify>
  <done>useSalon exports fetchTimeOffRequests, reviewTimeOff, timeOffRequests, timeOffLoading</done>
</task>

<task type="auto">
  <name>Task 3: Add Staff Policies section to settings page</name>
  <files>apps/web/src/app/settings/page.tsx</files>
  <action>
Add a "Staff Policies" section to the settings page:

1. Add to settingsSections array (around line 63, after 'team'):
```typescript
{ id: 'staff-policies', name: 'Staff Policies', icon: Users, description: 'Time-off approval and schedule settings', requiresPermission: PERMISSIONS.MANAGE_STAFF },
```

2. Create StaffPoliciesSection component:
```typescript
function StaffPoliciesSection() {
  const { salon, updateSalon, fetchTimeOffRequests, reviewTimeOff, timeOffRequests, timeOffLoading } = useSalon();
  const [showReviewModal, setShowReviewModal] = useState<{ request: TimeOffRequestWithStaff; action: 'approve' | 'reject' } | null>(null);
  const [reviewNotes, setReviewNotes] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  useEffect(() => {
    if (salon?.requireTimeOffApproval) {
      fetchTimeOffRequests('pending');
    }
  }, [salon?.requireTimeOffApproval, fetchTimeOffRequests]);

  const handleToggleApproval = async (enabled: boolean) => {
    await updateSalon({ requireTimeOffApproval: enabled });
    if (enabled) {
      fetchTimeOffRequests('pending');
    }
  };

  const handleReview = async () => {
    if (!showReviewModal) return;
    setIsSubmitting(true);
    try {
      await reviewTimeOff(showReviewModal.request.id, showReviewModal.action === 'approve' ? 'approved' : 'rejected', reviewNotes || undefined);
      setShowReviewModal(null);
      setReviewNotes('');
    } finally {
      setIsSubmitting(false);
    }
  };

  const pendingRequests = timeOffRequests.filter(r => r.status === 'pending');

  return (
    <div className="space-y-6">
      {/* Approval Toggle */}
      <div className="bg-white rounded-2xl border border-charcoal/10 p-6">
        <h3 className="font-semibold text-charcoal mb-4">Time-Off Approval</h3>
        <label className="flex items-center gap-3">
          <input
            type="checkbox"
            checked={salon?.requireTimeOffApproval ?? false}
            onChange={(e) => handleToggleApproval(e.target.checked)}
            className="rounded border-charcoal/20 text-sage focus:ring-sage w-5 h-5"
          />
          <div>
            <span className="text-charcoal font-medium">Require manager approval for time-off requests</span>
            <p className="text-sm text-charcoal/60">When enabled, staff time-off requests will need your approval before taking effect</p>
          </div>
        </label>
      </div>

      {/* Pending Requests (only show if approval is required) */}
      {salon?.requireTimeOffApproval && (
        <div className="bg-white rounded-2xl border border-charcoal/10 p-6">
          <div className="flex items-center justify-between mb-4">
            <h3 className="font-semibold text-charcoal">Pending Time-Off Requests</h3>
            {pendingRequests.length > 0 && (
              <span className="px-2 py-1 bg-amber-100 text-amber-700 rounded-full text-sm">
                {pendingRequests.length} pending
              </span>
            )}
          </div>

          {timeOffLoading ? (
            <div className="flex items-center justify-center py-8">
              <Loader2 className="w-6 h-6 animate-spin text-sage" />
            </div>
          ) : pendingRequests.length === 0 ? (
            <p className="text-charcoal/60 text-center py-8">No pending requests</p>
          ) : (
            <div className="space-y-3">
              {pendingRequests.map(request => (
                <div key={request.id} className="flex items-center justify-between p-4 bg-charcoal/5 rounded-xl">
                  <div>
                    <p className="font-medium text-charcoal">
                      {request.staff.firstName} {request.staff.lastName}
                    </p>
                    <p className="text-sm text-charcoal/60">
                      {new Date(request.startDate).toLocaleDateString()} - {new Date(request.endDate).toLocaleDateString()}
                    </p>
                    {request.reason && (
                      <p className="text-sm text-charcoal/50 mt-1">{request.reason}</p>
                    )}
                  </div>
                  <div className="flex gap-2">
                    <button
                      onClick={() => setShowReviewModal({ request, action: 'approve' })}
                      className="px-3 py-1.5 bg-sage text-white rounded-lg text-sm hover:bg-sage-dark"
                    >
                      Approve
                    </button>
                    <button
                      onClick={() => setShowReviewModal({ request, action: 'reject' })}
                      className="px-3 py-1.5 border border-rose-300 text-rose-600 rounded-lg text-sm hover:bg-rose-50"
                    >
                      Reject
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* Review Modal */}
      {showReviewModal && (
        <Modal
          isOpen={true}
          onClose={() => { setShowReviewModal(null); setReviewNotes(''); }}
          title={showReviewModal.action === 'approve' ? 'Approve Time Off' : 'Reject Time Off'}
          size="sm"
        >
          <div className="space-y-4">
            <p className="text-charcoal">
              {showReviewModal.action === 'approve' ? 'Approve' : 'Reject'} time off for{' '}
              <strong>{showReviewModal.request.staff.firstName} {showReviewModal.request.staff.lastName}</strong>?
            </p>
            <p className="text-sm text-charcoal/60">
              {new Date(showReviewModal.request.startDate).toLocaleDateString()} - {new Date(showReviewModal.request.endDate).toLocaleDateString()}
            </p>
            <div>
              <label className="block text-sm text-charcoal/60 mb-1">Note (optional)</label>
              <textarea
                value={reviewNotes}
                onChange={(e) => setReviewNotes(e.target.value)}
                rows={2}
                className="w-full px-3 py-2 rounded-lg border border-charcoal/20 resize-none"
                placeholder="Add a note for the staff member..."
              />
            </div>
            <div className="flex gap-3 pt-2">
              <button
                onClick={() => { setShowReviewModal(null); setReviewNotes(''); }}
                className="flex-1 px-4 py-2 border border-charcoal/20 text-charcoal rounded-lg"
              >
                Cancel
              </button>
              <button
                onClick={handleReview}
                disabled={isSubmitting}
                className={`flex-1 px-4 py-2 rounded-lg text-white ${
                  showReviewModal.action === 'approve' ? 'bg-sage hover:bg-sage-dark' : 'bg-rose-500 hover:bg-rose-600'
                } disabled:opacity-50`}
              >
                {isSubmitting ? 'Processing...' : showReviewModal.action === 'approve' ? 'Approve' : 'Reject'}
              </button>
            </div>
          </div>
        </Modal>
      )}
    </div>
  );
}
```

3. Add the section to the main render switch statement where other sections are rendered.

4. Import Modal from '@peacase/ui' if not already imported.

Use existing styling patterns from other settings sections (rounded-2xl, border-charcoal/10, etc.).
  </action>
  <verify>
```bash
cd apps/web && npx tsc --noEmit 2>&1 | head -20
```
TypeScript compiles without errors.
  </verify>
  <done>Settings page has Staff Policies section with approval toggle and pending requests list</done>
</task>

</tasks>

<verification>
1. API check: `grep -n "time-off-requests" apps/api/src/routes/salon.ts` shows endpoints
2. Hook check: `grep -n "fetchTimeOffRequests\|reviewTimeOff" apps/web/src/hooks/useSalon.ts` shows functions
3. UI check: `grep -n "staff-policies\|Staff Policies" apps/web/src/app/settings/page.tsx` shows section
4. TypeScript: `cd apps/api && npx tsc --noEmit` and `cd apps/web && npx tsc --noEmit` both pass
</verification>

<success_criteria>
- GET /salon/time-off-requests returns pending requests for salon's staff
- PATCH /salon/time-off-requests/:id approves or rejects with review notes
- Settings page has "Staff Policies" section visible to owners
- Toggle switches requireTimeOffApproval on/off
- When toggle is ON, pending requests list shows with approve/reject buttons
- Approve/reject opens modal with optional note field
- After action, request disappears from pending list
</success_criteria>

<output>
After completion, create `.planning/phases/21-availability-time-off/21-02-SUMMARY.md`
</output>
