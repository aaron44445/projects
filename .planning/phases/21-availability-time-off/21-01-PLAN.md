---
phase: 21-availability-time-off
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/prisma/schema.prisma
  - apps/api/src/routes/staffPortal.ts
  - apps/api/src/routes/salon.ts
autonomous: true

must_haves:
  truths:
    - "Time-off requests auto-approve when salon.requireTimeOffApproval=false"
    - "Time-off requests stay pending when salon.requireTimeOffApproval=true"
    - "Salon setting can be updated via API"
  artifacts:
    - path: "packages/database/prisma/schema.prisma"
      provides: "requireTimeOffApproval field on Salon model"
      contains: "requireTimeOffApproval"
    - path: "apps/api/src/routes/staffPortal.ts"
      provides: "Auto-approve logic in POST /time-off"
      contains: "requireTimeOffApproval"
    - path: "apps/api/src/routes/salon.ts"
      provides: "Update endpoint for requireTimeOffApproval"
      contains: "requireTimeOffApproval"
  key_links:
    - from: "apps/api/src/routes/staffPortal.ts"
      to: "prisma.salon"
      via: "Check requireTimeOffApproval before setting status"
      pattern: "salon\\.requireTimeOffApproval"
---

<objective>
Add `requireTimeOffApproval` salon setting and implement auto-approve logic for time-off requests.

Purpose: Most small salons don't need manager approval for time-off. This setting (defaulting to false) enables auto-approval while allowing larger salons to enable approval workflow.

Output: Database migration, API routes updated, auto-approve logic working.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-availability-time-off/21-CONTEXT.md
@.planning/phases/21-availability-time-off/21-RESEARCH.md

Key existing patterns:
- staffCanRequestTimeOff, staffScheduleNeedsApproval already exist in Salon model
- POST /staff-portal/time-off currently hardcodes status='pending'
- Salon GET endpoint returns all settings
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add requireTimeOffApproval to Salon model</name>
  <files>packages/database/prisma/schema.prisma</files>
  <action>
Add `requireTimeOffApproval` field to Salon model:

```prisma
requireTimeOffApproval   Boolean             @default(false) @map("require_time_off_approval")
```

Place it after `staffScheduleNeedsApproval` (around line 72) to group staff-related settings together.

After editing schema.prisma:
1. Run `npx prisma generate` to update Prisma client
2. Run `npx prisma db push` to sync schema with database

DO NOT run migrations (db push is sufficient for adding a column with default value).
  </action>
  <verify>
```bash
cd packages/database && npx prisma db push --accept-data-loss 2>&1 | grep -E "(applied|already in sync)"
```
Prisma client regenerated and database schema synced.
  </verify>
  <done>Salon model has requireTimeOffApproval field with @default(false)</done>
</task>

<task type="auto">
  <name>Task 2: Implement auto-approve logic in time-off creation</name>
  <files>apps/api/src/routes/staffPortal.ts</files>
  <action>
Modify the POST /time-off endpoint (around line 962-1014) to implement auto-approve logic:

1. Find the existing salon query that checks `staffCanRequestTimeOff`
2. Add `requireTimeOffApproval` to the select clause
3. After validation passes, determine status based on setting:
   - If `salon.requireTimeOffApproval === false`: set `status: 'approved'`
   - If `salon.requireTimeOffApproval === true`: set `status: 'pending'`

Example implementation:
```typescript
// Check if salon requires approval
const salon = await prisma.salon.findUnique({
  where: { id: salonId },
  select: { staffCanRequestTimeOff: true, requireTimeOffApproval: true },
});

// ... existing validation ...

// Determine initial status based on salon setting
const initialStatus = salon.requireTimeOffApproval ? 'pending' : 'approved';

const timeOff = await prisma.timeOff.create({
  data: {
    staffId,
    startDate: data.startDate,
    endDate: data.endDate,
    type: data.type,
    reason: data.reason,
    notes: data.notes,
    status: initialStatus,
    // If auto-approved, set reviewed fields
    ...(initialStatus === 'approved' && {
      reviewedAt: new Date(),
      reviewNotes: 'Auto-approved',
    }),
  },
});
```

Important: Keep all existing validation (overlap check, staffCanRequestTimeOff check).
  </action>
  <verify>
```bash
cd apps/api && npx tsc --noEmit 2>&1 | head -20
```
TypeScript compiles without errors.
  </verify>
  <done>POST /time-off auto-approves when requireTimeOffApproval=false, stays pending when true</done>
</task>

<task type="auto">
  <name>Task 3: Add requireTimeOffApproval to salon settings endpoint</name>
  <files>apps/api/src/routes/salon.ts</files>
  <action>
Update the salon settings endpoints to support requireTimeOffApproval:

1. Add to the Zod schema (salonUpdateSchema or create staff policies schema):
```typescript
requireTimeOffApproval: z.boolean().optional(),
```

2. Ensure the PATCH endpoint accepts and updates this field. If using salonUpdateSchema, add the field there.

3. Verify GET /salon already returns all Salon fields (it likely does via findUnique without select).

Pattern reference: Look at how other boolean settings like `staffCanEditSchedule` are handled in the same file.
  </action>
  <verify>
```bash
cd apps/api && npx tsc --noEmit 2>&1 | head -20
```
TypeScript compiles without errors.
  </verify>
  <done>PATCH /salon accepts requireTimeOffApproval boolean, GET /salon returns it</done>
</task>

</tasks>

<verification>
1. Schema check: `grep -n "requireTimeOffApproval" packages/database/prisma/schema.prisma` shows field
2. API check: `grep -n "requireTimeOffApproval" apps/api/src/routes/staffPortal.ts` shows auto-approve logic
3. Settings check: `grep -n "requireTimeOffApproval" apps/api/src/routes/salon.ts` shows PATCH support
4. TypeScript: `cd apps/api && npx tsc --noEmit` passes
</verification>

<success_criteria>
- Salon model has requireTimeOffApproval field defaulting to false
- POST /staff-portal/time-off checks salon.requireTimeOffApproval
- When false: new time-off requests are auto-approved (status='approved')
- When true: new time-off requests stay pending (status='pending')
- PATCH /salon can update requireTimeOffApproval setting
</success_criteria>

<output>
After completion, create `.planning/phases/21-availability-time-off/21-01-SUMMARY.md`
</output>
