---
phase: 17-code-quality
plan: 08
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - apps/api/src/index.ts
  - apps/api/src/lib/errorUtils.ts
  - apps/api/src/lib/env.ts
  - apps/api/src/lib/encryption.ts
  - apps/api/src/lib/sentry.ts
  - apps/api/src/lib/refundHelper.ts
  - apps/api/src/lib/calendar.ts
  - apps/api/src/cron/index.ts
  - apps/api/src/cron/appointmentReminders.ts
  - apps/api/src/workers/notification-worker.ts
autonomous: true

must_haves:
  truths:
    - "All lib files use logger instead of console.log"
    - "All cron files use logger instead of console.log"
    - "notification-worker.ts uses structured logger"
    - "index.ts uses logger for startup messages"
  artifacts:
    - path: "apps/api/src/lib/errorUtils.ts"
      provides: "Error utilities with structured logging"
      contains: "import logger from"
    - path: "apps/api/src/cron/index.ts"
      provides: "Cron scheduler with structured logging"
      contains: "import logger from"
    - path: "apps/api/src/workers/notification-worker.ts"
      provides: "Notification worker with structured logging"
      contains: "import logger from"
  key_links:
    - from: "apps/api/src/index.ts"
      to: "apps/api/src/lib/logger.ts"
      via: "import"
      pattern: "import logger from"
---

<objective>
Migrate remaining lib, cron, and worker files to use structured logging.

Purpose: Complete the console.log migration. These files include core utilities (errorUtils, env, encryption), cron jobs, and the notification worker. Total: ~45 console.log calls across 10 files.
Output: Ten files with structured logger replacing all console.log calls.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-code-quality/17-RESEARCH.md
@.planning/phases/17-code-quality/17-01-SUMMARY.md
@apps/api/src/lib/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate lib files (errorUtils, env, encryption, sentry)</name>
  <files>apps/api/src/lib/errorUtils.ts, apps/api/src/lib/env.ts, apps/api/src/lib/encryption.ts, apps/api/src/lib/sentry.ts</files>
  <action>
**For errorUtils.ts (4 console.log calls):**
1. Add logger import:
```typescript
import logger from './logger.js';
```

2. Replace 4 console.log calls with structured logger:
```typescript
logger.error(err, 'Async handler error');
```

**For env.ts (6 console.log calls):**
1. Add logger import
2. Replace 6 console.log calls:
```typescript
logger.info('Environment validation passed');
logger.error({ missing: missingVars }, 'Missing required environment variables');
```
Note: env.ts is called at startup before logger may be fully configured. Use console for critical startup failures only if needed, but prefer logger.

**For encryption.ts (2 console.log calls):**
1. Add logger import
2. Replace 2 console.log calls:
```typescript
logger.error(err, 'Encryption failed');
logger.warn('Decryption failed - invalid key');
```

**For sentry.ts (2 console.log calls):**
1. Add logger import
2. Replace 2 console.log calls with logger
  </action>
  <verify>
```bash
cd apps/api && npx tsc --noEmit src/lib/errorUtils.ts src/lib/env.ts src/lib/encryption.ts src/lib/sentry.ts
grep -c "console\." src/lib/errorUtils.ts src/lib/env.ts src/lib/encryption.ts src/lib/sentry.ts 2>/dev/null | grep -v ":0$" || echo "All clean"
```
  </verify>
  <done>errorUtils.ts, env.ts, encryption.ts, sentry.ts have 0 console.log calls</done>
</task>

<task type="auto">
  <name>Task 2: Migrate lib files (refundHelper, calendar) and index.ts</name>
  <files>apps/api/src/lib/refundHelper.ts, apps/api/src/lib/calendar.ts, apps/api/src/index.ts</files>
  <action>
**For refundHelper.ts (1 console.log call):**
1. Add logger import
2. Replace 1 console.log call:
```typescript
logger.info({ appointmentId, refundAmount }, 'Processing refund');
```

**For calendar.ts (1 console.log call):**
1. Add logger import
2. Replace 1 console.log call:
```typescript
logger.info({ eventId }, 'Calendar event created');
```

**For index.ts (1 console.log call):**
1. Add logger import at top:
```typescript
import logger from './lib/logger.js';
```

2. Replace startup console.log:
```typescript
// BEFORE
console.log(`Server running on port ${PORT}`);

// AFTER
logger.info({ port: PORT }, 'Server started');
```

3. Also log any other startup events (database connection, etc.) with logger
  </action>
  <verify>
```bash
cd apps/api && npx tsc --noEmit src/lib/refundHelper.ts src/lib/calendar.ts src/index.ts
grep -c "console\." src/lib/refundHelper.ts src/lib/calendar.ts src/index.ts 2>/dev/null | grep -v ":0$" || echo "All clean"
```
  </verify>
  <done>refundHelper.ts, calendar.ts, index.ts have 0 console.log calls</done>
</task>

<task type="auto">
  <name>Task 3: Migrate cron and worker files</name>
  <files>apps/api/src/cron/index.ts, apps/api/src/cron/appointmentReminders.ts, apps/api/src/workers/notification-worker.ts</files>
  <action>
**For cron/index.ts (12 console.log calls):**
1. Add logger import:
```typescript
import logger from '../lib/logger.js';
```

2. Replace 12 console.log calls with structured logger:
```typescript
logger.info({ job: 'appointment-reminders' }, 'Cron job started');
logger.info({ job: 'appointment-reminders', processed: count }, 'Cron job completed');
logger.error(err, 'Cron job failed');
```

**For cron/appointmentReminders.ts (9 console.log calls):**
1. Add logger import
2. Replace 9 console.log calls:
```typescript
logger.info({ appointmentId, reminderType }, 'Sending appointment reminder');
logger.info({ count }, 'Appointment reminders sent');
logger.error(err, 'Failed to send reminder');
```

**For workers/notification-worker.ts (8 console.log calls):**
1. Add logger import:
```typescript
import logger from '../lib/logger.js';
```

2. Replace 8 console.log calls:
```typescript
logger.info({ jobId, type }, 'Processing notification job');
logger.info({ jobId }, 'Notification job completed');
logger.error(err, 'Notification job failed');
logger.warn({ jobId, attempts }, 'Notification job retry');
```
  </action>
  <verify>
```bash
cd apps/api && npx tsc --noEmit src/cron/index.ts src/cron/appointmentReminders.ts src/workers/notification-worker.ts
grep -c "console\." src/cron/index.ts src/cron/appointmentReminders.ts src/workers/notification-worker.ts 2>/dev/null | grep -v ":0$" || echo "All clean"
```
  </verify>
  <done>All cron and worker files have 0 console.log calls</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Zero console.log calls in all 10 files
2. All files import and use logger
3. TypeScript compilation passes
4. All 165 console.log calls across 37 files are now migrated
</verification>

<success_criteria>
- All 10 lib/cron/worker files use structured logger
- Zero console.log/warn/error calls in these files
- Logger calls include relevant context
- CODE-04 requirement (structured logging) complete
</success_criteria>

<output>
After completion, create `.planning/phases/17-code-quality/17-08-SUMMARY.md`
</output>
