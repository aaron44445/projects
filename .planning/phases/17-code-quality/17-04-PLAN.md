---
phase: 17-code-quality
plan: 04
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - apps/api/src/routes/clientPortal.ts
  - apps/api/src/routes/staffPortal.ts
  - apps/api/src/routes/uploads.ts
  - apps/api/src/routes/reports.ts
autonomous: true

must_haves:
  truths:
    - "clientPortal.ts uses explicit Prisma types instead of any"
    - "staffPortal.ts uses explicit Prisma types instead of any"
    - "uploads.ts uses explicit Prisma types instead of any"
    - "reports.ts uses explicit Prisma types instead of any"
    - "All console.log/warn/error calls replaced with logger"
  artifacts:
    - path: "apps/api/src/routes/clientPortal.ts"
      provides: "Typed client portal queries"
      contains: "import logger from"
    - path: "apps/api/src/routes/staffPortal.ts"
      provides: "Typed staff portal queries"
      contains: "import logger from"
    - path: "apps/api/src/routes/uploads.ts"
      provides: "Typed upload queries"
      contains: "import logger from"
    - path: "apps/api/src/routes/reports.ts"
      provides: "Typed report queries"
      contains: "import logger from"
  key_links:
    - from: "apps/api/src/routes/reports.ts"
      to: "apps/api/src/lib/logger.ts"
      via: "import"
      pattern: "import logger from"
---

<objective>
Migrate portal and reporting route files to use explicit Prisma types and structured logging.

Purpose: Portal routes (clientPortal, staffPortal) serve external users. Reports and uploads handle data export and file management. These four files have 2 + 3 + 3 + 6 = 14 console.log calls.
Output: Four route files with explicit types, withSalonId usage, and structured logging.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-code-quality/17-RESEARCH.md
@.planning/phases/17-code-quality/17-01-SUMMARY.md
@apps/api/src/lib/logger.ts
@apps/api/src/lib/prismaUtils.ts
@apps/api/src/routes/clientPortal.ts
@apps/api/src/routes/staffPortal.ts
@apps/api/src/routes/uploads.ts
@apps/api/src/routes/reports.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate clientPortal.ts and staffPortal.ts</name>
  <files>apps/api/src/routes/clientPortal.ts, apps/api/src/routes/staffPortal.ts</files>
  <action>
**For clientPortal.ts:**
1. Add imports at top:
```typescript
import { Prisma } from '@prisma/client';
import logger from '../lib/logger.js';
import { withSalonId } from '../lib/prismaUtils.js';
```

2. Replace `: any` with appropriate Prisma types:
- `Prisma.AppointmentWhereInput` for appointment queries
- `Prisma.ClientWhereInput` for client queries

3. Replace 2 console.log calls with logger

4. Note: clientPortal may use client tokens instead of req.user.salonId - use appropriate context

**For staffPortal.ts:**
1. Add imports (Prisma, logger, withSalonId)
2. Replace `: any` with appropriate Prisma types:
- `Prisma.AppointmentWhereInput` for appointment filters
- `Prisma.StaffWhereInput` for staff queries
3. Replace 3 console.log calls with logger
4. Use withSalonId where staff's salonId is available
  </action>
  <verify>
```bash
cd apps/api && npx tsc --noEmit src/routes/clientPortal.ts src/routes/staffPortal.ts
grep -c ": any" src/routes/clientPortal.ts || echo "0"
grep -c ": any" src/routes/staffPortal.ts || echo "0"
grep -c "console\." src/routes/clientPortal.ts || echo "0"
grep -c "console\." src/routes/staffPortal.ts || echo "0"
```
  </verify>
  <done>clientPortal.ts and staffPortal.ts have 0 `any` types, 0 console.log calls</done>
</task>

<task type="auto">
  <name>Task 2: Migrate uploads.ts</name>
  <files>apps/api/src/routes/uploads.ts</files>
  <action>
Update `apps/api/src/routes/uploads.ts`:

1. Add imports at top:
```typescript
import { Prisma } from '@prisma/client';
import logger from '../lib/logger.js';
import { withSalonId } from '../lib/prismaUtils.js';
```

2. Replace `: any` with appropriate Prisma types:
- `Prisma.FileWhereInput` or `Prisma.UploadWhereInput` (check model name)

3. Replace 3 console.log calls with structured logger:
```typescript
// Log upload events with context
logger.info({ salonId, fileId, fileName }, 'File uploaded');
logger.error(err, 'File upload failed');
logger.warn({ fileId }, 'File ownership verification failed');
```

4. Use withSalonId for tenant filtering in file queries
  </action>
  <verify>
```bash
cd apps/api && npx tsc --noEmit src/routes/uploads.ts
grep -c ": any" src/routes/uploads.ts || echo "0"
grep -c "console\." src/routes/uploads.ts || echo "0"
```
  </verify>
  <done>uploads.ts has 0 `any` types, 0 console.log calls</done>
</task>

<task type="auto">
  <name>Task 3: Migrate reports.ts</name>
  <files>apps/api/src/routes/reports.ts</files>
  <action>
Update `apps/api/src/routes/reports.ts`:

1. Add imports at top:
```typescript
import { Prisma } from '@prisma/client';
import logger from '../lib/logger.js';
import { withSalonId } from '../lib/prismaUtils.js';
```

2. Replace all `: any` with explicit Prisma types:
- `Prisma.AppointmentWhereInput` for appointment reports
- `Prisma.ClientWhereInput` for client reports
- `Prisma.InvoiceWhereInput` for revenue reports
- Date range filters: `Prisma.DateTimeFilter`

3. Replace 6 console.log calls with structured logger:
```typescript
// Report generation logging
logger.info({ salonId, reportType, dateRange }, 'Generating report');
logger.info({ salonId, reportType, rowCount }, 'Report generated');
logger.error(err, 'Report generation failed');
```

4. Use withSalonId for all tenant filtering in report queries

5. For complex date filters:
```typescript
const dateFilter: Prisma.DateTimeFilter = {
  gte: startDate,
  lte: endDate,
};
```
  </action>
  <verify>
```bash
cd apps/api && npx tsc --noEmit src/routes/reports.ts
grep -c ": any" src/routes/reports.ts || echo "0"
grep -c "console\." src/routes/reports.ts || echo "0"
```
  </verify>
  <done>reports.ts has 0 `any` types, 0 console.log calls</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cd apps/api && npm run build` passes
2. Zero `: any` in all four files
3. Zero `console.` in all four files
4. All files import logger and withSalonId
</verification>

<success_criteria>
- All four route files compile without TypeScript errors
- Zero `: any` type annotations in these files
- Zero console.log/warn/error calls in these files
- All files use structured logger with context objects
- All files use withSalonId where appropriate for tenant filtering
</success_criteria>

<output>
After completion, create `.planning/phases/17-code-quality/17-04-SUMMARY.md`
</output>
