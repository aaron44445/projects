---
phase: 17-code-quality
plan: 03
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - apps/api/src/routes/billing.ts
  - apps/api/src/routes/packages.ts
  - apps/api/src/routes/gift-cards.ts
  - apps/api/src/routes/marketing.ts
autonomous: true

must_haves:
  truths:
    - "billing.ts uses explicit Prisma types instead of any"
    - "packages.ts uses Prisma.PackageWhereInput instead of any"
    - "gift-cards.ts uses Prisma.GiftCardWhereInput instead of any"
    - "marketing.ts uses explicit Prisma types instead of any"
    - "All console.log/warn/error calls replaced with logger"
  artifacts:
    - path: "apps/api/src/routes/billing.ts"
      provides: "Typed billing queries"
      contains: "import logger from"
    - path: "apps/api/src/routes/packages.ts"
      provides: "Typed package queries"
      contains: "withSalonId"
    - path: "apps/api/src/routes/gift-cards.ts"
      provides: "Typed gift card queries"
      contains: "Prisma.GiftCardWhereInput"
    - path: "apps/api/src/routes/marketing.ts"
      provides: "Typed marketing queries"
      contains: "import logger from"
  key_links:
    - from: "apps/api/src/routes/billing.ts"
      to: "apps/api/src/lib/logger.ts"
      via: "import"
      pattern: "import logger from"
---

<objective>
Migrate business logic route files to use explicit Prisma types and structured logging.

Purpose: Billing, packages, gift-cards, and marketing routes handle financial and promotional data. These routes have 9 + 7 + 2 + 6 = 24 console.log calls to replace.
Output: Four route files with explicit types, withSalonId usage, and structured logging.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-code-quality/17-RESEARCH.md
@.planning/phases/17-code-quality/17-01-SUMMARY.md
@apps/api/src/lib/logger.ts
@apps/api/src/lib/prismaUtils.ts
@apps/api/src/routes/billing.ts
@apps/api/src/routes/packages.ts
@apps/api/src/routes/gift-cards.ts
@apps/api/src/routes/marketing.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate billing.ts to explicit types and logger</name>
  <files>apps/api/src/routes/billing.ts</files>
  <action>
Update `apps/api/src/routes/billing.ts`:

1. Add imports at top:
```typescript
import { Prisma } from '@prisma/client';
import logger from '../lib/logger.js';
import { withSalonId } from '../lib/prismaUtils.js';
```

2. Replace all `: any` filter patterns with explicit Prisma types:
- `Prisma.InvoiceWhereInput` for invoice filters
- `Prisma.SubscriptionWhereInput` for subscription filters
- `Prisma.PaymentWhereInput` for payment filters (if applicable)

3. Replace all 9 console.log/warn/error calls with logger:
```typescript
// Use context object for structured data
logger.info({ salonId, invoiceId }, 'Invoice created');
logger.error(err, 'Failed to process payment');
logger.warn({ customerId }, 'Customer approaching credit limit');
```

4. Use withSalonId for tenant filtering:
```typescript
const where: Prisma.InvoiceWhereInput = {
  ...withSalonId(req.user!.salonId),
  status: 'pending',
};
```
  </action>
  <verify>
```bash
cd apps/api && npx tsc --noEmit src/routes/billing.ts
grep -c ": any" src/routes/billing.ts || echo "0"
grep -c "console\." src/routes/billing.ts || echo "0"
```
  </verify>
  <done>billing.ts has 0 `any` types, 0 console.log calls</done>
</task>

<task type="auto">
  <name>Task 2: Migrate packages.ts to explicit types and logger</name>
  <files>apps/api/src/routes/packages.ts</files>
  <action>
Update `apps/api/src/routes/packages.ts`:

1. Add imports at top:
```typescript
import { Prisma } from '@prisma/client';
import logger from '../lib/logger.js';
import { withSalonId } from '../lib/prismaUtils.js';
```

2. Replace all `: any` with `Prisma.PackageWhereInput`:
```typescript
const where: Prisma.PackageWhereInput = {
  ...withSalonId(req.user!.salonId),
  ...(isActive !== undefined && { isActive: isActive === 'true' }),
};
```

3. For ClientPackage queries, use `Prisma.ClientPackageWhereInput`

4. Replace console.log calls with logger (packages.ts has minimal logging, but check for any)

5. Verify all salonId patterns use withSalonId utility
  </action>
  <verify>
```bash
cd apps/api && npx tsc --noEmit src/routes/packages.ts
grep -c ": any" src/routes/packages.ts || echo "0"
grep -c "console\." src/routes/packages.ts || echo "0"
```
  </verify>
  <done>packages.ts has 0 `any` types, 0 console.log calls</done>
</task>

<task type="auto">
  <name>Task 3: Migrate gift-cards.ts and marketing.ts to explicit types and logger</name>
  <files>apps/api/src/routes/gift-cards.ts, apps/api/src/routes/marketing.ts</files>
  <action>
**For gift-cards.ts:**
1. Add imports (Prisma, logger, withSalonId)
2. Replace `: any` with `Prisma.GiftCardWhereInput` for gift card filters
3. Replace 2 console.log calls with logger
4. Use withSalonId for salonId filtering

**For marketing.ts:**
1. Add imports (Prisma, logger, withSalonId)
2. Replace `: any` with appropriate Prisma types:
   - `Prisma.CampaignWhereInput` for campaign filters
   - `Prisma.EmailTemplateWhereInput` for template filters
3. Replace 6 console.log calls with logger:
```typescript
// Example patterns
logger.info({ campaignId, recipientCount }, 'Campaign started');
logger.error(err, 'Failed to send campaign');
```
4. Use withSalonId for all tenant filtering

For both files:
- No remaining `: any` type annotations
- No remaining `console.` calls
- All Prisma queries use typed where clauses
  </action>
  <verify>
```bash
cd apps/api && npx tsc --noEmit src/routes/gift-cards.ts src/routes/marketing.ts
grep -c ": any" src/routes/gift-cards.ts || echo "0"
grep -c ": any" src/routes/marketing.ts || echo "0"
grep -c "console\." src/routes/gift-cards.ts || echo "0"
grep -c "console\." src/routes/marketing.ts || echo "0"
```
  </verify>
  <done>gift-cards.ts and marketing.ts have 0 `any` types, 0 console.log calls</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cd apps/api && npm run build` passes
2. Zero `: any` in all four files
3. Zero `console.` in all four files
4. All files import logger and withSalonId
</verification>

<success_criteria>
- All four route files compile without TypeScript errors
- Zero `: any` type annotations in these files
- Zero console.log/warn/error calls in these files
- All files use structured logger with context objects
- All files use withSalonId for tenant filtering
</success_criteria>

<output>
After completion, create `.planning/phases/17-code-quality/17-03-SUMMARY.md`
</output>
