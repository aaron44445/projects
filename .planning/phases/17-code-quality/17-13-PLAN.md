---
phase: 17-code-quality
plan: 13
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routes/clients.ts
  - apps/api/src/routes/notifications.ts
  - apps/api/src/routes/packages.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "clients.ts uses withSalonId for all salonId filter patterns"
    - "notifications.ts uses withSalonId for all salonId filter patterns"
    - "packages.ts uses withSalonId for all salonId filter patterns"
  artifacts:
    - path: "apps/api/src/routes/clients.ts"
      provides: "Prisma queries with withSalonId utility"
      contains: "...withSalonId(req.user!.salonId)"
    - path: "apps/api/src/routes/notifications.ts"
      provides: "Prisma queries with withSalonId utility"
      contains: "...withSalonId(req.user!.salonId)"
    - path: "apps/api/src/routes/packages.ts"
      provides: "Prisma queries with withSalonId utility"
      contains: "...withSalonId(req.user!.salonId)"
  key_links: []
---

<objective>
Replace inline salonId patterns in clients.ts (5), notifications.ts (2), and packages.ts (2)

Purpose: Close CODE-03 gap by ensuring all tenant isolation filters use the shared utility
Output: All three files with consistent withSalonId usage
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/17-code-quality/17-VERIFICATION.md
@apps/api/src/lib/prismaUtils.ts
@apps/api/src/routes/clients.ts
@apps/api/src/routes/notifications.ts
@apps/api/src/routes/packages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace inline salonId patterns in clients.ts</name>
  <files>apps/api/src/routes/clients.ts</files>
  <action>
    Replace all 5 inline `salonId: req.user!.salonId` patterns with `...withSalonId(req.user!.salonId)`.

    The file already imports withSalonId from '../lib/prismaUtils.js' (line 7).

    Target patterns (by line number):
    - Line 68: `salonId: req.user!.salonId,` in where block → `...withSalonId(req.user!.salonId),`
    - Line 167: `salonId: req.user!.salonId,` in data block → `...withSalonId(req.user!.salonId),`
    - Line 195: `where: { id: req.params.id, salonId: req.user!.salonId }` → `where: { id: req.params.id, ...withSalonId(req.user!.salonId) }`
    - Line 209: Same pattern
    - Line 227: Same pattern
  </action>
  <verify>
    Run: `grep -c "salonId: req.user!.salonId" apps/api/src/routes/clients.ts`
    Expected: 0 matches
  </verify>
  <done>All 5 inline salonId patterns replaced in clients.ts</done>
</task>

<task type="auto">
  <name>Task 2: Replace inline salonId patterns in notifications.ts and packages.ts</name>
  <files>apps/api/src/routes/notifications.ts, apps/api/src/routes/packages.ts</files>
  <action>
    Replace inline salonId patterns in both files. Both already import withSalonId.

    **notifications.ts (2 patterns):**
    - Line 124: `salonId: req.user!.salonId,` in where block → `...withSalonId(req.user!.salonId),`
    - Line 160: Same pattern

    **packages.ts (2 patterns):**
    - Line 38: `salonId: req.user!.salonId,` in data block → `...withSalonId(req.user!.salonId),`
    - Line 102: `salonId: req.user!.salonId,` → `...withSalonId(req.user!.salonId),`
  </action>
  <verify>
    Run: `grep -c "salonId: req.user!.salonId" apps/api/src/routes/notifications.ts apps/api/src/routes/packages.ts`
    Expected: 0 matches in both files

    Run: `npx tsc --noEmit -p apps/api/tsconfig.json`
    Expected: No errors
  </verify>
  <done>All inline salonId patterns replaced in notifications.ts and packages.ts, TypeScript compiles successfully</done>
</task>

</tasks>

<verification>
1. Zero inline `salonId: req.user!.salonId` patterns remain in clients.ts
2. Zero inline patterns remain in notifications.ts
3. Zero inline patterns remain in packages.ts
4. TypeScript compilation passes
</verification>

<success_criteria>
- grep returns 0 matches for inline pattern in all three files
- `npx tsc --noEmit` passes
</success_criteria>

<output>
After completion, create `.planning/phases/17-code-quality/17-13-SUMMARY.md`
</output>
