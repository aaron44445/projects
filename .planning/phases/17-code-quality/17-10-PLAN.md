---
phase: 17-code-quality
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routes/appointments.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "appointments.ts uses withSalonId for all salonId filter patterns"
  artifacts:
    - path: "apps/api/src/routes/appointments.ts"
      provides: "Prisma queries with withSalonId utility"
      contains: "...withSalonId(req.user!.salonId)"
  key_links:
    - from: "apps/api/src/routes/appointments.ts"
      to: "apps/api/src/lib/prismaUtils.ts"
      via: "withSalonId import"
      pattern: "import.*withSalonId.*from.*prismaUtils"
---

<objective>
Replace 17 inline `salonId: req.user!.salonId` patterns with `...withSalonId(req.user!.salonId)` in appointments.ts

Purpose: Close CODE-03 gap by ensuring all tenant isolation filters use the shared utility
Output: appointments.ts with consistent withSalonId usage
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/17-code-quality/17-VERIFICATION.md
@apps/api/src/lib/prismaUtils.ts
@apps/api/src/routes/appointments.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace inline salonId patterns in appointments.ts</name>
  <files>apps/api/src/routes/appointments.ts</files>
  <action>
    Replace all 17 inline `salonId: req.user!.salonId` patterns with `...withSalonId(req.user!.salonId)`.

    The file already imports withSalonId from '../lib/prismaUtils.js' (line 17).

    Target patterns to replace (by line number from verification):
    - Line 153: `where: { id: serviceId as string, salonId: req.user!.salonId }` → `where: { id: serviceId as string, ...withSalonId(req.user!.salonId) }`
    - Line 174: `salonId: req.user!.salonId,` in where block → `...withSalonId(req.user!.salonId),`
    - Line 222: `salonId: req.user!.salonId,` in where block → `...withSalonId(req.user!.salonId),`
    - Line 304: `where: { id: serviceId, salonId: req.user!.salonId }` → `where: { id: serviceId, ...withSalonId(req.user!.salonId) }`
    - Line 324: `salonId: req.user!.salonId,` in where block → `...withSalonId(req.user!.salonId),`
    - Line 359: `salonId: req.user!.salonId,` in data block → `...withSalonId(req.user!.salonId),`
    - Line 410: `salonId: req.user!.salonId,` in data block → `...withSalonId(req.user!.salonId),`
    - Line 458: `where: { id: req.params.id, salonId: req.user!.salonId }` → `where: { id: req.params.id, ...withSalonId(req.user!.salonId) }`
    - Line 498: Same pattern
    - Line 532: Same pattern
    - Line 576: Same pattern
    - Line 603: Same pattern
    - Line 617: Same pattern
    - Line 637: Same pattern
    - Line 651: Same pattern
    - Line 671: Same pattern
    - Line 710: Same pattern

    Use search-replace to change all occurrences. The spread operator pattern ensures the utility return value is merged into the object.
  </action>
  <verify>
    Run: `grep -c "salonId: req.user!.salonId" apps/api/src/routes/appointments.ts`
    Expected: 0 matches

    Run: `grep -c "\.\.\.withSalonId(req.user!.salonId)" apps/api/src/routes/appointments.ts`
    Expected: 18 or more matches (1 existing + 17 new)

    Run: `npx tsc --noEmit -p apps/api/tsconfig.json`
    Expected: No errors
  </verify>
  <done>All 17 inline salonId patterns replaced with withSalonId utility calls, TypeScript compiles successfully</done>
</task>

</tasks>

<verification>
1. Zero inline `salonId: req.user!.salonId` patterns remain in appointments.ts
2. All tenant isolation filters use `...withSalonId(req.user!.salonId)` pattern
3. TypeScript compilation passes
</verification>

<success_criteria>
- grep returns 0 matches for inline pattern
- grep returns 18+ matches for withSalonId pattern
- `npx tsc --noEmit` passes
</success_criteria>

<output>
After completion, create `.planning/phases/17-code-quality/17-10-SUMMARY.md`
</output>
