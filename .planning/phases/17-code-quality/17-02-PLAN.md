---
phase: 17-code-quality
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - apps/api/src/routes/appointments.ts
  - apps/api/src/routes/clients.ts
  - apps/api/src/routes/services.ts
  - apps/api/src/routes/staff.ts
autonomous: true

must_haves:
  truths:
    - "appointments.ts uses Prisma.AppointmentWhereInput instead of any"
    - "clients.ts uses Prisma.ClientWhereInput instead of any"
    - "services.ts uses Prisma.ServiceWhereInput instead of any"
    - "staff.ts uses Prisma.StaffWhereInput instead of any"
    - "All console.log/warn/error calls replaced with logger"
    - "All files import withSalonId from prismaUtils"
  artifacts:
    - path: "apps/api/src/routes/appointments.ts"
      provides: "Typed appointment queries"
      contains: "Prisma.AppointmentWhereInput"
    - path: "apps/api/src/routes/clients.ts"
      provides: "Typed client queries"
      contains: "Prisma.ClientWhereInput"
    - path: "apps/api/src/routes/services.ts"
      provides: "Typed service queries"
      contains: "Prisma.ServiceWhereInput"
    - path: "apps/api/src/routes/staff.ts"
      provides: "Typed staff queries"
      contains: "Prisma.StaffWhereInput"
  key_links:
    - from: "apps/api/src/routes/appointments.ts"
      to: "apps/api/src/lib/logger.ts"
      via: "import"
      pattern: "import logger from"
    - from: "apps/api/src/routes/appointments.ts"
      to: "apps/api/src/lib/prismaUtils.ts"
      via: "import"
      pattern: "import.*withSalonId.*from"
---

<objective>
Migrate high-traffic route files to use explicit Prisma types and structured logging.

Purpose: These four routes (appointments, clients, services, staff) are the most frequently used and have the most filter patterns. Fixing them establishes the migration pattern for remaining routes.
Output: Four route files with explicit types (no `any`), withSalonId usage, and logger calls instead of console.log.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-code-quality/17-RESEARCH.md
@.planning/phases/17-code-quality/17-01-SUMMARY.md
@apps/api/src/lib/logger.ts
@apps/api/src/lib/prismaUtils.ts
@apps/api/src/routes/appointments.ts
@apps/api/src/routes/clients.ts
@apps/api/src/routes/services.ts
@apps/api/src/routes/staff.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate appointments.ts to explicit types and logger</name>
  <files>apps/api/src/routes/appointments.ts</files>
  <action>
Update `apps/api/src/routes/appointments.ts`:

1. Add imports at top:
```typescript
import { Prisma } from '@prisma/client';
import logger from '../lib/logger.js';
import { withSalonId } from '../lib/prismaUtils.js';
```

2. Replace all `const where: any = {` patterns with explicit Prisma types:
```typescript
// BEFORE
const where: any = {
  salonId: req.user!.salonId,
  ...(status && { status: status as string }),
};

// AFTER
const where: Prisma.AppointmentWhereInput = {
  ...withSalonId(req.user!.salonId),
  ...(status && { status: status as string }),
};
```

3. Replace all `console.log`, `console.warn`, `console.error` with logger:
```typescript
// BEFORE
console.log('Creating appointment');
console.error('Error creating appointment:', error);

// AFTER
logger.info({ salonId: req.user!.salonId }, 'Creating appointment');
logger.error(error, 'Error creating appointment');
```

4. For startTimeFilter and other partial filters, use:
```typescript
const startTimeFilter: Prisma.DateTimeFilter = {};
// Or if optional:
let startTimeFilter: Prisma.DateTimeFilter | undefined;
```

5. Search file for any remaining `: any` and replace with explicit types.
  </action>
  <verify>
```bash
cd apps/api && npx tsc --noEmit src/routes/appointments.ts
grep -c ": any" src/routes/appointments.ts || echo "0"
grep -c "console\." src/routes/appointments.ts || echo "0"
```
TypeScript compiles, no `: any` found, no `console.` found.
  </verify>
  <done>appointments.ts has 0 `any` types, 0 console.log calls, uses withSalonId and logger imports</done>
</task>

<task type="auto">
  <name>Task 2: Migrate clients.ts to explicit types and logger</name>
  <files>apps/api/src/routes/clients.ts</files>
  <action>
Update `apps/api/src/routes/clients.ts`:

1. Add imports at top:
```typescript
import { Prisma } from '@prisma/client';
import logger from '../lib/logger.js';
import { withSalonId } from '../lib/prismaUtils.js';
```

2. Replace all `let where: any = {` or `const where: any = {` with:
```typescript
const where: Prisma.ClientWhereInput = {
  ...withSalonId(req.user!.salonId),
  isActive: true,
};
```

3. For search filters with OR clause:
```typescript
const where: Prisma.ClientWhereInput = {
  ...withSalonId(req.user!.salonId),
  isActive: true,
  ...(search && {
    OR: [
      { firstName: { contains: search as string, mode: 'insensitive' } },
      { lastName: { contains: search as string, mode: 'insensitive' } },
      { email: { contains: search as string, mode: 'insensitive' } },
      { phone: { contains: search as string } },
    ],
  }),
};
```

4. Replace all console.log/warn/error with logger calls.

5. Ensure all Prisma filter objects have explicit types.
  </action>
  <verify>
```bash
cd apps/api && npx tsc --noEmit src/routes/clients.ts
grep -c ": any" src/routes/clients.ts || echo "0"
grep -c "console\." src/routes/clients.ts || echo "0"
```
  </verify>
  <done>clients.ts has 0 `any` types, 0 console.log calls, uses withSalonId and logger</done>
</task>

<task type="auto">
  <name>Task 3: Migrate services.ts and staff.ts to explicit types and logger</name>
  <files>apps/api/src/routes/services.ts, apps/api/src/routes/staff.ts</files>
  <action>
Apply the same pattern to both files:

**For services.ts:**
1. Add imports (Prisma, logger, withSalonId)
2. Replace `any` with `Prisma.ServiceWhereInput` for service filters
3. Replace `any` with `Prisma.CategoryWhereInput` if category filters exist
4. Replace console.log calls with logger
5. Use withSalonId for all salonId filter patterns

**For staff.ts:**
1. Add imports (Prisma, logger, withSalonId)
2. Replace `any` with `Prisma.StaffWhereInput` for staff filters
3. Replace all console.log/warn/error with logger:
   - staff.ts has 6 console.log calls to replace
4. Use withSalonId for all salonId filter patterns

For both files, ensure:
- No remaining `: any` type annotations
- No remaining `console.` calls
- All Prisma queries use typed where clauses
  </action>
  <verify>
```bash
cd apps/api && npx tsc --noEmit src/routes/services.ts src/routes/staff.ts
grep -c ": any" src/routes/services.ts || echo "0"
grep -c ": any" src/routes/staff.ts || echo "0"
grep -c "console\." src/routes/services.ts || echo "0"
grep -c "console\." src/routes/staff.ts || echo "0"
```
All four checks should return 0.
  </verify>
  <done>services.ts and staff.ts have 0 `any` types, 0 console.log calls, use typed filters</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cd apps/api && npm run build` passes
2. `grep -r ": any" src/routes/appointments.ts src/routes/clients.ts src/routes/services.ts src/routes/staff.ts` returns empty
3. `grep -r "console\." src/routes/appointments.ts src/routes/clients.ts src/routes/services.ts src/routes/staff.ts` returns empty
4. All four files import logger and withSalonId
</verification>

<success_criteria>
- All four route files compile without TypeScript errors
- Zero `: any` type annotations in these files
- Zero console.log/warn/error calls in these files
- All files import and use logger from lib/logger.ts
- All files import and use withSalonId from lib/prismaUtils.ts
- All Prisma filters use explicit Prisma.*WhereInput types
</success_criteria>

<output>
After completion, create `.planning/phases/17-code-quality/17-02-SUMMARY.md`
</output>
