---
phase: 17-code-quality
plan: 12
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routes/users.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "users.ts uses withSalonId for all salonId filter patterns"
  artifacts:
    - path: "apps/api/src/routes/users.ts"
      provides: "Prisma queries with withSalonId utility"
      contains: "...withSalonId(req.user!.salonId)"
  key_links:
    - from: "apps/api/src/routes/users.ts"
      to: "apps/api/src/lib/prismaUtils.ts"
      via: "withSalonId import"
      pattern: "import.*withSalonId.*from.*prismaUtils"
---

<objective>
Replace 9 inline `salonId: req.user!.salonId` patterns with `...withSalonId(req.user!.salonId)` in users.ts

Purpose: Close CODE-03 gap by ensuring all tenant isolation filters use the shared utility
Output: users.ts with consistent withSalonId usage
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/17-code-quality/17-VERIFICATION.md
@apps/api/src/lib/prismaUtils.ts
@apps/api/src/routes/users.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add withSalonId import to users.ts</name>
  <files>apps/api/src/routes/users.ts</files>
  <action>
    users.ts does NOT currently import withSalonId. Add the import:

    After line 5 (`import { asyncHandler } from '../lib/errorUtils.js';`), add:
    `import { withSalonId } from '../lib/prismaUtils.js';`
  </action>
  <verify>
    Run: `grep "import.*withSalonId.*from.*prismaUtils" apps/api/src/routes/users.ts`
    Expected: 1 match
  </verify>
  <done>withSalonId import added to users.ts</done>
</task>

<task type="auto">
  <name>Task 2: Replace inline salonId patterns in users.ts</name>
  <files>apps/api/src/routes/users.ts</files>
  <action>
    Replace all 9 inline `salonId: req.user!.salonId` patterns with `...withSalonId(req.user!.salonId)`.

    Target patterns (by line number):
    - Line 54: `salonId: req.user!.salonId,` in Prisma.UserWhereInput → `...withSalonId(req.user!.salonId),`
    - Line 163: `salonId: req.user!.salonId,` in where block → `...withSalonId(req.user!.salonId),`
    - Line 232: `where: { salonId: req.user!.salonId, email, isActive: true }` → `where: { ...withSalonId(req.user!.salonId), email, isActive: true }`
    - Line 247: `where: { salonId: req.user!.salonId, email, isActive: false }` → `where: { ...withSalonId(req.user!.salonId), email, isActive: false }`
    - Line 260: `salonId: req.user!.salonId,` in data block → `...withSalonId(req.user!.salonId),`
    - Line 321: `where: { id: req.params.id, salonId: req.user!.salonId }` → `where: { id: req.params.id, ...withSalonId(req.user!.salonId) }`
    - Line 445: Same pattern
    - Line 521: `where: { id, salonId: req.user!.salonId }` → `where: { id, ...withSalonId(req.user!.salonId) }`
    - Line 597: Same pattern
  </action>
  <verify>
    Run: `grep -c "salonId: req.user!.salonId" apps/api/src/routes/users.ts`
    Expected: 0 matches

    Run: `grep -c "\.\.\.withSalonId(req.user!.salonId)" apps/api/src/routes/users.ts`
    Expected: 9 matches

    Run: `npx tsc --noEmit -p apps/api/tsconfig.json`
    Expected: No errors
  </verify>
  <done>All 9 inline salonId patterns replaced with withSalonId utility calls, TypeScript compiles successfully</done>
</task>

</tasks>

<verification>
1. withSalonId is imported in users.ts
2. Zero inline `salonId: req.user!.salonId` patterns remain in users.ts
3. TypeScript compilation passes
</verification>

<success_criteria>
- withSalonId import exists
- grep returns 0 matches for inline pattern
- grep returns 9 matches for withSalonId pattern
- `npx tsc --noEmit` passes
</success_criteria>

<output>
After completion, create `.planning/phases/17-code-quality/17-12-SUMMARY.md`
</output>
