---
phase: 17-code-quality
plan: 11
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routes/services.ts
  - apps/api/src/routes/staff.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "services.ts uses withSalonId for all salonId filter patterns"
    - "staff.ts uses withSalonId for all salonId filter patterns"
  artifacts:
    - path: "apps/api/src/routes/services.ts"
      provides: "Prisma queries with withSalonId utility"
      contains: "...withSalonId(req.user!.salonId)"
    - path: "apps/api/src/routes/staff.ts"
      provides: "Prisma queries with withSalonId utility"
      contains: "...withSalonId(req.user!.salonId)"
  key_links:
    - from: "apps/api/src/routes/services.ts"
      to: "apps/api/src/lib/prismaUtils.ts"
      via: "withSalonId import"
      pattern: "import.*withSalonId.*from.*prismaUtils"
    - from: "apps/api/src/routes/staff.ts"
      to: "apps/api/src/lib/prismaUtils.ts"
      via: "withSalonId import"
      pattern: "import.*withSalonId.*from.*prismaUtils"
---

<objective>
Replace 14 inline salonId patterns in services.ts and 14 in staff.ts with withSalonId utility

Purpose: Close CODE-03 gap by ensuring all tenant isolation filters use the shared utility
Output: services.ts and staff.ts with consistent withSalonId usage
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/17-code-quality/17-VERIFICATION.md
@apps/api/src/lib/prismaUtils.ts
@apps/api/src/routes/services.ts
@apps/api/src/routes/staff.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace inline salonId patterns in services.ts</name>
  <files>apps/api/src/routes/services.ts</files>
  <action>
    Replace all 14 inline `salonId: req.user!.salonId` patterns with `...withSalonId(req.user!.salonId)`.

    The file already imports withSalonId from '../lib/prismaUtils.js' (line 7).

    Target patterns (by line number):
    - Line 21: `salonId: req.user!.salonId,` in where block → `...withSalonId(req.user!.salonId),`
    - Line 42: `where: { salonId: req.user!.salonId }` → `where: { ...withSalonId(req.user!.salonId) }`
    - Line 72: `where: { salonId: req.user!.salonId }` → `where: { ...withSalonId(req.user!.salonId) }`
    - Line 81: `salonId: req.user!.salonId,` in data block → `...withSalonId(req.user!.salonId),`
    - Line 104: `where: { id: req.params.id, salonId: req.user!.salonId }` → `where: { id: req.params.id, ...withSalonId(req.user!.salonId) }`
    - Line 117: Same pattern
    - Line 141: Same pattern
    - Line 159: Same pattern
    - Line 177: `salonId: req.user!.salonId,` in where block → `...withSalonId(req.user!.salonId),`
    - Line 228: `salonId: req.user!.salonId,` in data block → `...withSalonId(req.user!.salonId),`
    - Line 256: `where: { id: req.params.id, salonId: req.user!.salonId }` → same pattern
    - Line 270: Same pattern
    - Line 290: Same pattern
    - Line 304: Same pattern
  </action>
  <verify>
    Run: `grep -c "salonId: req.user!.salonId" apps/api/src/routes/services.ts`
    Expected: 0 matches
  </verify>
  <done>All 14 inline salonId patterns replaced in services.ts</done>
</task>

<task type="auto">
  <name>Task 2: Replace inline salonId patterns in staff.ts</name>
  <files>apps/api/src/routes/staff.ts</files>
  <action>
    Replace all 14 inline `salonId: req.user!.salonId` patterns with `...withSalonId(req.user!.salonId)`.

    The file already imports withSalonId from '../lib/prismaUtils.js' (line 9).

    Target patterns (by line number):
    - Line 29: `salonId: req.user!.salonId,` in nested where → `...withSalonId(req.user!.salonId),`
    - Line 58: `salonId: req.user!.salonId,` in where block → `...withSalonId(req.user!.salonId),`
    - Line 87: `salonId: req.user!.salonId,` in where block → `...withSalonId(req.user!.salonId),`
    - Line 121: `salonId: req.user!.salonId,` in where block → `...withSalonId(req.user!.salonId),`
    - Line 170: `where: { salonId: req.user!.salonId, email, isActive: true }` → `where: { ...withSalonId(req.user!.salonId), email, isActive: true }`
    - Line 185: `where: { salonId: req.user!.salonId, email, isActive: false }` → `where: { ...withSalonId(req.user!.salonId), email, isActive: false }`
    - Line 202: `salonId: req.user!.salonId,` in data block → `...withSalonId(req.user!.salonId),`
    - Line 305: `where: { id: req.params.id, salonId: req.user!.salonId }` → `where: { id: req.params.id, ...withSalonId(req.user!.salonId) }`
    - Line 366: Same pattern
    - Line 400: Same pattern
    - Line 415: Same pattern
    - Line 440: `where: { id: staffId, salonId: req.user!.salonId }` → `where: { id: staffId, ...withSalonId(req.user!.salonId) }`
    - Line 514: Same pattern
    - Line 542: `salonId: req.user!.salonId,` in where block → `...withSalonId(req.user!.salonId),`
  </action>
  <verify>
    Run: `grep -c "salonId: req.user!.salonId" apps/api/src/routes/staff.ts`
    Expected: 0 matches

    Run: `npx tsc --noEmit -p apps/api/tsconfig.json`
    Expected: No errors
  </verify>
  <done>All 14 inline salonId patterns replaced in staff.ts, TypeScript compiles successfully</done>
</task>

</tasks>

<verification>
1. Zero inline `salonId: req.user!.salonId` patterns remain in services.ts
2. Zero inline `salonId: req.user!.salonId` patterns remain in staff.ts
3. TypeScript compilation passes
</verification>

<success_criteria>
- grep returns 0 matches for inline pattern in both files
- `npx tsc --noEmit` passes
</success_criteria>

<output>
After completion, create `.planning/phases/17-code-quality/17-11-SUMMARY.md`
</output>
