---
phase: 17-code-quality
plan: 14
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routes/onboarding.ts
  - apps/api/src/routes/marketing.ts
  - apps/api/src/routes/gift-cards.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "onboarding.ts uses withSalonId for all salonId filter patterns"
    - "marketing.ts uses withSalonId for all salonId filter patterns"
    - "gift-cards.ts uses withSalonId for all salonId filter patterns"
  artifacts:
    - path: "apps/api/src/routes/onboarding.ts"
      provides: "Prisma queries with withSalonId utility"
      contains: "...withSalonId(req.user!.salonId)"
    - path: "apps/api/src/routes/marketing.ts"
      provides: "Prisma queries with withSalonId utility"
      contains: "...withSalonId(req.user!.salonId)"
    - path: "apps/api/src/routes/gift-cards.ts"
      provides: "Prisma queries with withSalonId utility"
      contains: "...withSalonId(req.user!.salonId)"
  key_links:
    - from: "apps/api/src/routes/onboarding.ts"
      to: "apps/api/src/lib/prismaUtils.ts"
      via: "withSalonId import"
      pattern: "import.*withSalonId.*from.*prismaUtils"
---

<objective>
Replace inline salonId patterns in onboarding.ts (2), marketing.ts (1), and gift-cards.ts (1)

Purpose: Close CODE-03 gap by ensuring all tenant isolation filters use the shared utility
Output: All three files with consistent withSalonId usage (completing the gap closure)
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/17-code-quality/17-VERIFICATION.md
@apps/api/src/lib/prismaUtils.ts
@apps/api/src/routes/onboarding.ts
@apps/api/src/routes/marketing.ts
@apps/api/src/routes/gift-cards.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add withSalonId import to onboarding.ts and replace patterns</name>
  <files>apps/api/src/routes/onboarding.ts</files>
  <action>
    onboarding.ts does NOT currently import withSalonId. Add the import after existing imports:
    `import { withSalonId } from '../lib/prismaUtils.js';`

    Then replace 2 inline `salonId: req.user!.salonId` patterns:
    - Line 105: `where: { salonId: req.user!.salonId, role: 'admin' }` → `where: { ...withSalonId(req.user!.salonId), role: 'admin' }`
    - Line 169: `salonId: req.user!.salonId,` in createMany data mapper → `...withSalonId(req.user!.salonId),`
  </action>
  <verify>
    Run: `grep "import.*withSalonId.*from.*prismaUtils" apps/api/src/routes/onboarding.ts`
    Expected: 1 match

    Run: `grep -c "salonId: req.user!.salonId" apps/api/src/routes/onboarding.ts`
    Expected: 0 matches
  </verify>
  <done>withSalonId imported and all inline patterns replaced in onboarding.ts</done>
</task>

<task type="auto">
  <name>Task 2: Replace inline salonId patterns in marketing.ts and gift-cards.ts</name>
  <files>apps/api/src/routes/marketing.ts, apps/api/src/routes/gift-cards.ts</files>
  <action>
    Replace remaining inline salonId patterns. Both files already import withSalonId.

    **marketing.ts (1 pattern):**
    - Line 39: `salonId: req.user!.salonId,` in data block → `...withSalonId(req.user!.salonId),`

    **gift-cards.ts (1 pattern):**
    - Line 48: `salonId: req.user!.salonId,` in data block → `...withSalonId(req.user!.salonId),`
  </action>
  <verify>
    Run: `grep -c "salonId: req.user!.salonId" apps/api/src/routes/marketing.ts apps/api/src/routes/gift-cards.ts`
    Expected: 0 matches in both files

    Run: `npx tsc --noEmit -p apps/api/tsconfig.json`
    Expected: No errors
  </verify>
  <done>All inline salonId patterns replaced in marketing.ts and gift-cards.ts, TypeScript compiles successfully</done>
</task>

<task type="auto">
  <name>Task 3: Final verification of CODE-03 gap closure</name>
  <files>apps/api/src/routes/*.ts</files>
  <action>
    Verify that NO inline `salonId: req.user!.salonId` patterns remain in any route file EXCEPT:
    - billing.ts (8 patterns in logger calls - these are tracing context, not database filters)
    - integrations.ts (11 patterns in logger calls - same reason)

    These logger patterns should NOT be changed to withSalonId because:
    1. withSalonId is designed for Prisma where/data clauses
    2. Logger calls use salonId as structured logging context, not as database filters
    3. The VERIFICATION.md gap specifically targets "where patterns" not logger context
  </action>
  <verify>
    Run: `grep -c "salonId: req.user!.salonId" apps/api/src/routes/*.ts | grep -v ":0$"`
    Expected: Only billing.ts:8 and integrations.ts:11 (logger context only)

    Run: `grep "where.*salonId: req.user!.salonId" apps/api/src/routes/*.ts`
    Expected: 0 matches (all where clauses now use withSalonId)

    Run: `grep "data:.*salonId: req.user!.salonId" apps/api/src/routes/*.ts`
    Expected: 0 matches (all data clauses now use withSalonId)
  </verify>
  <done>CODE-03 gap fully closed - all database filter patterns use withSalonId, only logger context remains with inline pattern</done>
</task>

</tasks>

<verification>
1. withSalonId is imported in onboarding.ts
2. Zero inline `salonId: req.user!.salonId` patterns remain in onboarding.ts, marketing.ts, gift-cards.ts
3. Zero inline patterns remain in any WHERE or DATA clause across all routes
4. Logger context patterns in billing.ts and integrations.ts are unchanged (correct behavior)
5. TypeScript compilation passes
</verification>

<success_criteria>
- grep returns 0 matches for inline pattern in onboarding.ts, marketing.ts, gift-cards.ts
- grep for `where.*salonId: req.user!.salonId` returns 0 matches across all routes
- Only billing.ts (8) and integrations.ts (11) have any inline patterns (all in logger calls)
- `npx tsc --noEmit` passes
</success_criteria>

<output>
After completion, create `.planning/phases/17-code-quality/17-14-SUMMARY.md`
</output>
