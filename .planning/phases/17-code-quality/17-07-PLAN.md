---
phase: 17-code-quality
plan: 07
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - apps/api/src/services/email.ts
  - apps/api/src/services/sms.ts
  - apps/api/src/services/notifications.ts
  - apps/api/src/services/booking.ts
  - apps/api/src/services/subscriptions.ts
  - apps/api/src/services/webhookEvents.ts
  - apps/api/src/middleware/errorHandler.ts
  - apps/api/src/middleware/clientAuth.ts
  - apps/api/src/middleware/subscription.ts
  - apps/api/src/middleware/validateFileOwnership.ts
autonomous: true

must_haves:
  truths:
    - "All service files use logger instead of console.log"
    - "All middleware files use logger instead of console.log"
    - "email.ts replaces 15 console.log calls with structured logger"
  artifacts:
    - path: "apps/api/src/services/email.ts"
      provides: "Typed email service with logging"
      contains: "import logger from"
    - path: "apps/api/src/services/subscriptions.ts"
      provides: "Typed subscription service with logging"
      contains: "import logger from"
    - path: "apps/api/src/middleware/errorHandler.ts"
      provides: "Error handler with structured logging"
      contains: "import logger from"
  key_links:
    - from: "apps/api/src/services/email.ts"
      to: "apps/api/src/lib/logger.ts"
      via: "import"
      pattern: "import logger from"
---

<objective>
Migrate service and middleware files to use structured logging.

Purpose: Services (email, sms, notifications, booking, subscriptions, webhookEvents) and middleware (errorHandler, clientAuth, subscription, validateFileOwnership) contain 52 console.log calls that need structured logging.
Output: Ten files with structured logger replacing all console.log calls.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-code-quality/17-RESEARCH.md
@.planning/phases/17-code-quality/17-01-SUMMARY.md
@apps/api/src/lib/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate email.ts, sms.ts, and notifications.ts services</name>
  <files>apps/api/src/services/email.ts, apps/api/src/services/sms.ts, apps/api/src/services/notifications.ts</files>
  <action>
**For email.ts (15 console.log calls - second highest):**
1. Add import at top:
```typescript
import logger from '../lib/logger.js';
```

2. Replace all 15 console.log calls with structured logger:
```typescript
// Email sending logging
logger.info({ to, subject, templateId }, 'Sending email');
logger.info({ to, messageId }, 'Email sent successfully');
logger.error(err, 'Email sending failed');
logger.warn({ to }, 'Email bounced');
```

3. Include relevant context (recipient, template, salonId if available)

**For sms.ts (3 console.log calls):**
1. Add logger import
2. Replace 3 console.log calls:
```typescript
logger.info({ to, messageType }, 'Sending SMS');
logger.error(err, 'SMS sending failed');
```

**For notifications.ts (2 console.log calls):**
1. Add logger import
2. Replace 2 console.log calls with structured logger
  </action>
  <verify>
```bash
cd apps/api && npx tsc --noEmit src/services/email.ts src/services/sms.ts src/services/notifications.ts
grep -c "console\." src/services/email.ts src/services/sms.ts src/services/notifications.ts 2>/dev/null | grep -v ":0$" || echo "All clean"
```
  </verify>
  <done>email.ts, sms.ts, notifications.ts have 0 console.log calls, use structured logger</done>
</task>

<task type="auto">
  <name>Task 2: Migrate booking.ts, subscriptions.ts, and webhookEvents.ts services</name>
  <files>apps/api/src/services/booking.ts, apps/api/src/services/subscriptions.ts, apps/api/src/services/webhookEvents.ts</files>
  <action>
**For booking.ts (1 console.log call):**
1. Add logger import
2. Replace 1 console.log call with structured logger

**For subscriptions.ts (8 console.log calls):**
1. Add logger import
2. Replace 8 console.log calls with structured logger:
```typescript
logger.info({ salonId, planId }, 'Subscription created');
logger.info({ salonId, subscriptionId }, 'Subscription cancelled');
logger.warn({ salonId }, 'Subscription approaching limit');
logger.error(err, 'Subscription update failed');
```

Note: subscriptions.ts has pre-existing TypeScript errors mentioned in STATE.md. Fix only the console.log calls; do not attempt to fix unrelated type errors.

**For webhookEvents.ts (2 console.log calls):**
1. Add logger import
2. Replace 2 console.log calls with structured logger
  </action>
  <verify>
```bash
cd apps/api && npx tsc --noEmit src/services/booking.ts 2>/dev/null || true
grep -c "console\." src/services/booking.ts src/services/subscriptions.ts src/services/webhookEvents.ts 2>/dev/null | grep -v ":0$" || echo "All clean"
```
  </verify>
  <done>booking.ts, subscriptions.ts, webhookEvents.ts have 0 console.log calls</done>
</task>

<task type="auto">
  <name>Task 3: Migrate middleware files</name>
  <files>apps/api/src/middleware/errorHandler.ts, apps/api/src/middleware/clientAuth.ts, apps/api/src/middleware/subscription.ts, apps/api/src/middleware/validateFileOwnership.ts</files>
  <action>
**For errorHandler.ts (1 console.log call):**
1. Add logger import
2. Replace console.log with logger:
```typescript
logger.error(err, 'Unhandled request error');
```

**For clientAuth.ts (1 console.log call):**
1. Add logger import
2. Replace console.log with logger:
```typescript
logger.warn({ token }, 'Invalid client authentication token');
```

**For subscription.ts (3 console.log calls):**
1. Add logger import
2. Replace 3 console.log calls:
```typescript
logger.warn({ salonId }, 'Subscription check failed');
logger.info({ salonId, plan }, 'Subscription validated');
```

**For validateFileOwnership.ts (2 console.log calls):**
1. Add logger import
2. Replace 2 console.log calls:
```typescript
logger.warn({ fileId, requestedBy }, 'File ownership verification failed');
logger.info({ fileId }, 'File ownership verified');
```
  </action>
  <verify>
```bash
cd apps/api && npx tsc --noEmit src/middleware/errorHandler.ts src/middleware/clientAuth.ts src/middleware/subscription.ts src/middleware/validateFileOwnership.ts 2>/dev/null || true
grep -c "console\." src/middleware/errorHandler.ts src/middleware/clientAuth.ts src/middleware/subscription.ts src/middleware/validateFileOwnership.ts 2>/dev/null | grep -v ":0$" || echo "All clean"
```
  </verify>
  <done>All middleware files have 0 console.log calls</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Zero console.log calls in all 10 service/middleware files
2. All files import and use logger
3. TypeScript compilation passes (except known pre-existing subscription errors)
</verification>

<success_criteria>
- All 10 service/middleware files use structured logger
- Zero console.log/warn/error calls in these files
- Logger calls include relevant context (salonId, userId, etc.)
- Services and middleware migration complete
</success_criteria>

<output>
After completion, create `.planning/phases/17-code-quality/17-07-SUMMARY.md`
</output>
