---
phase: 04-payment-processing
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/web/package.json
  - apps/web/src/components/booking/PaymentForm.tsx
  - apps/web/src/components/booking/BookingSummary.tsx
  - apps/web/src/hooks/usePayment.ts
  - apps/web/src/lib/stripe.ts
autonomous: true
user_setup:
  - service: stripe
    why: "Stripe publishable key needed for frontend Payment Element"
    env_vars:
      - name: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Publishable key"

must_haves:
  truths:
    - "PaymentForm component renders Stripe Payment Element"
    - "Decline errors show user-friendly messages with retry option"
    - "usePayment hook creates payment intent via API and confirms payment"
    - "BookingSummary shows deposit amount and service total"
  artifacts:
    - path: "apps/web/src/components/booking/PaymentForm.tsx"
      provides: "Stripe Payment Element with error handling"
      min_lines: 80
    - path: "apps/web/src/components/booking/BookingSummary.tsx"
      provides: "Booking summary with deposit breakdown"
      min_lines: 40
    - path: "apps/web/src/hooks/usePayment.ts"
      provides: "Payment intent creation and confirmation logic"
      exports: ["usePayment"]
    - path: "apps/web/src/lib/stripe.ts"
      provides: "Stripe.js initialization"
      exports: ["stripePromise", "getStripe"]
  key_links:
    - from: "apps/web/src/components/booking/PaymentForm.tsx"
      to: "@stripe/react-stripe-js"
      via: "PaymentElement component"
      pattern: "PaymentElement"
    - from: "apps/web/src/components/booking/PaymentForm.tsx"
      to: "onSuccess callback"
      via: "passes paymentIntent.id (NOT clientSecret) after confirmPayment succeeds"
      pattern: "onSuccess\\(paymentIntent\\.id\\)"
    - from: "apps/web/src/hooks/usePayment.ts"
      to: "API"
      via: "fetch to create payment intent"
      pattern: "fetch.*payment-intent"
---

<objective>
Build frontend payment components using Stripe Payment Element for deposit collection.

Purpose: Enable clients to securely enter payment details during booking with proper error handling and retry capabilities.
Output: PaymentForm component, BookingSummary component, usePayment hook, Stripe.js setup.
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-payment-processing/04-RESEARCH.md
@.planning/phases/04-payment-processing/04-01-SUMMARY.md
@apps/web/package.json
@apps/web/src/app/embed/[slug]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Stripe frontend packages and create Stripe.js setup</name>
  <files>apps/web/package.json, apps/web/src/lib/stripe.ts</files>
  <action>
1. Install Stripe frontend packages:
```bash
pnpm --filter @peacase/web add @stripe/stripe-js @stripe/react-stripe-js
```

2. Create apps/web/src/lib/stripe.ts:
```typescript
import { loadStripe, Stripe } from '@stripe/stripe-js';

let stripePromise: Promise<Stripe | null> | null = null;

/**
 * Get or initialize the Stripe.js instance.
 * Uses lazy initialization to avoid loading Stripe.js until needed.
 */
export function getStripe(): Promise<Stripe | null> {
  if (!stripePromise) {
    const key = process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY;
    if (!key) {
      console.warn('NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY is not set. Payment features will be unavailable.');
      return Promise.resolve(null);
    }
    stripePromise = loadStripe(key);
  }
  return stripePromise;
}

// Export the promise for use with Elements provider
export { stripePromise };
```
  </action>
  <verify>
Check apps/web/package.json includes @stripe/stripe-js and @stripe/react-stripe-js.
Check apps/web/src/lib/stripe.ts exists and exports getStripe function.
Run `pnpm --filter @peacase/web exec tsc --noEmit` - should compile.
  </verify>
  <done>
Stripe packages installed and stripe.ts setup file created with lazy-loaded Stripe.js instance.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create usePayment hook for payment flow</name>
  <files>apps/web/src/hooks/usePayment.ts</files>
  <action>
Create the usePayment hook that handles payment intent creation and status:

```typescript
import { useState, useCallback } from 'react';

interface PaymentIntentResponse {
  clientSecret: string;
  depositAmountCents: number;
}

interface UsePaymentOptions {
  slug: string;
  serviceId: string;
  servicePrice: number;
  clientEmail: string;
  staffId?: string;
  locationId?: string;
  appointmentDate: string;
}

interface UsePaymentReturn {
  clientSecret: string | null;
  depositAmount: number;
  isLoading: boolean;
  error: string | null;
  createPaymentIntent: () => Promise<boolean>;
  clearError: () => void;
}

const API_BASE = process.env.NEXT_PUBLIC_API_URL
  ? process.env.NEXT_PUBLIC_API_URL.replace(/\/api\/v1$/, '')
  : 'http://localhost:3001';

/**
 * Hook for managing payment intent creation and state.
 * Creates a payment intent on the server and returns the client secret for Stripe.js.
 */
export function usePayment(options: UsePaymentOptions): UsePaymentReturn {
  const [clientSecret, setClientSecret] = useState<string | null>(null);
  const [depositAmount, setDepositAmount] = useState<number>(0);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const createPaymentIntent = useCallback(async (): Promise<boolean> => {
    setIsLoading(true);
    setError(null);

    try {
      const response = await fetch(
        `${API_BASE}/api/v1/public/${options.slug}/create-payment-intent`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            serviceId: options.serviceId,
            servicePrice: options.servicePrice,
            clientEmail: options.clientEmail,
            staffId: options.staffId,
            locationId: options.locationId,
            appointmentDate: options.appointmentDate,
          }),
        }
      );

      const data = await response.json();

      if (!response.ok || !data.success) {
        setError(data.error?.message || 'Failed to initialize payment');
        return false;
      }

      setClientSecret(data.data.clientSecret);
      setDepositAmount(data.data.depositAmountCents / 100);
      return true;
    } catch (err) {
      setError('Unable to connect to payment service. Please try again.');
      return false;
    } finally {
      setIsLoading(false);
    }
  }, [options]);

  const clearError = useCallback(() => {
    setError(null);
  }, []);

  return {
    clientSecret,
    depositAmount,
    isLoading,
    error,
    createPaymentIntent,
    clearError,
  };
}
```

Also add the export to apps/web/src/hooks/index.ts.
  </action>
  <verify>
Check usePayment.ts exists and exports usePayment function.
Run `pnpm --filter @peacase/web exec tsc --noEmit` - should compile.
  </verify>
  <done>
usePayment hook created with payment intent creation logic and state management.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create PaymentForm and BookingSummary components</name>
  <files>apps/web/src/components/booking/PaymentForm.tsx, apps/web/src/components/booking/BookingSummary.tsx</files>
  <action>
1. Create apps/web/src/components/booking/ directory if it doesn't exist.

2. Create PaymentForm.tsx:
```typescript
'use client';

import { useState } from 'react';
import { PaymentElement, useStripe, useElements } from '@stripe/react-stripe-js';
import { Loader2, AlertCircle, RefreshCw } from 'lucide-react';

interface PaymentFormProps {
  onSuccess: (paymentIntentId: string) => void;  // CRITICAL: Pass payment intent ID, NOT client secret
  onError?: (error: string) => void;
  primaryColor?: string;
}

// Map Stripe decline codes to friendly messages
function getDeclineMessage(error: any): string {
  const declineCode = error?.decline_code || error?.code;
  const messages: Record<string, string> = {
    card_declined: "Your card was declined. Please try a different payment method.",
    insufficient_funds: "Insufficient funds. Please try a different card.",
    incorrect_cvc: "Your card's security code is incorrect. Please check and try again.",
    expired_card: "Your card has expired. Please use a different card.",
    processing_error: "A temporary error occurred. Please try again in a moment.",
    incorrect_number: "Your card number is incorrect. Please check and try again.",
    incorrect_zip: "Your ZIP/postal code is incorrect. Please check and try again.",
  };
  return messages[declineCode] || error?.message || "Payment could not be processed. Please try again.";
}

export function PaymentForm({ onSuccess, onError, primaryColor = '#7C9A82' }: PaymentFormProps) {
  const stripe = useStripe();
  const elements = useElements();
  const [isProcessing, setIsProcessing] = useState(false);
  const [errorMessage, setErrorMessage] = useState<string | null>(null);
  const [canRetry, setCanRetry] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!stripe || !elements) {
      return;
    }

    setIsProcessing(true);
    setErrorMessage(null);
    setCanRetry(false);

    const { error, paymentIntent } = await stripe.confirmPayment({
      elements,
      confirmParams: {
        return_url: `${window.location.origin}/booking/confirm`,
      },
      redirect: 'if_required',
    });

    if (error) {
      const friendlyMessage = getDeclineMessage(error);
      setErrorMessage(friendlyMessage);
      setCanRetry(true);
      onError?.(friendlyMessage);
      setIsProcessing(false);
    } else if (paymentIntent) {
      // CRITICAL: Extract paymentIntent.id from the confirmPayment result
      // The result object structure is: { error?: StripeError, paymentIntent?: PaymentIntent }
      // paymentIntent.id has format 'pi_xxx' (NOT the clientSecret which is 'pi_xxx_secret_yyy')
      //
      // The booking endpoint needs this ID to link the appointment to the payment.
      // Webhooks will later find the appointment by stripePaymentIntentId field.
      //
      // Handle both manual capture (requires_capture) and auto-capture (succeeded) flows:
      if (paymentIntent.status === 'requires_capture' || paymentIntent.status === 'succeeded') {
        // Pass the payment intent ID to the parent component
        onSuccess(paymentIntent.id);
      }
      setIsProcessing(false);
    }
  };

  const handleRetry = () => {
    setErrorMessage(null);
    setCanRetry(false);
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div className="bg-white rounded-xl border border-gray-200 p-4">
        <PaymentElement
          options={{
            layout: 'tabs',
          }}
        />
      </div>

      {errorMessage && (
        <div className="flex items-start gap-3 p-4 bg-red-50 border border-red-200 rounded-xl">
          <AlertCircle className="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" />
          <div className="flex-1">
            <p className="text-sm text-red-700">{errorMessage}</p>
            {canRetry && (
              <button
                type="button"
                onClick={handleRetry}
                className="mt-2 inline-flex items-center gap-1 text-sm font-medium text-red-600 hover:text-red-700"
              >
                <RefreshCw className="w-4 h-4" />
                Try again
              </button>
            )}
          </div>
        </div>
      )}

      <button
        type="submit"
        disabled={!stripe || isProcessing}
        className="w-full flex items-center justify-center gap-2 px-6 py-3 text-white font-semibold rounded-xl transition-all disabled:opacity-50"
        style={{ backgroundColor: primaryColor }}
      >
        {isProcessing ? (
          <>
            <Loader2 className="w-5 h-5 animate-spin" />
            Processing...
          </>
        ) : (
          'Pay Deposit'
        )}
      </button>
    </form>
  );
}
```

3. Create BookingSummary.tsx:
```typescript
'use client';

import { Clock, DollarSign, User, MapPin, Calendar } from 'lucide-react';

interface BookingSummaryProps {
  serviceName: string;
  servicePrice: number;
  depositAmount: number;
  staffName?: string;
  locationName?: string;
  dateTime: string;
  primaryColor?: string;
}

export function BookingSummary({
  serviceName,
  servicePrice,
  depositAmount,
  staffName,
  locationName,
  dateTime,
  primaryColor = '#7C9A82',
}: BookingSummaryProps) {
  const balanceDue = servicePrice - depositAmount;

  return (
    <div className="bg-gray-50 rounded-xl p-4 space-y-4">
      <h3 className="font-semibold text-gray-900">Booking Summary</h3>

      <div className="space-y-3">
        <div className="flex items-start gap-3">
          <div
            className="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0"
            style={{ backgroundColor: primaryColor + '20' }}
          >
            <Clock className="w-4 h-4" style={{ color: primaryColor }} />
          </div>
          <div>
            <p className="text-sm text-gray-500">Service</p>
            <p className="font-medium text-gray-900">{serviceName}</p>
          </div>
        </div>

        {locationName && (
          <div className="flex items-start gap-3">
            <div
              className="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0"
              style={{ backgroundColor: primaryColor + '20' }}
            >
              <MapPin className="w-4 h-4" style={{ color: primaryColor }} />
            </div>
            <div>
              <p className="text-sm text-gray-500">Location</p>
              <p className="font-medium text-gray-900">{locationName}</p>
            </div>
          </div>
        )}

        {staffName && (
          <div className="flex items-start gap-3">
            <div
              className="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0"
              style={{ backgroundColor: primaryColor + '20' }}
            >
              <User className="w-4 h-4" style={{ color: primaryColor }} />
            </div>
            <div>
              <p className="text-sm text-gray-500">With</p>
              <p className="font-medium text-gray-900">{staffName}</p>
            </div>
          </div>
        )}

        <div className="flex items-start gap-3">
          <div
            className="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0"
            style={{ backgroundColor: primaryColor + '20' }}
          >
            <Calendar className="w-4 h-4" style={{ color: primaryColor }} />
          </div>
          <div>
            <p className="text-sm text-gray-500">When</p>
            <p className="font-medium text-gray-900">{dateTime}</p>
          </div>
        </div>
      </div>

      <div className="border-t border-gray-200 pt-4 space-y-2">
        <div className="flex justify-between text-sm">
          <span className="text-gray-500">Service total</span>
          <span className="text-gray-900">${servicePrice.toFixed(2)}</span>
        </div>
        <div className="flex justify-between text-sm font-medium">
          <span className="text-gray-700">Deposit due now</span>
          <span style={{ color: primaryColor }}>${depositAmount.toFixed(2)}</span>
        </div>
        {balanceDue > 0 && (
          <div className="flex justify-between text-sm">
            <span className="text-gray-500">Balance due at appointment</span>
            <span className="text-gray-900">${balanceDue.toFixed(2)}</span>
          </div>
        )}
      </div>

      <p className="text-xs text-gray-400">
        Your deposit will be charged to hold your appointment. The remaining balance is due at the time of service.
      </p>
    </div>
  );
}
```
  </action>
  <verify>
Check both component files exist in apps/web/src/components/booking/.
Run `pnpm --filter @peacase/web exec tsc --noEmit` - should compile.
Components export PaymentForm and BookingSummary.
  </verify>
  <done>
PaymentForm component with Stripe Payment Element and error handling, BookingSummary component with deposit breakdown created.
  </done>
</task>

</tasks>

<verification>
1. Stripe packages in apps/web/package.json: @stripe/stripe-js, @stripe/react-stripe-js
2. apps/web/src/lib/stripe.ts exports getStripe function
3. apps/web/src/hooks/usePayment.ts exports usePayment hook
4. apps/web/src/components/booking/PaymentForm.tsx renders PaymentElement
5. apps/web/src/components/booking/BookingSummary.tsx shows deposit breakdown
6. `pnpm --filter @peacase/web exec tsc --noEmit` passes
</verification>

<success_criteria>
- Stripe.js loads lazily when needed
- PaymentForm handles errors with friendly messages
- Retry button available after decline
- BookingSummary shows service total, deposit, and balance due
</success_criteria>

<output>
After completion, create `.planning/phases/04-payment-processing/04-03-SUMMARY.md`
</output>
