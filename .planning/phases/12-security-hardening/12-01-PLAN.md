---
phase: 12-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routes/clientPortal.ts
  - apps/api/src/routes/ownerNotifications.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "clientPortal client lookups include salonId for defense-in-depth"
    - "clientPortal client updates include salonId in WHERE clause"
    - "ownerNotifications routes verify user belongs to current salon"
  artifacts:
    - path: "apps/api/src/routes/clientPortal.ts"
      provides: "Client portal with tenant-safe queries"
      contains: "where: { id: clientId, salonId }"
    - path: "apps/api/src/routes/ownerNotifications.ts"
      provides: "Owner notifications with salonId verification"
      contains: "salonId: req.user!.salonId"
  key_links:
    - from: "clientPortal.ts line 308"
      to: "prisma.client.findUnique"
      via: "WHERE clause"
      pattern: "id: clientId, salonId"
    - from: "clientPortal.ts line 550"
      to: "prisma.client.update"
      via: "WHERE clause"
      pattern: "id: clientId, salonId"
---

<objective>
Add salonId to remaining Prisma queries for defense-in-depth tenant isolation

Purpose: Complete AUTH-01 requirement by fixing the 2 remaining client queries in clientPortal.ts
and adding salonId verification to ownerNotifications routes.

Output: Tenant-safe Prisma queries with salonId in all WHERE clauses
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-security-hardening/12-CONTEXT.md
@.planning/phases/09-authentication-tenant-isolation/09-FINDINGS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add salonId to clientPortal.ts remaining queries</name>
  <files>apps/api/src/routes/clientPortal.ts</files>
  <action>
    Fix the two remaining client queries that are missing salonId:

    1. Line 308 (in POST /booking):
       Before: `prisma.client.findUnique({ where: { id: clientId } })`
       After:  `prisma.client.findFirst({ where: { id: clientId, salonId } })`
       Note: Change findUnique to findFirst since we're adding a non-unique field

    2. Line 550 (in POST /reviews - loyalty points update):
       Before: `prisma.client.update({ where: { id: clientId } })`
       After:  `prisma.client.update({ where: { id: clientId, salonId } })`
       Note: This update already has the salonId available from the client token

    The salonId is already extracted from the client token at line 275 and 492.
    Both routes already have: `const { id: clientId, salonId } = (req as any as AuthenticatedClientRequest).client;`
  </action>
  <verify>
    Run grep to confirm both queries now include salonId:
    `grep -n "clientId, salonId" apps/api/src/routes/clientPortal.ts`
  </verify>
  <done>
    - Line 308 uses `findFirst({ where: { id: clientId, salonId } })`
    - Line 550 uses `update({ where: { id: clientId, salonId } })`
  </done>
</task>

<task type="auto">
  <name>Task 2: Add salonId verification to ownerNotifications routes</name>
  <files>apps/api/src/routes/ownerNotifications.ts</files>
  <action>
    Add salonId verification to ownerNotifications routes for defense-in-depth.
    Currently, routes filter by userId only. While this is safe (userId is unique per user),
    adding salonId provides additional protection.

    1. GET / (line 32):
       Before: `where: { userId }`
       After: Verify user's salonId matches before returning preferences

    2. PATCH / (line 80):
       Before: upsert with `where: { userId }`
       After: Verify user's salonId before upsert

    3. POST /test (line 132):
       Before: `where: { userId }`
       After: Add salonId verification

    Implementation approach:
    - Add `const { salonId } = req.user!;` after getting userId
    - Verify user belongs to salon by checking `user.salonId === salonId`
    - This is defense-in-depth since userId is already unique per user
  </action>
  <verify>
    Run grep to confirm salonId is now used in ownerNotifications:
    `grep -n "salonId" apps/api/src/routes/ownerNotifications.ts`
  </verify>
  <done>
    - All routes extract and verify salonId
    - User's salon membership is verified before operations
  </done>
</task>

</tasks>

<verification>
1. Confirm clientPortal queries include salonId:
   - `grep -n "id: clientId, salonId" apps/api/src/routes/clientPortal.ts`

2. Confirm ownerNotifications uses salonId:
   - `grep -n "salonId" apps/api/src/routes/ownerNotifications.ts`

3. Run TypeScript compilation:
   - `cd apps/api && npx tsc --noEmit`
</verification>

<success_criteria>
1. Zero Prisma client queries in clientPortal.ts without salonId in WHERE clause
2. ownerNotifications routes verify user belongs to current salon
3. TypeScript compiles without errors
4. AUTH-01 fully satisfied (100% tenant isolation)
</success_criteria>

<output>
After completion, create `.planning/phases/12-security-hardening/12-01-SUMMARY.md`
</output>
