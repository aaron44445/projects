---
phase: 05-notification-system
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routes/appointments.ts
  - apps/api/src/routes/clientPortal.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Confirmation email includes Add to Calendar links for Google, Outlook, Yahoo, Apple"
    - "Calendar links appear in both desktop and mobile email views"
  artifacts:
    - path: "apps/api/src/routes/appointments.ts"
      provides: "Calendar fields passed to appointmentConfirmationEmail"
      contains: "startTime.*endTime.*salonTimezone"
    - path: "apps/api/src/routes/clientPortal.ts"
      provides: "Calendar fields passed to appointmentConfirmationEmail"
      contains: "startTime.*endTime.*salonTimezone"
  key_links:
    - from: "appointments.ts"
      to: "appointmentConfirmationEmail"
      via: "startTime, endTime, salonTimezone, salonEmail parameters"
      pattern: "appointmentConfirmationEmail.*startTime.*endTime"
    - from: "clientPortal.ts"
      to: "appointmentConfirmationEmail"
      via: "startTime, endTime, salonTimezone, salonEmail parameters"
      pattern: "appointmentConfirmationEmail.*startTime.*endTime"
---

<objective>
Pass calendar fields to appointmentConfirmationEmail in all booking confirmation call sites

Purpose: Fix missing "Add to Calendar" links in booking confirmation emails reported in UAT Test 2
Output: Calendar links (Google, Outlook, Yahoo, Apple ICS) appear in all booking confirmation emails
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-notification-system/05-UAT.md

Relevant code context:
- apps/api/src/services/email.ts: appointmentConfirmationEmail accepts optional startTime, endTime, salonTimezone, salonEmail - when present, generates calendar links section
- apps/api/src/routes/public.ts: Already passes calendar fields correctly (lines 862-864)
- apps/api/src/routes/appointments.ts: Missing calendar fields at line 400-407
- apps/api/src/routes/clientPortal.ts: Missing calendar fields at line 384-391
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add calendar fields to appointments.ts confirmation email</name>
  <files>apps/api/src/routes/appointments.ts</files>
  <action>
Update the appointmentConfirmationEmail call around line 400-407 to include the 4 calendar fields:

1. Calculate endTime from startTime + service duration:
   ```typescript
   const appointmentEndTime = new Date(appointment.startTime);
   appointmentEndTime.setMinutes(appointmentEndTime.getMinutes() + service.durationMinutes);
   ```

2. Fetch salon timezone and email (salon is already fetched above, just need to include timezone and email in select):
   - Add `timezone: true` and `email: true` to the salon select query
   - Or re-fetch salon with these fields if not available

3. Update the appointmentConfirmationEmail call to include:
   ```typescript
   appointmentConfirmationEmail({
     clientName: client.firstName,
     serviceName: service.name,
     staffName: `${staff?.firstName} ${staff?.lastName}`,
     dateTime: formattedDateTime,
     salonName: salon?.name || '',
     salonAddress: salon?.address || '',
     // Calendar fields
     startTime: appointment.startTime,
     endTime: appointmentEndTime,
     salonTimezone: salon?.timezone,
     salonEmail: salon?.email,
   })
   ```
  </action>
  <verify>
TypeScript compilation: `cd apps/api && npx tsc --noEmit`
Grep for calendar fields: `grep -A10 "appointmentConfirmationEmail" apps/api/src/routes/appointments.ts`
  </verify>
  <done>appointmentConfirmationEmail in appointments.ts passes startTime, endTime, salonTimezone, salonEmail</done>
</task>

<task type="auto">
  <name>Task 2: Add calendar fields to clientPortal.ts confirmation email</name>
  <files>apps/api/src/routes/clientPortal.ts</files>
  <action>
Update the appointmentConfirmationEmail call around line 384-391 to include the 4 calendar fields:

1. Calculate endTime from startTime + service duration:
   ```typescript
   const appointmentEndTime = new Date(appointmentStart);
   appointmentEndTime.setMinutes(appointmentEndTime.getMinutes() + service.durationMinutes);
   ```

2. Update the salon fetch (around line 376-379) to include timezone and email:
   ```typescript
   const salon = await prisma.salon.findUnique({
     where: { id: salonId },
     select: { name: true, timezone: true, email: true, address: true },
   });
   ```

3. Update the appointmentConfirmationEmail call to include:
   ```typescript
   appointmentConfirmationEmail({
     clientName: `${client!.firstName} ${client!.lastName}`,
     serviceName: service.name,
     staffName: `${staff.firstName} ${staff.lastName}`,
     dateTime: appointmentStart.toLocaleString(),
     salonName: salon?.name || '',
     salonAddress: salon?.address || '',
     // Calendar fields
     startTime: appointmentStart,
     endTime: appointmentEndTime,
     salonTimezone: salon?.timezone,
     salonEmail: salon?.email,
   })
   ```
  </action>
  <verify>
TypeScript compilation: `cd apps/api && npx tsc --noEmit`
Grep for calendar fields: `grep -A10 "appointmentConfirmationEmail" apps/api/src/routes/clientPortal.ts`
  </verify>
  <done>appointmentConfirmationEmail in clientPortal.ts passes startTime, endTime, salonTimezone, salonEmail</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `cd apps/api && npx tsc --noEmit`
2. All 3 call sites now pass calendar fields:
   - `grep -c "startTime.*endTime" apps/api/src/routes/appointments.ts` returns 1+
   - `grep -c "startTime.*endTime" apps/api/src/routes/clientPortal.ts` returns 1+
   - `grep -c "startTime.*endTime" apps/api/src/routes/public.ts` returns 1+ (already done)
</verification>

<success_criteria>
- appointmentConfirmationEmail calls in appointments.ts and clientPortal.ts include startTime, endTime, salonTimezone, salonEmail
- TypeScript compilation passes
- Email template will render calendar links section when these fields are present
</success_criteria>

<output>
After completion, create `.planning/phases/05-notification-system/05-06-SUMMARY.md`
</output>
