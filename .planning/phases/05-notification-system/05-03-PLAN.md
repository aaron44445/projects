---
phase: 05-notification-system
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - apps/api/package.json
  - apps/api/src/lib/calendar.ts
  - apps/api/src/services/email.ts
autonomous: true

must_haves:
  truths:
    - "Booking confirmation emails include Add to Calendar links for Google, Outlook, Yahoo"
    - "ICS file content is generated and attached or linked in email"
    - "Calendar events include correct appointment details and salon timezone"
  artifacts:
    - path: "apps/api/src/lib/calendar.ts"
      provides: "Calendar link and ICS generation utilities"
      exports: ["generateCalendarLinks", "generateICS"]
    - path: "apps/api/src/services/email.ts"
      provides: "Updated confirmation email with calendar links"
      contains: "calendarLinks"
  key_links:
    - from: "apps/api/src/services/email.ts"
      to: "apps/api/src/lib/calendar.ts"
      via: "import for calendar links"
      pattern: "import.*generateCalendarLinks.*from.*calendar"
---

<objective>
Add calendar integration to booking confirmation emails with Add to Calendar links and ICS content.

Purpose: Clients can easily add appointments to their calendars (Google, Outlook, Apple)
Output: Calendar link generator + updated confirmation email template with links
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-notification-system/05-CONTEXT.md
@.planning/phases/05-notification-system/05-RESEARCH.md
@.planning/phases/05-notification-system/05-01-SUMMARY.md
@apps/api/src/services/email.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install calendar libraries</name>
  <files>apps/api/package.json</files>
  <action>
Install the calendar link generation libraries in the API package.

Run from the spa-final root directory:
```bash
pnpm add ics calendar-link --filter @peacase/api
```

These libraries provide:
- `ics`: Generates .ics file content for Apple Calendar and other ICS-compatible apps
- `calendar-link`: Generates URLs for Google Calendar, Outlook Web, Yahoo Calendar

After installation, verify the packages are in apps/api/package.json dependencies.
  </action>
  <verify>
Check apps/api/package.json includes "ics" and "calendar-link" in dependencies.
Run `pnpm install` from root to ensure lockfile is updated.
  </verify>
  <done>
ics and calendar-link packages installed in @peacase/api.
Lockfile updated with new dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create calendar utilities module</name>
  <files>apps/api/src/lib/calendar.ts</files>
  <action>
Create a new calendar utilities module that generates calendar links and ICS content.

```typescript
import { createEvent, EventAttributes } from 'ics';
import { google, outlook, yahoo, ics as icsLink } from 'calendar-link';

export interface CalendarEventData {
  title: string;
  description: string;
  location: string;
  startTime: Date;
  endTime: Date;
  timezone?: string;  // e.g., 'America/New_York'
  organizerName?: string;
  organizerEmail?: string;
}

export interface CalendarLinks {
  google: string;
  outlook: string;
  yahoo: string;
  icsDownload: string;  // Data URL for direct download
}

/**
 * Generate add-to-calendar links for various providers
 */
export function generateCalendarLinks(event: CalendarEventData): CalendarLinks {
  const calendarEvent = {
    title: event.title,
    description: event.description,
    location: event.location,
    start: event.startTime.toISOString(),
    end: event.endTime.toISOString(),
  };

  // Generate ICS content for download link
  const icsContent = generateICSContent(event);
  const icsDataUrl = `data:text/calendar;charset=utf-8,${encodeURIComponent(icsContent)}`;

  return {
    google: google(calendarEvent),
    outlook: outlook(calendarEvent),
    yahoo: yahoo(calendarEvent),
    icsDownload: icsDataUrl,
  };
}

/**
 * Generate ICS file content for Apple Calendar and other ICS apps
 */
export function generateICSContent(event: CalendarEventData): string {
  const start = event.startTime;
  const end = event.endTime;

  const eventAttrs: EventAttributes = {
    start: [
      start.getFullYear(),
      start.getMonth() + 1,  // ics uses 1-indexed months
      start.getDate(),
      start.getHours(),
      start.getMinutes(),
    ],
    end: [
      end.getFullYear(),
      end.getMonth() + 1,
      end.getDate(),
      end.getHours(),
      end.getMinutes(),
    ],
    title: event.title,
    description: event.description,
    location: event.location,
    status: 'CONFIRMED',
    busyStatus: 'BUSY',
  };

  // Add organizer if provided
  if (event.organizerName && event.organizerEmail) {
    eventAttrs.organizer = {
      name: event.organizerName,
      email: event.organizerEmail,
    };
  }

  const { error, value } = createEvent(eventAttrs);

  if (error) {
    console.error('Error generating ICS:', error);
    // Return minimal valid ICS on error
    return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Peacase//Appointment//EN
BEGIN:VEVENT
DTSTART:${formatICSDate(start)}
DTEND:${formatICSDate(end)}
SUMMARY:${event.title}
LOCATION:${event.location}
END:VEVENT
END:VCALENDAR`;
  }

  return value!;
}

/**
 * Format date for ICS (YYYYMMDDTHHmmssZ)
 */
function formatICSDate(date: Date): string {
  return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
}

/**
 * Generate calendar event for an appointment
 */
export function createAppointmentCalendarEvent(data: {
  serviceName: string;
  staffName: string;
  salonName: string;
  salonAddress: string;
  salonEmail?: string;
  startTime: Date;
  endTime: Date;
  salonTimezone?: string;
}): CalendarEventData {
  return {
    title: `${data.serviceName} at ${data.salonName}`,
    description: `Your appointment with ${data.staffName}`,
    location: data.salonAddress,
    startTime: data.startTime,
    endTime: data.endTime,
    timezone: data.salonTimezone,
    organizerName: data.salonName,
    organizerEmail: data.salonEmail,
  };
}
```
  </action>
  <verify>
TypeScript compiles: `cd apps/api && pnpm exec tsc --noEmit`
  </verify>
  <done>
calendar.ts exports generateCalendarLinks, generateICSContent, createAppointmentCalendarEvent.
Links generated for Google, Outlook, Yahoo, and ICS download.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update confirmation email with calendar links</name>
  <files>apps/api/src/services/email.ts</files>
  <action>
Update the appointmentConfirmationEmail function to include calendar links.

1. Import the calendar utilities at the top of the file:
```typescript
import { generateCalendarLinks, createAppointmentCalendarEvent, CalendarLinks } from '../lib/calendar.js';
```

2. Update the appointmentConfirmationEmail function signature to accept optional calendar data:
```typescript
export function appointmentConfirmationEmail(data: {
  clientName: string;
  serviceName: string;
  staffName: string;
  dateTime: string;
  salonName: string;
  salonAddress: string;
  // New optional fields for calendar
  startTime?: Date;
  endTime?: Date;
  salonTimezone?: string;
  salonEmail?: string;
}): string {
```

3. Generate calendar links if time data is provided:
```typescript
  // Generate calendar links if appointment times provided
  let calendarSection = '';
  if (data.startTime && data.endTime) {
    const calendarEvent = createAppointmentCalendarEvent({
      serviceName: data.serviceName,
      staffName: data.staffName,
      salonName: data.salonName,
      salonAddress: data.salonAddress,
      salonEmail: data.salonEmail,
      startTime: data.startTime,
      endTime: data.endTime,
      salonTimezone: data.salonTimezone,
    });
    const links = generateCalendarLinks(calendarEvent);

    calendarSection = `
      <div style="margin: 20px 0; padding: 15px; background: #E8F4EA; border-radius: 8px;">
        <p style="margin: 0 0 10px 0; font-weight: 600;">Add to your calendar:</p>
        <p style="margin: 0;">
          <a href="${links.google}" target="_blank" style="color: #4285F4; text-decoration: none; margin-right: 15px;">Google Calendar</a>
          <a href="${links.outlook}" target="_blank" style="color: #0078D4; text-decoration: none; margin-right: 15px;">Outlook</a>
          <a href="${links.yahoo}" target="_blank" style="color: #6001D2; text-decoration: none; margin-right: 15px;">Yahoo</a>
          <a href="${links.icsDownload}" download="appointment.ics" style="color: #6B9B76; text-decoration: none;">Apple Calendar (.ics)</a>
        </p>
      </div>
    `;
  }
```

4. Insert the calendar section into the email template after the details div:
```html
<div class="details">
  <!-- existing appointment details -->
</div>
${calendarSection}
<p>Need to reschedule? Please contact us at least 24 hours before your appointment.</p>
```

5. Ensure backward compatibility - if startTime/endTime not provided, calendar section simply won't appear.
  </action>
  <verify>
TypeScript compiles: `cd apps/api && pnpm exec tsc --noEmit`
Test by generating an email with calendar data and verify links work.
  </verify>
  <done>
Confirmation emails include Add to Calendar section when appointment times provided.
Google, Outlook, Yahoo, and .ics download links functional.
Backward compatible with existing code that doesn't pass calendar data.
  </done>
</task>

</tasks>

<verification>
1. API builds: `cd apps/api && pnpm run build`
2. TypeScript compiles: `cd apps/api && pnpm exec tsc --noEmit`
3. Calendar links are valid URLs (Google, Outlook, Yahoo)
4. ICS download link contains properly formatted calendar data
5. Confirmation email renders calendar section when times provided
</verification>

<success_criteria>
- ics and calendar-link packages installed
- Calendar link generation working for Google/Outlook/Yahoo/ICS
- Booking confirmation emails include Add to Calendar section
- ICS file downloadable from email link
- Backward compatible - old code without calendar data still works
</success_criteria>

<output>
After completion, create `.planning/phases/05-notification-system/05-03-SUMMARY.md`
</output>
