---
phase: 05-notification-system
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/hooks/useNotificationSettings.ts
  - apps/web/src/app/settings/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Notification settings persist after save and refresh"
    - "Reminder timing changes (24h, 48h, 2h) are saved to database"
    - "Email/SMS channel toggles are saved to database"
  artifacts:
    - path: "apps/web/src/hooks/useNotificationSettings.ts"
      provides: "Hook for fetching and saving notification settings"
      exports: ["useNotificationSettings"]
    - path: "apps/web/src/app/settings/page.tsx"
      provides: "Notification settings UI wired to API"
      contains: "useNotificationSettings"
  key_links:
    - from: "apps/web/src/app/settings/page.tsx"
      to: "/api/v1/salon/notification-settings"
      via: "useNotificationSettings hook"
      pattern: "useNotificationSettings"
    - from: "apps/web/src/hooks/useNotificationSettings.ts"
      to: "GET /api/v1/salon/notification-settings"
      via: "fetch call"
      pattern: "notification-settings"
---

<objective>
Wire notification settings UI to API for persistence

Purpose: Fix notification settings not saving reported in UAT Test 5 - "doesnt save when i select it then save then refresh the page it goes back to 24 hrs"
Output: Notification settings (reminder timing, email/SMS channels) persist across page refreshes
</objective>

<execution_context>
@C:\Users\aaron\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aaron\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-notification-system/05-UAT.md
@.planning/phases/05-notification-system/05-04-SUMMARY.md

API already exists:
- GET /api/v1/salon/notification-settings - returns { reminders: { enabled, timings }, channels: { email, sms } }
- PUT /api/v1/salon/notification-settings - accepts same structure

Frontend problem:
- apps/web/src/app/settings/page.tsx lines 2086-2197 have static HTML with defaultChecked and no state management
- No hook exists to fetch/save settings
- Need to create hook and wire up the UI
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useNotificationSettings hook</name>
  <files>apps/web/src/hooks/useNotificationSettings.ts</files>
  <action>
Create a new hook at apps/web/src/hooks/useNotificationSettings.ts that:

1. Defines the NotificationSettings interface matching the API:
   ```typescript
   interface ReminderTiming {
     hours: number;
     enabled: boolean;
   }

   interface NotificationSettings {
     reminders: {
       enabled: boolean;
       timings: ReminderTiming[];
     };
     channels: {
       email: boolean;
       sms: boolean;
     };
   }
   ```

2. Exports useNotificationSettings hook that:
   - Uses React useState for settings, loading, error, saving states
   - Fetches from GET /api/v1/salon/notification-settings on mount
   - Provides updateSettings function that:
     - Sets saving state
     - PUTs to /api/v1/salon/notification-settings
     - Updates local state on success
     - Shows toast on success/error (use sonner if available, or console.log)
   - Provides helper functions:
     - setReminderTiming(hours: number) - updates the primary reminder timing
     - toggleChannel(channel: 'email' | 'sms') - toggles a channel
     - toggleReminders() - toggles reminders.enabled

3. Use the existing API client pattern from the codebase (check apps/web/src/lib/api.ts or similar)
  </action>
  <verify>
File exists: `ls apps/web/src/hooks/useNotificationSettings.ts`
TypeScript compilation: `cd apps/web && npx tsc --noEmit`
  </verify>
  <done>useNotificationSettings hook created with fetch, save, and helper functions</done>
</task>

<task type="auto">
  <name>Task 2: Wire notification settings UI to hook</name>
  <files>apps/web/src/app/settings/page.tsx</files>
  <action>
Update the notifications case (lines 2086-2197) in settings/page.tsx:

1. Import the hook at the top of the file:
   ```typescript
   import { useNotificationSettings } from '@/hooks/useNotificationSettings';
   ```

2. Call the hook inside the component (near other hooks):
   ```typescript
   const {
     settings: notificationSettings,
     loading: notificationLoading,
     saving: notificationSaving,
     updateSettings: updateNotificationSettings,
     setReminderTiming,
     toggleChannel,
     toggleReminders
   } = useNotificationSettings();
   ```

3. Update the "Appointment Reminder" select (around line 2149):
   - Replace `<select disabled={notificationsLocked} className=...>`
   - Add value binding: `value={notificationSettings?.reminders?.timings?.[0]?.hours || 24}`
   - Add onChange handler: `onChange={(e) => setReminderTiming(parseInt(e.target.value))}`

4. Update the checkboxes for email/SMS channels:
   - Replace `defaultChecked` with `checked={notificationSettings?.channels?.email}`
   - Add onChange: `onChange={() => toggleChannel('email')}`
   - Same pattern for SMS checkbox

5. Update the reminder toggle (around line 2143):
   - Replace `defaultChecked` with `checked={notificationSettings?.reminders?.enabled}`
   - Add onChange: `onChange={() => toggleReminders()}`

6. Add a Save button or auto-save on change:
   - Option A (auto-save): Call updateSettings in each onChange after local state update
   - Option B (explicit save): Add Save button that calls updateSettings
   - Recommended: Auto-save with debounce for better UX

7. Show loading state while fetching:
   ```typescript
   {notificationLoading ? (
     <div>Loading settings...</div>
   ) : (
     // existing notification settings UI
   )}
   ```

8. Show saving indicator:
   - Add visual feedback when saving (spinner, "Saving..." text)
  </action>
  <verify>
TypeScript compilation: `cd apps/web && npx tsc --noEmit`
Grep for hook usage: `grep "useNotificationSettings" apps/web/src/app/settings/page.tsx`
  </verify>
  <done>Notification settings UI is wired to useNotificationSettings hook with state bindings and save functionality</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `cd apps/web && npx tsc --noEmit`
2. Hook exists and is imported: `grep -l "useNotificationSettings" apps/web/src/hooks/useNotificationSettings.ts apps/web/src/app/settings/page.tsx`
3. Settings UI has value bindings: `grep -c "value=\|checked=" apps/web/src/app/settings/page.tsx` shows increased count in notifications section
</verification>

<success_criteria>
- useNotificationSettings hook exists and fetches/saves to API
- Notification settings UI is wired to the hook
- Changing reminder timing and saving persists the value
- Refreshing the page shows the previously saved value
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-notification-system/05-07-SUMMARY.md`
</output>
