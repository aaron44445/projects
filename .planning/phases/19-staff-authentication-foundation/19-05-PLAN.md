---
phase: 19-staff-authentication-foundation
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/app/staff/layout.tsx
  - apps/web/src/components/staff/StaffHeader.tsx
autonomous: true

must_haves:
  truths:
    - "Staff portal header shows logout button"
    - "Logout clears all tokens (access, refresh, local storage)"
    - "Logout redirects to /staff/login"
    - "Logout works from any page in staff portal"
  artifacts:
    - path: "apps/web/src/app/staff/layout.tsx"
      provides: "Staff portal layout with header"
      contains: "logout"
    - path: "apps/web/src/components/staff/StaffHeader.tsx"
      provides: "Staff header component with logout button"
      contains: "logout"
  key_links:
    - from: "apps/web/src/components/staff/StaffHeader.tsx"
      to: "StaffAuthContext.logout"
      via: "logout button onClick"
      pattern: "logout"
---

<objective>
Ensure staff can log out from any page in the portal with a visible logout button in the header.

Purpose: Complete the authentication flow - staff must be able to securely end their session from anywhere in the portal.

Output: Staff header component with logout functionality, integrated into staff portal layout.

Note: StaffAuthContext.logout already exists (line 274 of StaffAuthContext.tsx). This plan verifies it's properly wired to the UI and creates the header component if needed.
</objective>

<execution_context>
@C:\Users\aaron\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\aaron\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-staff-authentication-foundation/19-CONTEXT.md
@apps/web/src/app/staff/layout.tsx
@apps/web/src/contexts/StaffAuthContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Check existing staff layout and header implementation</name>
  <files>apps/web/src/app/staff/layout.tsx</files>
  <action>
Examine the existing staff layout to understand current structure.

Check for:
1. Does a header component already exist?
2. Is there already a logout button?
3. What's the current layout structure?

If a header with logout already exists, this task becomes verification. If not, proceed to Task 2.

Read apps/web/src/app/staff/layout.tsx and any referenced components to understand current state.

If logout functionality already exists, verify:
- Logout button is visible
- Clicking logout calls the context logout function
- After logout, user is redirected to /staff/login
- All tokens are cleared

If existing, just verify and document. If missing, proceed to create.
  </action>
  <verify>
Read the layout file.
Search for "logout" in the layout and any header component.
Check if StaffAuthContext.logout is used.
  </verify>
  <done>
Current staff layout and logout implementation status documented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement or verify logout button in staff header</name>
  <files>apps/web/src/app/staff/layout.tsx, apps/web/src/components/staff/StaffHeader.tsx</files>
  <action>
Ensure there's a visible logout button in the staff portal header.

If header/logout doesn't exist, create it:

1. Create StaffHeader component (if not exists):
```tsx
// apps/web/src/components/staff/StaffHeader.tsx
'use client';

import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { LogOut, User, Menu } from 'lucide-react';
import { useStaffAuth } from '@/contexts/StaffAuthContext';
import { useState } from 'react';

export function StaffHeader() {
  const router = useRouter();
  const { staff, logout, isAuthenticated } = useStaffAuth();
  const [isLoggingOut, setIsLoggingOut] = useState(false);

  const handleLogout = async () => {
    setIsLoggingOut(true);
    try {
      await logout();
      router.push('/staff/login');
    } catch (error) {
      console.error('Logout failed:', error);
      // Still redirect even if API call fails - local state is cleared
      router.push('/staff/login');
    }
  };

  if (!isAuthenticated || !staff) {
    return null;
  }

  return (
    <header className="bg-white border-b border-charcoal/10 sticky top-0 z-40">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex items-center justify-between h-16">
          {/* Logo/Brand */}
          <div className="flex items-center gap-3">
            <Link href="/staff/dashboard" className="font-display font-bold text-xl text-charcoal">
              Peacase
            </Link>
            <span className="text-xs bg-sage/10 text-sage px-2 py-1 rounded-full">
              Staff Portal
            </span>
          </div>

          {/* User Menu */}
          <div className="flex items-center gap-4">
            <div className="text-sm text-charcoal/70">
              {staff.firstName} {staff.lastName}
            </div>
            <button
              onClick={handleLogout}
              disabled={isLoggingOut}
              className="flex items-center gap-2 px-3 py-2 text-sm text-charcoal/70 hover:text-charcoal hover:bg-charcoal/5 rounded-lg transition-colors disabled:opacity-50"
              aria-label="Log out"
            >
              <LogOut className="w-4 h-4" />
              <span className="hidden sm:inline">Log out</span>
            </button>
          </div>
        </div>
      </div>
    </header>
  );
}
```

2. Update staff layout to include header:
```tsx
// In apps/web/src/app/staff/layout.tsx
import { StaffHeader } from '@/components/staff/StaffHeader';

export default function StaffLayout({ children }) {
  return (
    <div className="min-h-screen bg-cream">
      <StaffHeader />
      <main>{children}</main>
    </div>
  );
}
```

If logout already exists, verify it:
- Calls logout() from StaffAuthContext
- Redirects to /staff/login after logout
- Is visible on all pages (in layout, not individual pages)
- Shows loading state during logout
  </action>
  <verify>
Search for "logout" in the header component.
Verify logout redirects to /staff/login.
Check that StaffHeader is used in the layout.
  </verify>
  <done>
Staff portal has visible logout button in header that clears tokens and redirects to login.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify logout clears all tokens properly</name>
  <files>apps/web/src/contexts/StaffAuthContext.tsx</files>
  <action>
Verify the logout function in StaffAuthContext properly clears all tokens.

Check that logout():
1. Calls the API logout endpoint (to invalidate refresh token server-side)
2. Clears access token from memory/storage
3. Clears refresh token from localStorage
4. Clears the staff state
5. Stops the token refresh timer

The current implementation should already do this, but verify:

```typescript
const logout = async (): Promise<void> => {
  stopTokenRefreshTimer();  // Stop background refresh

  try {
    await api.post('/staff-portal/auth/logout');  // Server-side invalidation
  } catch {
    // Ignore errors - clear local state anyway
  } finally {
    clearTokens();  // Clear localStorage
    setStaff(null);  // Clear React state
  }
};
```

The clearTokens function should:
```typescript
const clearTokens = useCallback(() => {
  localStorage.removeItem(STAFF_ACCESS_TOKEN_KEY);
  localStorage.removeItem(STAFF_REFRESH_TOKEN_KEY);
  api.setAccessToken(null);
}, []);
```

If any of these are missing, add them. Per CONTEXT.md: "Logout clears access token, refresh token, and any local storage"
  </action>
  <verify>
Search StaffAuthContext for logout function.
Verify clearTokens removes both access and refresh tokens.
Verify api.setAccessToken(null) is called.
  </verify>
  <done>
Logout function verified to clear all tokens (access, refresh, local storage) and redirect to login.
  </done>
</task>

</tasks>

<verification>
1. Staff header exists with logout button
2. Logout calls StaffAuthContext.logout
3. After logout, user is at /staff/login
4. localStorage is cleared of staff tokens
5. Subsequent API calls fail (tokens gone)
</verification>

<success_criteria>
- [ ] Logout button visible in staff portal header
- [ ] Clicking logout clears all tokens
- [ ] User redirected to /staff/login after logout
- [ ] Logout works from any page (header is in layout)
- [ ] Loading state shown during logout
</success_criteria>

<output>
After completion, create `.planning/phases/19-staff-authentication-foundation/19-05-SUMMARY.md`
</output>
