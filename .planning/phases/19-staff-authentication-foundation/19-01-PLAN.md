---
phase: 19-staff-authentication-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routes/staffPortal.ts
  - apps/api/src/middleware/staffAuth.ts
autonomous: true

must_haves:
  truths:
    - "Staff tokens include portalType: 'staff' claim"
    - "Staff tokens use 15-minute access expiry"
    - "Staff tokens with rememberMe use 30-day refresh, without use 24-hour refresh"
    - "Middleware rejects staff tokens on owner routes with 401"
  artifacts:
    - path: "apps/api/src/routes/staffPortal.ts"
      provides: "Portal-specific JWT generation with portalType claim"
      contains: "portalType: 'staff'"
    - path: "apps/api/src/middleware/staffAuth.ts"
      provides: "staffPortalOnly middleware for route protection"
      exports: ["staffPortalOnly"]
  key_links:
    - from: "apps/api/src/routes/staffPortal.ts"
      to: "jwt.sign"
      via: "generateStaffTokens function"
      pattern: "portalType.*staff"
---

<objective>
Implement portal-specific JWT tokens for staff authentication with short-lived access tokens (15 min) and remember-me functionality.

Purpose: Staff tokens must be distinguishable from owner tokens to prevent cross-portal access. This is the security foundation for the entire staff portal.

Output: Modified staffPortal.ts with portal-specific token generation, updated staffAuth.ts with middleware to reject staff tokens on owner routes.
</objective>

<execution_context>
@C:\Users\aaron\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\aaron\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-staff-authentication-foundation/19-CONTEXT.md
@.planning/phases/19-staff-authentication-foundation/19-RESEARCH.md
@apps/api/src/routes/staffPortal.ts
@apps/api/src/middleware/staffAuth.ts
@apps/api/src/middleware/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update JWT token generation with portal-specific claims</name>
  <files>apps/api/src/routes/staffPortal.ts</files>
  <action>
Modify the generateTokens function in staffPortal.ts to:

1. Rename to generateStaffTokens for clarity
2. Add `portalType: 'staff'` claim to both access and refresh tokens
3. Change ACCESS_TOKEN_EXPIRY from '7d' to '15m' (15 minutes per CONTEXT.md requirement)
4. Add rememberMe parameter to control refresh token expiry:
   - When true: 30-day refresh token (REFRESH_TOKEN_EXPIRY = '30d')
   - When false: 24-hour refresh token (SESSION_TOKEN_EXPIRY = '24h')
5. Update all calls to generateTokens -> generateStaffTokens with rememberMe parameter

Token structure should include:
```typescript
const accessToken = jwt.sign(
  {
    userId,
    salonId,
    role,
    staffId: userId,  // Explicit staff identifier
    portalType: 'staff'  // Portal discrimination claim
  },
  env.JWT_SECRET,
  { expiresIn: STAFF_ACCESS_TOKEN_EXPIRY }  // 15m
);
```

Update all endpoints that generate tokens:
- POST /auth/login - add rememberMe from request body
- POST /setup - default rememberMe to false
- POST /login - add rememberMe from request body

Do NOT change the owner auth.ts file - we're only modifying staff portal tokens.
  </action>
  <verify>
Search for "portalType" in staffPortal.ts to confirm it's added.
Verify ACCESS_TOKEN_EXPIRY is set to '15m'.
Run `grep -n "portalType" apps/api/src/routes/staffPortal.ts` to confirm.
  </verify>
  <done>
Staff JWT tokens include portalType: 'staff' claim, use 15-minute access expiry, and support rememberMe for refresh token duration (30d vs 24h).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update login endpoints to accept rememberMe parameter</name>
  <files>apps/api/src/routes/staffPortal.ts</files>
  <action>
Modify the staff login endpoints to handle rememberMe:

1. Update staffLoginSchema to include optional rememberMe field:
```typescript
const staffLoginSchema = z.object({
  email: z.string().email(),
  password: z.string(),
  rememberMe: z.boolean().optional().default(false),
});
```

2. In POST /auth/login endpoint:
   - Extract rememberMe from validated data
   - Pass rememberMe to generateStaffTokens
   - Set refresh token expiry based on rememberMe:
     - true: 30 days
     - false: 24 hours
   - When storing RefreshToken in database, use the appropriate expiresAt

3. In POST /login endpoint (the other login route):
   - Same changes as above

4. In POST /setup endpoint:
   - Default rememberMe to false (new users shouldn't auto-remember)
   - Use 24-hour refresh token expiry

Update the RefreshToken creation to use dynamic expiry:
```typescript
const refreshExpiry = rememberMe
  ? new Date(Date.now() + 30 * 24 * 60 * 60 * 1000)  // 30 days
  : new Date(Date.now() + 24 * 60 * 60 * 1000);  // 24 hours

await prisma.refreshToken.create({
  data: {
    userId: user.id,
    token: tokens.refreshToken,
    expiresAt: refreshExpiry,
  },
});
```
  </action>
  <verify>
Check that rememberMe is parsed from login requests.
Verify both login endpoints handle the parameter.
Run `grep -n "rememberMe" apps/api/src/routes/staffPortal.ts` to confirm.
  </verify>
  <done>
Staff login endpoints accept rememberMe boolean, generating 30-day refresh tokens when true, 24-hour tokens when false.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add staffPortalOnly middleware to reject staff tokens on owner routes</name>
  <files>apps/api/src/middleware/staffAuth.ts</files>
  <action>
Update apps/api/src/middleware/staffAuth.ts to add a new middleware that:

1. Export a new `staffPortalOnly` middleware function that:
   - Checks req.user exists (should be set by authenticate middleware)
   - Verifies req.user.portalType === 'staff' if the claim exists
   - Returns 403 if portalType is not 'staff'

2. Export a new `ownerPortalOnly` middleware function that:
   - Checks req.user exists
   - Verifies req.user.portalType is NOT 'staff' (owner tokens don't have this claim)
   - Returns 401 with 'Staff tokens cannot access owner routes' if portalType === 'staff'

3. Update the JWTPayload interface in auth.ts middleware to include optional portalType:
```typescript
interface JWTPayload {
  userId: string;
  salonId: string;
  role: string;
  portalType?: 'staff' | 'owner';  // Optional for backward compatibility
  staffId?: string;  // Only present on staff tokens
}
```

Note: The authenticate middleware in auth.ts already decodes the JWT and sets req.user. We just need to check the portalType claim in our new middleware.

The staffPortalOnly middleware should look like:
```typescript
export function staffPortalOnly(req: Request, res: Response, next: NextFunction) {
  if (!req.user) {
    return res.status(401).json({
      success: false,
      error: { code: 'UNAUTHORIZED', message: 'Not authenticated' },
    });
  }

  // If token doesn't have portalType, it's an owner token (backward compatible)
  if (req.user.portalType && req.user.portalType !== 'staff') {
    return res.status(403).json({
      success: false,
      error: { code: 'FORBIDDEN', message: 'Staff portal access required' },
    });
  }

  next();
}
```

The ownerPortalOnly middleware should look like:
```typescript
export function ownerPortalOnly(req: Request, res: Response, next: NextFunction) {
  if (!req.user) {
    return res.status(401).json({
      success: false,
      error: { code: 'UNAUTHORIZED', message: 'Not authenticated' },
    });
  }

  // If portalType is 'staff', reject - staff cannot access owner routes
  if (req.user.portalType === 'staff') {
    return res.status(401).json({
      success: false,
      error: { code: 'UNAUTHORIZED', message: 'Staff tokens cannot access owner routes' },
    });
  }

  next();
}
```
  </action>
  <verify>
Check middleware exports: `grep -n "export function" apps/api/src/middleware/staffAuth.ts`
Verify ownerPortalOnly checks for portalType === 'staff'
  </verify>
  <done>
staffPortalOnly and ownerPortalOnly middleware functions exported, ready to protect routes from cross-portal access.
  </done>
</task>

</tasks>

<verification>
1. Search staffPortal.ts for "portalType" - should find it in token generation
2. Search staffPortal.ts for "15m" or "STAFF_ACCESS_TOKEN_EXPIRY" - should find short expiry
3. Search staffAuth.ts for "ownerPortalOnly" - should find the middleware
4. Verify rememberMe handling in login endpoints
</verification>

<success_criteria>
- [ ] Staff tokens include `portalType: 'staff'` claim
- [ ] Staff access tokens expire in 15 minutes
- [ ] Staff refresh tokens expire in 24h (default) or 30d (rememberMe)
- [ ] ownerPortalOnly middleware can reject staff tokens on owner routes
- [ ] All existing staff auth functionality continues to work
</success_criteria>

<output>
After completion, create `.planning/phases/19-staff-authentication-foundation/19-01-SUMMARY.md`
</output>
