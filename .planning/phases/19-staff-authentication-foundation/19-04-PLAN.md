---
phase: 19-staff-authentication-foundation
plan: 04
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - apps/api/src/routes/index.ts
  - apps/api/src/app.ts
autonomous: true

must_haves:
  truths:
    - "Staff tokens are rejected with 401 on owner API routes"
    - "Owner tokens continue to work on owner routes"
    - "Staff tokens work on staff portal routes"
    - "Defense-in-depth: both middleware and route handlers verify portal type"
  artifacts:
    - path: "apps/api/src/routes/index.ts"
      provides: "Owner routes protected with ownerPortalOnly middleware"
      contains: "ownerPortalOnly"
  key_links:
    - from: "apps/api/src/routes/index.ts"
      to: "ownerPortalOnly middleware"
      via: "route protection"
      pattern: "ownerPortalOnly"
---

<objective>
Apply ownerPortalOnly middleware to owner API routes to prevent staff tokens from accessing owner functionality.

Purpose: Defense-in-depth security - staff tokens with portalType: 'staff' must be rejected on all owner routes even if they have valid signatures.

Output: Owner routes protected by ownerPortalOnly middleware, ensuring cross-portal token rejection.
</objective>

<execution_context>
@C:\Users\aaron\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\aaron\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-staff-authentication-foundation/19-CONTEXT.md
@.planning/phases/19-staff-authentication-foundation/19-01-SUMMARY.md
@apps/api/src/routes/index.ts
@apps/api/src/app.ts
@apps/api/src/middleware/staffAuth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Identify owner-only routes that need protection</name>
  <files>apps/api/src/routes/index.ts, apps/api/src/app.ts</files>
  <action>
First, understand the route structure by examining the app.ts and routes/index.ts files.

Identify all routes that should be owner-only (not staff accessible):
- /api/v1/salon/* - salon settings, billing, etc.
- /api/v1/staff/* - staff management (creating/editing staff)
- /api/v1/services/* - service management
- /api/v1/clients/* - full client management
- /api/v1/reports/* - business reports
- /api/v1/settings/* - salon settings
- /api/v1/payments/* - payment management
- /api/v1/locations/* - location management
- /api/v1/auth/* - owner authentication (separate from staff-portal/auth)

Routes that staff CAN access:
- /api/v1/staff-portal/* - staff portal endpoints (already protected by staffOnly)
- /api/v1/public/* - public endpoints (booking widget, etc.)

Document findings before applying middleware in Task 2.
  </action>
  <verify>
List all route files and their mount points in app.ts or routes/index.ts.
Note which routes need ownerPortalOnly middleware.
  </verify>
  <done>
Owner-only routes identified and documented for middleware application.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply ownerPortalOnly middleware to owner routes</name>
  <files>apps/api/src/app.ts</files>
  <action>
Apply the ownerPortalOnly middleware to protect owner routes from staff token access.

Strategy: Apply middleware at the router mount level for efficiency, rather than on every individual route.

1. Import ownerPortalOnly from staffAuth middleware:
```typescript
import { ownerPortalOnly } from './middleware/staffAuth.js';
```

2. For routes that require authentication AND should be owner-only, apply ownerPortalOnly after authenticate:

Option A - Per-router application (cleaner):
```typescript
// Owner routes - protected from staff tokens
app.use('/api/v1/salon', authenticate, ownerPortalOnly, salonRouter);
app.use('/api/v1/services', authenticate, ownerPortalOnly, servicesRouter);
app.use('/api/v1/staff', authenticate, ownerPortalOnly, staffRouter);
// ... etc
```

Option B - If routes already have authenticate middleware internally:
Add ownerPortalOnly to the router definition file after authenticate.

IMPORTANT: Do NOT apply ownerPortalOnly to:
- /api/v1/staff-portal/* - these are for staff
- /api/v1/public/* - these are public
- /api/v1/booking/* - public booking endpoints
- /api/v1/auth/* - needs special handling (owner login should work)

For /api/v1/auth/*, the existing owner tokens don't have portalType claim, so they'll pass through ownerPortalOnly (which only rejects tokens WITH portalType: 'staff').

Check the actual file structure and apply the middleware appropriately. The goal is:
- Staff token on owner route -> 401
- Owner token on owner route -> allowed
- Staff token on staff-portal route -> allowed
  </action>
  <verify>
Search for "ownerPortalOnly" in app.ts or routes/index.ts.
Verify it's applied to owner routes but NOT staff-portal routes.
Test mentally: staff token should fail on /api/v1/salon but work on /api/v1/staff-portal/dashboard
  </verify>
  <done>
Owner routes protected by ownerPortalOnly middleware, rejecting staff tokens with 401.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update auth.ts JWTPayload interface for portalType</name>
  <files>apps/api/src/middleware/auth.ts</files>
  <action>
Update the JWTPayload interface in auth.ts to include the optional portalType field, so TypeScript understands the claim exists on decoded tokens.

Update the interface:
```typescript
interface JWTPayload {
  userId: string;
  salonId: string;
  role: string;
  portalType?: 'staff';  // Only present on staff tokens
  staffId?: string;      // Only present on staff tokens (same as userId)
}
```

Also update the Express.Request interface augmentation if it exists:
```typescript
declare global {
  namespace Express {
    interface Request {
      user?: JWTPayload;
      userLocations?: string[] | null;
    }
  }
}
```

This ensures:
1. TypeScript knows portalType might exist on decoded tokens
2. Other middleware can check req.user.portalType without type errors
3. Backward compatibility - owner tokens without portalType still work
  </action>
  <verify>
Search auth.ts for "portalType" in the interface.
Run TypeScript check: `cd apps/api && npx tsc --noEmit`
  </verify>
  <done>
JWTPayload interface includes optional portalType field for type safety.
  </done>
</task>

</tasks>

<verification>
1. Search for ownerPortalOnly in route configuration
2. Verify staff-portal routes are NOT affected
3. TypeScript compiles without errors
4. API starts without errors: `cd apps/api && npm run dev` (quick check)
</verification>

<success_criteria>
- [ ] ownerPortalOnly middleware applied to owner routes
- [ ] Staff tokens rejected with 401 on owner routes
- [ ] Owner tokens continue to work on owner routes
- [ ] Staff-portal routes unaffected (staff tokens work)
- [ ] TypeScript compiles without errors
- [ ] API starts successfully
</success_criteria>

<output>
After completion, create `.planning/phases/19-staff-authentication-foundation/19-04-SUMMARY.md`
</output>
