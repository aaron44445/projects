---
phase: 19-staff-authentication-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routes/staffPortal.ts
  - apps/api/src/routes/staff.ts
autonomous: true

must_haves:
  truths:
    - "Owner can manually resend invite to staff member"
    - "Resend generates new magic link token with fresh 72-hour expiry"
    - "API returns invite status (invited/active/expired) for staff list"
    - "Expired invites can be resent without creating duplicate users"
  artifacts:
    - path: "apps/api/src/routes/staffPortal.ts"
      provides: "POST /invite/resend/:staffId endpoint"
      contains: "resend"
    - path: "apps/api/src/routes/staff.ts"
      provides: "Invite status in staff list response"
      contains: "inviteStatus"
  key_links:
    - from: "apps/api/src/routes/staffPortal.ts"
      to: "prisma.user.update"
      via: "resend endpoint updates magicLinkToken"
      pattern: "magicLinkToken"
---

<objective>
Implement manual invite resend functionality and invite status tracking for staff management.

Purpose: Owners need to resend invites when staff miss the initial email, and see at a glance which staff have accepted their invites.

Output: New resend endpoint in staffPortal.ts, invite status added to staff list API responses.
</objective>

<execution_context>
@C:\Users\aaron\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\aaron\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-staff-authentication-foundation/19-CONTEXT.md
@apps/api/src/routes/staffPortal.ts
@apps/api/src/routes/staff.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add resend invite endpoint</name>
  <files>apps/api/src/routes/staffPortal.ts</files>
  <action>
Add a new endpoint for resending staff invites:

POST /api/v1/staff-portal/invite/resend/:staffId

1. Verify the requester is admin/owner (same as /invite endpoint)
2. Verify the staff member exists and belongs to the same salon
3. Verify the staff member hasn't already set a password (passwordHash is null)
4. Generate new magic link token with 72-hour expiry (per CONTEXT.md)
5. Update the user record with new token and expiry
6. Send invite email (reuse existing email sending logic)

Implementation:
```typescript
// ============================================
// POST /api/v1/staff-portal/invite/resend/:staffId
// Resend invite email to staff member
// ============================================
router.post('/invite/resend/:staffId', authenticate, asyncHandler(async (req: Request, res: Response) => {
  if (!req.user || (req.user.role !== 'admin' && req.user.role !== 'owner')) {
    return res.status(403).json({
      success: false,
      error: { code: 'FORBIDDEN', message: 'Only owners and admins can resend invites' },
    });
  }

  const { staffId } = req.params;
  const salonId = req.user.salonId;

  // Find the staff member
  const staff = await prisma.user.findFirst({
    where: {
      id: staffId,
      salonId,
      role: 'staff',
    },
  });

  if (!staff) {
    return res.status(404).json({
      success: false,
      error: { code: 'NOT_FOUND', message: 'Staff member not found' },
    });
  }

  // Check if already activated
  if (staff.passwordHash) {
    return res.status(400).json({
      success: false,
      error: { code: 'ALREADY_ACTIVE', message: 'Staff member has already set their password' },
    });
  }

  // Generate new token with 72-hour expiry (per CONTEXT.md)
  const inviteToken = crypto.randomBytes(32).toString('hex');
  const tokenExpiry = new Date(Date.now() + 72 * 60 * 60 * 1000); // 72 hours

  await prisma.user.update({
    where: { id: staffId },
    data: {
      magicLinkToken: inviteToken,
      magicLinkExpires: tokenExpiry,
    },
  });

  // Get salon for email
  const salon = await prisma.salon.findUnique({
    where: { id: salonId },
  });

  // Send invite email
  const inviteUrl = `${env.FRONTEND_URL}/staff/setup?token=${inviteToken}`;
  logger.info({ email: staff.email, staffId, salonId }, 'Resending staff invite email');

  try {
    await sendEmail({
      to: staff.email,
      subject: `Reminder: You're invited to join ${salon?.name || 'the team'} on Peacase`,
      html: `
        <h2>Your invitation is waiting!</h2>
        <p>You've been invited to join <strong>${salon?.name || 'the team'}</strong> as a staff member.</p>
        <p>Click the link below to set up your account and password:</p>
        <p><a href="${inviteUrl}" style="display: inline-block; padding: 12px 24px; background-color: #7C9A82; color: white; text-decoration: none; border-radius: 6px;">Set Up Your Account</a></p>
        <p>This link will expire in 72 hours.</p>
        <p>If you didn't expect this invitation, you can safely ignore this email.</p>
      `,
    });
    logger.info({ email: staff.email }, 'Staff invite resend email sent');
  } catch (emailError) {
    logger.error({ err: emailError, email: staff.email }, 'Failed to resend staff invite email');
  }

  res.json({
    success: true,
    data: {
      message: 'Invite resent successfully',
      staffId,
      expiresAt: tokenExpiry.toISOString(),
    },
  });
}));
```

Place this endpoint near the existing /invite endpoint in the file.
  </action>
  <verify>
Search for "invite/resend" in staffPortal.ts.
Verify 72-hour expiry is used.
Run `grep -n "72 \* 60 \* 60" apps/api/src/routes/staffPortal.ts` to confirm.
  </verify>
  <done>
POST /invite/resend/:staffId endpoint allows owners to resend invites with fresh 72-hour expiry.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add invite status to staff list API response</name>
  <files>apps/api/src/routes/staff.ts</files>
  <action>
Find the staff list endpoint (GET /api/v1/staff) and add invite status calculation to each staff member in the response.

Add an `inviteStatus` field to each staff object:
- "active" - staff has set password (passwordHash is not null)
- "invited" - staff has pending valid invite (passwordHash null, magicLinkExpires > now)
- "expired" - staff invite has expired (passwordHash null, magicLinkExpires < now or null)

Implementation approach:

1. Find the GET endpoint that returns staff list
2. For each staff member, compute inviteStatus:

```typescript
function getInviteStatus(staff: {
  passwordHash: string | null;
  magicLinkExpires: Date | null;
}): 'active' | 'invited' | 'expired' {
  if (staff.passwordHash) {
    return 'active';
  }
  if (staff.magicLinkExpires && staff.magicLinkExpires > new Date()) {
    return 'invited';
  }
  return 'expired';
}
```

3. Add inviteStatus to the response for each staff member:
```typescript
{
  id: staff.id,
  email: staff.email,
  firstName: staff.firstName,
  lastName: staff.lastName,
  // ... existing fields
  inviteStatus: getInviteStatus(staff),
}
```

If the staff.ts file doesn't have a list endpoint, check if it's in another file like salon.ts or create a helper function that can be used by whichever route returns staff lists.
  </action>
  <verify>
Search for "inviteStatus" in the modified file.
Verify the three status values are computed correctly.
  </verify>
  <done>
Staff list API includes inviteStatus field showing invited/active/expired for each staff member.
  </done>
</task>

</tasks>

<verification>
1. Search staffPortal.ts for "invite/resend" endpoint
2. Search for inviteStatus in staff response
3. Verify 72-hour expiry for resend (not 7 days)
4. Manual test: API should reject resend for staff with password set
</verification>

<success_criteria>
- [ ] POST /invite/resend/:staffId endpoint exists and works
- [ ] Resend uses 72-hour expiry (per CONTEXT.md)
- [ ] Already-activated staff cannot have invite resent
- [ ] Staff list includes inviteStatus (active/invited/expired)
- [ ] Only admin/owner can resend invites
</success_criteria>

<output>
After completion, create `.planning/phases/19-staff-authentication-foundation/19-03-SUMMARY.md`
</output>
