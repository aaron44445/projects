# Plan 09-01: Prisma Query Safety - Add salonId to Update/Delete Operations

## Goal
Fix all Prisma update and delete operations that currently use only `id` in the WHERE clause, adding `salonId` for atomic tenant isolation.

## Why This Matters
Current pattern relies on a prior `findFirst` check, but this is not atomic. If the check is bypassed (race condition, code path change, or future refactor), cross-tenant data modification becomes possible.

## Tasks

### Task 1: Fix appointments.ts Updates
**File:** `apps/api/src/routes/appointments.ts`

Fix 5 update operations:

| Line | Current | Change To |
|------|---------|-----------|
| 492 | `where: { id: req.params.id }` | `where: { id: req.params.id, salonId: req.user!.salonId }` |
| 571 | `where: { id: req.params.id }` | `where: { id: req.params.id, salonId: req.user!.salonId }` |
| 613 | `where: { id: req.params.id }` | `where: { id: req.params.id, salonId: req.user!.salonId }` |
| 648 | `where: { id: req.params.id }` | `where: { id: req.params.id, salonId: req.user!.salonId }` |
| 708 | `where: { id: req.params.id }` | `where: { id: req.params.id, salonId: req.user!.salonId }` |

**Verification:** Search file for `update({` and verify all have salonId.

---

### Task 2: Fix clients.ts Update
**File:** `apps/api/src/routes/clients.ts`

| Line | Current | Change To |
|------|---------|-----------|
| 204 | `where: { id: req.params.id }` | `where: { id: req.params.id, salonId: req.user!.salonId }` |

**Verification:** Search file for `update({` and verify salonId present.

---

### Task 3: Fix services.ts Updates
**File:** `apps/api/src/routes/services.ts`

| Line | Current | Change To |
|------|---------|-----------|
| 268 | `where: { id: req.params.id }` | `where: { id: req.params.id, salonId: req.user!.salonId }` |
| 303 | `where: { id: req.params.id }` | `where: { id: req.params.id, salonId: req.user!.salonId }` |

**Verification:** Search file for `update({` and verify all have salonId.

---

### Task 4: Fix staff.ts Updates
**File:** `apps/api/src/routes/staff.ts`

| Line | Current | Change To |
|------|---------|-----------|
| 363 | `where: { id: req.params.id }` | `where: { id: req.params.id, salonId: req.user!.salonId }` |
| 412 | `where: { id: req.params.id }` | `where: { id: req.params.id, salonId: req.user!.salonId }` |

**Verification:** Search file for `update({` and verify all have salonId.

---

### Task 5: Fix reviews.ts Update
**File:** `apps/api/src/routes/reviews.ts`

| Line | Current | Change To |
|------|---------|-----------|
| 219 | `where: { id: req.params.id }` | `where: { id: req.params.id, salonId: req.user!.salonId }` |

**Verification:** Search file for `update({` and verify salonId present.

---

### Task 6: Fix locations.ts Delete
**File:** `apps/api/src/routes/locations.ts`

| Line | Current | Change To |
|------|---------|-----------|
| 228 | `where: { id }` | `where: { id, salonId }` |

**Note:** The `salonId` variable is already in scope from line 177.

**Verification:** Search file for `delete({` and verify salonId present.

---

### Task 7: Fix clientPortal.ts Updates
**File:** `apps/api/src/routes/clientPortal.ts`

| Line | Current | Change To |
|------|---------|-----------|
| 222 | `where: { id }` | `where: { id, salonId }` |
| 441 | `where: { id: clientId }` | `where: { id: clientId, salonId }` |

**Note:** salonId comes from `req.client.salonId` in client portal routes.

**Verification:** Search file for `update({` and verify all have salonId.

---

### Task 8: Fix ownerNotifications.ts - Add salonId Filter
**File:** `apps/api/src/routes/ownerNotifications.ts`

Both GET and PATCH routes filter by userId only. Add salonId for defense-in-depth:

```typescript
// GET /
where: { userId: req.user!.userId, salonId: req.user!.salonId }

// PATCH /
where: { userId: req.user!.userId, salonId: req.user!.salonId }
```

**Verification:** Both queries include salonId alongside userId.

---

## Success Criteria

1. All 14 identified update/delete operations include salonId in WHERE clause
2. `grep -r "update({" apps/api/src/routes/` shows no `where: { id:` without salonId (for tenant models)
3. `grep -r "delete({" apps/api/src/routes/` shows no `where: { id }` without salonId
4. TypeScript compiles without errors
5. Existing tests pass (if any)

## Files Modified

- `apps/api/src/routes/appointments.ts` (5 changes)
- `apps/api/src/routes/clients.ts` (1 change)
- `apps/api/src/routes/services.ts` (2 changes)
- `apps/api/src/routes/staff.ts` (2 changes)
- `apps/api/src/routes/reviews.ts` (1 change)
- `apps/api/src/routes/locations.ts` (1 change)
- `apps/api/src/routes/clientPortal.ts` (2 changes)
- `apps/api/src/routes/ownerNotifications.ts` (2 changes)

**Total: 16 changes across 8 files**

---

*Plan created: 2026-01-28*
