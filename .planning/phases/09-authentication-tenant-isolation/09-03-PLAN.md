# Plan 09-03: Public Endpoint Validation - staffId & locationId Verification

## Goal
Secure all public booking endpoints to validate that staffId and locationId belong to the target salon before using them.

## Tasks

### Task 1: Validate staffId in Public Booking Endpoint
**File:** `apps/api/src/routes/public.ts`

**Location:** `POST /:slug/book` (~line 570)

**Current Code:**
```typescript
const {
  serviceId,
  staffId,        // USER PROVIDED - NOT VALIDATED
  locationId,
  startTime,
  // ...
} = req.body;
```

**Required Changes:**

Add validation after salon lookup:

```typescript
// Validate staffId if provided
if (staffId) {
  const staff = await prisma.user.findFirst({
    where: {
      id: staffId,
      salonId: salon.id,
      isActive: true
    }
  });

  if (!staff) {
    return res.status(400).json({
      error: 'INVALID_STAFF',
      message: 'Selected staff member is not available'
    });
  }
}
```

**Verification:** Booking with staffId from different salon returns 400 error.

---

### Task 2: Validate locationId in Public Booking Endpoint
**File:** `apps/api/src/routes/public.ts`

**Location:** `POST /:slug/book` (~line 570)

**Required Changes:**

Add validation after salon lookup:

```typescript
// Validate locationId
const location = await prisma.location.findFirst({
  where: {
    id: locationId,
    salonId: salon.id,
    isActive: true
  }
});

if (!location) {
  return res.status(400).json({
    error: 'INVALID_LOCATION',
    message: 'Selected location is not available'
  });
}
```

**Verification:** Booking with locationId from different salon returns 400 error.

---

### Task 3: Fix Service Location Pricing Lookup
**File:** `apps/api/src/routes/public.ts`

**Location:** `POST /:slug/book` (~lines 774-782)

**Current Code:**
```typescript
if (locationId) {
  const serviceLocation = await prisma.serviceLocation.findUnique({
    where: { serviceId_locationId: { serviceId, locationId } },
  });
```

**Required Changes:**

Since we now validate locationId in Task 2, this is safe. But add explicit check for defense-in-depth:

```typescript
if (locationId) {
  const serviceLocation = await prisma.serviceLocation.findFirst({
    where: {
      serviceId,
      locationId,
      location: { salonId: salon.id } // Verify location belongs to salon
    },
  });
```

**Verification:** Price lookup cannot use location from different salon.

---

### Task 4: Validate staffId/locationId in Payment Intent Creation
**File:** `apps/api/src/routes/public.ts`

**Location:** `POST /:slug/create-payment-intent` (~line 917)

**Current Code:**
```typescript
const { serviceId, servicePrice, clientEmail, staffId, locationId, appointmentDate } = req.body;
// staffId and locationId used in metadata without validation
```

**Required Changes:**

Add validation before creating payment intent:

```typescript
// Validate staffId if provided
if (staffId) {
  const staff = await prisma.user.findFirst({
    where: { id: staffId, salonId: salon.id, isActive: true }
  });
  if (!staff) {
    return res.status(400).json({
      error: 'INVALID_STAFF',
      message: 'Selected staff member is not available'
    });
  }
}

// Validate locationId if provided
if (locationId) {
  const location = await prisma.location.findFirst({
    where: { id: locationId, salonId: salon.id, isActive: true }
  });
  if (!location) {
    return res.status(400).json({
      error: 'INVALID_LOCATION',
      message: 'Selected location is not available'
    });
  }
}
```

**Verification:** Payment intent creation rejects invalid staffId/locationId.

---

### Task 5: Validate Location in Availability Query
**File:** `apps/api/src/routes/public.ts`

**Location:** `GET /:slug/availability` (~lines 384-494)

**Current Code:**
```typescript
// Service validation is correct
const service = await prisma.service.findFirst({
  where: { id: serviceId as string, salonId: salon.id, isActive: true },
});

// But location validation may be incomplete
```

**Required Changes:**

Ensure location is validated:

```typescript
// Validate location belongs to salon
const location = await prisma.location.findFirst({
  where: {
    id: locationId as string,
    salonId: salon.id,
    isActive: true
  }
});

if (!location) {
  return res.status(400).json({
    error: 'INVALID_LOCATION',
    message: 'Location not found'
  });
}
```

**Verification:** Availability query with wrong locationId returns 400.

---

### Task 6: Fix Client Portal Client Lookup
**File:** `apps/api/src/routes/clientPortal.ts`

**Location:** Dashboard endpoint (~line 16)

**Current Code:**
```typescript
const client = await prisma.client.findUnique({
  where: { id: clientId },
});
```

**Required Changes:**

```typescript
const client = await prisma.client.findFirst({
  where: {
    id: clientId,
    salonId  // Add salonId from auth context
  },
});
```

**Verification:** Client lookup includes salonId verification.

---

### Task 7: Create Validation Helper Function
**File:** `apps/api/src/utils/validation.ts` (new file or add to existing)

Create reusable validation helpers:

```typescript
import { prisma } from '../lib/prisma';

export async function validateStaffBelongsToSalon(
  staffId: string,
  salonId: string
): Promise<boolean> {
  const staff = await prisma.user.findFirst({
    where: { id: staffId, salonId, isActive: true },
    select: { id: true }
  });
  return !!staff;
}

export async function validateLocationBelongsToSalon(
  locationId: string,
  salonId: string
): Promise<boolean> {
  const location = await prisma.location.findFirst({
    where: { id: locationId, salonId, isActive: true },
    select: { id: true }
  });
  return !!location;
}

export async function validateServiceBelongsToSalon(
  serviceId: string,
  salonId: string
): Promise<boolean> {
  const service = await prisma.service.findFirst({
    where: { id: serviceId, salonId, isActive: true },
    select: { id: true }
  });
  return !!service;
}
```

**Usage:**
```typescript
import { validateStaffBelongsToSalon } from '../utils/validation';

if (staffId && !(await validateStaffBelongsToSalon(staffId, salon.id))) {
  return res.status(400).json({ error: 'INVALID_STAFF' });
}
```

---

## Success Criteria

1. Public booking endpoint validates staffId belongs to salon
2. Public booking endpoint validates locationId belongs to salon
3. Service location pricing lookup includes salonId check
4. Payment intent creation validates staffId/locationId
5. Availability query validates locationId
6. Client portal validates client belongs to salon
7. All validation returns clear error messages
8. TypeScript compiles without errors

## Files Modified

- `apps/api/src/routes/public.ts` (4 endpoints)
- `apps/api/src/routes/clientPortal.ts` (1 endpoint)
- `apps/api/src/utils/validation.ts` (new helper functions)

---

*Plan created: 2026-01-28*
