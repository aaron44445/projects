# Plan 09-04: Frontend Consistency - Token Keys & API Client Usage

## Goal
Fix frontend authentication inconsistencies: wrong token keys, direct fetch calls bypassing the API client, and inconsistent API URL definitions.

## Tasks

### Task 1: Fix Settings Page Token Key
**File:** `apps/web/src/app/settings/page.tsx`

**Current Code (lines 438-441, 472-476):**
```typescript
const response = await fetch(`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001/api/v1'}/salon/widget-settings`, {
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('accessToken')}`, // WRONG KEY!
  },
});
```

**Required Changes:**

Replace direct fetch with API client:

```typescript
import { api } from '@/lib/api';

// Replace fetch calls with:
const response = await api.get('/salon/widget-settings');
const data = await api.patch('/salon/widget-settings', widgetSettings);
```

**Verification:** Settings page loads and saves correctly with authenticated requests.

---

### Task 2: Replace Direct Fetch in ClientAuthContext
**File:** `apps/web/src/contexts/ClientAuthContext.tsx`

**Current Code (lines 96, 118, 232, 266, 299):**
Multiple direct fetch calls that bypass the API client.

**Required Changes:**

1. Create a dedicated client API instance or use fetch with correct token:

```typescript
const CLIENT_TOKEN_KEY = 'peacase_client_access_token';
const CLIENT_REFRESH_TOKEN_KEY = 'peacase_client_refresh_token';

// Helper function for client API calls
const clientFetch = async (endpoint: string, options: RequestInit = {}) => {
  const token = localStorage.getItem(CLIENT_TOKEN_KEY);
  const response = await fetch(`${API_URL}${endpoint}`, {
    ...options,
    headers: {
      'Content-Type': 'application/json',
      ...(token && { 'Authorization': `Bearer ${token}` }),
      ...options.headers,
    },
  });
  return response;
};
```

2. Standardize token key names:
```typescript
// Before
const ACCESS_TOKEN_KEY = 'client_access_token';
const REFRESH_TOKEN_KEY = 'client_refresh_token';

// After
const ACCESS_TOKEN_KEY = 'peacase_client_access_token';
const REFRESH_TOKEN_KEY = 'peacase_client_refresh_token';
```

**Verification:** Client portal authentication works correctly.

---

### Task 3: Replace Direct Fetch in Portal Data Page
**File:** `apps/web/src/app/portal/data/page.tsx`

**Current Code (lines 200, 240, 280, 318, 356):**
Direct fetch calls with manual token handling.

**Required Changes:**

Import and use the client auth context's fetch helper or create dedicated hooks:

```typescript
// Use the client auth context
const { clientFetch } = useClientAuth();

// Replace:
const response = await fetch(`${API_URL}/client-portal/export`, {
  headers: { 'Authorization': `Bearer ${token}` }
});

// With:
const response = await clientFetch('/client-portal/export');
```

**Verification:** GDPR data export and consent management work correctly.

---

### Task 4: Replace Direct Fetch in Staff Profile Page
**File:** `apps/web/src/app/staff/profile/page.tsx`

**Current Code (line 145, 150):**
```typescript
const token = localStorage.getItem('peacase_staff_access_token');
const response = await fetch(`${API_URL}/staff-portal/profile`, {
  headers: { 'Authorization': `Bearer ${token}` }
});
```

**Required Changes:**

Create or use staff auth context with consistent API handling:

```typescript
// Use staff auth context
const { staffFetch } = useStaffAuth();

const response = await staffFetch('/staff-portal/profile', {
  method: 'PATCH',
  body: JSON.stringify(data)
});
```

**Verification:** Staff profile updates work correctly.

---

### Task 5: Standardize Token Key Names
**Files:** Multiple auth contexts

**Current Keys:**
| Context | Access Token | Refresh Token |
|---------|--------------|---------------|
| AuthContext | `peacase_access_token` | `peacase_refresh_token` |
| ClientAuthContext | `client_access_token` | `client_refresh_token` |
| StaffAuthContext | `peacase_staff_access_token` | (none found) |

**Standardized Keys:**
| Context | Access Token | Refresh Token |
|---------|--------------|---------------|
| AuthContext | `peacase_access_token` | `peacase_refresh_token` |
| ClientAuthContext | `peacase_client_access_token` | `peacase_client_refresh_token` |
| StaffAuthContext | `peacase_staff_access_token` | `peacase_staff_refresh_token` |

**Changes Required:**

1. `apps/web/src/contexts/ClientAuthContext.tsx`:
```typescript
const ACCESS_TOKEN_KEY = 'peacase_client_access_token';
const REFRESH_TOKEN_KEY = 'peacase_client_refresh_token';
```

2. `apps/web/src/contexts/StaffAuthContext.tsx`:
```typescript
const ACCESS_TOKEN_KEY = 'peacase_staff_access_token';
const REFRESH_TOKEN_KEY = 'peacase_staff_refresh_token';
```

**Verification:** All auth contexts use consistent naming convention.

---

### Task 6: Centralize API URL Definition
**File:** Create `apps/web/src/config/api.ts`

**Current State:** API_BASE defined differently in multiple files:
- `api.ts`: `'http://localhost:3001/api/v1'`
- `embed/[slug]/page.tsx`: `'http://localhost:3001'` (strips /api/v1)
- `portal/data/page.tsx`: `'http://localhost:3001'`
- `ClientAuthContext.tsx`: `'http://localhost:3001'`

**Create Centralized Config:**

```typescript
// apps/web/src/config/api.ts
export const API_CONFIG = {
  // Base URL without /api/v1 suffix
  baseUrl: process.env.NEXT_PUBLIC_API_URL?.replace(/\/api\/v1\/?$/, '') || 'http://localhost:3001',

  // Full API URL with /api/v1
  apiUrl: process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001/api/v1',

  // Public API (no auth required)
  publicApiUrl: (slug: string) =>
    `${API_CONFIG.apiUrl}/public/${slug}`,

  // Client portal API
  clientPortalUrl: `${API_CONFIG.apiUrl}/client-portal`,

  // Staff portal API
  staffPortalUrl: `${API_CONFIG.apiUrl}/staff-portal`,
};

export default API_CONFIG;
```

**Update all files to import from config:**

```typescript
import { API_CONFIG } from '@/config/api';

// Instead of:
const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001/api/v1';

// Use:
const API_URL = API_CONFIG.apiUrl;
```

**Verification:** All API calls use centralized config.

---

### Task 7: Update Embed Page to Use Config
**File:** `apps/web/src/app/embed/[slug]/page.tsx`

**Current Code (lines 207-310):**
```typescript
const API_BASE = typeof window !== 'undefined'
  ? process.env.NEXT_PUBLIC_API_URL?.replace(/\/api\/v1$/, '') || 'http://localhost:3001'
  : 'http://localhost:3001';
```

**Required Changes:**

```typescript
import { API_CONFIG } from '@/config/api';

// Replace all API_BASE usages with:
const response = await fetch(`${API_CONFIG.apiUrl}/public/${slug}/salon`);
```

**Verification:** Embed booking widget works correctly.

---

### Task 8: Add TypeScript Types for Token Storage
**File:** `apps/web/src/types/auth.ts` (new or existing)

```typescript
export const TOKEN_KEYS = {
  // Owner/Admin auth
  owner: {
    access: 'peacase_access_token',
    refresh: 'peacase_refresh_token',
  },
  // Client portal auth
  client: {
    access: 'peacase_client_access_token',
    refresh: 'peacase_client_refresh_token',
  },
  // Staff portal auth
  staff: {
    access: 'peacase_staff_access_token',
    refresh: 'peacase_staff_refresh_token',
  },
} as const;

export type AuthContext = keyof typeof TOKEN_KEYS;
```

**Usage:**
```typescript
import { TOKEN_KEYS } from '@/types/auth';

localStorage.getItem(TOKEN_KEYS.client.access);
```

**Verification:** Token keys are type-safe and consistent.

---

## Success Criteria

1. Settings page uses correct token key (via api client)
2. All direct fetch calls replaced with proper API clients
3. Token keys standardized across all auth contexts
4. API URL centralized in single config file
5. No `localStorage.getItem('accessToken')` anywhere (wrong key)
6. TypeScript compiles without errors
7. All auth flows work: owner login, client login, staff login

## Files Modified

- `apps/web/src/app/settings/page.tsx`
- `apps/web/src/contexts/ClientAuthContext.tsx`
- `apps/web/src/contexts/StaffAuthContext.tsx`
- `apps/web/src/app/portal/data/page.tsx`
- `apps/web/src/app/staff/profile/page.tsx`
- `apps/web/src/app/embed/[slug]/page.tsx`
- `apps/web/src/config/api.ts` (new)
- `apps/web/src/types/auth.ts` (new or modified)

---

*Plan created: 2026-01-28*
