# Plan 09-02: Webhook Security - Signature Validation & Tenant Verification

## Goal
Secure all webhook endpoints with proper signature validation and cross-tenant verification to prevent spoofed callbacks.

## Tasks

### Task 1: Add Twilio Webhook Signature Validation
**File:** `apps/api/src/routes/webhooks.ts`

**Current Code (lines 26-93):**
```typescript
router.post('/sms-status', express.urlencoded({ extended: true }), asyncHandler(async (req, res) => {
  res.status(200).send('OK');
  const { MessageSid, MessageStatus } = req.body;
  // NO VALIDATION - anyone can call this
```

**Required Changes:**

1. Import Twilio validation helper:
```typescript
import twilio from 'twilio';
```

2. Add signature validation before processing:
```typescript
router.post('/sms-status', express.urlencoded({ extended: true }), asyncHandler(async (req, res) => {
  // Validate Twilio signature
  const twilioSignature = req.headers['x-twilio-signature'] as string;
  const url = `${env.API_URL}/api/v1/webhooks/sms-status`;

  const isValid = twilio.validateRequest(
    env.TWILIO_AUTH_TOKEN,
    twilioSignature,
    url,
    req.body
  );

  if (!isValid) {
    console.warn('[SMS Webhook] Invalid Twilio signature');
    return res.status(403).json({ error: 'Invalid signature' });
  }

  // Respond immediately to avoid Twilio timeout
  res.status(200).send('OK');

  // ... rest of processing
});
```

3. Add env variable check:
```typescript
if (!env.TWILIO_AUTH_TOKEN) {
  console.error('[SMS Webhook] TWILIO_AUTH_TOKEN not configured');
  return res.status(500).json({ error: 'Webhook not configured' });
}
```

**Verification:**
- Webhook rejects requests without valid signature
- Webhook rejects requests with tampered body
- Valid Twilio callbacks still process correctly

---

### Task 2: Fix Subscription Webhook Metadata Validation
**File:** `apps/api/src/services/subscriptions.ts`

**Current Code (handleSubscriptionUpdated, ~line 290):**
```typescript
export async function handleSubscriptionUpdated(subscription: any) {
  const salonId = subscription.metadata?.salonId;

  if (!salonId) {
    // Fallback lookup by stripeSubscriptionId only - DANGEROUS
    const existingSub = await prisma.subscription.findUnique({
      where: { stripeSubscriptionId: subscription.id },
    });
```

**Required Changes:**

```typescript
export async function handleSubscriptionUpdated(subscription: any) {
  const metadataSalonId = subscription.metadata?.salonId;

  // Always lookup existing subscription first
  const existingSub = await prisma.subscription.findUnique({
    where: { stripeSubscriptionId: subscription.id },
    select: { salonId: true }
  });

  if (!existingSub) {
    console.warn(`[Subscription] No subscription found for ${subscription.id}`);
    return;
  }

  // If metadata has salonId, verify it matches
  if (metadataSalonId && metadataSalonId !== existingSub.salonId) {
    console.error(`[Subscription] Metadata salonId mismatch: ${metadataSalonId} vs ${existingSub.salonId}`);
    return; // Reject mismatched updates
  }

  // Use verified salonId from database
  const salonId = existingSub.salonId;

  // ... proceed with update using verified salonId
}
```

**Verification:**
- Subscription updates only process when salonId matches
- Mismatched metadata is logged and rejected
- Updates without metadata still work (use DB salonId)

---

### Task 3: Fix Invoice Webhook Subscription Verification
**File:** `apps/api/src/services/subscriptions.ts`

**Current Code (handleInvoicePaid, ~line 372):**
```typescript
export async function handleInvoicePaid(invoice: Stripe.Invoice) {
  const customerId = invoice.customer as string;
  const salon = await prisma.salon.findFirst({
    where: { stripeCustomerId: customerId },
  });
```

**Required Changes:**

```typescript
export async function handleInvoicePaid(invoice: Stripe.Invoice) {
  const customerId = invoice.customer as string;

  // Find salon by customer ID
  const salon = await prisma.salon.findFirst({
    where: { stripeCustomerId: customerId },
    include: { subscription: true }
  });

  if (!salon) {
    console.warn(`[Invoice] No salon found for customer ${customerId}`);
    return;
  }

  // Verify invoice subscription belongs to this customer
  const invoiceSubscriptionId = invoice.subscription as string;
  if (invoiceSubscriptionId && salon.subscription?.stripeSubscriptionId !== invoiceSubscriptionId) {
    console.error(`[Invoice] Subscription mismatch for salon ${salon.id}`);
    return;
  }

  // ... proceed with verified salon
}
```

**Verification:**
- Invoice only creates billing record for correct salon
- Mismatched subscription IDs are rejected
- Logging captures any anomalies

---

### Task 4: Fix Gift Card Checkout Metadata Trust
**File:** `apps/api/src/routes/webhooks.ts`

**Current Code (~lines 137-172):**
```typescript
case 'checkout.session.completed': {
  const session = event.data.object as any;
  const metadata = session.metadata;

  if (metadata?.type === 'gift_card') {
    // Trusts metadata.salonId directly
    await prisma.giftCard.create({
      data: { salonId: metadata.salonId, ... }
    });
```

**Required Changes:**

The fix needs to happen at checkout session creation (public.ts), not the webhook. The webhook should verify:

```typescript
case 'checkout.session.completed': {
  const session = event.data.object as any;
  const metadata = session.metadata;

  if (metadata?.type === 'gift_card') {
    // Verify salon exists and matches the checkout context
    const salon = await prisma.salon.findUnique({
      where: { id: metadata.salonId },
      select: { id: true, stripeCustomerId: true }
    });

    if (!salon) {
      console.error(`[GiftCard] Invalid salonId in metadata: ${metadata.salonId}`);
      return;
    }

    // Additional check: verify payment went to correct Stripe account
    // (if using Stripe Connect)

    await prisma.giftCard.create({
      data: { salonId: salon.id, ... } // Use verified ID
    });
```

**Also fix checkout session creation in public.ts** to ensure salonId comes from verified salon lookup, not request body:

```typescript
// In public.ts create-checkout-session for gift cards
const salon = await prisma.salon.findUnique({ where: { slug } });
// Use salon.id, never trust request body salonId
metadata: { salonId: salon.id, type: 'gift_card', ... }
```

**Verification:**
- Gift cards only created for valid salons
- Checkout session uses verified salonId from slug lookup
- Invalid salonId in metadata is rejected

---

### Task 5: Add Tenant Verification to SMS Status Update
**File:** `apps/api/src/routes/webhooks.ts`

Even with signature validation, add defense-in-depth:

```typescript
// After signature validation, when updating notification log
const notification = await prisma.notificationLog.findFirst({
  where: { twilioMessageSid: MessageSid },
  select: { id: true, salonId: true }
});

if (!notification) {
  console.warn(`[SMS Webhook] No notification found for ${MessageSid}`);
  return;
}

// Log the update with salonId context for audit trail
console.log(`[SMS Webhook] Updating notification ${notification.id} for salon ${notification.salonId}`);

await prisma.notificationLog.update({
  where: { id: notification.id },
  data: { status: MessageStatus, ... }
});
```

**Verification:**
- Unknown MessageSids are logged and ignored
- Updates include audit trail with salonId

---

## Success Criteria

1. Twilio webhook validates signature before processing
2. Subscription updates verify salonId matches database
3. Invoice processing verifies subscription ownership
4. Gift card creation uses verified salonId only
5. SMS status updates include audit logging
6. All webhooks handle invalid/missing data gracefully
7. TypeScript compiles without errors

## Files Modified

- `apps/api/src/routes/webhooks.ts` (signature validation, gift card fix, SMS audit)
- `apps/api/src/services/subscriptions.ts` (subscription & invoice verification)
- `apps/api/src/routes/public.ts` (gift card checkout session fix)

---

*Plan created: 2026-01-28*
