// Peacase Database Schema
// PostgreSQL with Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE TABLES
// ============================================

model Salon {
  id               String   @id @default(uuid())
  name             String
  slug             String   @unique
  email            String
  phone            String?
  address          String?
  city             String?
  state            String?
  zip              String?
  country          String   @default("US")
  timezone         String   @default("America/Chicago")
  logoUrl          String?  @map("logo_url")
  website          String?
  description      String?
  subscriptionPlan String   @default("essentials") @map("subscription_plan")
  subscriptionTier String   @default("free") @map("subscription_tier") // free, professional, enterprise
  featuresEnabled  String   @default("[]") @map("features_enabled")
  stripeAccountId  String?  @map("stripe_account_id")
  stripeCustomerId String?  @map("stripe_customer_id")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  users              User[]
  clients            Client[]
  services           Service[]
  serviceCategories  ServiceCategory[]
  appointments       Appointment[]
  payments           Payment[]
  locations          Location[]
  packages           Package[]
  giftCards          GiftCard[]
  reviews            Review[]
  marketingCampaigns MarketingCampaign[]
  consultationForms  ConsultationForm[]
  commissionRecords  CommissionRecord[]
  subscription       Subscription?

  @@map("salons")
}

model User {
  id              String    @id @default(uuid())
  salonId         String    @map("salon_id")
  email           String
  passwordHash    String?   @map("password_hash")
  firstName       String    @map("first_name")
  lastName        String    @map("last_name")
  phone           String?
  role            String    @default("staff")
  avatarUrl       String?   @map("avatar_url")
  certifications  String?
  commissionRate  Float?    @map("commission_rate")
  googleId        String?   @map("google_id")
  appleId         String?   @map("apple_id")
  magicLinkToken  String?   @map("magic_link_token")
  magicLinkExpires DateTime? @map("magic_link_expires")
  emailVerified   Boolean   @default(false) @map("email_verified")
  isActive        Boolean   @default(true) @map("is_active")
  lastLogin       DateTime? @map("last_login")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  salon                     Salon                    @relation(fields: [salonId], references: [id], onDelete: Cascade)
  appointments              Appointment[]
  clientNotes               ClientNote[]
  staffServices             StaffService[]
  staffAvailability         StaffAvailability[]
  timeOff                   TimeOff[]
  reviewResponses           ReviewResponse[]
  commissionRecords         CommissionRecord[]
  refreshTokens             RefreshToken[]
  passwordResetTokens       PasswordResetToken[]
  emailVerificationTokens   EmailVerificationToken[]
  preferredByClients        Client[]                 @relation("PreferredStaff")

  @@unique([salonId, email])
  @@map("users")
}

model Client {
  id                      String   @id @default(uuid())
  salonId                 String   @map("salon_id")
  firstName               String   @map("first_name")
  lastName                String   @map("last_name")
  email                   String?
  phone                   String?
  address                 String?
  city                    String?
  state                   String?
  zip                     String?
  birthday                DateTime?
  notes                   String?
  preferredStaffId        String?  @map("preferred_staff_id")
  communicationPreference String   @default("email") @map("communication_preference")
  optedInReminders        Boolean  @default(true) @map("opted_in_reminders")
  optedInMarketing        Boolean  @default(true) @map("opted_in_marketing")
  isActive                Boolean  @default(true) @map("is_active")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  // Relations
  salon           Salon           @relation(fields: [salonId], references: [id], onDelete: Cascade)
  preferredStaff  User?           @relation("PreferredStaff", fields: [preferredStaffId], references: [id])
  appointments    Appointment[]
  payments        Payment[]
  clientNotes     ClientNote[]
  clientPackages  ClientPackage[]
  reviews         Review[]
  formResponses   FormResponse[]

  @@map("clients")
}

model ClientNote {
  id        String   @id @default(uuid())
  clientId  String   @map("client_id")
  staffId   String   @map("staff_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  staff  User   @relation(fields: [staffId], references: [id])

  @@map("client_notes")
}

model ServiceCategory {
  id           String   @id @default(uuid())
  salonId      String   @map("salon_id")
  name         String
  description  String?
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  salon    Salon     @relation(fields: [salonId], references: [id], onDelete: Cascade)
  services Service[]

  @@map("service_categories")
}

model Service {
  id             String   @id @default(uuid())
  salonId        String   @map("salon_id")
  categoryId     String?  @map("category_id")
  name           String
  description    String?
  durationMinutes Int     @default(30) @map("duration_minutes")
  bufferMinutes  Int      @default(0) @map("buffer_minutes")
  price          Float
  memberPrice    Float?   @map("member_price")
  color          String   @default("#C7DCC8")
  isActive       Boolean  @default(true) @map("is_active")
  displayOrder   Int      @default(0) @map("display_order")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  salon           Salon            @relation(fields: [salonId], references: [id], onDelete: Cascade)
  category        ServiceCategory? @relation(fields: [categoryId], references: [id])
  appointments    Appointment[]
  staffServices   StaffService[]
  packageServices PackageService[]

  @@map("services")
}

model StaffService {
  id          String  @id @default(uuid())
  staffId     String  @map("staff_id")
  serviceId   String  @map("service_id")
  isAvailable Boolean @default(true) @map("is_available")

  // Relations
  staff   User    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([staffId, serviceId])
  @@map("staff_services")
}

model StaffAvailability {
  id          String  @id @default(uuid())
  staffId     String  @map("staff_id")
  dayOfWeek   Int     @map("day_of_week")
  startTime   String  @map("start_time")
  endTime     String  @map("end_time")
  isAvailable Boolean @default(true) @map("is_available")

  // Relations
  staff User @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([staffId, dayOfWeek])
  @@map("staff_availability")
}

model TimeOff {
  id        String   @id @default(uuid())
  staffId   String   @map("staff_id")
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")
  reason    String?
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  staff User @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@map("time_off")
}

model Location {
  id        String   @id @default(uuid())
  salonId   String   @map("salon_id")
  name      String
  address   String?
  city      String?
  state     String?
  zip       String?
  phone     String?
  timezone  String?
  hours     String?
  isPrimary Boolean  @default(false) @map("is_primary")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  salon        Salon         @relation(fields: [salonId], references: [id], onDelete: Cascade)
  appointments Appointment[]

  @@map("locations")
}

model Appointment {
  id                String    @id @default(uuid())
  salonId           String    @map("salon_id")
  locationId        String?   @map("location_id")
  clientId          String    @map("client_id")
  staffId           String    @map("staff_id")
  serviceId         String    @map("service_id")
  startTime         DateTime  @map("start_time")
  endTime           DateTime  @map("end_time")
  durationMinutes   Int       @map("duration_minutes")
  price             Float
  priceOverride     Float?    @map("price_override")
  status            String    @default("confirmed")
  cancellationReason String?  @map("cancellation_reason")
  notes             String?
  source            String    @default("manual")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  cancelledAt       DateTime? @map("cancelled_at")

  // Relations
  salon             Salon              @relation(fields: [salonId], references: [id], onDelete: Cascade)
  location          Location?          @relation(fields: [locationId], references: [id])
  client            Client             @relation(fields: [clientId], references: [id])
  staff             User               @relation(fields: [staffId], references: [id])
  service           Service            @relation(fields: [serviceId], references: [id])
  payments          Payment[]
  reviews           Review[]
  formResponses     FormResponse[]
  commissionRecords CommissionRecord[]
  reminderLogs      ReminderLog[]

  @@map("appointments")
}

model Payment {
  id              String    @id @default(uuid())
  salonId         String    @map("salon_id")
  appointmentId   String?   @map("appointment_id")
  clientId        String    @map("client_id")
  amount          Float
  tipAmount       Float     @default(0) @map("tip_amount")
  totalAmount     Float     @map("total_amount")
  method          String?
  status          String    @default("pending")
  stripePaymentId String?   @map("stripe_payment_id")
  stripeRefundId  String?   @map("stripe_refund_id")
  refundAmount    Float?    @map("refund_amount")
  refundReason    String?   @map("refund_reason")
  createdAt       DateTime  @default(now()) @map("created_at")
  refundedAt      DateTime? @map("refunded_at")

  // Relations
  salon             Salon              @relation(fields: [salonId], references: [id], onDelete: Cascade)
  appointment       Appointment?       @relation(fields: [appointmentId], references: [id])
  client            Client             @relation(fields: [clientId], references: [id])
  commissionRecords CommissionRecord[]

  @@map("payments")
}

// ============================================
// ADD-ON FEATURE TABLES
// ============================================

model Package {
  id            String   @id @default(uuid())
  salonId       String   @map("salon_id")
  name          String
  description   String?
  price         Float
  type          String   @default("one_time")
  durationDays  Int?     @map("duration_days")
  renewalPrice  Float?   @map("renewal_price")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  salon           Salon            @relation(fields: [salonId], references: [id], onDelete: Cascade)
  packageServices PackageService[]
  clientPackages  ClientPackage[]

  @@map("packages")
}

model PackageService {
  id        String @id @default(uuid())
  packageId String @map("package_id")
  serviceId String @map("service_id")
  quantity  Int    @default(1)

  // Relations
  package Package @relation(fields: [packageId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id])

  @@map("package_services")
}

model ClientPackage {
  id                   String    @id @default(uuid())
  clientId             String    @map("client_id")
  packageId            String    @map("package_id")
  purchaseDate         DateTime  @map("purchase_date")
  expirationDate       DateTime? @map("expiration_date")
  servicesRemaining    Int       @map("services_remaining")
  totalServices        Int       @map("total_services")
  autoRenew            Boolean   @default(false) @map("auto_renew")
  stripeSubscriptionId String?   @map("stripe_subscription_id")
  isActive             Boolean   @default(true) @map("is_active")
  createdAt            DateTime  @default(now()) @map("created_at")

  // Relations
  client  Client  @relation(fields: [clientId], references: [id])
  package Package @relation(fields: [packageId], references: [id])

  @@map("client_packages")
}

model GiftCard {
  id             String    @id @default(uuid())
  salonId        String    @map("salon_id")
  code           String    @unique
  initialAmount  Float     @map("initial_amount")
  balance        Float
  status         String    @default("active")
  expiresAt      DateTime? @map("expires_at")
  purchasedAt    DateTime  @default(now()) @map("purchased_at")
  redeemedAt     DateTime? @map("redeemed_at")
  purchaserEmail String?   @map("purchaser_email")
  recipientEmail String?   @map("recipient_email")
  recipientName  String?   @map("recipient_name")
  message        String?

  // Relations
  salon Salon @relation(fields: [salonId], references: [id], onDelete: Cascade)

  @@map("gift_cards")
}

model Review {
  id            String    @id @default(uuid())
  salonId       String    @map("salon_id")
  appointmentId String    @map("appointment_id")
  clientId      String    @map("client_id")
  staffId       String?   @map("staff_id")
  rating        Int
  comment       String?
  isApproved    Boolean   @default(false) @map("is_approved")
  submittedAt   DateTime  @default(now()) @map("submitted_at")
  approvedAt    DateTime? @map("approved_at")

  // Relations
  salon       Salon            @relation(fields: [salonId], references: [id], onDelete: Cascade)
  appointment Appointment      @relation(fields: [appointmentId], references: [id])
  client      Client           @relation(fields: [clientId], references: [id])
  responses   ReviewResponse[]

  @@map("reviews")
}

model ReviewResponse {
  id            String   @id @default(uuid())
  reviewId      String   @map("review_id")
  responseText  String   @map("response_text")
  respondedById String   @map("responded_by_id")
  respondedAt   DateTime @default(now()) @map("responded_at")

  // Relations
  review      Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  respondedBy User   @relation(fields: [respondedById], references: [id])

  @@map("review_responses")
}

model MarketingCampaign {
  id              String    @id @default(uuid())
  salonId         String    @map("salon_id")
  name            String
  type            String
  subjectLine     String?   @map("subject_line")
  message         String
  audienceFilter  String?   @map("audience_filter")
  status          String    @default("draft")
  scheduledFor    DateTime? @map("scheduled_for")
  sentAt          DateTime? @map("sent_at")
  recipientsCount Int?      @map("recipients_count")
  openedCount     Int       @default(0) @map("opened_count")
  clickedCount    Int       @default(0) @map("clicked_count")
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  salon Salon @relation(fields: [salonId], references: [id], onDelete: Cascade)

  @@map("marketing_campaigns")
}

model ConsultationForm {
  id          String   @id @default(uuid())
  salonId     String   @map("salon_id")
  name        String
  description String?
  fields      String
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  salon     Salon          @relation(fields: [salonId], references: [id], onDelete: Cascade)
  responses FormResponse[]

  @@map("consultation_forms")
}

model FormResponse {
  id            String   @id @default(uuid())
  formId        String   @map("form_id")
  clientId      String   @map("client_id")
  appointmentId String?  @map("appointment_id")
  responseData  String   @map("response_data")
  signatureUrl  String?  @map("signature_url")
  submittedAt   DateTime @default(now()) @map("submitted_at")

  // Relations
  form        ConsultationForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  client      Client           @relation(fields: [clientId], references: [id])
  appointment Appointment?     @relation(fields: [appointmentId], references: [id])

  @@map("form_responses")
}

model CommissionRecord {
  id               String    @id @default(uuid())
  salonId          String    @map("salon_id")
  staffId          String    @map("staff_id")
  appointmentId    String    @map("appointment_id")
  paymentId        String    @map("payment_id")
  serviceAmount    Float     @map("service_amount")
  tipAmount        Float     @default(0) @map("tip_amount")
  commissionRate   Float     @map("commission_rate")
  commissionAmount Float     @map("commission_amount")
  periodStart      DateTime? @map("period_start")
  periodEnd        DateTime? @map("period_end")
  isPaid           Boolean   @default(false) @map("is_paid")
  paidAt           DateTime? @map("paid_at")
  createdAt        DateTime  @default(now()) @map("created_at")

  // Relations
  salon       Salon       @relation(fields: [salonId], references: [id], onDelete: Cascade)
  staff       User        @relation(fields: [staffId], references: [id])
  appointment Appointment @relation(fields: [appointmentId], references: [id])
  payment     Payment     @relation(fields: [paymentId], references: [id])

  @@map("commission_records")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tokenHash String   @map("token_hash")
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([userId])
  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("email_verification_tokens")
}

// ============================================
// REMINDER TRACKING
// ============================================

model ReminderLog {
  id            String   @id @default(uuid())
  appointmentId String   @map("appointment_id")
  reminderType  String   @map("reminder_type") // REMINDER_24H, REMINDER_2H
  channel       String   // email, sms, both
  success       Boolean  @default(true)
  error         String?
  sentAt        DateTime @default(now()) @map("sent_at")

  // Relations
  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  // Ensure we don't send duplicate reminders
  @@unique([appointmentId, reminderType])
  @@index([appointmentId])
  @@index([sentAt])
  @@map("reminder_logs")
}

// ============================================
// SUBSCRIPTION & BILLING
// ============================================

model Subscription {
  id                   String    @id @default(uuid())
  salonId              String    @unique @map("salon_id")
  stripeSubscriptionId String?   @unique @map("stripe_subscription_id")
  stripeCustomerId     String?   @map("stripe_customer_id")
  plan                 String    @default("free") // free, professional, enterprise
  status               String    @default("active") // active, canceled, past_due, trialing, incomplete
  currentPeriodStart   DateTime? @map("current_period_start")
  currentPeriodEnd     DateTime? @map("current_period_end")
  cancelAtPeriodEnd    Boolean   @default(false) @map("cancel_at_period_end")
  canceledAt           DateTime? @map("canceled_at")
  trialEndsAt          DateTime? @map("trial_ends_at")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  // Relations
  salon Salon @relation(fields: [salonId], references: [id], onDelete: Cascade)

  @@index([stripeSubscriptionId])
  @@index([status])
  @@map("subscriptions")
}

model BillingHistory {
  id                 String   @id @default(uuid())
  salonId            String   @map("salon_id")
  stripeInvoiceId    String?  @unique @map("stripe_invoice_id")
  amount             Float
  currency           String   @default("usd")
  status             String   // paid, open, void, uncollectible
  description        String?
  invoicePdfUrl      String?  @map("invoice_pdf_url")
  hostedInvoiceUrl   String?  @map("hosted_invoice_url")
  periodStart        DateTime @map("period_start")
  periodEnd          DateTime @map("period_end")
  paidAt             DateTime? @map("paid_at")
  createdAt          DateTime @default(now()) @map("created_at")

  @@index([salonId])
  @@index([createdAt])
  @@map("billing_history")
}
